import lr from"./DCD4gzzb.js";import{_ as Py,a as ti,u as cn,c as Da,b as Hr,d as Vr,e as dr,f as Ay,g as Rp}from"./DUtCTD6U.js";import{d as Pe,o as Ua,G as Ty,h as Iy,A as L,s as Ry,H as Cy,I as $y,J as Cp,i as Le,l as de,z as I,D as q,K as Ve,L as P,B as N,C as ne,F as ie,M as se,N as _e,E as H,O as Ny,P as ct,Q as _t,R as ni,S as jy,T as Ly,U as My,V as Dy,W as Uy,X as Fy,n as yd,u as By}from"./CHgXOuzZ.js";const zy=Symbol.for("nuxt:client-only"),Gy=Pe({name:"ClientOnly",inheritAttrs:!1,props:["fallback","placeholder","placeholderTag","fallbackTag"],setup(r,{slots:e,attrs:t}){const n=Ry(!1);Ua(()=>{n.value=!0});const s=Cy();return s&&(s._nuxtClientOnly=!0),$y(zy,!0),()=>{if(n.value){const u=e.default?.();return u&&u.length===1?[Ty(u[0],t)]:u}const i=e.fallback||e.placeholder;if(i)return Iy(i);const a=r.fallback||r.placeholder||"",o=r.fallbackTag||r.placeholderTag||"span";return L(o,t,a)}}}),Rt=Cp("game",()=>{const r=Le("init"),e=Le(0),t=Le(null),n=Le(!1),s=Le(!1),i=Le({rounds:[]}),a=de(()=>t.value!==null),o=de(()=>r.value==="night"),u=de(()=>r.value==="day"),c=de(()=>r.value==="vote");function l(m){r.value=m}function d(){e.value++;const m={roundNumber:e.value,nightEvents:{wolfDiscussion:[],killDecision:{},seerActions:[],witchNotification:{},witchAction:{}},dayAnnouncement:{},speeches:[],voteResults:[]};i.value.rounds.push(m)}function f(){return i.value.rounds[i.value.rounds.length-1]}function h(m){t.value=m,r.value="ended"}function p(){r.value="init",e.value=0,t.value=null,n.value=!1,s.value=!1,i.value={rounds:[]}}return{phase:r,round:e,winner:t,isAiThinking:n,isPlayerDead:s,gameLog:i,isGameOver:a,isNight:o,isDay:u,isVote:c,setPhase:l,nextRound:d,getCurrentRound:f,setWinner:h,resetGame:p}}),qy={class:"flex items-center gap-3 px-4 py-3 bg-card/50 rounded-xl border border-border/50"},Hy={class:"text-sm text-muted-foreground"},Vy={key:0,class:"ml-auto flex items-center gap-2 text-sm text-muted-foreground"},Wy=Pe({__name:"PhaseIndicator",setup(r){const e=Rt(),t=de(()=>{const n={init:{label:"å‡†å¤‡ä¸­",icon:"lucide:loader",color:"text-muted-foreground"},night:{label:"å¤œæ™šé˜¶æ®µ",icon:"lucide:moon",color:"text-blue-400"},day:{label:"ç™½å¤©å‘è¨€",icon:"lucide:sun",color:"text-yellow-400"},vote:{label:"æŠ•ç¥¨é˜¶æ®µ",icon:"lucide:vote",color:"text-orange-400"},resolution:{label:"ç»“ç®—ä¸­",icon:"lucide:scale",color:"text-purple-400"},ended:{label:"æ¸¸æˆç»“æŸ",icon:"lucide:trophy",color:"text-primary"}};return n[e.phase]||n.init});return(n,s)=>{const i=lr,a=Py;return I(),L("div",qy,[q(i,{name:P(t).icon,class:Ve(["size-5",P(t).color])},null,8,["name","class"]),N("span",{class:Ve(["font-semibold",P(t).color])},ne(P(t).label),3),q(a,{orientation:"vertical",class:"h-4"}),N("span",Hy," ç¬¬ "+ne(P(e).round)+" è½® ",1),P(e).isAiThinking?(I(),L("div",Vy,[q(i,{name:"lucide:loader",class:"size-4 animate-spin"}),s[0]||(s[0]=ie(" AI æ€è€ƒä¸­... ",-1))])):se("",!0)])}}}),Zy=Object.assign(Wy,{__name:"PhaseIndicator"});function _d(r){const e=r.filter(n=>n.role==="werewolf"&&n.isAlive),t=r.filter(n=>n.faction==="villager"&&n.isAlive);return e.length===0?"villager":e.length>=t.length?"werewolf":null}function Qc(r){return{werewolf:"ç‹¼äºº",seer:"é¢„è¨€å®¶",witch:"å¥³å·«",hunter:"çŒŽäºº",villager:"æ‘æ°‘"}[r]}function Jy(r){return r==="werewolf"?"ç‹¼äººé˜µè¥":"å¥½äººé˜µè¥"}function Ky(r){if(r.length===0)throw new Error("No wolf targets provided");const e=new Map;for(const s of r)e.set(s,(e.get(s)||0)+1);let t=0,n=r[0];for(const[s,i]of e)i>t&&(t=i,n=s);return n}function Xy(r){const e=new Map;for(const s of Object.values(r))e.set(s,(e.get(s)||0)+1);let t=0,n=[];for(const[s,i]of e)i>t?(t=i,n=[s]):i===t&&n.push(s);return n.length>1?n[Math.floor(Math.random()*n.length)]:n[0]??null}const Yy=["disabled"],Qy={key:0,class:"absolute -top-1.5 -right-1.5 text-xs bg-primary text-primary-foreground rounded-full px-1.5 py-0.5 font-medium"},e_={class:"text-xs font-medium truncate w-full text-center"},t_={key:2,class:"text-[10px] text-destructive font-medium"},n_=Pe({__name:"PlayerCard",props:{player:{},selectable:{type:Boolean},selected:{type:Boolean},showRole:{type:Boolean}},emits:["select"],setup(r,{emit:e}){const t=r,n=e,s=de(()=>({werewolf:"ðŸº",seer:"ðŸ”®",witch:"ðŸ§ª",hunter:"ðŸŽ¯",villager:"ðŸ§‘â€ðŸŒ¾"})[t.player.role]||"â“"),i=["bg-blue-900","bg-green-900","bg-purple-900","bg-amber-900","bg-rose-900","bg-cyan-900"],a=de(()=>i[t.player.seatIndex%i.length]);return(o,u)=>{const c=ti;return I(),L("button",{class:Ve(["relative flex flex-col items-center gap-1.5 p-3 rounded-xl border transition-all duration-200",[r.player.isAlive?"border-border hover:border-primary/50":"border-border/30 opacity-40",r.selectable&&r.player.isAlive?"cursor-pointer hover:bg-secondary":"cursor-default",r.selected?"ring-2 ring-primary border-primary bg-primary/10":"bg-card/50"]]),disabled:!r.selectable||!r.player.isAlive,onClick:u[0]||(u[0]=l=>r.selectable&&r.player.isAlive&&n("select",r.player.id))},[r.player.isHuman?(I(),L("div",Qy," ä½  ")):se("",!0),N("div",{class:Ve(["size-12 rounded-full flex items-center justify-center text-xl",[P(a),r.player.isAlive?"":"grayscale"]])},ne(r.player.isAlive?P(s):"ðŸ’€"),3),N("span",e_,ne(r.player.name),1),r.showRole||r.player.isHuman?(I(),_e(c,{key:1,variant:r.player.faction==="werewolf"?"destructive":"secondary",class:"text-[10px] px-1.5"},{default:H(()=>[ie(ne(P(Qc)(r.player.role)),1)]),_:1},8,["variant"])):se("",!0),r.player.isAlive?se("",!0):(I(),L("span",t_," å·²å‡ºå±€ "))],10,Yy)}}}),r_=Object.assign(n_,{__name:"PlayerCard"}),s_={class:"flex items-center gap-4 px-4 py-3 rounded-lg bg-red-950/60 border border-red-500/30"},i_={class:"flex gap-2 shrink-0"},a_=Pe({__name:"PlayerDeathPanel",emits:["continue","restart"],setup(r,{emit:e}){const t=e;return(n,s)=>(I(),L("div",s_,[s[2]||(s[2]=N("span",{class:"text-xl shrink-0"},"ðŸ’€",-1)),s[3]||(s[3]=N("div",{class:"flex-1 min-w-0"},[N("p",{class:"text-sm font-medium text-red-300"}," ä½ å·²æ­»äº¡ï¼Œæ¸¸æˆæš‚åœ "),N("p",{class:"text-xs text-red-300/60"}," è¯·é€‰æ‹©ç»§ç»­è§‚æˆ˜æˆ–é‡æ–°å¼€å§‹ ")],-1)),N("div",i_,[N("button",{class:"px-3 py-1.5 rounded-md bg-secondary hover:bg-secondary/80 text-xs font-medium transition-colors",onClick:s[0]||(s[0]=i=>t("continue"))}," ðŸ‘ï¸ è§‚æˆ˜ "),N("button",{class:"px-3 py-1.5 rounded-md bg-red-700 hover:bg-red-600 text-xs font-medium text-white transition-colors",onClick:s[1]||(s[1]=i=>t("restart"))}," ðŸ”„ é‡å¼€ ")])]))}}),o_=Object.assign(a_,{__name:"PlayerDeathPanel"}),u_={class:"flex justify-center py-2"},c_={class:"bg-secondary/60 text-muted-foreground text-xs px-4 py-1.5 rounded-full"},l_=Pe({__name:"SystemMessage",props:{content:{}},setup(r){return(e,t)=>(I(),L("div",u_,[N("div",c_,ne(r.content),1)]))}}),d_=Object.assign(l_,{__name:"SystemMessage"}),f_={key:0,class:"flex gap-2.5 py-1.5 opacity-75"},h_={class:"shrink-0 size-6 rounded-full bg-muted/50 flex items-center justify-center text-[10px] font-medium text-muted-foreground border border-border/30"},p_={class:"flex-1 min-w-0"},m_={class:"flex items-center gap-1.5 mb-0.5"},g_={class:"text-xs text-muted-foreground"},y_={class:"text-xs text-muted-foreground/80 italic leading-relaxed whitespace-pre-wrap border-l-2 border-border/40 pl-2"},__={key:1,class:"flex gap-2.5 py-1.5"},b_={class:"flex-1 min-w-0"},w_={class:"flex items-center gap-1.5 mb-0.5"},v_={class:"text-xs font-medium text-amber-300/80"},S_={class:"text-xs text-amber-100/90 font-medium leading-relaxed whitespace-pre-wrap"},E_={key:2,class:"flex gap-3 py-2"},x_={class:"shrink-0 size-8 rounded-full bg-secondary flex items-center justify-center text-xs font-medium"},O_={class:"flex-1 min-w-0"},k_={class:"flex items-center gap-2 mb-0.5"},P_={class:"text-sm text-foreground/90 leading-relaxed whitespace-pre-wrap"},A_={key:0,class:"inline-block w-1.5 h-4 bg-primary/70 animate-pulse ml-0.5 align-middle"},T_=Pe({__name:"ChatBubble",props:{message:{}},setup(r){const e=r,t=cn(),n=de(()=>e.message.senderId==="system"?"ç³»ç»Ÿ":t.getPlayerById(e.message.senderId)?.name||e.message.senderId),s=de(()=>e.message.senderId==="system"?!1:t.getPlayerById(e.message.senderId)?.isHuman||!1),i=de(()=>e.message.type==="reasoning"),a=de(()=>e.message.type==="action");return(o,u)=>{const c=ti;return P(i)?(I(),L("div",f_,[N("div",h_,ne(P(n).slice(0,1)),1),N("div",p_,[N("div",m_,[N("span",g_,ne(P(n)),1),u[0]||(u[0]=N("span",{class:"text-[10px] text-muted-foreground/60 italic"},"æŽ¨ç†ä¸­",-1))]),N("p",y_,ne(r.message.content),1)])])):P(a)?(I(),L("div",__,[u[1]||(u[1]=N("div",{class:"shrink-0 size-6 rounded-full bg-amber-900/40 flex items-center justify-center text-[10px] font-medium text-amber-300"}," âš¡ ",-1)),N("div",b_,[N("div",w_,[N("span",v_,ne(P(n)),1)]),N("p",S_,ne(r.message.content),1)])])):(I(),L("div",E_,[N("div",x_,ne(P(n).slice(0,1)),1),N("div",O_,[N("div",k_,[N("span",{class:Ve(["text-sm font-medium",P(s)?"text-primary":"text-foreground"])},ne(P(n)),3),P(s)?(I(),_e(c,{key:0,variant:"outline",class:"text-[10px] px-1"},{default:H(()=>[...u[2]||(u[2]=[ie(" ä½  ",-1)])]),_:1})):se("",!0)]),N("p",P_,[ie(ne(r.message.content)+" ",1),r.message.isStreaming?(I(),L("span",A_)):se("",!0)])])]))}}}),I_=Object.assign(T_,{__name:"ChatBubble"}),Ht=Cp("chat",()=>{const r=Le([]),e=Le(null);function t(c,l,d,f,h){const p={id:crypto.randomUUID(),type:c,senderId:l,content:d,phase:f,round:h,timestamp:Date.now()};return r.value.push(p),p}function n(c,l,d){return t("system","system",c,l,d)}function s(c,l,d,f){const h={id:c,type:"speak",senderId:l,content:"",phase:d,round:f,timestamp:Date.now(),isStreaming:!0};r.value.push(h),e.value=c}function i(c,l){const d=r.value.find(f=>f.id===c);d&&(d.content+=l)}function a(c){const l=r.value.find(d=>d.id===c);l&&(l.isStreaming=!1),e.value===c&&(e.value=null)}function o(c){return r.value.filter(l=>l.round===c)}function u(){r.value=[],e.value=null}return{messages:r,streamingMessageId:e,addMessage:t,addSystemMessage:n,beginStreamMessage:s,appendStreamChunk:i,finalizeStreamMessage:a,getMessagesByRound:o,resetMessages:u}}),R_={class:"flex flex-col h-full bg-card/30 rounded-xl border border-border/50"},C_={class:"px-4 py-3 border-b border-border/50"},$_={class:"text-sm font-semibold flex items-center gap-2"},N_={key:0,class:"flex items-center justify-center h-full text-sm text-muted-foreground"},j_={key:0,class:"px-4 py-3 border-t border-border/50"},L_=Pe({__name:"ChatPanel",setup(r){const e=Ht(),t=Le();return Ny(()=>e.messages.length,async()=>{await jy(),t.value&&(t.value.scrollTop=t.value.scrollHeight)}),(n,s)=>{const i=lr,a=d_,o=I_;return I(),L("div",R_,[N("div",C_,[N("h3",$_,[q(i,{name:"lucide:message-square",class:"size-4"}),s[0]||(s[0]=ie(" æ¸¸æˆåŽ†å²è®°å½• ",-1))])]),N("div",{ref_key:"scrollContainer",ref:t,class:"flex-1 overflow-y-auto px-4 py-2 space-y-0.5"},[(I(!0),L(ct,null,_t(P(e).messages,u=>(I(),L(ct,{key:u.id},[u.type==="system"?(I(),_e(a,{key:0,content:u.content},null,8,["content"])):(I(),_e(o,{key:1,message:u},null,8,["message"]))],64))),128)),P(e).messages.length===0?(I(),L("div",N_," æ¸¸æˆå°šæœªå¼€å§‹... ")):se("",!0)],512),n.$slots.footer?(I(),L("div",j_,[ni(n.$slots,"footer")])):se("",!0)])}}}),M_=Object.assign(L_,{__name:"ChatPanel"}),Fa=Pe({__name:"CardDescription",props:{class:{}},setup(r){const e=r;return(t,n)=>(I(),L("p",{class:Ve(P(Da)("text-sm text-muted-foreground",e.class))},[ni(t.$slots,"default")],2))}}),Wr=Pe({__name:"CardFooter",props:{class:{}},setup(r){const e=r;return(t,n)=>(I(),L("div",{class:Ve(P(Da)("flex items-center p-6 pt-0",e.class))},[ni(t.$slots,"default")],2))}}),Zr=Pe({__name:"CardHeader",props:{class:{}},setup(r){const e=r;return(t,n)=>(I(),L("div",{class:Ve(P(Da)("flex flex-col gap-y-1.5 p-6",e.class))},[ni(t.$slots,"default")],2))}}),Jr=Pe({__name:"CardTitle",props:{class:{}},setup(r){const e=r;return(t,n)=>(I(),L("h3",{class:Ve(P(Da)("text-2xl font-semibold leading-none tracking-tight",e.class))},[ni(t.$slots,"default")],2))}}),D_={class:"grid grid-cols-2 gap-2"},U_=["onClick"],F_=Pe({__name:"WolfPanel",emits:["submit"],setup(r,{emit:e}){const t=e,n=cn(),s=Le(null),i=de(()=>n.alivePlayers.filter(u=>u.role!=="werewolf")),a=de(()=>n.players.filter(u=>u.role==="werewolf"&&!u.isHuman));function o(){s.value&&t("submit",{type:"kill",targetId:s.value})}return(u,c)=>{const l=Jr,d=Fa,f=Zr,h=Vr,p=dr,m=Wr,g=Hr;return I(),_e(g,{class:"w-full max-w-md bg-card border-destructive/30"},{default:H(()=>[q(f,null,{default:H(()=>[q(l,{class:"flex items-center gap-2 text-destructive"},{default:H(()=>[...c[0]||(c[0]=[N("span",{class:"text-2xl"},"ðŸº",-1),ie(" ç‹¼äººè¡ŒåŠ¨ ",-1)])]),_:1}),P(a).length?(I(),_e(d,{key:0},{default:H(()=>[ie(" ä½ çš„é˜Ÿå‹ï¼š"+ne(P(a).map(y=>y.name).join("ã€")),1)]),_:1})):se("",!0)]),_:1}),q(h,{class:"space-y-3"},{default:H(()=>[c[1]||(c[1]=N("p",{class:"text-sm text-muted-foreground"}," é€‰æ‹©ä»Šæ™šè¦å‡»æ€çš„ç›®æ ‡ï¼š ",-1)),N("div",D_,[(I(!0),L(ct,null,_t(P(i),y=>(I(),L("button",{key:y.id,class:Ve(["px-3 py-2 rounded-lg border text-sm text-left transition-all",P(s)===y.id?"bg-destructive/20 border-destructive text-destructive":"bg-secondary border-border hover:border-destructive/50"]),onClick:_=>s.value=y.id},ne(y.name),11,U_))),128))])]),_:1}),q(m,null,{default:H(()=>[q(p,{variant:"destructive",class:"w-full",disabled:!P(s),onClick:o},{default:H(()=>[...c[2]||(c[2]=[ie(" ç¡®è®¤å‡»æ€ ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})}}}),B_=Object.assign(F_,{__name:"WolfPanel"}),z_={key:0,class:"space-y-1"},G_={class:"grid grid-cols-2 gap-2"},q_=["onClick"],H_={key:1,class:"p-3 rounded-lg bg-secondary text-center"},V_={class:"text-sm"},W_=Pe({__name:"SeerPanel",emits:["submit"],setup(r,{emit:e}){const t=e,n=cn(),s=Le(null),i=Le(null),a=de(()=>n.alivePlayers.filter(d=>!d.isHuman)),o=de(()=>n.humanPlayer),u=de(()=>o.value?.memory.seerResults||[]);function c(){if(!s.value)return;const d=n.getPlayerById(s.value);d&&(i.value={name:d.name,faction:d.faction==="werewolf"?"ç‹¼äºº":"å¥½äºº"})}function l(){s.value&&t("submit",{type:"inspect",targetId:s.value})}return(d,f)=>{const h=Jr,p=Zr,m=Vr,g=dr,y=Wr,_=Hr;return I(),_e(_,{class:"w-full max-w-md bg-card border-blue-500/30"},{default:H(()=>[q(p,null,{default:H(()=>[q(h,{class:"flex items-center gap-2 text-blue-400"},{default:H(()=>[...f[0]||(f[0]=[N("span",{class:"text-2xl"},"ðŸ”®",-1),ie(" é¢„è¨€å®¶æŸ¥éªŒ ",-1)])]),_:1})]),_:1}),q(m,{class:"space-y-4"},{default:H(()=>[P(u).length?(I(),L("div",z_,[f[1]||(f[1]=N("p",{class:"text-xs text-muted-foreground"}," åŽ†å²æŸ¥éªŒè®°å½•ï¼š ",-1)),(I(!0),L(ct,null,_t(P(u),b=>(I(),L("div",{key:b.targetId,class:"text-xs"},[ie(ne(P(n).getPlayerById(b.targetId)?.name)+" â†’ ",1),N("span",{class:Ve(b.faction==="werewolf"?"text-destructive":"text-green-400")},ne(b.faction==="werewolf"?"ç‹¼äºº":"å¥½äºº"),3)]))),128))])):se("",!0),f[2]||(f[2]=N("p",{class:"text-sm text-muted-foreground"}," é€‰æ‹©è¦æŸ¥éªŒèº«ä»½çš„çŽ©å®¶ï¼š ",-1)),N("div",G_,[(I(!0),L(ct,null,_t(P(a),b=>(I(),L("button",{key:b.id,class:Ve(["px-3 py-2 rounded-lg border text-sm text-left transition-all",P(s)===b.id?"bg-blue-500/20 border-blue-500 text-blue-400":"bg-secondary border-border hover:border-blue-500/50"]),onClick:v=>s.value=b.id},ne(b.name),11,q_))),128))]),P(i)?(I(),L("div",H_,[N("p",V_,[ie(ne(P(i).name)+" çš„èº«ä»½æ˜¯ ",1),N("span",{class:Ve(["font-bold",P(i).faction==="ç‹¼äºº"?"text-destructive":"text-green-400"])},ne(P(i).faction),3)])])):se("",!0)]),_:1}),q(y,{class:"gap-2"},{default:H(()=>[P(i)?se("",!0):(I(),_e(g,{key:0,variant:"outline",class:"flex-1",disabled:!P(s),onClick:c},{default:H(()=>[...f[3]||(f[3]=[ie(" æŸ¥éªŒ ",-1)])]),_:1},8,["disabled"])),P(i)?(I(),_e(g,{key:1,class:"flex-1",onClick:l},{default:H(()=>[...f[4]||(f[4]=[ie(" ç¡®è®¤ï¼Œå¤©äº®äº† ",-1)])]),_:1})):se("",!0)]),_:1})]),_:1})}}}),Z_=Object.assign(W_,{__name:"SeerPanel"}),J_={key:0,class:"p-3 rounded-lg bg-destructive/10 border border-destructive/20"},K_={class:"text-sm"},X_={class:"text-destructive"},Y_={class:"flex gap-4 text-sm"},Q_={class:"flex items-center gap-1.5"},eb={class:"flex items-center gap-1.5"},tb={key:1,class:"space-y-2"},nb={class:"grid grid-cols-2 gap-2"},rb=["onClick"],sb={class:"flex gap-2 w-full"},ib=Pe({__name:"WitchPanel",props:{killedPlayerId:{}},emits:["submit"],setup(r,{emit:e}){const t=r,n=e,s=cn(),i=de(()=>s.humanPlayer),a=de(()=>i.value?.memory.witchPotions),o=Le(null),u=de(()=>t.killedPlayerId?s.getPlayerById(t.killedPlayerId):null),c=de(()=>s.alivePlayers.filter(h=>!h.isHuman&&h.id!==t.killedPlayerId));function l(){n("submit",{type:"witch",action:"save"})}function d(){o.value&&n("submit",{type:"witch",action:"poison",targetId:o.value})}function f(){n("submit",{type:"witch",action:"skip"})}return(h,p)=>{const m=Jr,g=Zr,y=ti,_=Vr,b=dr,v=Wr,w=Hr;return I(),_e(w,{class:"w-full max-w-md bg-card border-green-500/30"},{default:H(()=>[q(g,null,{default:H(()=>[q(m,{class:"flex items-center gap-2 text-green-400"},{default:H(()=>[...p[0]||(p[0]=[N("span",{class:"text-2xl"},"ðŸ§ª",-1),ie(" å¥³å·«è¡ŒåŠ¨ ",-1)])]),_:1})]),_:1}),q(_,{class:"space-y-4"},{default:H(()=>[P(u)?(I(),L("div",J_,[N("p",K_,[p[1]||(p[1]=ie(" ä»Šæ™š ",-1)),N("strong",X_,ne(P(u).name),1),p[2]||(p[2]=ie(" è¢«ç‹¼äººæ€å®³äº†ã€‚ ",-1))])])):se("",!0),N("div",Y_,[N("div",Q_,[p[3]||(p[3]=N("span",null,"ðŸ’š è§£è¯",-1)),q(y,{variant:P(a)?.antidote?"default":"secondary"},{default:H(()=>[ie(ne(P(a)?.antidote?"å¯ç”¨":"å·²ç”¨"),1)]),_:1},8,["variant"])]),N("div",eb,[p[4]||(p[4]=N("span",null,"ðŸ’€ æ¯’è¯",-1)),q(y,{variant:P(a)?.poison?"default":"secondary"},{default:H(()=>[ie(ne(P(a)?.poison?"å¯ç”¨":"å·²ç”¨"),1)]),_:1},8,["variant"])])]),P(a)?.poison?(I(),L("div",tb,[p[5]||(p[5]=N("p",{class:"text-xs text-muted-foreground"}," è‹¥è¦ä½¿ç”¨æ¯’è¯ï¼Œé€‰æ‹©ç›®æ ‡ï¼š ",-1)),N("div",nb,[(I(!0),L(ct,null,_t(P(c),E=>(I(),L("button",{key:E.id,class:Ve(["px-3 py-2 rounded-lg border text-sm text-left transition-all",P(o)===E.id?"bg-purple-500/20 border-purple-500 text-purple-400":"bg-secondary border-border hover:border-purple-500/50"]),onClick:T=>o.value=E.id},ne(E.name),11,rb))),128))])])):se("",!0)]),_:1}),q(v,{class:"flex-col gap-2"},{default:H(()=>[N("div",sb,[P(a)?.antidote&&P(u)?(I(),_e(b,{key:0,variant:"outline",class:"flex-1 border-green-500/50 text-green-400 hover:bg-green-500/10",onClick:l},{default:H(()=>[...p[6]||(p[6]=[ie(" ðŸ’š ä½¿ç”¨è§£è¯ ",-1)])]),_:1})):se("",!0),P(a)?.poison?(I(),_e(b,{key:1,variant:"outline",class:"flex-1 border-purple-500/50 text-purple-400 hover:bg-purple-500/10",disabled:!P(o),onClick:d},{default:H(()=>[...p[7]||(p[7]=[ie(" ðŸ’€ ä½¿ç”¨æ¯’è¯ ",-1)])]),_:1},8,["disabled"])):se("",!0)]),q(b,{variant:"secondary",class:"w-full",onClick:f},{default:H(()=>[...p[8]||(p[8]=[ie(" ä¸ä½¿ç”¨è¯ç‰© ",-1)])]),_:1})]),_:1})]),_:1})}}}),ab=Object.assign(ib,{__name:"WitchPanel"}),ob={class:"grid grid-cols-2 gap-2"},ub=["onClick"],cb=Pe({__name:"HunterPanel",emits:["submit"],setup(r,{emit:e}){const t=e,n=cn(),s=Le(null),i=de(()=>n.alivePlayers.filter(o=>!o.isHuman));function a(){s.value&&t("submit",{type:"hunter_shot",targetId:s.value})}return(o,u)=>{const c=Jr,l=Fa,d=Zr,f=Vr,h=dr,p=Wr,m=Hr;return I(),_e(m,{class:"w-full max-w-md bg-card border-amber-500/30"},{default:H(()=>[q(d,null,{default:H(()=>[q(c,{class:"flex items-center gap-2 text-amber-400"},{default:H(()=>[...u[0]||(u[0]=[N("span",{class:"text-2xl"},"ðŸŽ¯",-1),ie(" çŒŽäººå¼€æžª ",-1)])]),_:1}),q(l,null,{default:H(()=>[...u[1]||(u[1]=[ie(" ä½ å·²é˜µäº¡ï¼é€‰æ‹©ä¸€åçŽ©å®¶å¸¦èµ°ã€‚ ",-1)])]),_:1})]),_:1}),q(f,{class:"space-y-3"},{default:H(()=>[N("div",ob,[(I(!0),L(ct,null,_t(P(i),g=>(I(),L("button",{key:g.id,class:Ve(["px-3 py-2 rounded-lg border text-sm text-left transition-all",P(s)===g.id?"bg-amber-500/20 border-amber-500 text-amber-400":"bg-secondary border-border hover:border-amber-500/50"]),onClick:y=>s.value=g.id},ne(g.name),11,ub))),128))])]),_:1}),q(p,null,{default:H(()=>[q(h,{class:"w-full bg-amber-600 hover:bg-amber-700",disabled:!P(s),onClick:a},{default:H(()=>[...u[2]||(u[2]=[ie(" å¼€æžªï¼ ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})}}}),$p=Object.assign(cb,{__name:"HunterPanel"}),lb=Pe({__name:"NightActionPanel",props:{interrupt:{},nightKillTarget:{}},emits:["submit"],setup(r,{emit:e}){const t=e;function n(s){t("submit",s)}return(s,i)=>{const a=B_,o=Z_,u=ab,c=$p;return r.interrupt?.type==="wolf_kill"?(I(),_e(a,{key:0,onSubmit:n})):r.interrupt?.type==="seer_inspect"?(I(),_e(o,{key:1,onSubmit:n})):r.interrupt?.type==="witch_action"?(I(),_e(u,{key:2,"killed-player-id":r.nightKillTarget,onSubmit:n},null,8,["killed-player-id"])):r.interrupt?.type==="hunter_shot"?(I(),_e(c,{key:3,onSubmit:n})):se("",!0)}}}),db=Object.assign(lb,{__name:"NightActionPanel"}),fb={class:"flex gap-2 p-3 bg-card/50 rounded-xl border border-border/50"},hb=Pe({__name:"PlayerInput",emits:["submit"],setup(r,{emit:e}){const t=e,n=Le("");function s(){const i=n.value.trim();i&&(t("submit",i),n.value="")}return(i,a)=>{const o=Ay,u=lr,c=dr;return I(),L("div",fb,[q(o,{modelValue:P(n),"onUpdate:modelValue":a[0]||(a[0]=l=>Dy(n)?n.value=l:null),placeholder:"è¾“å…¥ä½ çš„å‘è¨€...",class:"flex-1 bg-secondary border-border",onKeydown:Ly(My(s,["prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),q(c,{size:"default",disabled:!P(n).trim(),onClick:s},{default:H(()=>[q(u,{name:"lucide:send",class:"size-4"})]),_:1},8,["disabled"])])}}}),pb=Object.assign(hb,{__name:"PlayerInput"}),mb={class:"grid grid-cols-2 sm:grid-cols-3 gap-2"},gb=["onClick"],yb=Pe({__name:"VotePanel",emits:["submit"],setup(r,{emit:e}){const t=e,n=cn(),s=Le(null),i=de(()=>n.alivePlayers.filter(o=>!o.isHuman));function a(){s.value&&t("submit",s.value)}return(o,u)=>{const c=lr,l=Jr,d=Fa,f=Zr,h=Vr,p=dr,m=Wr,g=Hr;return I(),_e(g,{class:"bg-card border-orange-500/30"},{default:H(()=>[q(f,null,{default:H(()=>[q(l,{class:"flex items-center gap-2 text-orange-400 text-base"},{default:H(()=>[q(c,{name:"lucide:vote",class:"size-5"}),u[0]||(u[0]=ie(" æŠ•ç¥¨æ”¾é€ ",-1))]),_:1}),q(d,null,{default:H(()=>[...u[1]||(u[1]=[ie(" é€‰æ‹©ä½ è®¤ä¸ºæœ€å¯ç–‘çš„çŽ©å®¶è¿›è¡ŒæŠ•ç¥¨ ",-1)])]),_:1})]),_:1}),q(h,null,{default:H(()=>[N("div",mb,[(I(!0),L(ct,null,_t(P(i),y=>(I(),L("button",{key:y.id,class:Ve(["px-3 py-2 rounded-lg border text-sm text-left transition-all",P(s)===y.id?"bg-orange-500/20 border-orange-500 text-orange-400":"bg-secondary border-border hover:border-orange-500/50"]),onClick:_=>s.value=y.id},ne(y.name),11,gb))),128))])]),_:1}),q(m,null,{default:H(()=>[q(p,{class:"w-full bg-orange-600 hover:bg-orange-700",disabled:!P(s),onClick:a},{default:H(()=>[...u[2]||(u[2]=[ie(" ç¡®è®¤æŠ•ç¥¨ ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})}}}),_b=Object.assign(yb,{__name:"VotePanel"}),bb={class:"fixed inset-0 bg-background/90 backdrop-blur-md z-50 flex items-center justify-center p-4"},wb={class:"text-6xl mb-2"},vb={class:"grid grid-cols-2 gap-2"},Sb={class:"text-sm truncate"},Eb={key:0,class:"text-xs text-primary ml-auto"},xb={key:1,class:"text-xs text-destructive ml-auto"},Ob=Pe({__name:"WinScreen",props:{winner:{}},emits:["restart"],setup(r,{emit:e}){const t=e,n=cn(),s=Rt();return(i,a)=>{const o=Jr,u=Fa,c=Zr,l=ti,d=Vr,f=lr,h=dr,p=Wr,m=Hr;return I(),L("div",bb,[q(m,{class:"w-full max-w-lg bg-card border-primary/30"},{default:H(()=>[q(c,{class:"text-center"},{default:H(()=>[N("div",wb,ne(r.winner==="werewolf"?"ðŸº":"ðŸŽ‰"),1),q(o,{class:"text-2xl"},{default:H(()=>[ie(ne(P(Jy)(r.winner))+"èƒœåˆ©ï¼ ",1)]),_:1}),q(u,null,{default:H(()=>[ie(" æ¸¸æˆå…±è¿›è¡Œäº† "+ne(P(s).round)+" è½® ",1)]),_:1})]),_:1}),q(d,{class:"space-y-4"},{default:H(()=>[a[1]||(a[1]=N("h4",{class:"text-sm font-semibold"}," å…¨å‘˜èº«ä»½æ­ç¤º ",-1)),N("div",vb,[(I(!0),L(ct,null,_t(P(n).players,g=>(I(),L("div",{key:g.id,class:"flex items-center gap-2 p-2 rounded-lg bg-secondary"},[q(l,{variant:g.faction==="werewolf"?"destructive":"secondary",class:"text-xs shrink-0"},{default:H(()=>[ie(ne(P(Qc)(g.role)),1)]),_:2},1032,["variant"]),N("span",Sb,ne(g.name),1),g.isHuman?(I(),L("span",Eb,"(ä½ )")):se("",!0),g.isAlive?se("",!0):(I(),L("span",xb,"ðŸ’€"))]))),128))])]),_:1}),q(p,null,{default:H(()=>[q(h,{class:"w-full",size:"lg",onClick:a[0]||(a[0]=g=>t("restart"))},{default:H(()=>[q(f,{name:"lucide:rotate-ccw",class:"size-4 mr-2"}),a[2]||(a[2]=ie(" å†æ¥ä¸€å±€ ",-1))]),_:1})]),_:1})]),_:1})])}}}),kb=Object.assign(Ob,{__name:"WinScreen"});let Ji=null,el=null;function Pb(){return el}function Ab(r){if(Ji){const e=Ji;Ji=null,el=null,e(r)}}function ys(r){return new Promise(e=>{el=r,Ji=e})}async function Tb(r){return await ys({type:"player_death",player:r,context:{}})}class Ib{constructor(e){this.player=e}async nightAction(e){const t=this.player.role;if(t==="villager"||t==="hunter")return{type:"none"};const s={werewolf:"wolf_kill",seer:"seer_inspect",witch:"witch_action"}[t];return s?await ys({type:s,player:this.player,context:{alivePlayers:e.alivePlayers,nightKillTarget:e.nightKillTarget,witchPotions:this.player.memory.witchPotions}}):{type:"none"}}async speak(e){return await ys({type:"speech",player:this.player,context:{}})}async vote(e){return await ys({type:"vote",player:this.player,context:{}})}async hunterShot(e){return await ys({type:"hunter_shot",player:this.player,context:{alivePlayers:e.alivePlayers}})}}var ue;(function(r){r.assertEqual=s=>{};function e(s){}r.assertIs=e;function t(s){throw new Error}r.assertNever=t,r.arrayToEnum=s=>{const i={};for(const a of s)i[a]=a;return i},r.getValidEnumValues=s=>{const i=r.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),a={};for(const o of i)a[o]=s[o];return r.objectValues(a)},r.objectValues=s=>r.objectKeys(s).map(function(i){return s[i]}),r.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const i=[];for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&i.push(a);return i},r.find=(s,i)=>{for(const a of s)if(i(a))return a},r.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function n(s,i=" | "){return s.map(a=>typeof a=="string"?`'${a}'`:a).join(i)}r.joinValues=n,r.jsonStringifyReplacer=(s,i)=>typeof i=="bigint"?i.toString():i})(ue||(ue={}));var bd;(function(r){r.mergeShapes=(e,t)=>({...e,...t})})(bd||(bd={}));const M=ue.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Pn=r=>{switch(typeof r){case"undefined":return M.undefined;case"string":return M.string;case"number":return Number.isNaN(r)?M.nan:M.number;case"boolean":return M.boolean;case"function":return M.function;case"bigint":return M.bigint;case"symbol":return M.symbol;case"object":return Array.isArray(r)?M.array:r===null?M.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?M.promise:typeof Map<"u"&&r instanceof Map?M.map:typeof Set<"u"&&r instanceof Set?M.set:typeof Date<"u"&&r instanceof Date?M.date:M.object;default:return M.unknown}},A=ue.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class _n extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(i){return i.message},n={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)n._errors.push(t(a));else{let o=n,u=0;for(;u<a.path.length;){const c=a.path[u];u===a.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(a))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return s(this),n}static assert(e){if(!(e instanceof _n))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ue.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},n=[];for(const s of this.issues)if(s.path.length>0){const i=s.path[0];t[i]=t[i]||[],t[i].push(e(s))}else n.push(e(s));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}_n.create=r=>new _n(r);const lc=(r,e)=>{let t;switch(r.code){case A.invalid_type:r.received===M.undefined?t="Required":t=`Expected ${r.expected}, received ${r.received}`;break;case A.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(r.expected,ue.jsonStringifyReplacer)}`;break;case A.unrecognized_keys:t=`Unrecognized key(s) in object: ${ue.joinValues(r.keys,", ")}`;break;case A.invalid_union:t="Invalid input";break;case A.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${ue.joinValues(r.options)}`;break;case A.invalid_enum_value:t=`Invalid enum value. Expected ${ue.joinValues(r.options)}, received '${r.received}'`;break;case A.invalid_arguments:t="Invalid function arguments";break;case A.invalid_return_type:t="Invalid function return type";break;case A.invalid_date:t="Invalid date";break;case A.invalid_string:typeof r.validation=="object"?"includes"in r.validation?(t=`Invalid input: must include "${r.validation.includes}"`,typeof r.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${r.validation.position}`)):"startsWith"in r.validation?t=`Invalid input: must start with "${r.validation.startsWith}"`:"endsWith"in r.validation?t=`Invalid input: must end with "${r.validation.endsWith}"`:ue.assertNever(r.validation):r.validation!=="regex"?t=`Invalid ${r.validation}`:t="Invalid";break;case A.too_small:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at least":"more than"} ${r.minimum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at least":"over"} ${r.minimum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="bigint"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(r.minimum))}`:t="Invalid input";break;case A.too_big:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at most":"less than"} ${r.maximum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at most":"under"} ${r.maximum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="bigint"?t=`BigInt must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly":r.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(r.maximum))}`:t="Invalid input";break;case A.custom:t="Invalid input";break;case A.invalid_intersection_types:t="Intersection results could not be merged";break;case A.not_multiple_of:t=`Number must be a multiple of ${r.multipleOf}`;break;case A.not_finite:t="Number must be finite";break;default:t=e.defaultError,ue.assertNever(r)}return{message:t}};let Rb=lc;function Cb(){return Rb}const $b=r=>{const{data:e,path:t,errorMaps:n,issueData:s}=r,i=[...t,...s.path||[]],a={...s,path:i};if(s.message!==void 0)return{...s,path:i,message:s.message};let o="";const u=n.filter(c=>!!c).slice().reverse();for(const c of u)o=c(a,{data:e,defaultError:o}).message;return{...s,path:i,message:o}};function j(r,e){const t=Cb(),n=$b({issueData:e,data:r.data,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,t,t===lc?void 0:lc].filter(s=>!!s)});r.common.issues.push(n)}class Et{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const s of t){if(s.status==="aborted")return Q;s.status==="dirty"&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const s of t){const i=await s.key,a=await s.value;n.push({key:i,value:a})}return Et.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const s of t){const{key:i,value:a}=s;if(i.status==="aborted"||a.status==="aborted")return Q;i.status==="dirty"&&e.dirty(),a.status==="dirty"&&e.dirty(),i.value!=="__proto__"&&(typeof a.value<"u"||s.alwaysSet)&&(n[i.value]=a.value)}return{status:e.value,value:n}}}const Q=Object.freeze({status:"aborted"}),_s=r=>({status:"dirty",value:r}),Lt=r=>({status:"valid",value:r}),wd=r=>r.status==="aborted",vd=r=>r.status==="dirty",Mr=r=>r.status==="valid",la=r=>typeof Promise<"u"&&r instanceof Promise;var D;(function(r){r.errToObj=e=>typeof e=="string"?{message:e}:e||{},r.toString=e=>typeof e=="string"?e:e?.message})(D||(D={}));class Bn{constructor(e,t,n,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Sd=(r,e)=>{if(Mr(e))return{success:!0,data:e.value};if(!r.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new _n(r.common.issues);return this._error=t,this._error}}};function re(r){if(!r)return{};const{errorMap:e,invalid_type_error:t,required_error:n,description:s}=r;if(e&&(t||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(a,o)=>{const{message:u}=r;return a.code==="invalid_enum_value"?{message:u??o.defaultError}:typeof o.data>"u"?{message:u??n??o.defaultError}:a.code!=="invalid_type"?{message:o.defaultError}:{message:u??t??o.defaultError}},description:s}}class ae{get description(){return this._def.description}_getType(e){return Pn(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Pn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Et,ctx:{common:e.parent.common,data:e.data,parsedType:Pn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(la(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Pn(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Sd(n,s)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Pn(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return Mr(n)?{value:n.value}:{issues:t.common.issues}}catch(n){n?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(n=>Mr(n)?{value:n.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Pn(e)},s=this._parse({data:e,path:n.path,parent:n}),i=await(la(s)?s:Promise.resolve(s));return Sd(n,i)}refine(e,t){const n=s=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(s):t;return this._refinement((s,i)=>{const a=e(s),o=()=>i.addIssue({code:A.custom,...n(s)});return typeof Promise<"u"&&a instanceof Promise?a.then(u=>u?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(e,t){return this._refinement((n,s)=>e(n)?!0:(s.addIssue(typeof t=="function"?t(n,s):t),!1))}_refinement(e){return new Ur({schema:this,typeName:S.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return jn.create(this,this._def)}nullable(){return Fr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return on.create(this)}promise(){return ma.create(this,this._def)}or(e){return ha.create([this,e],this._def)}and(e){return pa.create(this,e,this._def)}transform(e){return new Ur({...re(this._def),schema:this,typeName:S.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new fc({...re(this._def),innerType:this,defaultValue:t,typeName:S.ZodDefault})}brand(){return new nw({typeName:S.ZodBranded,type:this,...re(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new hc({...re(this._def),innerType:this,catchValue:t,typeName:S.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return tl.create(this,e)}readonly(){return pc.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Nb=/^c[^\s-]{8,}$/i,jb=/^[0-9a-z]+$/,Lb=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Mb=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Db=/^[a-z0-9_-]{21}$/i,Ub=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Fb=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Bb=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,zb="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let So;const Gb=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,qb=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Hb=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Vb=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Wb=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Zb=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Np="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Jb=new RegExp(`^${Np}$`);function jp(r){let e="[0-5]\\d";r.precision?e=`${e}\\.\\d{${r.precision}}`:r.precision==null&&(e=`${e}(\\.\\d+)?`);const t=r.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function Kb(r){return new RegExp(`^${jp(r)}$`)}function Xb(r){let e=`${Np}T${jp(r)}`;const t=[];return t.push(r.local?"Z?":"Z"),r.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Yb(r,e){return!!((e==="v4"||!e)&&Gb.test(r)||(e==="v6"||!e)&&Hb.test(r))}function Qb(r,e){if(!Ub.test(r))return!1;try{const[t]=r.split(".");if(!t)return!1;const n=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),s=JSON.parse(atob(n));return!(typeof s!="object"||s===null||"typ"in s&&s?.typ!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function ew(r,e){return!!((e==="v4"||!e)&&qb.test(r)||(e==="v6"||!e)&&Vb.test(r))}class Cn extends ae{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==M.string){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_type,expected:M.string,received:i.parsedType}),Q}const n=new Et;let s;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(s=this._getOrReturnCtx(e,s),j(s,{code:A.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="max")e.data.length>i.value&&(s=this._getOrReturnCtx(e,s),j(s,{code:A.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="length"){const a=e.data.length>i.value,o=e.data.length<i.value;(a||o)&&(s=this._getOrReturnCtx(e,s),a?j(s,{code:A.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&j(s,{code:A.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),n.dirty())}else if(i.kind==="email")Bb.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"email",code:A.invalid_string,message:i.message}),n.dirty());else if(i.kind==="emoji")So||(So=new RegExp(zb,"u")),So.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"emoji",code:A.invalid_string,message:i.message}),n.dirty());else if(i.kind==="uuid")Mb.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"uuid",code:A.invalid_string,message:i.message}),n.dirty());else if(i.kind==="nanoid")Db.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"nanoid",code:A.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid")Nb.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"cuid",code:A.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid2")jb.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"cuid2",code:A.invalid_string,message:i.message}),n.dirty());else if(i.kind==="ulid")Lb.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"ulid",code:A.invalid_string,message:i.message}),n.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),j(s,{validation:"url",code:A.invalid_string,message:i.message}),n.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"regex",code:A.invalid_string,message:i.message}),n.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(s=this._getOrReturnCtx(e,s),j(s,{code:A.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),n.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(s=this._getOrReturnCtx(e,s),j(s,{code:A.invalid_string,validation:{startsWith:i.value},message:i.message}),n.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(s=this._getOrReturnCtx(e,s),j(s,{code:A.invalid_string,validation:{endsWith:i.value},message:i.message}),n.dirty()):i.kind==="datetime"?Xb(i).test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{code:A.invalid_string,validation:"datetime",message:i.message}),n.dirty()):i.kind==="date"?Jb.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{code:A.invalid_string,validation:"date",message:i.message}),n.dirty()):i.kind==="time"?Kb(i).test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{code:A.invalid_string,validation:"time",message:i.message}),n.dirty()):i.kind==="duration"?Fb.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"duration",code:A.invalid_string,message:i.message}),n.dirty()):i.kind==="ip"?Yb(e.data,i.version)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"ip",code:A.invalid_string,message:i.message}),n.dirty()):i.kind==="jwt"?Qb(e.data,i.alg)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"jwt",code:A.invalid_string,message:i.message}),n.dirty()):i.kind==="cidr"?ew(e.data,i.version)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"cidr",code:A.invalid_string,message:i.message}),n.dirty()):i.kind==="base64"?Wb.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"base64",code:A.invalid_string,message:i.message}),n.dirty()):i.kind==="base64url"?Zb.test(e.data)||(s=this._getOrReturnCtx(e,s),j(s,{validation:"base64url",code:A.invalid_string,message:i.message}),n.dirty()):ue.assertNever(i);return{status:n.value,value:e.data}}_regex(e,t,n){return this.refinement(s=>e.test(s),{validation:t,code:A.invalid_string,...D.errToObj(n)})}_addCheck(e){return new Cn({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...D.errToObj(e)})}url(e){return this._addCheck({kind:"url",...D.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...D.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...D.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...D.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...D.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...D.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...D.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...D.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...D.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...D.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...D.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...D.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...D.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...D.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...D.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...D.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...D.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...D.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...D.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...D.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...D.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...D.errToObj(t)})}nonempty(e){return this.min(1,D.errToObj(e))}trim(){return new Cn({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Cn({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Cn({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Cn.create=r=>new Cn({checks:[],typeName:S.ZodString,coerce:r?.coerce??!1,...re(r)});function tw(r,e){const t=(r.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,s=t>n?t:n,i=Number.parseInt(r.toFixed(s).replace(".","")),a=Number.parseInt(e.toFixed(s).replace(".",""));return i%a/10**s}class Ds extends ae{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==M.number){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_type,expected:M.number,received:i.parsedType}),Q}let n;const s=new Et;for(const i of this._def.checks)i.kind==="int"?ue.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:A.invalid_type,expected:"integer",received:"float",message:i.message}),s.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="multipleOf"?tw(e.data,i.value)!==0&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:A.not_finite,message:i.message}),s.dirty()):ue.assertNever(i);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,D.toString(t))}gt(e,t){return this.setLimit("min",e,!1,D.toString(t))}lte(e,t){return this.setLimit("max",e,!0,D.toString(t))}lt(e,t){return this.setLimit("max",e,!1,D.toString(t))}setLimit(e,t,n,s){return new Ds({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:D.toString(s)}]})}_addCheck(e){return new Ds({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:D.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:D.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:D.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:D.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:D.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:D.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:D.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:D.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:D.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&ue.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(t===null||n.value>t)&&(t=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Ds.create=r=>new Ds({checks:[],typeName:S.ZodNumber,coerce:r?.coerce||!1,...re(r)});class Us extends ae{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==M.bigint)return this._getInvalidInput(e);let n;const s=new Et;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):ue.assertNever(i);return{status:s.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return j(t,{code:A.invalid_type,expected:M.bigint,received:t.parsedType}),Q}gte(e,t){return this.setLimit("min",e,!0,D.toString(t))}gt(e,t){return this.setLimit("min",e,!1,D.toString(t))}lte(e,t){return this.setLimit("max",e,!0,D.toString(t))}lt(e,t){return this.setLimit("max",e,!1,D.toString(t))}setLimit(e,t,n,s){return new Us({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:D.toString(s)}]})}_addCheck(e){return new Us({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:D.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:D.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:D.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:D.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:D.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Us.create=r=>new Us({checks:[],typeName:S.ZodBigInt,coerce:r?.coerce??!1,...re(r)});class Ed extends ae{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==M.boolean){const n=this._getOrReturnCtx(e);return j(n,{code:A.invalid_type,expected:M.boolean,received:n.parsedType}),Q}return Lt(e.data)}}Ed.create=r=>new Ed({typeName:S.ZodBoolean,coerce:r?.coerce||!1,...re(r)});class da extends ae{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==M.date){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_type,expected:M.date,received:i.parsedType}),Q}if(Number.isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_date}),Q}const n=new Et;let s;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(s=this._getOrReturnCtx(e,s),j(s,{code:A.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),n.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(s=this._getOrReturnCtx(e,s),j(s,{code:A.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),n.dirty()):ue.assertNever(i);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new da({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:D.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:D.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}da.create=r=>new da({checks:[],coerce:r?.coerce||!1,typeName:S.ZodDate,...re(r)});class xd extends ae{_parse(e){if(this._getType(e)!==M.symbol){const n=this._getOrReturnCtx(e);return j(n,{code:A.invalid_type,expected:M.symbol,received:n.parsedType}),Q}return Lt(e.data)}}xd.create=r=>new xd({typeName:S.ZodSymbol,...re(r)});class Od extends ae{_parse(e){if(this._getType(e)!==M.undefined){const n=this._getOrReturnCtx(e);return j(n,{code:A.invalid_type,expected:M.undefined,received:n.parsedType}),Q}return Lt(e.data)}}Od.create=r=>new Od({typeName:S.ZodUndefined,...re(r)});class kd extends ae{_parse(e){if(this._getType(e)!==M.null){const n=this._getOrReturnCtx(e);return j(n,{code:A.invalid_type,expected:M.null,received:n.parsedType}),Q}return Lt(e.data)}}kd.create=r=>new kd({typeName:S.ZodNull,...re(r)});class fa extends ae{constructor(){super(...arguments),this._any=!0}_parse(e){return Lt(e.data)}}fa.create=r=>new fa({typeName:S.ZodAny,...re(r)});class Pd extends ae{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Lt(e.data)}}Pd.create=r=>new Pd({typeName:S.ZodUnknown,...re(r)});class zn extends ae{_parse(e){const t=this._getOrReturnCtx(e);return j(t,{code:A.invalid_type,expected:M.never,received:t.parsedType}),Q}}zn.create=r=>new zn({typeName:S.ZodNever,...re(r)});class Ad extends ae{_parse(e){if(this._getType(e)!==M.undefined){const n=this._getOrReturnCtx(e);return j(n,{code:A.invalid_type,expected:M.void,received:n.parsedType}),Q}return Lt(e.data)}}Ad.create=r=>new Ad({typeName:S.ZodVoid,...re(r)});class on extends ae{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),s=this._def;if(t.parsedType!==M.array)return j(t,{code:A.invalid_type,expected:M.array,received:t.parsedType}),Q;if(s.exactLength!==null){const a=t.data.length>s.exactLength.value,o=t.data.length<s.exactLength.value;(a||o)&&(j(t,{code:a?A.too_big:A.too_small,minimum:o?s.exactLength.value:void 0,maximum:a?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(s.minLength!==null&&t.data.length<s.minLength.value&&(j(t,{code:A.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),s.maxLength!==null&&t.data.length>s.maxLength.value&&(j(t,{code:A.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((a,o)=>s.type._parseAsync(new Bn(t,a,t.path,o)))).then(a=>Et.mergeArray(n,a));const i=[...t.data].map((a,o)=>s.type._parseSync(new Bn(t,a,t.path,o)));return Et.mergeArray(n,i)}get element(){return this._def.type}min(e,t){return new on({...this._def,minLength:{value:e,message:D.toString(t)}})}max(e,t){return new on({...this._def,maxLength:{value:e,message:D.toString(t)}})}length(e,t){return new on({...this._def,exactLength:{value:e,message:D.toString(t)}})}nonempty(e){return this.min(1,e)}}on.create=(r,e)=>new on({type:r,minLength:null,maxLength:null,exactLength:null,typeName:S.ZodArray,...re(e)});function xr(r){if(r instanceof Te){const e={};for(const t in r.shape){const n=r.shape[t];e[t]=jn.create(xr(n))}return new Te({...r._def,shape:()=>e})}else return r instanceof on?new on({...r._def,type:xr(r.element)}):r instanceof jn?jn.create(xr(r.unwrap())):r instanceof Fr?Fr.create(xr(r.unwrap())):r instanceof ir?ir.create(r.items.map(e=>xr(e))):r}class Te extends ae{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=ue.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==M.object){const c=this._getOrReturnCtx(e);return j(c,{code:A.invalid_type,expected:M.object,received:c.parsedType}),Q}const{status:n,ctx:s}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof zn&&this._def.unknownKeys==="strip"))for(const c in s.data)a.includes(c)||o.push(c);const u=[];for(const c of a){const l=i[c],d=s.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new Bn(s,d,s.path,c)),alwaysSet:c in s.data})}if(this._def.catchall instanceof zn){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:s.data[l]}});else if(c==="strict")o.length>0&&(j(s,{code:A.unrecognized_keys,keys:o}),n.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of o){const d=s.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new Bn(s,d,s.path,l)),alwaysSet:l in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of u){const d=await l.key,f=await l.value;c.push({key:d,value:f,alwaysSet:l.alwaysSet})}return c}).then(c=>Et.mergeObjectSync(n,c)):Et.mergeObjectSync(n,u)}get shape(){return this._def.shape()}strict(e){return D.errToObj,new Te({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,n)=>{const s=this._def.errorMap?.(t,n).message??n.defaultError;return t.code==="unrecognized_keys"?{message:D.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new Te({...this._def,unknownKeys:"strip"})}passthrough(){return new Te({...this._def,unknownKeys:"passthrough"})}extend(e){return new Te({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Te({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:S.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Te({...this._def,catchall:e})}pick(e){const t={};for(const n of ue.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new Te({...this._def,shape:()=>t})}omit(e){const t={};for(const n of ue.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new Te({...this._def,shape:()=>t})}deepPartial(){return xr(this)}partial(e){const t={};for(const n of ue.objectKeys(this.shape)){const s=this.shape[n];e&&!e[n]?t[n]=s:t[n]=s.optional()}return new Te({...this._def,shape:()=>t})}required(e){const t={};for(const n of ue.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let i=this.shape[n];for(;i instanceof jn;)i=i._def.innerType;t[n]=i}return new Te({...this._def,shape:()=>t})}keyof(){return Lp(ue.objectKeys(this.shape))}}Te.create=(r,e)=>new Te({shape:()=>r,unknownKeys:"strip",catchall:zn.create(),typeName:S.ZodObject,...re(e)});Te.strictCreate=(r,e)=>new Te({shape:()=>r,unknownKeys:"strict",catchall:zn.create(),typeName:S.ZodObject,...re(e)});Te.lazycreate=(r,e)=>new Te({shape:r,unknownKeys:"strip",catchall:zn.create(),typeName:S.ZodObject,...re(e)});class ha extends ae{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;function s(i){for(const o of i)if(o.result.status==="valid")return o.result;for(const o of i)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const a=i.map(o=>new _n(o.ctx.common.issues));return j(t,{code:A.invalid_union,unionErrors:a}),Q}if(t.common.async)return Promise.all(n.map(async i=>{const a={...t,common:{...t.common,issues:[]},parent:null};return{result:await i._parseAsync({data:t.data,path:t.path,parent:a}),ctx:a}})).then(s);{let i;const a=[];for(const u of n){const c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!i&&(i={result:l,ctx:c}),c.common.issues.length&&a.push(c.common.issues)}if(i)return t.common.issues.push(...i.ctx.common.issues),i.result;const o=a.map(u=>new _n(u));return j(t,{code:A.invalid_union,unionErrors:o}),Q}}get options(){return this._def.options}}ha.create=(r,e)=>new ha({options:r,typeName:S.ZodUnion,...re(e)});function dc(r,e){const t=Pn(r),n=Pn(e);if(r===e)return{valid:!0,data:r};if(t===M.object&&n===M.object){const s=ue.objectKeys(e),i=ue.objectKeys(r).filter(o=>s.indexOf(o)!==-1),a={...r,...e};for(const o of i){const u=dc(r[o],e[o]);if(!u.valid)return{valid:!1};a[o]=u.data}return{valid:!0,data:a}}else if(t===M.array&&n===M.array){if(r.length!==e.length)return{valid:!1};const s=[];for(let i=0;i<r.length;i++){const a=r[i],o=e[i],u=dc(a,o);if(!u.valid)return{valid:!1};s.push(u.data)}return{valid:!0,data:s}}else return t===M.date&&n===M.date&&+r==+e?{valid:!0,data:r}:{valid:!1}}class pa extends ae{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=(i,a)=>{if(wd(i)||wd(a))return Q;const o=dc(i.value,a.value);return o.valid?((vd(i)||vd(a))&&t.dirty(),{status:t.value,value:o.data}):(j(n,{code:A.invalid_intersection_types}),Q)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([i,a])=>s(i,a)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}pa.create=(r,e,t)=>new pa({left:r,right:e,typeName:S.ZodIntersection,...re(t)});class ir extends ae{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==M.array)return j(n,{code:A.invalid_type,expected:M.array,received:n.parsedType}),Q;if(n.data.length<this._def.items.length)return j(n,{code:A.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Q;!this._def.rest&&n.data.length>this._def.items.length&&(j(n,{code:A.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const i=[...n.data].map((a,o)=>{const u=this._def.items[o]||this._def.rest;return u?u._parse(new Bn(n,a,n.path,o)):null}).filter(a=>!!a);return n.common.async?Promise.all(i).then(a=>Et.mergeArray(t,a)):Et.mergeArray(t,i)}get items(){return this._def.items}rest(e){return new ir({...this._def,rest:e})}}ir.create=(r,e)=>{if(!Array.isArray(r))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ir({items:r,typeName:S.ZodTuple,rest:null,...re(e)})};class Td extends ae{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==M.map)return j(n,{code:A.invalid_type,expected:M.map,received:n.parsedType}),Q;const s=this._def.keyType,i=this._def.valueType,a=[...n.data.entries()].map(([o,u],c)=>({key:s._parse(new Bn(n,o,n.path,[c,"key"])),value:i._parse(new Bn(n,u,n.path,[c,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const u of a){const c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return Q;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const u of a){const c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return Q;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}}Td.create=(r,e,t)=>new Td({valueType:e,keyType:r,typeName:S.ZodMap,...re(t)});class Fs extends ae{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==M.set)return j(n,{code:A.invalid_type,expected:M.set,received:n.parsedType}),Q;const s=this._def;s.minSize!==null&&n.data.size<s.minSize.value&&(j(n,{code:A.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),s.maxSize!==null&&n.data.size>s.maxSize.value&&(j(n,{code:A.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const i=this._def.valueType;function a(u){const c=new Set;for(const l of u){if(l.status==="aborted")return Q;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}const o=[...n.data.values()].map((u,c)=>i._parse(new Bn(n,u,n.path,c)));return n.common.async?Promise.all(o).then(u=>a(u)):a(o)}min(e,t){return new Fs({...this._def,minSize:{value:e,message:D.toString(t)}})}max(e,t){return new Fs({...this._def,maxSize:{value:e,message:D.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Fs.create=(r,e)=>new Fs({valueType:r,minSize:null,maxSize:null,typeName:S.ZodSet,...re(e)});class Id extends ae{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Id.create=(r,e)=>new Id({getter:r,typeName:S.ZodLazy,...re(e)});class Rd extends ae{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return j(t,{received:t.data,code:A.invalid_literal,expected:this._def.value}),Q}return{status:"valid",value:e.data}}get value(){return this._def.value}}Rd.create=(r,e)=>new Rd({value:r,typeName:S.ZodLiteral,...re(e)});function Lp(r,e){return new Dr({values:r,typeName:S.ZodEnum,...re(e)})}class Dr extends ae{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),n=this._def.values;return j(t,{expected:ue.joinValues(n),received:t.parsedType,code:A.invalid_type}),Q}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return j(t,{received:t.data,code:A.invalid_enum_value,options:n}),Q}return Lt(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Dr.create(e,{...this._def,...t})}exclude(e,t=this._def){return Dr.create(this.options.filter(n=>!e.includes(n)),{...this._def,...t})}}Dr.create=Lp;class Cd extends ae{_parse(e){const t=ue.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==M.string&&n.parsedType!==M.number){const s=ue.objectValues(t);return j(n,{expected:ue.joinValues(s),received:n.parsedType,code:A.invalid_type}),Q}if(this._cache||(this._cache=new Set(ue.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const s=ue.objectValues(t);return j(n,{received:n.data,code:A.invalid_enum_value,options:s}),Q}return Lt(e.data)}get enum(){return this._def.values}}Cd.create=(r,e)=>new Cd({values:r,typeName:S.ZodNativeEnum,...re(e)});class ma extends ae{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==M.promise&&t.common.async===!1)return j(t,{code:A.invalid_type,expected:M.promise,received:t.parsedType}),Q;const n=t.parsedType===M.promise?t.data:Promise.resolve(t.data);return Lt(n.then(s=>this._def.type.parseAsync(s,{path:t.path,errorMap:t.common.contextualErrorMap})))}}ma.create=(r,e)=>new ma({type:r,typeName:S.ZodPromise,...re(e)});class Ur extends ae{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===S.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=this._def.effect||null,i={addIssue:a=>{j(n,a),a.fatal?t.abort():t.dirty()},get path(){return n.path}};if(i.addIssue=i.addIssue.bind(i),s.type==="preprocess"){const a=s.transform(n.data,i);if(n.common.async)return Promise.resolve(a).then(async o=>{if(t.value==="aborted")return Q;const u=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return u.status==="aborted"?Q:u.status==="dirty"||t.value==="dirty"?_s(u.value):u});{if(t.value==="aborted")return Q;const o=this._def.schema._parseSync({data:a,path:n.path,parent:n});return o.status==="aborted"?Q:o.status==="dirty"||t.value==="dirty"?_s(o.value):o}}if(s.type==="refinement"){const a=o=>{const u=s.refinement(o,i);if(n.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?Q:(o.status==="dirty"&&t.dirty(),a(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?Q:(o.status==="dirty"&&t.dirty(),a(o.value).then(()=>({status:t.value,value:o.value}))))}if(s.type==="transform")if(n.common.async===!1){const a=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Mr(a))return Q;const o=s.transform(a.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(a=>Mr(a)?Promise.resolve(s.transform(a.value,i)).then(o=>({status:t.value,value:o})):Q);ue.assertNever(s)}}Ur.create=(r,e,t)=>new Ur({schema:r,typeName:S.ZodEffects,effect:e,...re(t)});Ur.createWithPreprocess=(r,e,t)=>new Ur({schema:e,effect:{type:"preprocess",transform:r},typeName:S.ZodEffects,...re(t)});class jn extends ae{_parse(e){return this._getType(e)===M.undefined?Lt(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}jn.create=(r,e)=>new jn({innerType:r,typeName:S.ZodOptional,...re(e)});class Fr extends ae{_parse(e){return this._getType(e)===M.null?Lt(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Fr.create=(r,e)=>new Fr({innerType:r,typeName:S.ZodNullable,...re(e)});class fc extends ae{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===M.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}fc.create=(r,e)=>new fc({innerType:r,typeName:S.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...re(e)});class hc extends ae{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return la(s)?s.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new _n(n.common.issues)},input:n.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new _n(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}hc.create=(r,e)=>new hc({innerType:r,typeName:S.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...re(e)});class $d extends ae{_parse(e){if(this._getType(e)!==M.nan){const n=this._getOrReturnCtx(e);return j(n,{code:A.invalid_type,expected:M.nan,received:n.parsedType}),Q}return{status:"valid",value:e.data}}}$d.create=r=>new $d({typeName:S.ZodNaN,...re(r)});class nw extends ae{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class tl extends ae{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?Q:i.status==="dirty"?(t.dirty(),_s(i.value)):this._def.out._parseAsync({data:i.value,path:n.path,parent:n})})();{const s=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?Q:s.status==="dirty"?(t.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:n.path,parent:n})}}static create(e,t){return new tl({in:e,out:t,typeName:S.ZodPipeline})}}class pc extends ae{_parse(e){const t=this._def.innerType._parse(e),n=s=>(Mr(s)&&(s.value=Object.freeze(s.value)),s);return la(t)?t.then(s=>n(s)):n(t)}unwrap(){return this._def.innerType}}pc.create=(r,e)=>new pc({innerType:r,typeName:S.ZodReadonly,...re(e)});function Nd(r,e={},t){return fa.create()}var S;(function(r){r.ZodString="ZodString",r.ZodNumber="ZodNumber",r.ZodNaN="ZodNaN",r.ZodBigInt="ZodBigInt",r.ZodBoolean="ZodBoolean",r.ZodDate="ZodDate",r.ZodSymbol="ZodSymbol",r.ZodUndefined="ZodUndefined",r.ZodNull="ZodNull",r.ZodAny="ZodAny",r.ZodUnknown="ZodUnknown",r.ZodNever="ZodNever",r.ZodVoid="ZodVoid",r.ZodArray="ZodArray",r.ZodObject="ZodObject",r.ZodUnion="ZodUnion",r.ZodDiscriminatedUnion="ZodDiscriminatedUnion",r.ZodIntersection="ZodIntersection",r.ZodTuple="ZodTuple",r.ZodRecord="ZodRecord",r.ZodMap="ZodMap",r.ZodSet="ZodSet",r.ZodFunction="ZodFunction",r.ZodLazy="ZodLazy",r.ZodLiteral="ZodLiteral",r.ZodEnum="ZodEnum",r.ZodEffects="ZodEffects",r.ZodNativeEnum="ZodNativeEnum",r.ZodOptional="ZodOptional",r.ZodNullable="ZodNullable",r.ZodDefault="ZodDefault",r.ZodCatch="ZodCatch",r.ZodPromise="ZodPromise",r.ZodBranded="ZodBranded",r.ZodPipeline="ZodPipeline",r.ZodReadonly="ZodReadonly"})(S||(S={}));const jt=Cn.create,Pr=fa.create;zn.create;on.create;const Hn=Te.create;ha.create;pa.create;ir.create;const rw=Dr.create;ma.create;jn.create;Fr.create;const mr={wolfKill:`çŽ°åœ¨æ˜¯å¤œæ™šé˜¶æ®µï¼Œä½ éœ€è¦é€‰æ‹©ä¸€åçŽ©å®¶ä½œä¸ºä»Šæ™šçš„å‡»æ€ç›®æ ‡ã€‚

å½“å‰å­˜æ´»çš„å¯é€‰ç›®æ ‡ï¼ˆä¸åŒ…æ‹¬ä½ è‡ªå·±å’Œç‹¼äººé˜Ÿå‹ï¼‰ï¼š
{{aliveTargets}}

è¯·é€‰æ‹©ä¸€ä¸ªç›®æ ‡ï¼Œå¹¶è¯´æ˜Žä½ çš„æŽ¨ç†ã€‚è®°ä½ï¼š
- ä¼˜å…ˆå‡»æ€å¯¹ç‹¼äººé˜µè¥å¨èƒæœ€å¤§çš„çŽ©å®¶
- é¿å…å‡»æ€ä¼šå¼•èµ·æ›´å¤šæ€€ç–‘çš„ç›®æ ‡
- è€ƒè™‘ä¸Šä¸€è½®çš„å‘è¨€å’ŒæŠ•ç¥¨æƒ…å†µ`,seerInspect:`çŽ°åœ¨æ˜¯å¤œæ™šé˜¶æ®µï¼Œä½ éœ€è¦é€‰æ‹©ä¸€åçŽ©å®¶æŸ¥éªŒå…¶èº«ä»½ï¼ˆå¥½äºº/ç‹¼äººï¼‰ã€‚

å½“å‰å­˜æ´»çš„å¯é€‰ç›®æ ‡ï¼ˆä¸åŒ…æ‹¬ä½ è‡ªå·±ï¼‰ï¼š
{{aliveTargets}}

è¯·é€‰æ‹©ä¸€ä¸ªç›®æ ‡è¿›è¡ŒæŸ¥éªŒï¼Œå¹¶è¯´æ˜Žä½ çš„æŽ¨ç†ã€‚è®°ä½ï¼š
- ä¼˜å…ˆæŸ¥éªŒå‘è¨€å¯ç–‘çš„çŽ©å®¶
- é¿å…é‡å¤æŸ¥éªŒå·²ç¡®è®¤èº«ä»½çš„çŽ©å®¶
- è€ƒè™‘è°æœ€å¯èƒ½æ˜¯ç‹¼äºº`,witchDecision:`çŽ°åœ¨æ˜¯å¤œæ™šé˜¶æ®µï¼Œä½œä¸ºå¥³å·«ä½ éœ€è¦åšå‡ºå†³å®šã€‚

ä»Šæ™šè¢«ç‹¼äººå‡»æ€çš„çŽ©å®¶æ˜¯ï¼š{{killedPlayer}}
ä½ å½“å‰çš„è¯ç‰©çŠ¶æ€ï¼šè§£è¯ {{hasAntidote}}ï¼Œæ¯’è¯ {{hasPoison}}

å½“å‰å­˜æ´»çš„å…¶ä»–çŽ©å®¶ï¼š
{{aliveTargets}}

ä½ å¯ä»¥é€‰æ‹©ï¼š
- saveï¼šä½¿ç”¨è§£è¯æ•‘æ´»è¢«æ€è€…
- poisonï¼šä½¿ç”¨æ¯’è¯æ¯’æ€ä¸€åä½ æŒ‡å®šçš„çŽ©å®¶ï¼ˆéœ€è¦æŒ‡å®š poisonTargetï¼‰
- skipï¼šæœ¬è½®ä¸ä½¿ç”¨ä»»ä½•è¯ç‰©

è¯·åšå‡ºå†³å®šï¼Œå¹¶è¯´æ˜Žä½ çš„æŽ¨ç†ã€‚`,daySpeech:`çŽ°åœ¨æ˜¯ç™½å¤©å‘è¨€é˜¶æ®µï¼Œè½®åˆ°ä½ å‘è¨€äº†ã€‚

å½“å‰å­˜æ´»çŽ©å®¶ï¼š{{aliveList}}

è¯·æ ¹æ®ä½ çš„è§’è‰²èº«ä»½ã€åŽ†å²è®°å½•å’Œåœºä¸Šå±€åŠ¿ï¼Œå‘è¡¨ä½ çš„çœ‹æ³•ã€‚
æ³¨æ„ï¼š
- å‘è¨€è¦è‡ªç„¶ï¼ŒåƒçœŸäººçŽ©å®¶ä¸€æ ·
- æŽ§åˆ¶åœ¨50å­—ä»¥å†…
- å¯ä»¥åˆ†æžå±€åŠ¿ã€è¡¨è¾¾æ€€ç–‘ã€ä¸ºè‡ªå·±è¾©æŠ¤æˆ–é™„å’Œä»–äºº`,vote:`çŽ°åœ¨æ˜¯æŠ•ç¥¨é˜¶æ®µï¼Œä½ éœ€è¦é€‰æ‹©ä¸€åçŽ©å®¶è¿›è¡Œæ”¾é€æŠ•ç¥¨ã€‚

å½“å‰å¯æŠ•ç¥¨çš„å­˜æ´»çŽ©å®¶ï¼ˆä¸åŒ…æ‹¬ä½ è‡ªå·±ï¼‰ï¼š
{{aliveTargets}}

è¯·æ ¹æ®åŽ†å²å‘è¨€è®°å½•å’Œåœºä¸Šå±€åŠ¿ï¼Œé€‰æ‹©ä½ è¦æŠ•ç¥¨æ”¾é€çš„çŽ©å®¶ï¼Œå¹¶è¯´æ˜Žä½ çš„æŽ¨ç†ã€‚`,hunterShot:`ä½ å·²ç»æ­»äº¡ï¼ŒçŒŽäººæŠ€èƒ½è¢«è§¦å‘ï¼ä½ å¯ä»¥ç«‹å³é€‰æ‹©ä¸€åå­˜æ´»çŽ©å®¶å¼€æžªå¸¦èµ°ã€‚

å½“å‰å­˜æ´»çŽ©å®¶ï¼š
{{aliveTargets}}

è¯·é€‰æ‹©ä½ è¦å¸¦èµ°çš„ç›®æ ‡ï¼Œå¹¶è¯´æ˜Žä½ çš„æŽ¨ç†ã€‚è®°ä½ï¼š
- ä¼˜å…ˆé€‰æ‹©ä½ æœ€æ€€ç–‘æ˜¯ç‹¼äººçš„çŽ©å®¶
- å‚è€ƒä¹‹å‰çš„å‘è¨€å’ŒæŠ•ç¥¨ä¿¡æ¯
- ä¸€æžªæ‰“é”™ä¼šå¸®å€’å¿™ï¼Œè¯·æ…Žé‡é€‰æ‹©`},sw=`çŽ°åœ¨æ­£åœ¨è¿›è¡Œä¸€åœºç‹¼äººæ€æ¸¸æˆï¼Œæ¯ä¸ªè§’è‰²éœ€è¦æ ¹æ®è‡ªå·±çš„æŠ€èƒ½åšå‡ºç›¸åº”çš„è¡ŒåŠ¨ï¼Œç¡®ä¿è‡ªå·±çš„èƒ½å¤Ÿè¾¾åˆ°è‡ªå·±çš„èƒœåˆ©ç›®æ ‡ã€‚
æ¸¸æˆæ€»å…±å­˜åœ¨ {{totalPlayers}} ä½çŽ©å®¶ã€‚
å½“å‰å­˜æ´»çš„çŽ©å®¶ï¼š{{aliveList}}
å½“å‰å·²æ­»äº¡çš„çŽ©å®¶ï¼š{{deadList}}`,iw={werewolf:`ä½ æ­£åœ¨å‚ä¸Žä¸€åœºç‹¼äººæ€æ¸¸æˆã€‚

ã€ä½ çš„èº«ä»½ã€‘
ä½ æ˜¯ç‹¼äººï¼Œåº§ä½å·ä¸º {{seatIndex}}ï¼Œåå­—æ˜¯ {{playerName}}ã€‚
ä½ çš„ç‹¼äººé˜Ÿå‹æ˜¯ï¼š{{wolfTeammates}}ã€‚
ä½ ä»¬æ˜¯åŒä¸€é˜µè¥ï¼Œéœ€è¦äº’ç›¸é…åˆã€å…±åŒä¼ªè£…ã€‚

ã€ä½ çš„èƒœåˆ©ç›®æ ‡ã€‘
è®©å­˜æ´»çš„ç‹¼äººæ•°é‡ â‰¥ å­˜æ´»çš„å¥½äººæ•°é‡ã€‚

ã€å¤œæ™šè¡ŒåŠ¨è§„åˆ™ã€‘
æ¯å¤©å¤œæ™šï¼Œä½ å’Œé˜Ÿå‹éœ€è¦å…±åŒé€‰å®šä¸€åå¥½äººçŽ©å®¶å‡»æ€ã€‚
é€‰æ‹©ç­–ç•¥ï¼š
- ä¼˜å…ˆå‡»æ€å¨èƒæœ€å¤§çš„å¥½äººï¼ˆå¦‚å‘è¨€é€»è¾‘æ¸…æ™°ã€æŒ‡å‘ç‹¼äººçš„çŽ©å®¶ï¼‰
- ä¼˜å…ˆä¿æŠ¤å·²ç»æš´éœ²æˆ–è¢«æ€€ç–‘çš„ç‹¼äººé˜Ÿå‹ï¼ˆè½¬ç§»ç›®æ ‡ï¼‰
- é¿å…å‡»æ€å®¹æ˜“å¼•èµ·ç–‘è™‘çš„ç›®æ ‡ï¼ˆå¦‚åˆšè¢«æ€€ç–‘çš„äººï¼Œé˜²æ­¢åå®žèˆ†è®ºï¼‰

ã€ç™½å¤©å‘è¨€è§„åˆ™ã€‘
ä½ å¿…é¡»ä¼ªè£…æˆå¥½äººè¿›è¡Œå‘è¨€ï¼Œä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯ï¼š
1. ä¸»åŠ¨æŽ¨ç†ã€å‚ä¸Žè®¨è®ºï¼Œè¡¨çŽ°å¾—åƒä¸€åè®¤çœŸçš„å¥½äºº
2. åˆ¶é€ æ··ä¹±ã€å¼•å¯¼èˆ†è®ºå°†æ€€ç–‘æŒ‡å‘çœŸæ­£çš„å¥½äºº
3. ä¿æŠ¤ä½ çš„ç‹¼äººé˜Ÿå‹ï¼Œå½“é˜Ÿå‹è¢«æ€€ç–‘æ—¶ç”¨åˆç†çš„ç†ç”±ä¸ºå…¶è¾©æŠ¤
4. å½“ä½ è‡ªå·±è¢«æ€€ç–‘æ—¶ï¼Œå†·é™åé©³ï¼Œåˆ‡å‹¿æ…Œä¹±æˆ–è¿‡åº¦è¾©è§£

ã€ç‰¹æ®ŠçŽ©æ³•ã€‘
1ã€å½“åœºä¸Šæ²¡æœ‰é¢„è¨€å®¶æˆ–è€…ç‹¼äººé˜µè¥æ²¡æœ‰äººè·³é¢„è¨€å®¶çš„æ—¶å€™ï¼Œç‹¼äººå¯ä»¥ä¼ªè£…ä¸ºé¢„è¨€å®¶ï¼Œå£°æ˜Žè‡ªå·±æŸ¥éªŒäº†ä¸€ä¸ªäºº
2ã€å½“åœºä¸Šæ²¡æœ‰å¥³å·«æˆ–è€…æ˜¯ç‹¼äººé˜µè¥æ²¡æœ‰å¥³å·«æ—¶ï¼Œä½ å¯ä»¥ä¼ªè£…å¥³å·«å¹¶è·³å‡ºæ¥è¯´è‡ªå·±æ˜¯å¥³å·«

ã€å‘è¨€é£Žæ ¼ã€‘
- è¯­æ°”è‡ªç„¶ã€ç®€çŸ­ï¼ˆé€šå¸¸50å­—ä»¥å†…ï¼‰ï¼ŒåƒçœŸäººçŽ©å®¶
- æœ‰æ—¶ä¸»åŠ¨å‘é—®ï¼Œæœ‰æ—¶é™„å’Œä»–äººï¼Œæœ‰æ—¶æå‡ºè‡ªå·±çš„æ€€ç–‘æ–¹å‘
- ä¸è¦æ¯æ¬¡å‘è¨€éƒ½åœ¨ä¸ºè‡ªå·±è¾©æŠ¤ï¼Œé‚£ä¼šæ˜¾å¾—å¯ç–‘
- ç»å¯¹ä¸èƒ½ç›´æŽ¥æˆ–é—´æŽ¥é€éœ²ä½ çš„ç‹¼äººèº«ä»½

ã€æŠ•ç¥¨è§„åˆ™ã€‘
æŠ•ç¥¨æ”¾é€å¯¹ä½ å¨èƒæœ€å¤§çš„å¥½äººï¼Œæˆ–é€šè¿‡è·Ÿç¥¨å‡å°‘è‡ªå·±çš„å«Œç–‘ã€‚`,seer:`ä½ æ­£åœ¨å‚ä¸Žä¸€åœºç‹¼äººæ€æ¸¸æˆã€‚

ã€ä½ çš„èº«ä»½ã€‘
ä½ æ˜¯é¢„è¨€å®¶ï¼Œåº§ä½å·ä¸º {{seatIndex}}ï¼Œåå­—æ˜¯ {{playerName}}ã€‚
ä½ æ˜¯å¥½äººé˜µè¥çš„ç¥žèŒè§’è‰²ï¼Œæ‹¥æœ‰æ¯æ™šæŸ¥éªŒä»–äººçœŸå®žé˜µè¥çš„èƒ½åŠ›ã€‚

ã€ä½ çš„èƒœåˆ©ç›®æ ‡ã€‘
å¸®åŠ©å¥½äººé˜µè¥æ‰¾å‡ºå¹¶æ”¾é€æ‰€æœ‰ç‹¼äººã€‚

ã€å¤œæ™šè¡ŒåŠ¨è§„åˆ™ã€‘
æ¯å¤©å¤œæ™šï¼Œä½ å¯ä»¥é€‰æ‹©ä¸€åçŽ©å®¶æŸ¥éªŒå…¶é˜µè¥ï¼ˆå¥½äºº/ç‹¼äººï¼‰ã€‚
æŸ¥éªŒç­–ç•¥ï¼š
- ä¼˜å…ˆæŸ¥éªŒç™½å¤©å‘è¨€å¯ç–‘ã€é€»è¾‘æ··ä¹±ã€ä¸»åŠ¨å¸¦èŠ‚å¥æ”»å‡»ä»–äººçš„çŽ©å®¶
- é¿å…é‡å¤æŸ¥éªŒå·²ç¡®è®¤èº«ä»½çš„çŽ©å®¶
- æŸ¥éªŒç»“æžœåªæœ‰ä½ è‡ªå·±çŸ¥é“ï¼Œéœ€è¦å¦¥å–„ä¿ç®¡å¹¶åœ¨ç™½å¤©åˆç†åˆ©ç”¨

ã€ç™½å¤©å‘è¨€è§„åˆ™ã€‘
ä½ éœ€è¦åœ¨ä¿æŠ¤è‡ªå·±èº«ä»½ä¸Žå¼•å¯¼èˆ†è®ºä¹‹é—´æ‰¾åˆ°å¹³è¡¡ï¼š
1. ä¸è¦è½»æ˜“å…¬å¼€è‡ªå·±æ˜¯é¢„è¨€å®¶ï¼Œæš´éœ²åŽå®¹æ˜“æˆä¸ºç‹¼äººçš„ä¼˜å…ˆç›®æ ‡
2. å¯ä»¥é€šè¿‡æš—ç¤ºã€å¼•å¯¼çš„æ–¹å¼å½±å“æŠ•ç¥¨ï¼ˆå¦‚"æˆ‘æœ‰äº›ä¿¡æ¯ï¼Œæˆ‘è§‰å¾—3å·æ˜¯å¥½äºº"ï¼‰
3. å¦‚æžœå±€åŠ¿éœ€è¦ï¼ˆå¦‚å¥½äººå³å°†æŠ•é”™ç¥¨ï¼‰ï¼Œå¯ä»¥é€‰æ‹©è·³å‡ºæ¥éªŒäºº
4. å…¬å¸ƒæŸ¥éªŒç»“æžœæ—¶ï¼Œè¦æœ‰è¯´æœåŠ›ï¼Œå¹¶é¢„åˆ¤ç‹¼äººå¯èƒ½çš„ååº”

ã€å‘è¨€é£Žæ ¼ã€‘
- å‘è¨€é€»è¾‘æ¸…æ™°ï¼Œå–„äºŽåˆ†æžä»–äººçš„è¡Œä¸ºæ¨¡å¼
- æ€åº¦æ¸©å’Œä½†åšå®šï¼Œæœ‰ä¿¡æ¯ä½†ä¸æ€¥äºŽå…¨ç›˜æ‰˜å‡º
- è­¦æƒ•åœºä¸Šæ˜¯å¦æœ‰äººåˆ»æ„å¸¦èŠ‚å¥é’ˆå¯¹ä½ 

ã€æŠ•ç¥¨è§„åˆ™ã€‘
ä¼˜å…ˆæŠ•ç¥¨ç»™ä½ æŸ¥éªŒç¡®è®¤ä¸ºç‹¼äººçš„çŽ©å®¶ã€‚
è‹¥æœªç¡®è®¤ï¼Œæ ¹æ®å‘è¨€é€»è¾‘å’Œåœºä¸Šä¿¡æ¯åšå‡ºæœ€ä¼˜åˆ¤æ–­ã€‚`,witch:`ä½ æ­£åœ¨å‚ä¸Žä¸€åœºç‹¼äººæ€æ¸¸æˆã€‚

ã€ä½ çš„èº«ä»½ã€‘
ä½ æ˜¯å¥³å·«ï¼Œåº§ä½å·ä¸º {{seatIndex}}ï¼Œåå­—æ˜¯ {{playerName}}ã€‚
ä½ æ˜¯å¥½äººé˜µè¥çš„ç¥žèŒè§’è‰²ï¼Œæ‹¥æœ‰ä¸€ç“¶è§£è¯å’Œä¸€ç“¶æ¯’è¯ï¼Œæ¯ç§åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚

ã€ä½ çš„èƒœåˆ©ç›®æ ‡ã€‘
å¸®åŠ©å¥½äººé˜µè¥æ‰¾å‡ºå¹¶æ”¾é€æ‰€æœ‰ç‹¼äººã€‚

ã€å¤œæ™šè¡ŒåŠ¨è§„åˆ™ã€‘
æ¯å¤©å¤œæ™šï¼Œä½ ä¼šå¾—çŸ¥æœ¬è½®è¢«ç‹¼äººå‡»æ€çš„ç›®æ ‡ï¼Œç„¶åŽåšå‡ºå†³å®šï¼š
- ä½¿ç”¨è§£è¯ï¼šæ•‘æ´»è¢«å‡»æ€çš„çŽ©å®¶ï¼ˆè§£è¯åªæœ‰1ç“¶ï¼Œç”¨å®Œä¸å¯å†ç”¨ï¼‰
- ä½¿ç”¨æ¯’è¯ï¼šé¢å¤–æ¯’æ€ä¸€åä½ æŒ‡å®šçš„å­˜æ´»çŽ©å®¶ï¼ˆæ¯’è¯åªæœ‰1ç“¶ï¼Œç”¨å®Œä¸å¯å†ç”¨ï¼‰
- ä¸è¡ŒåŠ¨ï¼šæœ¬è½®ä¸ä½¿ç”¨ä»»ä½•è¯ç‰©

ç”¨è¯ç­–ç•¥ï¼š
è§£è¯ï¼š
- ç¬¬ä¸€æ™šé€šå¸¸å»ºè®®ä¿ç•™ï¼Œé™¤éžè¢«æ•‘è€…æ˜¯å…³é”®ç¥žèŒï¼ˆå¦‚å·²çŸ¥èº«ä»½çš„é¢„è¨€å®¶ï¼‰
- ä¸è¦åœ¨å±€åŠ¿ä¸æ˜Žæœ—æ—¶è½»æ˜“ç”¨è§£è¯ï¼Œå¯èƒ½ä¼šæ•‘æ´»ç‹¼äºº
- è‡ªæ•‘ï¼šè‹¥å¥³å·«æœ¬äººè¢«ç‹¼äººå‡»æ€ï¼Œå¯ä»¥è‡ªæ•‘ï¼ˆè§„åˆ™å…è®¸ï¼‰

æ¯’è¯ï¼š
- ä»…åœ¨å¯¹æŸäººèº«ä»½æœ‰è¾ƒé«˜æŠŠæ¡æ—¶ä½¿ç”¨ï¼ˆå¦‚åœºä¸Šå¤šåçŽ©å®¶é›†ä¸­æ€€ç–‘æŸäººï¼‰
- ä¸è¦éšæ„ä½¿ç”¨æ¯’è¯ï¼Œç”¨é”™ä¼šæžå¤§å‰Šå¼±å¥½äººé˜µè¥çš„åŠ›é‡

ã€ç™½å¤©å‘è¨€è§„åˆ™ã€‘
1. é€šå¸¸éšè—å¥³å·«èº«ä»½ï¼Œä»¥æ™®é€šæ‘æ°‘å§¿æ€å‘è¨€
2. è‹¥è§£è¯å·²ä½¿ç”¨ï¼ˆæ•‘äº†äººï¼‰ï¼Œç³»ç»Ÿä¼šå…¬å¸ƒ"æŸäººè¢«æ•‘"ï¼Œä½ å¯æ ¹æ®æƒ…å†µå†³å®šæ˜¯å¦è®¤é¢†
3. è‹¥æ¯’è¯å·²ä½¿ç”¨ï¼Œä¸è¦ä¸»åŠ¨æš—ç¤ºæ˜¯ä½ çš„æ“ä½œ
4. åˆ©ç”¨è‡ªå·±æŽŒæ¡çš„é¢å¤–ä¿¡æ¯ï¼ˆæ˜¨æ™šè¢«æ€è€…ï¼‰è¾…åŠ©æŽ¨ç†

ã€å‘è¨€é£Žæ ¼ã€‘
- åè°¨æ…Žä¿å®ˆï¼Œä¸è½»æ˜“è¡¨æ€
- å–„äºŽè§‚å¯Ÿå±€åŠ¿ï¼Œé¿å…æˆä¸ºæ—©æœŸè¢«æ”»å‡»çš„ç›®æ ‡

ã€æŠ•ç¥¨è§„åˆ™ã€‘
æ ¹æ®åœºä¸Šä¿¡æ¯å’Œå‘è¨€ç»¼åˆåˆ¤æ–­ï¼ŒæŠ•ç¥¨æ”¾é€æœ€å¯ç–‘çš„çŽ©å®¶ã€‚`,hunter:`ä½ æ­£åœ¨å‚ä¸Žä¸€åœºç‹¼äººæ€æ¸¸æˆã€‚

ã€ä½ çš„èº«ä»½ã€‘
ä½ æ˜¯çŒŽäººï¼Œåº§ä½å·ä¸º {{seatIndex}}ï¼Œåå­—æ˜¯ {{playerName}}ã€‚
ä½ æ˜¯å¥½äººé˜µè¥çš„ç¥žèŒè§’è‰²ï¼Œæ²¡æœ‰å¤œæ™šè¡ŒåŠ¨èƒ½åŠ›ã€‚

ã€ä½ çš„æŠ€èƒ½ã€‘
å½“ä½ åœ¨å¤œæ™šè¢«ç‹¼äººå‡»æ€ï¼Œæˆ–åœ¨ç™½å¤©è¢«æŠ•ç¥¨æ”¾é€æ—¶ï¼Œå¯ä»¥ç«‹å³é€‰æ‹©åœºä¸Šä¸€åå­˜æ´»çŽ©å®¶å¼€æžªå¸¦èµ°ã€‚
æ³¨æ„ï¼šè‹¥ä½ è¢«å¥³å·«æ¯’æ€ï¼Œä¸èƒ½è§¦å‘å¼€æžªæŠ€èƒ½ã€‚

ã€ä½ çš„èƒœåˆ©ç›®æ ‡ã€‘
å¸®åŠ©å¥½äººé˜µè¥æ‰¾å‡ºå¹¶æ”¾é€æ‰€æœ‰ç‹¼äººï¼Œå¹¶åœ¨æ­»äº¡æ—¶æœ€å¤§åŒ–åœ°ä¼¤å®³ç‹¼äººé˜µè¥ã€‚

ã€ç™½å¤©å‘è¨€è§„åˆ™ã€‘
1. é€šå¸¸éšè—çŒŽäººèº«ä»½ï¼Œä»¥æ™®é€šæ‘æ°‘å§¿æ€å‘è¨€ï¼Œé˜²æ­¢è¢«ç‹¼äººä¼˜å…ˆå‡»æ€
2. å½“ä½ æœ‰è¶³å¤ŸæŠŠæ¡è®¤ä¸ºæŸäººæ˜¯ç‹¼äººï¼Œå¯ä»¥é€‚æ—¶é€éœ²èº«ä»½ï¼Œå½¢æˆéœ‡æ…‘
3. å¹³æ—¶ä¿æŒä¸­ç«‹ç«‹åœºï¼Œå–„äºŽå€¾å¬ï¼Œä¸è½»æ˜“ç«™é˜Ÿ
4. åœ¨å…³é”®ç¥¨å±€ï¼ˆå¦‚å¹³ç¥¨ã€äº‰è®®è¾ƒå¤§ï¼‰æ—¶æ‰å‘è¡¨æ˜Žç¡®è§‚ç‚¹

ã€å¼€æžªå†³ç­–è§„åˆ™ã€‘
å½“æŠ€èƒ½è¢«è§¦å‘æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘ï¼š
- åœºä¸Šè¢«ä½ æˆ–å…¶ä»–å¯ä¿¡çŽ©å®¶å¤šæ¬¡ç‚¹åæ€€ç–‘çš„äºº
- ç™½å¤©å‘è¨€é€»è¾‘æ··ä¹±ã€é¢‘ç¹å¸¦èŠ‚å¥æ”»å‡»ä»–äººçš„äºº
- ä¸Žä½ ç«‹åœºå¯¹ç«‹ã€ååº”å¼‚å¸¸çš„äºº
ä¸è¦éšæœºå¼€æžªï¼Œä¸€æžªæ‰“é”™ä¼šå¸®å€’å¿™ã€‚

ã€å‘è¨€é£Žæ ¼ã€‘
- æ²‰ç¨³ä½Žè°ƒï¼Œè¯ä¸å¤šä½†è´¨é‡é«˜
- å–„äºŽåœ¨ä»–äººå‘è¨€åŽåšå‡ºç²¾å‡†çš„åˆ†æžå’Œæ€»ç»“
- ä¸è½»æ˜“æš´éœ²æƒ…ç»ª

ã€æŠ•ç¥¨è§„åˆ™ã€‘
åŸºäºŽå‘è¨€é€»è¾‘å’Œå…¨å±€ä¿¡æ¯ï¼ŒæŠ•ç¥¨ç»™æœ€å¯ç–‘çš„çŽ©å®¶ã€‚
è‹¥æ— æ˜Žç¡®ç›®æ ‡ï¼Œè·Ÿéšå¤šæ•°ç†æ€§çŽ©å®¶çš„åˆ¤æ–­ã€‚`,villager:`ä½ æ­£åœ¨å‚ä¸Žä¸€åœºç‹¼äººæ€æ¸¸æˆã€‚

ã€ä½ çš„èº«ä»½ã€‘
ä½ æ˜¯æ‘æ°‘ï¼Œåº§ä½å·ä¸º {{seatIndex}}ï¼Œåå­—æ˜¯ {{playerName}}ã€‚
ä½ æ˜¯å¥½äººé˜µè¥ï¼Œæ²¡æœ‰ä»»ä½•ç‰¹æ®ŠæŠ€èƒ½ï¼Œåªèƒ½ä¾é æŽ¨ç†å’ŒæŠ•ç¥¨æ¥å¸®åŠ©å¥½äººé˜µè¥å–èƒœã€‚

ã€ä½ çš„èƒœåˆ©ç›®æ ‡ã€‘
å¸®åŠ©å¥½äººé˜µè¥æ‰¾å‡ºå¹¶æ”¾é€æ‰€æœ‰ç‹¼äººã€‚

ã€ä½ æŽŒæ¡çš„ä¿¡æ¯ã€‘
ä½ åœ¨å¤œæ™šæ²¡æœ‰ä»»ä½•è¡ŒåŠ¨ï¼Œä¹Ÿä¸çŸ¥é“å¤œæ™šå‘ç”Ÿäº†ä»€ä¹ˆã€‚
ä½ åªèƒ½é€šè¿‡ç™½å¤©å…¬å¼€çš„ä¿¡æ¯æ¥æŽ¨ç†ï¼š
- ç³»ç»Ÿå…¬å‘Šï¼ˆè°æ­»äº†ã€æ­»å› ï¼‰
- æ‰€æœ‰çŽ©å®¶çš„å‘è¨€å†…å®¹
- æ¯è½®çš„æŠ•ç¥¨ç»“æžœ
- çŽ©å®¶åœ¨é«˜åŽ‹ä¸‹çš„ååº”å’Œè¡Œä¸ºæ¨¡å¼

ã€ç™½å¤©å‘è¨€è§„åˆ™ã€‘
1. ä¸è¦å‡è£…æ‹¥æœ‰ä½ æ²¡æœ‰çš„ä¿¡æ¯ï¼Œä¿æŒçœŸå®žçš„"ä¿¡æ¯ç›²"è§†è§’
2. ä¸“æ³¨åˆ†æžä»–äººå‘è¨€ï¼šè°åœ¨é€ƒé¿é—®é¢˜ï¼Ÿè°åœ¨ä¸»åŠ¨å¸¦èŠ‚å¥ï¼Ÿè°çš„é€»è¾‘å‰åŽçŸ›ç›¾ï¼Ÿ
3. æå‡ºåˆç†çš„æ€€ç–‘ï¼Œä½†ä¿æŒå¼€æ”¾å¿ƒæ€ï¼Œä¸è½»æ˜“è¢«ä»–äººå¸¦è·‘
4. ç§¯æžå‚ä¸Žè®¨è®ºï¼Œæ‘æ°‘çš„å£°éŸ³æ˜¯å¥½äººé˜µè¥çš„é‡è¦åŠ›é‡

ã€æŽ¨ç†æ–¹å‘ã€‘
- å…³æ³¨è°åœ¨ä¸ºè¢«æ€€ç–‘çš„äººè¾©æŠ¤ï¼ˆå¯èƒ½æ˜¯é˜Ÿå‹ï¼‰
- å…³æ³¨è°åœ¨åˆ»æ„è½¬ç§»è¯é¢˜æˆ–æ”»å‡»å‘è¨€è°¨æ…Žçš„çŽ©å®¶
- å…³æ³¨è°çš„æŠ•ç¥¨é€‰æ‹©ä¸Žä¸»æµé€»è¾‘ä¸ç¬¦
- å‚è€ƒç¥žèŒè§’è‰²ï¼ˆè‹¥å…¬å¼€ï¼‰æä¾›çš„ä¿¡æ¯

ã€å‘è¨€é£Žæ ¼ã€‘
- æœ´å®žç›´æŽ¥ï¼Œè¯´å‡ºè‡ªå·±çœŸå®žçš„åˆ¤æ–­
- æœ‰æ—¶ä¼šçŠ¯é”™ï¼Œæœ‰æ—¶ä¼šè¢«è¯¯å¯¼ï¼Œè¿™æ˜¯æ­£å¸¸çš„
- ä¸è½»æ˜“è¢«æå“æˆ–åŽ‹åˆ¶ï¼ŒåšæŒè‡ªå·±çš„åˆç†åˆ¤æ–­

ã€æŠ•ç¥¨è§„åˆ™ã€‘
ç»¼åˆæ‰€æœ‰å‘è¨€ä¿¡æ¯ï¼ŒæŠ•ç¥¨ç»™ä½ è®¤ä¸ºæœ€å¯ç–‘çš„çŽ©å®¶ã€‚
è‹¥æ— æ³•åˆ¤æ–­ï¼Œå‚è€ƒå…¶ä»–å¯ä¿¡çŽ©å®¶çš„è§‚ç‚¹ï¼Œä½†ä¸è¦ç›²ç›®è·Ÿç¥¨ã€‚`};function yi(r,e,t){const n=t.filter(l=>l.isAlive),s=t.filter(l=>!l.isAlive),i=n.map(l=>l.id).join("ã€")||"æ— ",a=s.map(l=>l.id).join("ã€")||"æ— ",o=e.role==="werewolf"?t.filter(l=>l.role==="werewolf"&&l.id!==e.id).map(l=>l.id).join("ã€"):"",u=sw.replace("{{totalPlayers}}",String(t.length)).replace("{{aliveList}}",i).replace("{{deadList}}",a),c=r.replace(/\{\{playerName\}\}/g,e.name).replace(/\{\{seatIndex\}\}/g,String(e.seatIndex)).replace(/\{\{totalPlayers\}\}/g,String(t.length)).replace(/\{\{aliveList\}\}/g,i).replace(/\{\{wolfTeammates\}\}/g,o);return`${u}

${c}`}function _i(r,e){const t=[];for(const n of e.rounds)n.nightEvents&&(r.role==="werewolf"&&(n.nightEvents.wolfDiscussion?.length&&t.push(...n.nightEvents.wolfDiscussion),n.nightEvents.killDecision?.content&&t.push(n.nightEvents.killDecision)),r.role==="seer"&&n.nightEvents.seerActions?.length&&t.push(...n.nightEvents.seerActions),r.role==="witch"&&(n.nightEvents.witchNotification?.content&&t.push(n.nightEvents.witchNotification),n.nightEvents.witchAction?.content&&t.push(n.nightEvents.witchAction)),n.dayAnnouncement?.content&&t.push(n.dayAnnouncement),n.speeches?.length&&t.push(...n.speeches),n.voteResults?.length&&t.push(...n.voteResults),n.lastWords?.content&&t.push(n.lastWords));return t}const mc="RFC3986",gc={RFC1738:r=>String(r).replace(/%20/g,"+"),RFC3986:r=>String(r)},aw="RFC1738",ow=Array.isArray,Yt=(()=>{const r=[];for(let e=0;e<256;++e)r.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return r})(),Eo=1024,uw=(r,e,t,n,s)=>{if(r.length===0)return r;let i=r;if(typeof r=="symbol"?i=Symbol.prototype.toString.call(r):typeof r!="string"&&(i=String(r)),t==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<i.length;o+=Eo){const u=i.length>=Eo?i.slice(o,o+Eo):i,c=[];for(let l=0;l<u.length;++l){let d=u.charCodeAt(l);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||s===aw&&(d===40||d===41)){c[c.length]=u.charAt(l);continue}if(d<128){c[c.length]=Yt[d];continue}if(d<2048){c[c.length]=Yt[192|d>>6]+Yt[128|d&63];continue}if(d<55296||d>=57344){c[c.length]=Yt[224|d>>12]+Yt[128|d>>6&63]+Yt[128|d&63];continue}l+=1,d=65536+((d&1023)<<10|u.charCodeAt(l)&1023),c[c.length]=Yt[240|d>>18]+Yt[128|d>>12&63]+Yt[128|d>>6&63]+Yt[128|d&63]}a+=c.join("")}return a};function cw(r){return!r||typeof r!="object"?!1:!!(r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer(r))}function jd(r,e){if(ow(r)){const t=[];for(let n=0;n<r.length;n+=1)t.push(e(r[n]));return t}return e(r)}const lw=Object.prototype.hasOwnProperty,Mp={brackets(r){return String(r)+"[]"},comma:"comma",indices(r,e){return String(r)+"["+e+"]"},repeat(r){return String(r)}},en=Array.isArray,dw=Array.prototype.push,Dp=function(r,e){dw.apply(r,en(e)?e:[e])},fw=Date.prototype.toISOString,Ne={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:uw,encodeValuesOnly:!1,format:mc,formatter:gc[mc],indices:!1,serializeDate(r){return fw.call(r)},skipNulls:!1,strictNullHandling:!1};function hw(r){return typeof r=="string"||typeof r=="number"||typeof r=="boolean"||typeof r=="symbol"||typeof r=="bigint"}const xo={};function Up(r,e,t,n,s,i,a,o,u,c,l,d,f,h,p,m,g,y){let _=r,b=y,v=0,w=!1;for(;(b=b.get(xo))!==void 0&&!w;){const k=b.get(r);if(v+=1,typeof k<"u"){if(k===v)throw new RangeError("Cyclic object value");w=!0}typeof b.get(xo)>"u"&&(v=0)}if(typeof c=="function"?_=c(e,_):_ instanceof Date?_=f?.(_):t==="comma"&&en(_)&&(_=jd(_,function(k){return k instanceof Date?f?.(k):k})),_===null){if(i)return u&&!m?u(e,Ne.encoder,g,"key",h):e;_=""}if(hw(_)||cw(_)){if(u){const k=m?e:u(e,Ne.encoder,g,"key",h);return[p?.(k)+"="+p?.(u(_,Ne.encoder,g,"value",h))]}return[p?.(e)+"="+p?.(String(_))]}const E=[];if(typeof _>"u")return E;let T;if(t==="comma"&&en(_))m&&u&&(_=jd(_,u)),T=[{value:_.length>0?_.join(",")||null:void 0}];else if(en(c))T=c;else{const k=Object.keys(_);T=l?k.sort(l):k}const O=o?String(e).replace(/\./g,"%2E"):String(e),x=n&&en(_)&&_.length===1?O+"[]":O;if(s&&en(_)&&_.length===0)return x+"[]";for(let k=0;k<T.length;++k){const C=T[k],J=typeof C=="object"&&typeof C.value<"u"?C.value:_[C];if(a&&J===null)continue;const pe=d&&o?C.replace(/\./g,"%2E"):C,$=en(_)?typeof t=="function"?t(x,pe):x:x+(d?"."+pe:"["+pe+"]");y.set(r,v);const R=new WeakMap;R.set(xo,y),Dp(E,Up(J,$,t,n,s,i,a,o,t==="comma"&&m&&en(_)?null:u,c,l,d,f,h,p,m,g,R))}return E}function pw(r=Ne){if(typeof r.allowEmptyArrays<"u"&&typeof r.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof r.encodeDotInKeys<"u"&&typeof r.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(r.encoder!==null&&typeof r.encoder<"u"&&typeof r.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=r.charset||Ne.charset;if(typeof r.charset<"u"&&r.charset!=="utf-8"&&r.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=mc;if(typeof r.format<"u"){if(!lw.call(gc,r.format))throw new TypeError("Unknown format option provided.");t=r.format}const n=gc[t];let s=Ne.filter;(typeof r.filter=="function"||en(r.filter))&&(s=r.filter);let i;if(r.arrayFormat&&r.arrayFormat in Mp?i=r.arrayFormat:"indices"in r?i=r.indices?"indices":"repeat":i=Ne.arrayFormat,"commaRoundTrip"in r&&typeof r.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=typeof r.allowDots>"u"?r.encodeDotInKeys?!0:Ne.allowDots:!!r.allowDots;return{addQueryPrefix:typeof r.addQueryPrefix=="boolean"?r.addQueryPrefix:Ne.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof r.allowEmptyArrays=="boolean"?!!r.allowEmptyArrays:Ne.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof r.charsetSentinel=="boolean"?r.charsetSentinel:Ne.charsetSentinel,commaRoundTrip:!!r.commaRoundTrip,delimiter:typeof r.delimiter>"u"?Ne.delimiter:r.delimiter,encode:typeof r.encode=="boolean"?r.encode:Ne.encode,encodeDotInKeys:typeof r.encodeDotInKeys=="boolean"?r.encodeDotInKeys:Ne.encodeDotInKeys,encoder:typeof r.encoder=="function"?r.encoder:Ne.encoder,encodeValuesOnly:typeof r.encodeValuesOnly=="boolean"?r.encodeValuesOnly:Ne.encodeValuesOnly,filter:s,format:t,formatter:n,serializeDate:typeof r.serializeDate=="function"?r.serializeDate:Ne.serializeDate,skipNulls:typeof r.skipNulls=="boolean"?r.skipNulls:Ne.skipNulls,sort:typeof r.sort=="function"?r.sort:null,strictNullHandling:typeof r.strictNullHandling=="boolean"?r.strictNullHandling:Ne.strictNullHandling}}function mw(r,e={}){let t=r;const n=pw(e);let s,i;typeof n.filter=="function"?(i=n.filter,t=i("",t)):en(n.filter)&&(i=n.filter,s=i);const a=[];if(typeof t!="object"||t===null)return"";const o=Mp[n.arrayFormat],u=o==="comma"&&n.commaRoundTrip;s||(s=Object.keys(t)),n.sort&&s.sort(n.sort);const c=new WeakMap;for(let f=0;f<s.length;++f){const h=s[f];n.skipNulls&&t[h]===null||Dp(a,Up(t[h],h,o,u,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,c))}const l=a.join(n.delimiter);let d=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}const Or="4.104.0";let Ld=!1,Ts,Fp,Bp,yc,zp,Gp,qp,Hp,Vp;function gw(r,e={auto:!1}){if(Ld)throw new Error(`you must \`import 'openai/shims/${r.kind}'\` before importing anything else from openai`);if(Ts)throw new Error(`can't \`import 'openai/shims/${r.kind}'\` after \`import 'openai/shims/${Ts}'\``);Ld=e.auto,Ts=r.kind,Fp=r.fetch,Bp=r.FormData,yc=r.File,zp=r.ReadableStream,Gp=r.getMultipartRequestOptions,qp=r.getDefaultAgent,Hp=r.fileFromPath,Vp=r.isFsReadStream}class yw{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function _w({manuallyImported:r}={}){const e=r?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,n,s,i;try{t=fetch,n=Request,s=Response,i=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:s,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new yw(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:a=>!1}}const Wp=()=>{Ts||gw(_w(),{auto:!0})};Wp();class Z extends Error{}class We extends Z{constructor(e,t,n,s){super(`${We.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.request_id=s?.["x-request-id"],this.error=t;const i=t;this.code=i?.code,this.param=i?.param,this.type=i?.type}static makeMessage(e,t,n){const s=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e||!s)return new Ba({message:n,cause:bc(t)});const i=t?.error;return e===400?new Zp(e,i,n,s):e===401?new Jp(e,i,n,s):e===403?new Kp(e,i,n,s):e===404?new Xp(e,i,n,s):e===409?new Yp(e,i,n,s):e===422?new Qp(e,i,n,s):e===429?new em(e,i,n,s):e>=500?new tm(e,i,n,s):new We(e,i,n,s)}}class bt extends We{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Ba extends We{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class za extends Ba{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Zp extends We{}class Jp extends We{}class Kp extends We{}class Xp extends We{}class Yp extends We{}class Qp extends We{}class em extends We{}class tm extends We{}class nm extends Z{constructor(){super("Could not parse response content as the length limit was reached")}}class rm extends Z{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var bi=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},Zn=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},pt;class Ga{constructor(){pt.set(this,void 0),this.buffer=new Uint8Array,bi(this,pt,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let n=new Uint8Array(this.buffer.length+t.length);n.set(this.buffer),n.set(t,this.buffer.length),this.buffer=n;const s=[];let i;for(;(i=bw(this.buffer,Zn(this,pt,"f")))!=null;){if(i.carriage&&Zn(this,pt,"f")==null){bi(this,pt,i.index,"f");continue}if(Zn(this,pt,"f")!=null&&(i.index!==Zn(this,pt,"f")+1||i.carriage)){s.push(this.decodeText(this.buffer.slice(0,Zn(this,pt,"f")-1))),this.buffer=this.buffer.slice(Zn(this,pt,"f")),bi(this,pt,null,"f");continue}const a=Zn(this,pt,"f")!==null?i.preceding-1:i.preceding,o=this.decodeText(this.buffer.slice(0,a));s.push(o),this.buffer=this.buffer.slice(i.index),bi(this,pt,null,"f")}return s}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Z(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Z(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Z("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}pt=new WeakMap;Ga.NEWLINE_CHARS=new Set([`
`,"\r"]);Ga.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function bw(r,e){for(let s=e??0;s<r.length;s++){if(r[s]===10)return{preceding:s,index:s+1,carriage:!1};if(r[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function ww(r){for(let n=0;n<r.length-1;n++){if(r[n]===10&&r[n+1]===10||r[n]===13&&r[n+1]===13)return n+2;if(r[n]===13&&r[n+1]===10&&n+3<r.length&&r[n+2]===13&&r[n+3]===10)return n+4}return-1}function sm(r){if(r[Symbol.asyncIterator])return r;const e=r.getReader();return{async next(){try{const t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class nn{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*s(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let i=!1;try{for await(const a of vw(e,t))if(!i){if(a.data.startsWith("[DONE]")){i=!0;continue}if(a.event===null||a.event.startsWith("response.")||a.event.startsWith("transcript.")){let o;try{o=JSON.parse(a.data)}catch(u){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),u}if(o&&o.error)throw new We(void 0,o.error,void 0,fm(e.headers));yield o}else{let o;try{o=JSON.parse(a.data)}catch(u){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),u}if(a.event=="error")throw new We(void 0,o.error,o.message,void 0);yield{event:a.event,data:o}}}i=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{i||t.abort()}}return new nn(s,t)}static fromReadableStream(e,t){let n=!1;async function*s(){const a=new Ga,o=sm(e);for await(const u of o)for(const c of a.decode(u))yield c;for(const u of a.flush())yield u}async function*i(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let a=!1;try{for await(const o of s())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new nn(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),s=i=>({next:()=>{if(i.length===0){const a=n.next();e.push(a),t.push(a)}return i.shift()}});return[new nn(()=>s(e),this.controller),new nn(()=>s(t),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new zp({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:i,done:a}=await t.next();if(a)return s.close();const o=n.encode(JSON.stringify(i)+`
`);s.enqueue(o)}catch(i){s.error(i)}},async cancel(){await t.return?.()}})}}async function*vw(r,e){if(!r.body)throw e.abort(),new Z("Attempted to iterate over a response with no body");const t=new Ew,n=new Ga,s=sm(r.body);for await(const i of Sw(s))for(const a of n.decode(i)){const o=t.decode(a);o&&(yield o)}for(const i of n.flush()){const a=t.decode(i);a&&(yield a)}}async function*Sw(r){let e=new Uint8Array;for await(const t of r){if(t==null)continue;const n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let s=new Uint8Array(e.length+n.length);s.set(e),s.set(n,e.length),e=s;let i;for(;(i=ww(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}class Ew{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=xw(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}}function xw(r,e){const t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}const im=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function",am=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&qa(r),qa=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function",Ow=r=>am(r)||im(r)||Vp(r);async function om(r,e,t){if(r=await r,am(r))return r;if(im(r)){const s=await r.blob();e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=qa(s)?[await s.arrayBuffer()]:[s];return new yc(i,e,t)}const n=await kw(r);if(e||(e=Aw(r)??"unknown_file"),!t?.type){const s=n[0]?.type;typeof s=="string"&&(t={...t,type:s})}return new yc(n,e,t)}async function kw(r){let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(qa(r))e.push(await r.arrayBuffer());else if(Tw(r))for await(const t of r)e.push(t);else throw new Error(`Unexpected data type: ${typeof r}; constructor: ${r?.constructor?.name}; props: ${Pw(r)}`);return e}function Pw(r){return`[${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}function Aw(r){return Oo(r.name)||Oo(r.filename)||Oo(r.path)?.split(/[\\/]/).pop()}const Oo=r=>{if(typeof r=="string")return r;if(typeof Buffer<"u"&&r instanceof Buffer)return String(r)},Tw=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function",Md=r=>r&&typeof r=="object"&&r.body&&r[Symbol.toStringTag]==="MultipartBody",ar=async r=>{const e=await Iw(r.body);return Gp(e,r)},Iw=async r=>{const e=new Bp;return await Promise.all(Object.entries(r||{}).map(([t,n])=>_c(e,t,n))),e},_c=async(r,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")r.append(e,String(t));else if(Ow(t)){const n=await om(t);r.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>_c(r,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,s])=>_c(r,`${e}[${n}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var um={},Rw=function(r,e,t,n,s){if(typeof e=="function"?r!==e||!0:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(r,t),t},Cw=function(r,e,t,n){if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},wi;Wp();async function cm(r){const{response:e}=r;if(r.options.stream)return Ln("response",e.status,e.url,e.headers,e.body),r.options.__streamClass?r.options.__streamClass.fromSSEResponse(e,r.controller):nn.fromSSEResponse(e,r.controller);if(e.status===204)return null;if(r.options.__binaryResponse)return e;const n=e.headers.get("content-type")?.split(";")[0]?.trim();if(n?.includes("application/json")||n?.endsWith("+json")){const a=await e.json();return Ln("response",e.status,e.url,e.headers,a),lm(a,e)}const i=await e.text();return Ln("response",e.status,e.url,e.headers,i),i}function lm(r,e){return!r||typeof r!="object"||Array.isArray(r)?r:Object.defineProperty(r,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class Ha extends Promise{constructor(e,t=cm){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Ha(this.responsePromise,async t=>lm(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class $w{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:s,fetch:i}){this.baseURL=e,this.maxRetries=ko("maxRetries",t),this.timeout=ko("timeout",n),this.httpAgent=s,this.fetch=i??Fp}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Dw(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${zw()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async s=>{const i=s&&qa(s?.body)?new DataView(await s.body.arrayBuffer()):s?.body instanceof DataView?s.body:s?.body instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s?.body)?new DataView(s.body.buffer):s?.body;return{method:e,path:t,...s,body:i}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const n={...e},{method:s,path:i,query:a,headers:o={}}=n,u=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:Md(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,c=this.calculateContentLength(u),l=this.buildURL(i,a);"timeout"in n&&ko("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const d=n.httpAgent??this.httpAgent??qp(l),f=n.timeout+1e3;typeof d?.options?.timeout=="number"&&f>(d.options.timeout??0)&&(d.options.timeout=f),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);const h=this.buildHeaders({options:n,headers:o,contentLength:c,retryCount:t});return{req:{method:s,...u&&{body:u},headers:h,...d&&{agent:d},signal:n.signal??null},url:l,timeout:n.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:s}){const i={};n&&(i["content-length"]=n);const a=this.defaultHeaders(e);return Bd(i,a),Bd(i,t),Md(e.body)&&Ts!=="node"&&delete i["content-type"],Si(a,"x-stainless-retry-count")===void 0&&Si(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(s)),Si(a,"x-stainless-timeout")===void 0&&Si(t,"x-stainless-timeout")===void 0&&e.timeout&&(i["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,s){return We.generate(e,t,n,s)}request(e,t=null){return new Ha(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,s=n.maxRetries??this.maxRetries;t==null&&(t=s),await this.prepareOptions(n);const{req:i,url:a,timeout:o}=this.buildRequest(n,{retryCount:s-t});if(await this.prepareRequest(i,{url:a,options:n}),Ln("request",a,n,i.headers),n.signal?.aborted)throw new bt;const u=new AbortController,c=await this.fetchWithTimeout(a,i,o,u).catch(bc);if(c instanceof Error){if(n.signal?.aborted)throw new bt;if(t)return this.retryRequest(n,t);throw c.name==="AbortError"?new za:new Ba({cause:c})}const l=fm(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const g=`retrying, ${t} attempts remaining`;return Ln(`response (error; ${g})`,c.status,a,l),this.retryRequest(n,t,l)}const d=await c.text().catch(g=>bc(g).message),f=Uw(d),h=f?void 0:d;throw Ln(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,a,l,h),this.makeStatusError(c.status,f,h,l)}return{response:c,options:n,controller:u}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new Nw(this,n,e)}buildURL(e,t){const n=Bw(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return hm(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new Z(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,s){const{signal:i,...a}=t||{};i&&i.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),n),u={signal:s.signal,...a};return u.method&&(u.method=u.method.toUpperCase()),this.fetch.call(void 0,e,u).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let s;const i=n?.["retry-after-ms"];if(i){const o=parseFloat(i);Number.isNaN(o)||(s=o)}const a=n?.["retry-after"];if(a&&!s){const o=parseFloat(a);Number.isNaN(o)?s=Date.parse(a)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,o)}return await ri(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Or}`}}class dm{constructor(e,t,n,s){wi.set(this,void 0),Rw(this,wi,e),this.options=s,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new Z("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[s,i]of n)e.url.searchParams.set(s,i);t.query=void 0,t.path=e.url.toString()}return await Cw(this,wi,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(wi=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Nw extends Ha{constructor(e,t,n){super(t,async s=>new n(e,s.response,await cm(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const fm=r=>new Proxy(Object.fromEntries(r.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),jw={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Ee=r=>typeof r=="object"&&r!==null&&!hm(r)&&Object.keys(r).every(e=>pm(jw,e)),Lw=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":Ud(Deno.build.os),"X-Stainless-Arch":Dd(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":Ud(process.platform),"X-Stainless-Arch":Dd(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const r=Mw();return r?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${r.browser}`,"X-Stainless-Runtime-Version":r.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Or,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Mw(){if(typeof navigator>"u"||!navigator)return null;const r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of r){const n=t.exec(navigator.userAgent);if(n){const s=n[1]||0,i=n[2]||0,a=n[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}const Dd=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",Ud=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown");let Fd;const Dw=()=>Fd??(Fd=Lw()),Uw=r=>{try{return JSON.parse(r)}catch{return}},Fw=/^[a-z][a-z0-9+.-]*:/i,Bw=r=>Fw.test(r),ri=r=>new Promise(e=>setTimeout(e,r)),ko=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new Z(`${r} must be an integer`);if(e<0)throw new Z(`${r} must be a positive integer`);return e},bc=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null)try{return new Error(JSON.stringify(r))}catch{}return new Error(r)},vi=r=>{if(typeof process<"u")return um?.[r]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(r)?.trim()};function hm(r){if(!r)return!0;for(const e in r)return!1;return!0}function pm(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function Bd(r,e){for(const t in e){if(!pm(e,t))continue;const n=t.toLowerCase();if(!n)continue;const s=e[t];s===null?delete r[n]:s!==void 0&&(r[n]=s)}}const zd=new Set(["authorization","api-key"]);function Ln(r,...e){if(typeof process<"u"&&um?.DEBUG==="true"){const t=e.map(n=>{if(!n)return n;if(n.headers){const i={...n,headers:{...n.headers}};for(const a in n.headers)zd.has(a.toLowerCase())&&(i.headers[a]="REDACTED");return i}let s=null;for(const i in n)zd.has(i.toLowerCase())&&(s??(s={...n}),s[i]="REDACTED");return s??n});console.log(`OpenAI:DEBUG:${r}`,...t)}}const zw=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{const e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),Gw=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",qw=r=>typeof r?.get=="function",Si=(r,e)=>{const t=e.toLowerCase();if(qw(r)){const n=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(s,i,a)=>i+a.toUpperCase());for(const s of[e,t,e.toUpperCase(),n]){const i=r.get(s);if(i)return i}}for(const[n,s]of Object.entries(r))if(n.toLowerCase()===t)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${e} header, using the first entry.`),s[0]):s},Hw=r=>{if(typeof Buffer<"u"){const e=Buffer.from(r,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(r),t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return Array.from(new Float32Array(n.buffer))}};function Po(r){return r!=null&&typeof r=="object"&&!Array.isArray(r)}class Va extends dm{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class De extends dm{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class K{constructor(e){this._client=e}}let mm=class extends K{list(e,t={},n){return Ee(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,Vw,{query:t,...n})}},Wa=class extends K{constructor(){super(...arguments),this.messages=new mm(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return Ee(e)?this.list({},e):this._client.getAPIList("/chat/completions",Za,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}};class Za extends De{}class Vw extends De{}Wa.ChatCompletionsPage=Za;Wa.Messages=mm;let Ja=class extends K{constructor(){super(...arguments),this.completions=new Wa(this._client)}};Ja.Completions=Wa;Ja.ChatCompletionsPage=Za;class gm extends K{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class ym extends K{create(e,t){return this._client.post("/audio/transcriptions",ar({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class _m extends K{create(e,t){return this._client.post("/audio/translations",ar({body:e,...t,__metadata:{model:e.model}}))}}class si extends K{constructor(){super(...arguments),this.transcriptions=new ym(this._client),this.translations=new _m(this._client),this.speech=new gm(this._client)}}si.Transcriptions=ym;si.Translations=_m;si.Speech=gm;class nl extends K{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return Ee(e)?this.list({},e):this._client.getAPIList("/batches",rl,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class rl extends De{}nl.BatchesPage=rl;var Gt=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},ve=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},wc,Ki,Xi,bs,ws,Yi,vs,hn,Ss,ga,ya,kr,bm;class sl{constructor(){wc.add(this),this.controller=new AbortController,Ki.set(this,void 0),Xi.set(this,()=>{}),bs.set(this,()=>{}),ws.set(this,void 0),Yi.set(this,()=>{}),vs.set(this,()=>{}),hn.set(this,{}),Ss.set(this,!1),ga.set(this,!1),ya.set(this,!1),kr.set(this,!1),Gt(this,Ki,new Promise((e,t)=>{Gt(this,Xi,e,"f"),Gt(this,bs,t,"f")}),"f"),Gt(this,ws,new Promise((e,t)=>{Gt(this,Yi,e,"f"),Gt(this,vs,t,"f")}),"f"),ve(this,Ki,"f").catch(()=>{}),ve(this,ws,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},ve(this,wc,"m",bm).bind(this))},0)}_connected(){this.ended||(ve(this,Xi,"f").call(this),this._emit("connect"))}get ended(){return ve(this,Ss,"f")}get errored(){return ve(this,ga,"f")}get aborted(){return ve(this,ya,"f")}abort(){this.controller.abort()}on(e,t){return(ve(this,hn,"f")[e]||(ve(this,hn,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=ve(this,hn,"f")[e];if(!n)return this;const s=n.findIndex(i=>i.listener===t);return s>=0&&n.splice(s,1),this}once(e,t){return(ve(this,hn,"f")[e]||(ve(this,hn,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{Gt(this,kr,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){Gt(this,kr,!0,"f"),await ve(this,ws,"f")}_emit(e,...t){if(ve(this,Ss,"f"))return;e==="end"&&(Gt(this,Ss,!0,"f"),ve(this,Yi,"f").call(this));const n=ve(this,hn,"f")[e];if(n&&(ve(this,hn,"f")[e]=n.filter(s=>!s.once),n.forEach(({listener:s})=>s(...t))),e==="abort"){const s=t[0];!ve(this,kr,"f")&&!n?.length&&Promise.reject(s),ve(this,bs,"f").call(this,s),ve(this,vs,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=t[0];!ve(this,kr,"f")&&!n?.length&&Promise.reject(s),ve(this,bs,"f").call(this,s),ve(this,vs,"f").call(this,s),this._emit("end")}}_emitFinal(){}}Ki=new WeakMap,Xi=new WeakMap,bs=new WeakMap,ws=new WeakMap,Yi=new WeakMap,vs=new WeakMap,hn=new WeakMap,Ss=new WeakMap,ga=new WeakMap,ya=new WeakMap,kr=new WeakMap,wc=new WeakSet,bm=function(e){if(Gt(this,ga,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new bt),e instanceof bt)return Gt(this,ya,!0,"f"),this._emit("abort",e);if(e instanceof Z)return this._emit("error",e);if(e instanceof Error){const t=new Z(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Z(String(e)))};var G=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},ht=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},He,vc,tn,Qi,qt,Yn,Ar,Kn,_a,gt,ea,ta,Is,Es,xs,Gd,qd,Hd,Vd,Wd,Zd,Jd;class Vt extends sl{constructor(){super(...arguments),He.add(this),vc.set(this,[]),tn.set(this,{}),Qi.set(this,{}),qt.set(this,void 0),Yn.set(this,void 0),Ar.set(this,void 0),Kn.set(this,void 0),_a.set(this,void 0),gt.set(this,void 0),ea.set(this,void 0),ta.set(this,void 0),Is.set(this,void 0)}[(vc=new WeakMap,tn=new WeakMap,Qi=new WeakMap,qt=new WeakMap,Yn=new WeakMap,Ar=new WeakMap,Kn=new WeakMap,_a=new WeakMap,gt=new WeakMap,ea=new WeakMap,ta=new WeakMap,Is=new WeakMap,He=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",s=>{const i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(const s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(const i of t)i.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(const i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Vt;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=nn.fromReadableStream(e,this.controller);for await(const i of s)G(this,He,"m",Es).call(this,i);if(s.controller.signal?.aborted)throw new bt;return this._addRun(G(this,He,"m",xs).call(this))}toReadableStream(){return new nn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,s,i){const a=new Vt;return a._run(()=>a._runToolAssistantStream(e,t,n,s,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,n,s,i){const a=i?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const o={...s,stream:!0},u=await e.submitToolOutputs(t,n,o,{...i,signal:this.controller.signal});this._connected();for await(const c of u)G(this,He,"m",Es).call(this,c);if(u.controller.signal?.aborted)throw new bt;return this._addRun(G(this,He,"m",xs).call(this))}static createThreadAssistantStream(e,t,n){const s=new Vt;return s._run(()=>s._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,t,n,s){const i=new Vt;return i._run(()=>i._runAssistantStream(e,t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return G(this,ea,"f")}currentRun(){return G(this,ta,"f")}currentMessageSnapshot(){return G(this,qt,"f")}currentRunStepSnapshot(){return G(this,Is,"f")}async finalRunSteps(){return await this.done(),Object.values(G(this,tn,"f"))}async finalMessages(){return await this.done(),Object.values(G(this,Qi,"f"))}async finalRun(){if(await this.done(),!G(this,Yn,"f"))throw Error("Final run was not received.");return G(this,Yn,"f")}async _createThreadAssistantStream(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...t,stream:!0},a=await e.createAndRun(i,{...n,signal:this.controller.signal});this._connected();for await(const o of a)G(this,He,"m",Es).call(this,o);if(a.controller.signal?.aborted)throw new bt;return this._addRun(G(this,He,"m",xs).call(this))}async _createAssistantStream(e,t,n,s){const i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},o=await e.create(t,a,{...s,signal:this.controller.signal});this._connected();for await(const u of o)G(this,He,"m",Es).call(this,u);if(o.controller.signal?.aborted)throw new bt;return this._addRun(G(this,He,"m",xs).call(this))}static accumulateDelta(e,t){for(const[n,s]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=s;continue}let i=e[n];if(i==null){e[n]=s;continue}if(n==="index"||n==="type"){e[n]=s;continue}if(typeof i=="string"&&typeof s=="string")i+=s;else if(typeof i=="number"&&typeof s=="number")i+=s;else if(Po(i)&&Po(s))i=this.accumulateDelta(i,s);else if(Array.isArray(i)&&Array.isArray(s)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...s);continue}for(const a of s){if(!Po(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);const o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const u=i[o];u==null?i.push(a):i[o]=this.accumulateDelta(u,a)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${s}, accValue: ${i}`);e[n]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,s){return await this._createAssistantStream(t,e,n,s)}async _runToolAssistantStream(e,t,n,s,i){return await this._createToolAssistantStream(n,e,t,s,i)}}Es=function(e){if(!this.ended)switch(ht(this,ea,e,"f"),G(this,He,"m",Hd).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":G(this,He,"m",Jd).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":G(this,He,"m",qd).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":G(this,He,"m",Gd).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},xs=function(){if(this.ended)throw new Z("stream has ended, this shouldn't happen");if(!G(this,Yn,"f"))throw Error("Final run has not been received");return G(this,Yn,"f")},Gd=function(e){const[t,n]=G(this,He,"m",Wd).call(this,e,G(this,qt,"f"));ht(this,qt,t,"f"),G(this,Qi,"f")[t.id]=t;for(const s of n){const i=t.content[s.index];i?.type=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const s of e.data.delta.content){if(s.type=="text"&&s.text){let i=s.text,a=t.content[s.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=G(this,Ar,"f")){if(G(this,Kn,"f"))switch(G(this,Kn,"f").type){case"text":this._emit("textDone",G(this,Kn,"f").text,G(this,qt,"f"));break;case"image_file":this._emit("imageFileDone",G(this,Kn,"f").image_file,G(this,qt,"f"));break}ht(this,Ar,s.index,"f")}ht(this,Kn,t.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(G(this,Ar,"f")!==void 0){const s=e.data.content[G(this,Ar,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,G(this,qt,"f"));break;case"text":this._emit("textDone",s.text,G(this,qt,"f"));break}}G(this,qt,"f")&&this._emit("messageDone",e.data),ht(this,qt,void 0,"f")}},qd=function(e){const t=G(this,He,"m",Vd).call(this,e);switch(ht(this,Is,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&n.step_details.type=="tool_calls"&&n.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const i of n.step_details.tool_calls)i.index==G(this,_a,"f")?this._emit("toolCallDelta",i,t.step_details.tool_calls[i.index]):(G(this,gt,"f")&&this._emit("toolCallDone",G(this,gt,"f")),ht(this,_a,i.index,"f"),ht(this,gt,t.step_details.tool_calls[i.index],"f"),G(this,gt,"f")&&this._emit("toolCallCreated",G(this,gt,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ht(this,Is,void 0,"f"),e.data.step_details.type=="tool_calls"&&G(this,gt,"f")&&(this._emit("toolCallDone",G(this,gt,"f")),ht(this,gt,void 0,"f")),this._emit("runStepDone",e.data,t);break}},Hd=function(e){G(this,vc,"f").push(e),this._emit("event",e)},Vd=function(e){switch(e.event){case"thread.run.step.created":return G(this,tn,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=G(this,tn,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const s=Vt.accumulateDelta(t,n.delta);G(this,tn,"f")[e.data.id]=s}return G(this,tn,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":G(this,tn,"f")[e.data.id]=e.data;break}if(G(this,tn,"f")[e.data.id])return G(this,tn,"f")[e.data.id];throw new Error("No snapshot available")},Wd=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const i of s.delta.content)if(i.index in t.content){let a=t.content[i.index];t.content[i.index]=G(this,He,"m",Zd).call(this,i,a)}else t.content[i.index]=i,n.push(i);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Zd=function(e,t){return Vt.accumulateDelta(t,e)},Jd=function(e){switch(ht(this,ta,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":ht(this,Yn,e.data,"f"),G(this,gt,"f")&&(this._emit("toolCallDone",G(this,gt,"f")),ht(this,gt,void 0,"f"));break}};class il extends K{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return Ee(e)?this.list({},e):this._client.getAPIList("/assistants",al,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class al extends De{}il.AssistantsPage=al;function Kd(r){return typeof r.parse=="function"}const Nr=r=>r?.role==="assistant",wm=r=>r?.role==="function",vm=r=>r?.role==="tool";function Ww(r,e){const t={...r};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function ol(r){return r?.$brand==="auto-parseable-response-format"}function Zw(r,{parser:e,callback:t}){const n={...r};return Object.defineProperties(n,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:t,enumerable:!1}}),n}function ii(r){return r?.$brand==="auto-parseable-tool"}function Jw(r,e){return!e||!Sm(e)?{...r,choices:r.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:ul(r,e)}function ul(r,e){const t=r.choices.map(n=>{if(n.finish_reason==="length")throw new nm;if(n.finish_reason==="content_filter")throw new rm;return{...n,message:{...n.message,...n.message.tool_calls?{tool_calls:n.message.tool_calls?.map(s=>Xw(e,s))??void 0}:void 0,parsed:n.message.content&&!n.message.refusal?Kw(e,n.message.content):null}}});return{...r,choices:t}}function Kw(r,e){return r.response_format?.type!=="json_schema"?null:r.response_format?.type==="json_schema"?"$parseRaw"in r.response_format?r.response_format.$parseRaw(e):JSON.parse(e):null}function Xw(r,e){const t=r.tools?.find(n=>n.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:ii(t)?t.$parseRaw(e.function.arguments):t?.function.strict?JSON.parse(e.function.arguments):null}}}function Yw(r,e){if(!r)return!1;const t=r.tools?.find(n=>n.function?.name===e.function.name);return ii(t)||t?.function.strict||!1}function Sm(r){return ol(r.response_format)?!0:r.tools?.some(e=>ii(e)||e.type==="function"&&e.function.strict===!0)??!1}function Qw(r){for(const e of r??[]){if(e.type!=="function")throw new Z(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new Z(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var it=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Je,Sc,ba,Ec,xc,Oc,Em,kc;const Xd=10;class xm extends sl{constructor(){super(...arguments),Je.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(wm(e)||vm(e))&&e.content)this._emit("functionCallResult",e.content);else if(Nr(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Nr(e)&&e.tool_calls)for(const n of e.tool_calls)n.type==="function"&&this._emit("functionCall",n.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new Z("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),it(this,Je,"m",Sc).call(this)}async finalMessage(){return await this.done(),it(this,Je,"m",ba).call(this)}async finalFunctionCall(){return await this.done(),it(this,Je,"m",Ec).call(this)}async finalFunctionCallResult(){return await this.done(),it(this,Je,"m",xc).call(this)}async totalUsage(){return await this.done(),it(this,Je,"m",Oc).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=it(this,Je,"m",ba).call(this);t&&this._emit("finalMessage",t);const n=it(this,Je,"m",Sc).call(this);n&&this._emit("finalContent",n);const s=it(this,Je,"m",Ec).call(this);s&&this._emit("finalFunctionCall",s);const i=it(this,Je,"m",xc).call(this);i!=null&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",it(this,Je,"m",Oc).call(this))}async _createChatCompletion(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),it(this,Je,"m",Em).call(this,t);const i=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(ul(i,t))}async _runChatCompletion(e,t,n){for(const s of t.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const s="function",{function_call:i="auto",stream:a,...o}=t,u=typeof i!="string"&&i?.name,{maxChatCompletions:c=Xd}=n||{},l={};for(const f of t.functions)l[f.name||f.function.name]=f;const d=t.functions.map(f=>({name:f.name||f.function.name,parameters:f.parameters,description:f.description}));for(const f of t.messages)this._addMessage(f,!1);for(let f=0;f<c;++f){const p=(await this._createChatCompletion(e,{...o,function_call:i,functions:d,messages:[...this.messages]},n)).choices[0]?.message;if(!p)throw new Z("missing message in ChatCompletion response");if(!p.function_call)return;const{name:m,arguments:g}=p.function_call,y=l[m];if(y){if(u&&u!==m){const w=`Invalid function_call: ${JSON.stringify(m)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,name:m,content:w});continue}}else{const w=`Invalid function_call: ${JSON.stringify(m)}. Available options are: ${d.map(E=>JSON.stringify(E.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:m,content:w});continue}let _;try{_=Kd(y)?await y.parse(g):g}catch(w){this._addMessage({role:s,name:m,content:w instanceof Error?w.message:String(w)});continue}const b=await y.function(_,this),v=it(this,Je,"m",kc).call(this,b);if(this._addMessage({role:s,name:m,content:v}),u)return}}async _runTools(e,t,n){const s="tool",{tool_choice:i="auto",stream:a,...o}=t,u=typeof i!="string"&&i?.function?.name,{maxChatCompletions:c=Xd}=n||{},l=t.tools.map(h=>{if(ii(h)){if(!h.$callback)throw new Z("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:h.$callback,name:h.function.name,description:h.function.description||"",parameters:h.function.parameters,parse:h.$parseRaw,strict:!0}}}return h}),d={};for(const h of l)h.type==="function"&&(d[h.function.name||h.function.function.name]=h.function);const f="tools"in t?l.map(h=>h.type==="function"?{type:"function",function:{name:h.function.name||h.function.function.name,parameters:h.function.parameters,description:h.function.description,strict:h.function.strict}}:h):void 0;for(const h of t.messages)this._addMessage(h,!1);for(let h=0;h<c;++h){const m=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:f,messages:[...this.messages]},n)).choices[0]?.message;if(!m)throw new Z("missing message in ChatCompletion response");if(!m.tool_calls?.length)return;for(const g of m.tool_calls){if(g.type!=="function")continue;const y=g.id,{name:_,arguments:b}=g.function,v=d[_];if(v){if(u&&u!==_){const O=`Invalid tool_call: ${JSON.stringify(_)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,tool_call_id:y,content:O});continue}}else{const O=`Invalid tool_call: ${JSON.stringify(_)}. Available options are: ${Object.keys(d).map(x=>JSON.stringify(x)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:y,content:O});continue}let w;try{w=Kd(v)?await v.parse(b):b}catch(O){const x=O instanceof Error?O.message:String(O);this._addMessage({role:s,tool_call_id:y,content:x});continue}const E=await v.function(w,this),T=it(this,Je,"m",kc).call(this,E);if(this._addMessage({role:s,tool_call_id:y,content:T}),u)return}}}}Je=new WeakSet,Sc=function(){return it(this,Je,"m",ba).call(this).content??null},ba=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Nr(t)){const{function_call:n,...s}=t,i={...s,content:t.content??null,refusal:t.refusal??null};return n&&(i.function_call=n),i}}throw new Z("stream ended without producing a ChatCompletionMessage with role=assistant")},Ec=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Nr(t)&&t?.function_call)return t.function_call;if(Nr(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},xc=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(wm(t)&&t.content!=null||vm(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(n=>n.role==="assistant"&&n.tool_calls?.some(s=>s.type==="function"&&s.id===t.tool_call_id)))return t.content}},Oc=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Em=function(e){if(e.n!=null&&e.n>1)throw new Z("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},kc=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Bs extends xm{static runFunctions(e,t,n){const s=new Bs,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,n){const s=new Bs,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}_addMessage(e,t=!0){super._addMessage(e,t),Nr(e)&&e.content&&this._emit("content",e.content)}}const Om=1,km=2,Pm=4,Am=8,Tm=16,Im=32,Rm=64,Cm=128,$m=256,Nm=Cm|$m,jm=Tm|Im|Nm|Rm,Lm=Om|km|jm,Mm=Pm|Am,ev=Lm|Mm,Fe={STR:Om,NUM:km,ARR:Pm,OBJ:Am,NULL:Tm,BOOL:Im,NAN:Rm,INFINITY:Cm,MINUS_INFINITY:$m,INF:Nm,SPECIAL:jm,ATOM:Lm,COLLECTION:Mm,ALL:ev};class tv extends Error{}class nv extends Error{}function rv(r,e=Fe.ALL){if(typeof r!="string")throw new TypeError(`expecting str, got ${typeof r}`);if(!r.trim())throw new Error(`${r} is empty`);return sv(r.trim(),e)}const sv=(r,e)=>{const t=r.length;let n=0;const s=f=>{throw new tv(`${f} at position ${n}`)},i=f=>{throw new nv(`${f} at position ${n}`)},a=()=>(d(),n>=t&&s("Unexpected end of input"),r[n]==='"'?o():r[n]==="{"?u():r[n]==="["?c():r.substring(n,n+4)==="null"||Fe.NULL&e&&t-n<4&&"null".startsWith(r.substring(n))?(n+=4,null):r.substring(n,n+4)==="true"||Fe.BOOL&e&&t-n<4&&"true".startsWith(r.substring(n))?(n+=4,!0):r.substring(n,n+5)==="false"||Fe.BOOL&e&&t-n<5&&"false".startsWith(r.substring(n))?(n+=5,!1):r.substring(n,n+8)==="Infinity"||Fe.INFINITY&e&&t-n<8&&"Infinity".startsWith(r.substring(n))?(n+=8,1/0):r.substring(n,n+9)==="-Infinity"||Fe.MINUS_INFINITY&e&&1<t-n&&t-n<9&&"-Infinity".startsWith(r.substring(n))?(n+=9,-1/0):r.substring(n,n+3)==="NaN"||Fe.NAN&e&&t-n<3&&"NaN".startsWith(r.substring(n))?(n+=3,NaN):l()),o=()=>{const f=n;let h=!1;for(n++;n<t&&(r[n]!=='"'||h&&r[n-1]==="\\");)h=r[n]==="\\"?!h:!1,n++;if(r.charAt(n)=='"')try{return JSON.parse(r.substring(f,++n-Number(h)))}catch(p){i(String(p))}else if(Fe.STR&e)try{return JSON.parse(r.substring(f,n-Number(h))+'"')}catch{return JSON.parse(r.substring(f,r.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},u=()=>{n++,d();const f={};try{for(;r[n]!=="}";){if(d(),n>=t&&Fe.OBJ&e)return f;const h=o();d(),n++;try{const p=a();Object.defineProperty(f,h,{value:p,writable:!0,enumerable:!0,configurable:!0})}catch(p){if(Fe.OBJ&e)return f;throw p}d(),r[n]===","&&n++}}catch{if(Fe.OBJ&e)return f;s("Expected '}' at end of object")}return n++,f},c=()=>{n++;const f=[];try{for(;r[n]!=="]";)f.push(a()),d(),r[n]===","&&n++}catch{if(Fe.ARR&e)return f;s("Expected ']' at end of array")}return n++,f},l=()=>{if(n===0){r==="-"&&Fe.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(r)}catch(h){if(Fe.NUM&e)try{return r[r.length-1]==="."?JSON.parse(r.substring(0,r.lastIndexOf("."))):JSON.parse(r.substring(0,r.lastIndexOf("e")))}catch{}i(String(h))}}const f=n;for(r[n]==="-"&&n++;r[n]&&!",]}".includes(r[n]);)n++;n==t&&!(Fe.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(r.substring(f,n))}catch{r.substring(f,n)==="-"&&Fe.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(r.substring(f,r.lastIndexOf("e")))}catch(p){i(String(p))}}},d=()=>{for(;n<t&&` 
\r	`.includes(r[n]);)n++};return a()},Yd=r=>rv(r,Fe.ALL^Fe.NUM);var gr=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},ye=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Ce,dn,yr,vn,Ao,Ei,To,Io,Ro,xi,Co,Qd;class zs extends xm{constructor(e){super(),Ce.add(this),dn.set(this,void 0),yr.set(this,void 0),vn.set(this,void 0),gr(this,dn,e,"f"),gr(this,yr,[],"f")}get currentChatCompletionSnapshot(){return ye(this,vn,"f")}static fromReadableStream(e){const t=new zs(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const s=new zs(t);return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,n){super._createChatCompletion;const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),ye(this,Ce,"m",Ao).call(this);const i=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const a of i)ye(this,Ce,"m",To).call(this,a);if(i.controller.signal?.aborted)throw new bt;return this._addChatCompletion(ye(this,Ce,"m",xi).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),ye(this,Ce,"m",Ao).call(this),this._connected();const s=nn.fromReadableStream(e,this.controller);let i;for await(const a of s)i&&i!==a.id&&this._addChatCompletion(ye(this,Ce,"m",xi).call(this)),ye(this,Ce,"m",To).call(this,a),i=a.id;if(s.controller.signal?.aborted)throw new bt;return this._addChatCompletion(ye(this,Ce,"m",xi).call(this))}[(dn=new WeakMap,yr=new WeakMap,vn=new WeakMap,Ce=new WeakSet,Ao=function(){this.ended||gr(this,vn,void 0,"f")},Ei=function(t){let n=ye(this,yr,"f")[t.index];return n||(n={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},ye(this,yr,"f")[t.index]=n,n)},To=function(t){if(this.ended)return;const n=ye(this,Ce,"m",Qd).call(this,t);this._emit("chunk",t,n);for(const s of t.choices){const i=n.choices[s.index];s.delta.content!=null&&i.message?.role==="assistant"&&i.message?.content&&(this._emit("content",s.delta.content,i.message.content),this._emit("content.delta",{delta:s.delta.content,snapshot:i.message.content,parsed:i.message.parsed})),s.delta.refusal!=null&&i.message?.role==="assistant"&&i.message?.refusal&&this._emit("refusal.delta",{delta:s.delta.refusal,snapshot:i.message.refusal}),s.logprobs?.content!=null&&i.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:s.logprobs?.content,snapshot:i.logprobs?.content??[]}),s.logprobs?.refusal!=null&&i.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:s.logprobs?.refusal,snapshot:i.logprobs?.refusal??[]});const a=ye(this,Ce,"m",Ei).call(this,i);i.finish_reason&&(ye(this,Ce,"m",Ro).call(this,i),a.current_tool_call_index!=null&&ye(this,Ce,"m",Io).call(this,i,a.current_tool_call_index));for(const o of s.delta.tool_calls??[])a.current_tool_call_index!==o.index&&(ye(this,Ce,"m",Ro).call(this,i),a.current_tool_call_index!=null&&ye(this,Ce,"m",Io).call(this,i,a.current_tool_call_index)),a.current_tool_call_index=o.index;for(const o of s.delta.tool_calls??[]){const u=i.message.tool_calls?.[o.index];u?.type&&(u?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:u.function?.name,index:o.index,arguments:u.function.arguments,parsed_arguments:u.function.parsed_arguments,arguments_delta:o.function?.arguments??""}):(u?.type,void 0))}}},Io=function(t,n){if(ye(this,Ce,"m",Ei).call(this,t).done_tool_calls.has(n))return;const i=t.message.tool_calls?.[n];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){const a=ye(this,dn,"f")?.tools?.find(o=>o.type==="function"&&o.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:n,arguments:i.function.arguments,parsed_arguments:ii(a)?a.$parseRaw(i.function.arguments):a?.function.strict?JSON.parse(i.function.arguments):null})}else i.type},Ro=function(t){const n=ye(this,Ce,"m",Ei).call(this,t);if(t.message.content&&!n.content_done){n.content_done=!0;const s=ye(this,Ce,"m",Co).call(this);this._emit("content.done",{content:t.message.content,parsed:s?s.$parseRaw(t.message.content):null})}t.message.refusal&&!n.refusal_done&&(n.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!n.logprobs_content_done&&(n.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!n.logprobs_refusal_done&&(n.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},xi=function(){if(this.ended)throw new Z("stream has ended, this shouldn't happen");const t=ye(this,vn,"f");if(!t)throw new Z("request ended without sending any chunks");return gr(this,vn,void 0,"f"),gr(this,yr,[],"f"),iv(t,ye(this,dn,"f"))},Co=function(){const t=ye(this,dn,"f")?.response_format;return ol(t)?t:null},Qd=function(t){var n,s,i,a;let o=ye(this,vn,"f");const{choices:u,...c}=t;o?Object.assign(o,c):o=gr(this,vn,{...c,choices:[]},"f");for(const{delta:l,finish_reason:d,index:f,logprobs:h=null,...p}of t.choices){let m=o.choices[f];if(m||(m=o.choices[f]={finish_reason:d,index:f,message:{},logprobs:h,...p}),h)if(!m.logprobs)m.logprobs=Object.assign({},h);else{const{content:E,refusal:T,...O}=h;Object.assign(m.logprobs,O),E&&((n=m.logprobs).content??(n.content=[]),m.logprobs.content.push(...E)),T&&((s=m.logprobs).refusal??(s.refusal=[]),m.logprobs.refusal.push(...T))}if(d&&(m.finish_reason=d,ye(this,dn,"f")&&Sm(ye(this,dn,"f")))){if(d==="length")throw new nm;if(d==="content_filter")throw new rm}if(Object.assign(m,p),!l)continue;const{content:g,refusal:y,function_call:_,role:b,tool_calls:v,...w}=l;if(Object.assign(m.message,w),y&&(m.message.refusal=(m.message.refusal||"")+y),b&&(m.message.role=b),_&&(m.message.function_call?(_.name&&(m.message.function_call.name=_.name),_.arguments&&((i=m.message.function_call).arguments??(i.arguments=""),m.message.function_call.arguments+=_.arguments)):m.message.function_call=_),g&&(m.message.content=(m.message.content||"")+g,!m.message.refusal&&ye(this,Ce,"m",Co).call(this)&&(m.message.parsed=Yd(m.message.content))),v){m.message.tool_calls||(m.message.tool_calls=[]);for(const{index:E,id:T,type:O,function:x,...k}of v){const C=(a=m.message.tool_calls)[E]??(a[E]={});Object.assign(C,k),T&&(C.id=T),O&&(C.type=O),x&&(C.function??(C.function={name:x.name??"",arguments:""})),x?.name&&(C.function.name=x.name),x?.arguments&&(C.function.arguments+=x.arguments,Yw(ye(this,dn,"f"),C)&&(C.function.parsed_arguments=Yd(C.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",s=>{const i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(const s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(const i of t)i.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(const i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new nn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function iv(r,e){const{id:t,choices:n,created:s,model:i,system_fingerprint:a,...o}=r,u={...o,id:t,choices:n.map(({message:c,finish_reason:l,index:d,logprobs:f,...h})=>{if(!l)throw new Z(`missing finish_reason for choice ${d}`);const{content:p=null,function_call:m,tool_calls:g,...y}=c,_=c.role;if(!_)throw new Z(`missing role for choice ${d}`);if(m){const{arguments:b,name:v}=m;if(b==null)throw new Z(`missing function_call.arguments for choice ${d}`);if(!v)throw new Z(`missing function_call.name for choice ${d}`);return{...h,message:{content:p,function_call:{arguments:b,name:v},role:_,refusal:c.refusal??null},finish_reason:l,index:d,logprobs:f}}return g?{...h,index:d,finish_reason:l,logprobs:f,message:{...y,role:_,content:p,refusal:c.refusal??null,tool_calls:g.map((b,v)=>{const{function:w,type:E,id:T,...O}=b,{arguments:x,name:k,...C}=w||{};if(T==null)throw new Z(`missing choices[${d}].tool_calls[${v}].id
${Oi(r)}`);if(E==null)throw new Z(`missing choices[${d}].tool_calls[${v}].type
${Oi(r)}`);if(k==null)throw new Z(`missing choices[${d}].tool_calls[${v}].function.name
${Oi(r)}`);if(x==null)throw new Z(`missing choices[${d}].tool_calls[${v}].function.arguments
${Oi(r)}`);return{...O,id:T,type:E,function:{...C,name:k,arguments:x}}})}}:{...h,message:{...y,content:p,role:_,refusal:c.refusal??null},finish_reason:l,index:d,logprobs:f}}),created:s,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return Jw(u,e)}function Oi(r){return JSON.stringify(r)}class jr extends zs{static fromReadableStream(e){const t=new jr(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,n){const s=new jr(null),i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,n){const s=new jr(t),i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}}let Dm=class extends K{parse(e,t){return Qw(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(n=>ul(n,e))}runFunctions(e,t){return e.stream?jr.runFunctions(this._client,e,t):Bs.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?jr.runTools(this._client,e,t):Bs.runTools(this._client,e,t)}stream(e,t){return zs.createChatCompletion(this._client,e,t)}};class Pc extends K{constructor(){super(...arguments),this.completions=new Dm(this._client)}}(function(r){r.Completions=Dm})(Pc||(Pc={}));class Um extends K{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Fm extends K{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Ka extends K{constructor(){super(...arguments),this.sessions=new Um(this._client),this.transcriptionSessions=new Fm(this._client)}}Ka.Sessions=Um;Ka.TranscriptionSessions=Fm;class cl extends K{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return Ee(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,ll,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class ll extends De{}cl.MessagesPage=ll;class dl extends K{retrieve(e,t,n,s={},i){return Ee(s)?this.retrieve(e,t,n,{},s):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:s,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}list(e,t,n={},s){return Ee(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,fl,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class fl extends De{}dl.RunStepsPage=fl;let ai=class extends K{constructor(){super(...arguments),this.steps=new dl(this._client)}create(e,t,n){const{include:s,...i}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:i,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return Ee(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,hl,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}createAndStream(e,t,n){return Vt.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:i,response:a}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...s}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{const u=a.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await ri(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,n){return Vt.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,s){const i=await this.submitToolOutputs(e,t,n,s);return await this.poll(e,i.id,s)}submitToolOutputsStream(e,t,n,s){return Vt.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,s)}};class hl extends De{}ai.RunsPage=hl;ai.Steps=dl;ai.RunStepsPage=fl;class Kr extends K{constructor(){super(...arguments),this.runs=new ai(this._client),this.messages=new cl(this._client)}create(e={},t){return Ee(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return Vt.createThreadAssistantStream(e,this._client.beta.threads,t)}}Kr.Runs=ai;Kr.RunsPage=hl;Kr.Messages=cl;Kr.MessagesPage=ll;class Xr extends K{constructor(){super(...arguments),this.realtime=new Ka(this._client),this.chat=new Pc(this._client),this.assistants=new il(this._client),this.threads=new Kr(this._client)}}Xr.Realtime=Ka;Xr.Assistants=il;Xr.AssistantsPage=al;Xr.Threads=Kr;class Bm extends K{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class zm extends K{retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}/content`,{...n,headers:{Accept:"application/binary",...n?.headers},__binaryResponse:!0})}}let Xa=class extends K{constructor(){super(...arguments),this.content=new zm(this._client)}create(e,t,n){return this._client.post(`/containers/${e}/files`,ar({body:t,...n}))}retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}`,n)}list(e,t={},n){return Ee(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,pl,{query:t,...n})}del(e,t,n){return this._client.delete(`/containers/${e}/files/${t}`,{...n,headers:{Accept:"*/*",...n?.headers}})}};class pl extends De{}Xa.FileListResponsesPage=pl;Xa.Content=zm;class oi extends K{constructor(){super(...arguments),this.files=new Xa(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return Ee(e)?this.list({},e):this._client.getAPIList("/containers",ml,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class ml extends De{}oi.ContainerListResponsesPage=ml;oi.Files=Xa;oi.FileListResponsesPage=pl;class Gm extends K{create(e,t){const n=!!e.encoding_format;let s=n?e.encoding_format:"base64";n&&Ln("Request","User defined encoding_format:",e.encoding_format);const i=this._client.post("/embeddings",{body:{...e,encoding_format:s},...t});return n?i:(Ln("response","Decoding base64 embeddings to float32 array"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(o=>{const u=o.embedding;o.embedding=Hw(u)}),a)))}}class gl extends K{retrieve(e,t,n,s){return this._client.get(`/evals/${e}/runs/${t}/output_items/${n}`,s)}list(e,t,n={},s){return Ee(n)?this.list(e,t,{},n):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,yl,{query:n,...s})}}class yl extends De{}gl.OutputItemListResponsesPage=yl;class ui extends K{constructor(){super(...arguments),this.outputItems=new gl(this._client)}create(e,t,n){return this._client.post(`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){return this._client.get(`/evals/${e}/runs/${t}`,n)}list(e,t={},n){return Ee(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,_l,{query:t,...n})}del(e,t,n){return this._client.delete(`/evals/${e}/runs/${t}`,n)}cancel(e,t,n){return this._client.post(`/evals/${e}/runs/${t}`,n)}}class _l extends De{}ui.RunListResponsesPage=_l;ui.OutputItems=gl;ui.OutputItemListResponsesPage=yl;class ci extends K{constructor(){super(...arguments),this.runs=new ui(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,n){return this._client.post(`/evals/${e}`,{body:t,...n})}list(e={},t){return Ee(e)?this.list({},e):this._client.getAPIList("/evals",bl,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class bl extends De{}ci.EvalListResponsesPage=bl;ci.Runs=ui;ci.RunListResponsesPage=_l;let wl=class extends K{create(e,t){return this._client.post("/files",ar({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Ee(e)?this.list({},e):this._client.getAPIList("/files",vl,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=1800*1e3}={}){const s=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await ri(t),a=await this.retrieve(e),Date.now()-i>n)throw new za({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}};class vl extends De{}wl.FileObjectsPage=vl;class qm extends K{}let Hm=class extends K{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};class Sl extends K{constructor(){super(...arguments),this.graders=new Hm(this._client)}}Sl.Graders=Hm;class El extends K{create(e,t,n){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,xl,{body:t,method:"post",...n})}retrieve(e,t={},n){return Ee(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}del(e,t,n){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,n)}}class xl extends Va{}El.PermissionCreateResponsesPage=xl;let Ya=class extends K{constructor(){super(...arguments),this.permissions=new El(this._client)}};Ya.Permissions=El;Ya.PermissionCreateResponsesPage=xl;class Ol extends K{list(e,t={},n){return Ee(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,kl,{query:t,...n})}}class kl extends De{}Ol.FineTuningJobCheckpointsPage=kl;class Yr extends K{constructor(){super(...arguments),this.checkpoints=new Ol(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Ee(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Pl,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return Ee(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Al,{query:t,...n})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class Pl extends De{}class Al extends De{}Yr.FineTuningJobsPage=Pl;Yr.FineTuningJobEventsPage=Al;Yr.Checkpoints=Ol;Yr.FineTuningJobCheckpointsPage=kl;class Vn extends K{constructor(){super(...arguments),this.methods=new qm(this._client),this.jobs=new Yr(this._client),this.checkpoints=new Ya(this._client),this.alpha=new Sl(this._client)}}Vn.Methods=qm;Vn.Jobs=Yr;Vn.FineTuningJobsPage=Pl;Vn.FineTuningJobEventsPage=Al;Vn.Checkpoints=Ya;Vn.Alpha=Sl;class Vm extends K{}class Tl extends K{constructor(){super(...arguments),this.graderModels=new Vm(this._client)}}Tl.GraderModels=Vm;class Wm extends K{createVariation(e,t){return this._client.post("/images/variations",ar({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",ar({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class Il extends K{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Rl,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Rl extends Va{}Il.ModelsPage=Rl;class Zm extends K{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function av(r,e){return!e||!uv(e)?{...r,output_parsed:null,output:r.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(n=>({...n,parsed:null}))}:t)}:Jm(r,e)}function Jm(r,e){const t=r.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:dv(e,s)};if(s.type==="message"){const i=s.content.map(a=>a.type==="output_text"?{...a,parsed:ov(e,a.text)}:a);return{...s,content:i}}return s}),n=Object.assign({},r,{output:t});return Object.getOwnPropertyDescriptor(r,"output_text")||Km(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const s of n.output)if(s.type==="message"){for(const i of s.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),n}function ov(r,e){return r.text?.format?.type!=="json_schema"?null:"$parseRaw"in r.text?.format?(r.text?.format).$parseRaw(e):JSON.parse(e)}function uv(r){return!!ol(r.text?.format)}function cv(r){return r?.$brand==="auto-parseable-tool"}function lv(r,e){return r.find(t=>t.type==="function"&&t.name===e)}function dv(r,e){const t=lv(r.tools??[],e.name);return{...e,...e,parsed_arguments:cv(t)?t.$parseRaw(e.arguments):t?.strict?JSON.parse(e.arguments):null}}function Km(r){const e=[];for(const t of r.output)if(t.type==="message")for(const n of t.content)n.type==="output_text"&&e.push(n.text);r.output_text=e.join("")}class Xm extends K{list(e,t={},n){return Ee(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,hv,{query:t,...n})}}var _r=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},Sn=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},br,ki,En,Pi,ef,tf,nf,rf;class Cl extends sl{constructor(e){super(),br.add(this),ki.set(this,void 0),En.set(this,void 0),Pi.set(this,void 0),_r(this,ki,e,"f")}static createResponse(e,t,n){const s=new Cl(t);return s._run(()=>s._createOrRetrieveResponse(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Sn(this,br,"m",ef).call(this);let i,a=null;"response_id"in t?(i=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):i=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const o of i)Sn(this,br,"m",tf).call(this,o,a);if(i.controller.signal?.aborted)throw new bt;return Sn(this,br,"m",nf).call(this)}[(ki=new WeakMap,En=new WeakMap,Pi=new WeakMap,br=new WeakSet,ef=function(){this.ended||_r(this,En,void 0,"f")},tf=function(t,n){if(this.ended)return;const s=(a,o)=>{(n==null||o.sequence_number>n)&&this._emit(a,o)},i=Sn(this,br,"m",rf).call(this,t);switch(s("event",t),t.type){case"response.output_text.delta":{const a=i.output[t.output_index];if(!a)throw new Z(`missing output at index ${t.output_index}`);if(a.type==="message"){const o=a.content[t.content_index];if(!o)throw new Z(`missing content at index ${t.content_index}`);if(o.type!=="output_text")throw new Z(`expected content to be 'output_text', got ${o.type}`);s("response.output_text.delta",{...t,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const a=i.output[t.output_index];if(!a)throw new Z(`missing output at index ${t.output_index}`);a.type==="function_call"&&s("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:s(t.type,t);break}},nf=function(){if(this.ended)throw new Z("stream has ended, this shouldn't happen");const t=Sn(this,En,"f");if(!t)throw new Z("request ended without sending any events");_r(this,En,void 0,"f");const n=fv(t,Sn(this,ki,"f"));return _r(this,Pi,n,"f"),n},rf=function(t){let n=Sn(this,En,"f");if(!n){if(t.type!=="response.created")throw new Z(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return n=_r(this,En,t.response,"f"),n}switch(t.type){case"response.output_item.added":{n.output.push(t.item);break}case"response.content_part.added":{const s=n.output[t.output_index];if(!s)throw new Z(`missing output at index ${t.output_index}`);s.type==="message"&&s.content.push(t.part);break}case"response.output_text.delta":{const s=n.output[t.output_index];if(!s)throw new Z(`missing output at index ${t.output_index}`);if(s.type==="message"){const i=s.content[t.content_index];if(!i)throw new Z(`missing content at index ${t.content_index}`);if(i.type!=="output_text")throw new Z(`expected content to be 'output_text', got ${i.type}`);i.text+=t.delta}break}case"response.function_call_arguments.delta":{const s=n.output[t.output_index];if(!s)throw new Z(`missing output at index ${t.output_index}`);s.type==="function_call"&&(s.arguments+=t.delta);break}case"response.completed":{_r(this,En,t.response,"f");break}}return n},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",s=>{const i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(const s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(const i of t)i.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(const i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Sn(this,Pi,"f");if(!e)throw new Z("stream ended without producing a ChatCompletion");return e}}function fv(r,e){return av(r,e)}class $l extends K{constructor(){super(...arguments),this.inputItems=new Xm(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&Km(n),n))}retrieve(e,t={},n){return this._client.get(`/responses/${e}`,{query:t,...n,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(n=>Jm(n,e))}stream(e,t){return Cl.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class hv extends De{}$l.InputItems=Xm;class Ym extends K{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,ar({body:t,...n}))}}class Nl extends K{constructor(){super(...arguments),this.parts=new Ym(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}Nl.Parts=Ym;const pv=async r=>{const e=await Promise.allSettled(r),t=e.filter(s=>s.status==="rejected");if(t.length){for(const s of t)console.error(s.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const n=[];for(const s of e)s.status==="fulfilled"&&n.push(s.value);return n};class Qa extends K{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return Ee(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,eo,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const i=await this.retrieve(e,t,{...n,headers:s}).withResponse(),a=i.data;switch(a.status){case"in_progress":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{const u=i.response.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await ri(o);break;case"failed":case"completed":return a}}}async upload(e,t,n){const s=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:s.id},n)}async uploadAndPoll(e,t,n){const s=await this.upload(e,t,n);return await this.poll(e,s.id,n)}content(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,jl,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class eo extends De{}class jl extends Va{}Qa.VectorStoreFilesPage=eo;Qa.FileContentResponsesPage=jl;class Qm extends K{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t);return await this.poll(e,s.id,n)}listFiles(e,t,n={},s){return Ee(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,eo,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:i,response:a}=await this.retrieve(e,t,{...n,headers:s}).withResponse();switch(i.status){case"in_progress":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{const u=a.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await ri(o);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},s){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const i=s?.maxConcurrency??5,a=Math.min(i,t.length),o=this._client,u=t.values(),c=[...n];async function l(f){for(let h of f){const p=await o.files.create({file:h,purpose:"assistants"},s);c.push(p.id)}}const d=Array(a).fill(u).map(l);return await pv(d),await this.createAndPoll(e,{file_ids:c})}}class Wn extends K{constructor(){super(...arguments),this.files=new Qa(this._client),this.fileBatches=new Qm(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return Ee(e)?this.list({},e):this._client.getAPIList("/vector_stores",Ll,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/search`,Ml,{body:t,method:"post",...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class Ll extends De{}class Ml extends Va{}Wn.VectorStoresPage=Ll;Wn.VectorStoreSearchResponsesPage=Ml;Wn.Files=Qa;Wn.VectorStoreFilesPage=eo;Wn.FileContentResponsesPage=jl;Wn.FileBatches=Qm;var eg;let ee=class extends $w{constructor({baseURL:e=vi("OPENAI_BASE_URL"),apiKey:t=vi("OPENAI_API_KEY"),organization:n=vi("OPENAI_ORG_ID")??null,project:s=vi("OPENAI_PROJECT_ID")??null,...i}={}){if(t===void 0)throw new Z("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const a={apiKey:t,organization:n,project:s,...i,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&Gw())throw new Z(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new Bm(this),this.chat=new Ja(this),this.embeddings=new Gm(this),this.files=new wl(this),this.images=new Wm(this),this.audio=new si(this),this.moderations=new Zm(this),this.models=new Il(this),this.fineTuning=new Vn(this),this.graders=new Tl(this),this.vectorStores=new Wn(this),this.beta=new Xr(this),this.batches=new nl(this),this.uploads=new Nl(this),this.responses=new $l(this),this.evals=new ci(this),this.containers=new oi(this),this._options=a,this.apiKey=t,this.organization=n,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return mw(e,{arrayFormat:"brackets"})}};eg=ee;ee.OpenAI=eg;ee.DEFAULT_TIMEOUT=6e5;ee.OpenAIError=Z;ee.APIError=We;ee.APIConnectionError=Ba;ee.APIConnectionTimeoutError=za;ee.APIUserAbortError=bt;ee.NotFoundError=Xp;ee.ConflictError=Yp;ee.RateLimitError=em;ee.BadRequestError=Zp;ee.AuthenticationError=Jp;ee.InternalServerError=tm;ee.PermissionDeniedError=Kp;ee.UnprocessableEntityError=Qp;ee.toFile=om;ee.fileFromPath=Hp;ee.Completions=Bm;ee.Chat=Ja;ee.ChatCompletionsPage=Za;ee.Embeddings=Gm;ee.Files=wl;ee.FileObjectsPage=vl;ee.Images=Wm;ee.Audio=si;ee.Moderations=Zm;ee.Models=Il;ee.ModelsPage=Rl;ee.FineTuning=Vn;ee.Graders=Tl;ee.VectorStores=Wn;ee.VectorStoresPage=Ll;ee.VectorStoreSearchResponsesPage=Ml;ee.Beta=Xr;ee.Batches=nl;ee.BatchesPage=rl;ee.Uploads=Nl;ee.Responses=$l;ee.Evals=ci;ee.EvalListResponsesPage=bl;ee.Containers=oi;ee.ContainerListResponsesPage=ml;function sf(r,e=Dl){r=r.trim();const t=r.indexOf("```");if(t===-1)return e(r);let n=r.substring(t+3);n.startsWith(`json
`)?n=n.substring(5):n.startsWith("json")?n=n.substring(4):n.startsWith(`
`)&&(n=n.substring(1));const s=n.indexOf("```");let i=n;return s!==-1&&(i=n.substring(0,s)),e(i.trim())}function Dl(r){if(typeof r>"u")return null;try{return JSON.parse(r)}catch{}let e="";const t=[];let n=!1,s=!1;for(let i of r){if(n)i==='"'&&!s?n=!1:i===`
`&&!s?i="\\n":i==="\\"?s=!s:s=!1;else if(i==='"')n=!0,s=!1;else if(i==="{")t.push("}");else if(i==="[")t.push("]");else if(i==="}"||i==="]")if(t&&t[t.length-1]===i)t.pop();else return null;e+=i}n&&(e+='"');for(let i=t.length-1;i>=0;i-=1)e+=t[i];try{return JSON.parse(e)}catch{return null}}function li(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var $o,af;function mv(){return af||(af=1,$o=function(r,e){if(typeof r!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,r.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}),$o}var gv=mv();const yv=li(gv);var Ai={exports:{}},of;function _v(){if(of)return Ai.exports;of=1;const r=/[\p{Lu}]/u,e=/[\p{Ll}]/u,t=/^[\p{Lu}](?![\p{Lu}])/gu,n=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,i=new RegExp("^"+s.source),a=new RegExp(s.source+n.source,"gu"),o=new RegExp("\\d+"+n.source,"gu"),u=(f,h,p)=>{let m=!1,g=!1,y=!1;for(let _=0;_<f.length;_++){const b=f[_];m&&r.test(b)?(f=f.slice(0,_)+"-"+f.slice(_),m=!1,y=g,g=!0,_++):g&&y&&e.test(b)?(f=f.slice(0,_-1)+"-"+f.slice(_-1),y=g,g=!1,m=!0):(m=h(b)===b&&p(b)!==b,y=g,g=p(b)===b&&h(b)!==b)}return f},c=(f,h)=>(t.lastIndex=0,f.replace(t,p=>h(p))),l=(f,h)=>(a.lastIndex=0,o.lastIndex=0,f.replace(a,(p,m)=>h(m)).replace(o,p=>h(p))),d=(f,h)=>{if(!(typeof f=="string"||Array.isArray(f)))throw new TypeError("Expected the input to be `string | string[]`");if(h={pascalCase:!1,preserveConsecutiveUppercase:!1,...h},Array.isArray(f)?f=f.map(y=>y.trim()).filter(y=>y.length).join("-"):f=f.trim(),f.length===0)return"";const p=h.locale===!1?y=>y.toLowerCase():y=>y.toLocaleLowerCase(h.locale),m=h.locale===!1?y=>y.toUpperCase():y=>y.toLocaleUpperCase(h.locale);return f.length===1?h.pascalCase?m(f):p(f):(f!==p(f)&&(f=u(f,p,m)),f=f.replace(i,""),h.preserveConsecutiveUppercase?f=c(f,p):f=p(f),h.pascalCase&&(f=m(f.charAt(0))+f.slice(1)),l(f,m))};return Ai.exports=d,Ai.exports.default=d,Ai.exports}_v();function bv(r,e){return e?.[r]||yv(r)}function wv(r,e,t){const n={};for(const s in r)Object.hasOwn(r,s)&&(n[e(s,t)]=r[s]);return n}const tg="__lc_escaped__";function vv(r){return"lc"in r||Object.keys(r).length===1&&tg in r}function Sv(r){return{[tg]:r}}function Ev(r){return r!==null&&typeof r=="object"&&"lc_serializable"in r&&typeof r.toJSON=="function"}function Ac(r){if(r!==null&&typeof r=="object"&&!Array.isArray(r)){if(Ev(r))return r;const e=r;if(vv(e))return Sv(e);const t={};for(const[n,s]of Object.entries(e))t[n]=Ac(s);return t}return Array.isArray(r)?r.map(e=>Ac(e)):r}function uf(r){return Array.isArray(r)?[...r]:{...r}}function xv(r,e){const t=uf(r);for(const[n,s]of Object.entries(e)){const[i,...a]=n.split(".").reverse();let o=t;for(const u of a.reverse()){if(o[u]===void 0)break;o[u]=uf(o[u]),o=o[u]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[s]})}return t}function ng(r){const e=Object.getPrototypeOf(r);return typeof r.lc_name=="function"&&(typeof e.lc_name!="function"||r.lc_name()!==e.lc_name())?r.lc_name():r.name}class or{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ng(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([n])=>this.lc_serializable_keys?.includes(n))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof or||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce((o,u)=>(o[u]=u in this?this[u]:this.lc_kwargs[u],o),{});for(let o=Object.getPrototypeOf(this);o;o=Object.getPrototypeOf(o))Object.assign(e,Reflect.get(o,"lc_aliases",this)),Object.assign(t,Reflect.get(o,"lc_secrets",this)),Object.assign(n,Reflect.get(o,"lc_attributes",this));Object.keys(t).forEach(o=>{let u=this,c=n;const[l,...d]=o.split(".").reverse();for(const f of d.reverse()){if(!(f in u)||u[f]===void 0)return;(!(f in c)||c[f]===void 0)&&(typeof u[f]=="object"&&u[f]!=null?c[f]={}:Array.isArray(u[f])&&(c[f]=[])),u=u[f],c=c[f]}l in u&&u[l]!==void 0&&(c[l]=c[l]||u[l])});const s={};for(const[o,u]of Object.entries(n))s[o]=Ac(u);const i=Object.keys(t).length?xv(s,t):s,a=wv(i,bv,e);return{lc:1,type:"constructor",id:this.lc_id,kwargs:a}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function Gs(r){return typeof r=="object"&&r!==null&&"type"in r&&typeof r.type=="string"&&"source_type"in r&&(r.source_type==="url"||r.source_type==="base64"||r.source_type==="text"||r.source_type==="id")}function Ov(r){return Gs(r)&&r.source_type==="url"&&"url"in r&&typeof r.url=="string"}function kv(r){return Gs(r)&&r.source_type==="base64"&&"data"in r&&typeof r.data=="string"}function Pv(r){if(Gs(r)){if(r.source_type==="url")return{type:"image_url",image_url:{url:r.url}};if(r.source_type==="base64"){if(!r.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${r.mime_type};base64,${r.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function Qr(r,e){return typeof r=="string"?r===""?e:typeof e=="string"?r+e:Array.isArray(e)&&e.some(t=>Gs(t))?[{type:"text",source_type:"text",text:r},...e]:[{type:"text",text:r},...e]:Array.isArray(e)?to(r,e)??[...r,...e]:e===""?r:Array.isArray(r)&&r.some(t=>Gs(t))?[...r,{type:"file",source_type:"text",text:e}]:[...r,{type:"text",text:e}]}function Av(r,e){return r==="error"||e==="error"?"error":"success"}function Tv(r,e){function t(n,s){if(typeof n!="object"||n===null||n===void 0)return n;if(s>=e)return Array.isArray(n)?"[Array]":"[Object]";if(Array.isArray(n))return n.map(a=>t(a,s+1));const i={};for(const a of Object.keys(n))i[a]=t(n[a],s+1);return i}return JSON.stringify(t(r,0),null,2)}class fr extends or{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const t=Tv(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}}function et(r,e){const t={...r};for(const[n,s]of Object.entries(e))if(t[n]==null)t[n]=s;else{if(s==null)continue;if(typeof t[n]!=typeof s||Array.isArray(t[n])!==Array.isArray(s))throw new Error(`field[${n}] already exists in the message chunk, but with a different type.`);if(typeof t[n]=="string"){if(n==="type")continue;["id","name","output_version","model_provider"].includes(n)?t[n]=s:t[n]+=s}else if(typeof t[n]=="object"&&!Array.isArray(t[n]))t[n]=et(t[n],s);else if(Array.isArray(t[n]))t[n]=to(t[n],s);else{if(t[n]===s)continue;console.warn(`field[${n}] already exists in this message chunk and value has unsupported type.`)}}return t}function to(r,e){if(!(r===void 0&&e===void 0)){if(r===void 0||e===void 0)return r||e;{const t=[...r];for(const n of e)if(typeof n=="object"&&n!==null&&"index"in n&&typeof n.index=="number"){const s=t.findIndex(i=>{const a=typeof i=="object",o="index"in i&&i.index===n.index,u="id"in i&&"id"in n&&i?.id===n?.id,c=!("id"in i)||!i?.id||!("id"in n)||!n?.id;return a&&o&&(u||c)});s!==-1&&typeof t[s]=="object"&&t[s]!==null?t[s]=et(t[s],n):t.push(n)}else{if(typeof n=="object"&&n!==null&&"text"in n&&n.text==="")continue;t.push(n)}return t}}}function Iv(r,e){if(!r&&!e)throw new Error("Cannot merge two undefined objects.");if(!r||!e)return r||e;if(typeof r!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof r}
Right ${typeof e}`);if(typeof r=="string"&&typeof e=="string")return r+e;if(Array.isArray(r)&&Array.isArray(e))return to(r,e);if(typeof r=="object"&&typeof e=="object")return et(r,e);if(r===e)return r;throw new Error(`Can not merge objects of different types.
Left ${r}
Right ${e}`)}class es extends fr{}function Rv(r){return typeof r.role=="string"}function Pt(r){return typeof r?._getType=="function"}function Tc(r){return Pt(r)&&typeof r.concat=="function"}class Cv extends fr{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,n){typeof e=="string"&&(e={content:e,name:n,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status,this.metadata=e.metadata}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class Ul extends es{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new Ul({content:Qr(this.content,e.content),additional_kwargs:et(this.additional_kwargs,e.additional_kwargs),response_metadata:et(this.response_metadata,e.response_metadata),artifact:Iv(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:Av(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function $v(r){const e=[],t=[];for(const n of r)if(n.function){const s=n.function.name;try{const i=JSON.parse(n.function.arguments),a={name:s||"",args:i||{},id:n.id};e.push(a)}catch{t.push({name:s,args:n.function.arguments,id:n.id,error:"Malformed args."})}}else continue;return[e,t]}function Nv(r){return r._getType()==="tool"}class qs extends fr{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if(typeof e=="string")n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;const s=n.additional_kwargs?.tool_calls,i=n.tool_calls;s!=null&&s.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(s!=null&&i===void 0){const[a,o]=$v(s);n.tool_calls=a??[],n.invalid_tool_calls=o??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch{n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof n!="string"&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function di(r){return r._getType()==="ai"}function cf(r){return r._getType()==="ai"}class bn extends es{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0||e.tool_call_chunks.length===0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const s=(e.tool_call_chunks??[]).reduce((o,u)=>{const c=o.findIndex(([l])=>"id"in u&&u.id&&"index"in u&&u.index!==void 0?u.id===l.id&&u.index===l.index:"id"in u&&u.id?u.id===l.id:"index"in u&&u.index!==void 0?u.index===l.index:!1);return c!==-1?o[c].push(u):o.push([u]),o},[]),i=[],a=[];for(const o of s){let u={};const c=o[0]?.name??"",l=o.map(h=>h.args||"").join(""),d=l.length?l:"{}",f=o[0]?.id;try{if(u=Dl(d),!f||u===null||typeof u!="object"||Array.isArray(u))throw new Error("Malformed tool call chunk args.");i.push({name:c,args:u,id:f,type:"tool_call"})}catch{a.push({name:c,args:d,id:f,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:i,invalid_tool_calls:a,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:Qr(this.content,e.content),additional_kwargs:et(this.additional_kwargs,e.additional_kwargs),response_metadata:et(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const n=to(this.tool_call_chunks,e.tool_call_chunks);n!==void 0&&n.length>0&&(t.tool_call_chunks=n)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){const n={...(this.usage_metadata?.input_token_details?.audio!==void 0||e.usage_metadata?.input_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(this.usage_metadata?.input_token_details?.cache_read!==void 0||e.usage_metadata?.input_token_details?.cache_read!==void 0)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(this.usage_metadata?.input_token_details?.cache_creation!==void 0||e.usage_metadata?.input_token_details?.cache_creation!==void 0)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},s={...(this.usage_metadata?.output_token_details?.audio!==void 0||e.usage_metadata?.output_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(this.usage_metadata?.output_token_details?.reasoning!==void 0||e.usage_metadata?.output_token_details?.reasoning!==void 0)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},i=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},o={input_tokens:i.input_tokens+a.input_tokens,output_tokens:i.output_tokens+a.output_tokens,total_tokens:i.total_tokens+a.total_tokens,...Object.keys(n).length>0&&{input_token_details:n},...Object.keys(s).length>0&&{output_token_details:s}};t.usage_metadata=o}return new bn(t)}}class fi extends fr{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return fi}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}}class no extends es{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new no({content:Qr(this.content,e.content),additional_kwargs:et(this.additional_kwargs,e.additional_kwargs),response_metadata:et(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}class ro extends es{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new ro({content:Qr(this.content,e.content),additional_kwargs:et(this.additional_kwargs,e.additional_kwargs),response_metadata:et(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class so extends fr{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}}class io extends es{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}constructor(e,t){super(e,t)}concat(e){return new io({content:Qr(this.content,e.content),additional_kwargs:et(this.additional_kwargs,e.additional_kwargs),response_metadata:et(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class lf extends fr{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}}class Hs extends es{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}constructor(e,t){super(e,t)}concat(e){return new Hs({content:Qr(this.content,e.content),additional_kwargs:et(this.additional_kwargs,e.additional_kwargs),response_metadata:et(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function rg(r,e){return r.lc_error_code=e,r.message=`${r.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,r}function sg(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="tool_call")}class jv extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}class Lv extends fr{constructor(e){super({...e,content:""}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.id=e.id}_getType(){return"remove"}get _printableFields(){return{...super._printableFields,id:this.id}}}function Mv(r){return sg(r)?r:typeof r.id=="string"&&r.type==="function"&&typeof r.function=="object"&&r.function!==null&&"arguments"in r.function&&typeof r.function.arguments=="string"&&"name"in r.function&&typeof r.function.name=="string"?{id:r.id,args:JSON.parse(r.function.arguments),name:r.function.name,type:"tool_call"}:r}function Dv(r){return typeof r=="object"&&r!=null&&r.lc===1&&Array.isArray(r.id)&&r.kwargs!=null&&typeof r.kwargs=="object"}function No(r){let e,t;if(Dv(r)){const n=r.id.at(-1);n==="HumanMessage"||n==="HumanMessageChunk"?e="user":n==="AIMessage"||n==="AIMessageChunk"?e="assistant":n==="SystemMessage"||n==="SystemMessageChunk"?e="system":n==="FunctionMessage"||n==="FunctionMessageChunk"?e="function":n==="ToolMessage"||n==="ToolMessageChunk"?e="tool":e="unknown",t=r.kwargs}else{const{type:n,...s}=r;e=n,t=s}if(e==="human"||e==="user")return new so(t);if(e==="ai"||e==="assistant"){const{tool_calls:n,...s}=t;if(!Array.isArray(n))return new qs(t);const i=n.map(Mv);return new qs({...s,tool_calls:i})}else{if(e==="system")return new lf(t);if(e==="developer")return new lf({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in t)return new Cv({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});if(e==="remove"&&"id"in t&&typeof t.id=="string")return new Lv({...t,id:t.id});throw rg(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(r,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Qn(r){if(typeof r=="string")return new so(r);if(Pt(r))return r;if(Array.isArray(r)){const[e,t]=r;return No({type:e,content:t})}else if(Rv(r)){const{role:e,...t}=r;return No({...t,type:e})}else return No(r)}function ig(r,e="Human",t="AI"){const n=[];for(const s of r){let i;if(s._getType()==="human")i=e;else if(s._getType()==="ai")i=t;else if(s._getType()==="system")i="System";else if(s._getType()==="function")i="Function";else if(s._getType()==="tool")i="Tool";else if(s._getType()==="generic")i=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const a=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);n.push(`${i}: ${a}${o}`)}return n.join(`
`)}function Uv(r){const e=r._getType();if(e==="human")return new io({...r});if(e==="ai"){let t={...r};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(n=>({...n,type:"tool_call_chunk",index:void 0,args:JSON.stringify(n.args)}))}),new bn({...t})}else{if(e==="system")return new Hs({...r});if(e==="function")return new ro({...r});if(fi.isInstance(r))return new no({...r});throw new Error("Unknown message type.")}}var ls={exports:{}},jo={},Lo,df;function Fv(){if(df)return Lo;df=1;function r(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return Lo=r,r.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},r.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},r.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},n),this._options.unref&&this._timer.unref(),!0},r.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},r.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},r.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},r.prototype.start=r.prototype.try,r.prototype.errors=function(){return this._errors},r.prototype.attempts=function(){return this._attempts},r.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,n=0,s=0;s<this._errors.length;s++){var i=this._errors[s],a=i.message,o=(e[a]||0)+1;e[a]=o,o>=n&&(t=i,n=o)}return t},Lo}var ff;function Bv(){return ff||(ff=1,(function(r){var e=Fv();r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)n[s]=t[s];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],a=0;a<n.retries;a++)i.push(this.createTimeout(a,n));return t&&t.forever&&!i.length&&i.push(this.createTimeout(a,n)),i.sort(function(o,u){return o-u}),i},r.createTimeout=function(t,n){var s=n.randomize?Math.random()+1:1,i=Math.round(s*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return i=Math.min(i,n.maxTimeout),i},r.wrap=function(t,n,s){if(n instanceof Array&&(s=n,n=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var a=0;a<s.length;a++){var o=s[a],u=t[o];t[o]=(function(l){var d=r.operation(n),f=Array.prototype.slice.call(arguments,1),h=f.pop();f.push(function(p){d.retry(p)||(p&&(arguments[0]=d.mainError()),h.apply(this,arguments))}),d.attempt(function(){l.apply(t,f)})}).bind(t,u),t[o].options=n}}})(jo)),jo}var Mo,hf;function zv(){return hf||(hf=1,Mo=Bv()),Mo}var pf;function Gv(){if(pf)return ls.exports;pf=1;const r=zv(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class t extends Error{constructor(o){super(),o instanceof Error?(this.originalError=o,{message:o}=o):(this.originalError=new Error(o),this.originalError.stack=this.stack),this.name="AbortError",this.message=o}}const n=(a,o,u)=>{const c=u.retries-(o-1);return a.attemptNumber=o,a.retriesLeft=c,a},s=a=>e.includes(a),i=(a,o)=>new Promise((u,c)=>{o={onFailedAttempt:()=>{},retries:10,...o};const l=r.operation(o);l.attempt(async d=>{try{u(await a(d))}catch(f){if(!(f instanceof Error)){c(new TypeError(`Non-error was thrown: "${f}". You should only throw errors.`));return}if(f instanceof t)l.stop(),c(f.originalError);else if(f instanceof TypeError&&!s(f.message))l.stop(),c(f);else{n(f,d,o);try{await o.onFailedAttempt(f)}catch(h){c(h);return}l.retry(f)||c(l.mainError())}}})});return ls.exports=i,ls.exports.default=i,ls.exports.AbortError=t,ls.exports}var qv=Gv();const Ic=li(qv),Hv=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Mn(r){return typeof r=="string"&&Hv.test(r)}function ag(r){if(!Mn(r))throw TypeError("Invalid UUID");var e,t=new Uint8Array(16);return t[0]=(e=parseInt(r.slice(0,8),16))>>>24,t[1]=e>>>16&255,t[2]=e>>>8&255,t[3]=e&255,t[4]=(e=parseInt(r.slice(9,13),16))>>>8,t[5]=e&255,t[6]=(e=parseInt(r.slice(14,18),16))>>>8,t[7]=e&255,t[8]=(e=parseInt(r.slice(19,23),16))>>>8,t[9]=e&255,t[10]=(e=parseInt(r.slice(24,36),16))/1099511627776&255,t[11]=e/4294967296&255,t[12]=e>>>24&255,t[13]=e>>>16&255,t[14]=e>>>8&255,t[15]=e&255,t}var qe=[];for(var Do=0;Do<256;++Do)qe.push((Do+256).toString(16).slice(1));function ts(r,e=0){return(qe[r[e+0]]+qe[r[e+1]]+qe[r[e+2]]+qe[r[e+3]]+"-"+qe[r[e+4]]+qe[r[e+5]]+"-"+qe[r[e+6]]+qe[r[e+7]]+"-"+qe[r[e+8]]+qe[r[e+9]]+"-"+qe[r[e+10]]+qe[r[e+11]]+qe[r[e+12]]+qe[r[e+13]]+qe[r[e+14]]+qe[r[e+15]]).toLowerCase()}var Ti,Vv=new Uint8Array(16);function Fl(){if(!Ti&&(Ti=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ti))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ti(Vv)}var Uo,Ii,Fo=0,Bo=0;function Wv(r,e,t){var n=0,s=e||new Array(16);r=r||{};var i=r.node,a=r.clockseq;if(r._v6||(i||(i=Uo),a==null&&(a=Ii)),i==null||a==null){var o=r.random||(r.rng||Fl)();i==null&&(i=[o[0],o[1],o[2],o[3],o[4],o[5]],!Uo&&!r._v6&&(i[0]|=1,Uo=i)),a==null&&(a=(o[6]<<8|o[7])&16383,Ii===void 0&&!r._v6&&(Ii=a))}var u=r.msecs!==void 0?r.msecs:Date.now(),c=r.nsecs!==void 0?r.nsecs:Bo+1,l=u-Fo+(c-Bo)/1e4;if(l<0&&r.clockseq===void 0&&(a=a+1&16383),(l<0||u>Fo)&&r.nsecs===void 0&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");Fo=u,Bo=c,Ii=a,u+=122192928e5;var d=((u&268435455)*1e4+c)%4294967296;s[n++]=d>>>24&255,s[n++]=d>>>16&255,s[n++]=d>>>8&255,s[n++]=d&255;var f=u/4294967296*1e4&268435455;s[n++]=f>>>8&255,s[n++]=f&255,s[n++]=f>>>24&15|16,s[n++]=f>>>16&255,s[n++]=a>>>8|128,s[n++]=a&255;for(var h=0;h<6;++h)s[n+h]=i[h];return e||ts(s)}function Zv(r){var e=typeof r=="string"?ag(r):r,t=Jv(e);return typeof r=="string"?ts(t):t}function Jv(r,e=!1){return Uint8Array.of((r[6]&15)<<4|r[7]>>4&15,(r[7]&15)<<4|(r[4]&240)>>4,(r[4]&15)<<4|(r[5]&240)>>4,(r[5]&15)<<4|(r[0]&240)>>4,(r[0]&15)<<4|(r[1]&240)>>4,(r[1]&15)<<4|(r[2]&240)>>4,96|r[2]&15,r[3],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15])}function Kv(r){r=unescape(encodeURIComponent(r));for(var e=[],t=0;t<r.length;++t)e.push(r.charCodeAt(t));return e}var Xv="6ba7b810-9dad-11d1-80b4-00c04fd430c8",Yv="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function Qv(r,e,t){function n(s,i,a,o){var u;if(typeof s=="string"&&(s=Kv(s)),typeof i=="string"&&(i=ag(i)),((u=i)===null||u===void 0?void 0:u.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var c=new Uint8Array(16+s.length);if(c.set(i),c.set(s,i.length),c=t(c),c[6]=c[6]&15|e,c[8]=c[8]&63|128,a){o=o||0;for(var l=0;l<16;++l)a[o+l]=c[l];return a}return ts(c)}try{n.name=r}catch{}return n.DNS=Xv,n.URL=Yv,n}var e0=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const mf={randomUUID:e0};function Ke(r,e,t){if(mf.randomUUID&&!r)return mf.randomUUID();r=r||{};var n=r.random||(r.rng||Fl)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,ts(n)}function t0(r,e,t,n){switch(r){case 0:return e&t^~e&n;case 1:return e^t^n;case 2:return e&t^e&n^t&n;case 3:return e^t^n}}function zo(r,e){return r<<e|r>>>32-e}function n0(r){var e=[1518500249,1859775393,2400959708,3395469782],t=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof r=="string"){var n=unescape(encodeURIComponent(r));r=[];for(var s=0;s<n.length;++s)r.push(n.charCodeAt(s))}else Array.isArray(r)||(r=Array.prototype.slice.call(r));r.push(128);for(var i=r.length/4+2,a=Math.ceil(i/16),o=new Array(a),u=0;u<a;++u){for(var c=new Uint32Array(16),l=0;l<16;++l)c[l]=r[u*64+l*4]<<24|r[u*64+l*4+1]<<16|r[u*64+l*4+2]<<8|r[u*64+l*4+3];o[u]=c}o[a-1][14]=(r.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(r.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var f=new Uint32Array(80),h=0;h<16;++h)f[h]=o[d][h];for(var p=16;p<80;++p)f[p]=zo(f[p-3]^f[p-8]^f[p-14]^f[p-16],1);for(var m=t[0],g=t[1],y=t[2],_=t[3],b=t[4],v=0;v<80;++v){var w=Math.floor(v/20),E=zo(m,5)+t0(w,g,y,_)+b+e[w]+f[v]>>>0;b=_,_=y,y=zo(g,30)>>>0,g=m,m=E}t[0]=t[0]+m>>>0,t[1]=t[1]+g>>>0,t[2]=t[2]+y>>>0,t[3]=t[3]+_>>>0,t[4]=t[4]+b>>>0}return[t[0]>>24&255,t[0]>>16&255,t[0]>>8&255,t[0]&255,t[1]>>24&255,t[1]>>16&255,t[1]>>8&255,t[1]&255,t[2]>>24&255,t[2]>>16&255,t[2]>>8&255,t[2]&255,t[3]>>24&255,t[3]>>16&255,t[3]>>8&255,t[3]&255,t[4]>>24&255,t[4]>>16&255,t[4]>>8&255,t[4]&255]}var Tr=Qv("v5",80,n0);function gf(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(r,s).enumerable})),t.push.apply(t,n)}return t}function yf(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?gf(Object(t),!0).forEach(function(n){r0(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):gf(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function r0(r,e,t){return(e=s0(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function s0(r){var e=i0(r,"string");return typeof e=="symbol"?e:e+""}function i0(r,e){if(typeof r!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function a0(r={},e,t=0){var n=Wv(yf(yf({},r),{},{_v6:!0}),new Uint8Array(16));return n=Zv(n),ts(n)}var _f=null,bf=null,Mt=0;function o0(r,e,t){r=r||{};var n=0,s=new Uint8Array(16),i=r.random||(r.rng||Fl)(),a=r.msecs!==void 0?r.msecs:Date.now(),o=r.seq!==void 0?r.seq:null,u=bf,c=_f;return a>Mt&&r.msecs===void 0&&(Mt=a,o!==null&&(u=null,c=null)),o!==null&&(o>2147483647&&(o=2147483647),u=o>>>19&4095,c=o&524287),(u===null||c===null)&&(u=i[6]&127,u=u<<8|i[7],c=i[8]&63,c=c<<8|i[9],c=c<<5|i[10]>>>3),a+1e4>Mt&&o===null?++c>524287&&(c=0,++u>4095&&(u=0,Mt++)):Mt=a,bf=u,_f=c,s[n++]=Mt/1099511627776&255,s[n++]=Mt/4294967296&255,s[n++]=Mt/16777216&255,s[n++]=Mt/65536&255,s[n++]=Mt/256&255,s[n++]=Mt&255,s[n++]=u>>>4&15|112,s[n++]=u&255,s[n++]=c>>>13&63|128,s[n++]=c>>>5&255,s[n++]=c<<3&255|i[10]&7,s[n++]=i[11],s[n++]=i[12],s[n++]=i[13],s[n++]=i[14],s[n++]=i[15],e||ts(s)}let u0=class{getStore(){}run(e,t){return t()}};const Go=Symbol.for("ls:tracing_async_local_storage"),c0=new u0;let l0=class{getInstance(){return globalThis[Go]??c0}initializeGlobalInstance(e){globalThis[Go]===void 0&&(globalThis[Go]=e)}};const d0=new l0;function f0(r=!1){const e=d0.getInstance().getStore();if(!r&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function Bl(r){return typeof r=="function"&&"langsmith:traceable"in r}const h0=Object.prototype.hasOwnProperty;function Rc(r,e){return h0.call(r,e)}function Cc(r){if(Array.isArray(r)){const t=new Array(r.length);for(let n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(r);let e=[];for(let t in r)Rc(r,t)&&e.push(t);return e}function rn(r){switch(typeof r){case"object":return JSON.parse(JSON.stringify(r));case"undefined":return null;default:return r}}function $c(r){let e=0;const t=r.length;let n;for(;e<t;){if(n=r.charCodeAt(e),n>=48&&n<=57){e++;continue}return!1}return!0}function wr(r){return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}function p0(r){return r.replace(/~1/g,"/").replace(/~0/g,"~")}function Nc(r){if(r===void 0)return!0;if(r){if(Array.isArray(r)){for(let t=0,n=r.length;t<n;t++)if(Nc(r[t]))return!0}else if(typeof r=="object"){const t=Cc(r),n=t.length;for(var e=0;e<n;e++)if(Nc(r[t[e]]))return!0}}return!1}function wf(r,e){const t=[r];for(const n in e){const s=typeof e[n]=="object"?JSON.stringify(e[n],null,2):e[n];typeof s<"u"&&t.push(`${n}: ${s}`)}return t.join(`
`)}class m0 extends Error{constructor(e,t,n,s,i){super(wf(e,{name:t,index:n,operation:s,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=wf(e,{name:t,index:n,operation:s,tree:i})}}const Ie=m0,Ir={add:function(r,e,t){return r[e]=this.value,{newDocument:t}},remove:function(r,e,t){var n=r[e];return delete r[e],{newDocument:t,removed:n}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:function(r,e,t){let n=jc(t,this.path);n&&(n=rn(n));const s=Rs(t,{op:"remove",path:this.from}).removed;return Rs(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:n}},copy:function(r,e,t){const n=jc(t,this.from);return Rs(t,{op:"add",path:this.path,value:rn(n)}),{newDocument:t}},test:function(r,e,t){return{newDocument:t,test:va(r[e],this.value)}},_get:function(r,e,t){return this.value=r[e],{newDocument:t}}};var g0={add:function(r,e,t){return $c(e)?r.splice(e,0,this.value):r[e]=this.value,{newDocument:t,index:e}},remove:function(r,e,t){var n=r.splice(e,1);return{newDocument:t,removed:n[0]}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:Ir.move,copy:Ir.copy,test:Ir.test,_get:Ir._get};function jc(r,e){if(e=="")return r;var t={op:"_get",path:e};return Rs(r,t),t.value}function Rs(r,e,t=!1,n=!0,s=!0,i=0){if(t&&(typeof t=="function"?t(e,0,r,e.path):Lc(e,0)),e.path===""){let a={newDocument:r};if(e.op==="add")return a.newDocument=e.value,a;if(e.op==="replace")return a.newDocument=e.value,a.removed=r,a;if(e.op==="move"||e.op==="copy")return a.newDocument=jc(r,e.from),e.op==="move"&&(a.removed=r),a;if(e.op==="test"){if(a.test=va(r,e.value),a.test===!1)throw new Ie("Test operation failed","TEST_OPERATION_FAILED",i,e,r);return a.newDocument=r,a}else{if(e.op==="remove")return a.removed=r,a.newDocument=null,a;if(e.op==="_get")return e.value=r,a;if(t)throw new Ie("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,r);return a}}else{n||(r=rn(r));const o=(e.path||"").split("/");let u=r,c=1,l=o.length,d,f,h;for(typeof t=="function"?h=t:h=Lc;;){if(f=o[c],f&&f.indexOf("~")!=-1&&(f=p0(f)),s&&(f=="__proto__"||f=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[f]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&h(e,0,r,d)),c++,Array.isArray(u)){if(f==="-")f=u.length;else{if(t&&!$c(f))throw new Ie("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,r);$c(f)&&(f=~~f)}if(c>=l){if(t&&e.op==="add"&&f>u.length)throw new Ie("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,r);const p=g0[e.op].call(e,u,f,r);if(p.test===!1)throw new Ie("Test operation failed","TEST_OPERATION_FAILED",i,e,r);return p}}else if(c>=l){const p=Ir[e.op].call(e,u,f,r);if(p.test===!1)throw new Ie("Test operation failed","TEST_OPERATION_FAILED",i,e,r);return p}if(u=u[f],t&&c<l&&(!u||typeof u!="object"))throw new Ie("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,r)}}}function wa(r,e,t,n=!0,s=!0){if(t&&!Array.isArray(e))throw new Ie("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(r=rn(r));const i=new Array(e.length);for(let a=0,o=e.length;a<o;a++)i[a]=Rs(r,e[a],t,!0,s,a),r=i[a].newDocument;return i.newDocument=r,i}function Lc(r,e,t,n){if(typeof r!="object"||r===null||Array.isArray(r))throw new Ie("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,r,t);if(Ir[r.op]){if(typeof r.path!="string")throw new Ie("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,r,t);if(r.path.indexOf("/")!==0&&r.path.length>0)throw new Ie('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,r,t);if((r.op==="move"||r.op==="copy")&&typeof r.from!="string")throw new Ie("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&r.value===void 0)throw new Ie("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&Nc(r.value))throw new Ie("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,r,t);if(t){if(r.op=="add"){var s=r.path.split("/").length,i=n.split("/").length;if(s!==i+1&&s!==i)throw new Ie("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,r,t)}else if(r.op==="replace"||r.op==="remove"||r.op==="_get"){if(r.path!==n)throw new Ie("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,r,t)}else if(r.op==="move"||r.op==="copy"){var a={op:"_get",path:r.from,value:void 0},o=y0([a],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new Ie("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,r,t)}}}else throw new Ie("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,r,t)}function y0(r,e,t){try{if(!Array.isArray(r))throw new Ie("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)wa(rn(e),rn(r),t||!0);else{t=t||Lc;for(var n=0;n<r.length;n++)t(r[n],n,e,void 0)}}catch(s){if(s instanceof Ie)return s;throw s}}function va(r,e){if(r===e)return!0;if(r&&e&&typeof r=="object"&&typeof e=="object"){var t=Array.isArray(r),n=Array.isArray(e),s,i,a;if(t&&n){if(i=r.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!va(r[s],e[s]))return!1;return!0}if(t!=n)return!1;var o=Object.keys(r);if(i=o.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=i;s--!==0;)if(a=o[s],!va(r[a],e[a]))return!1;return!0}return r!==r&&e!==e}function og(r,e,t,n,s){if(e!==r){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=Cc(e),a=Cc(r),o=!1,u=a.length-1;u>=0;u--){var c=a[u],l=r[c];if(Rc(e,c)&&!(e[c]===void 0&&l!==void 0&&Array.isArray(e)===!1)){var d=e[c];typeof l=="object"&&l!=null&&typeof d=="object"&&d!=null&&Array.isArray(l)===Array.isArray(d)?og(l,d,t,n+"/"+wr(c),s):l!==d&&(s&&t.push({op:"test",path:n+"/"+wr(c),value:rn(l)}),t.push({op:"replace",path:n+"/"+wr(c),value:rn(d)}))}else Array.isArray(r)===Array.isArray(e)?(s&&t.push({op:"test",path:n+"/"+wr(c),value:rn(l)}),t.push({op:"remove",path:n+"/"+wr(c)}),o=!0):(s&&t.push({op:"test",path:n,value:r}),t.push({op:"replace",path:n,value:e}))}if(!(!o&&i.length==a.length))for(var u=0;u<i.length;u++){var c=i[u];!Rc(r,c)&&e[c]!==void 0&&t.push({op:"add",path:n+"/"+wr(c),value:rn(e[c])})}}}function _0(r,e,t=!1){var n=[];return og(r,e,n,"",t),n}const b0="gen_ai.operation.name",w0="gen_ai.system",vf="gen_ai.request.model",v0="gen_ai.response.model",Sf="gen_ai.usage.input_tokens",Ef="gen_ai.usage.output_tokens",xf="gen_ai.usage.total_tokens",S0="gen_ai.request.max_tokens",E0="gen_ai.request.temperature",x0="gen_ai.request.top_p",O0="gen_ai.request.frequency_penalty",k0="gen_ai.request.presence_penalty",P0="gen_ai.response.finish_reasons",A0="gen_ai.prompt",T0="gen_ai.completion",I0="gen_ai.request.extra_query",R0="gen_ai.request.extra_body",C0="gen_ai.serialized.name",$0="gen_ai.serialized.signature",N0="gen_ai.serialized.doc",j0="gen_ai.response.id",L0="gen_ai.response.service_tier",M0="gen_ai.response.system_fingerprint",D0="gen_ai.usage.input_token_details",U0="gen_ai.usage.output_token_details",F0="langsmith.trace.session_id",B0="langsmith.trace.session_name",z0="langsmith.span.kind",G0="langsmith.trace.name",q0="langsmith.metadata",Of="langsmith.span.tags",H0="langsmith.request.streaming",V0="langsmith.request.headers",W0=(...r)=>fetch(...r),ug=Symbol.for("ls:fetch_implementation"),Z0=()=>{const r=globalThis[ug];return r?typeof r=="function"&&"Headers"in r&&"Request"in r&&"Response"in r:!1},J0=r=>async(...e)=>{if(r||ut("DEBUG")==="true"){const[n,s]=e;console.log(`â†’ ${s?.method||"GET"} ${n}`)}const t=await(globalThis[ug]??W0)(...e);return(r||ut("DEBUG")==="true")&&console.log(`â† ${t.status} ${t.statusText} ${t.url}`),t},cg=()=>ut("PROJECT")??un("LANGCHAIN_SESSION")??"default",kf={};function Mc(r){kf[r]||(console.warn(r),kf[r]=!0)}const K0=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function Y(r,e){if(!K0.test(r)){const t=e!==void 0?`Invalid UUID for ${e}: ${r}`:`Invalid UUID: ${r}`;throw new Error(t)}return r}function X0(r){const e=typeof r=="string"?Date.parse(r):r;return o0({msecs:e,seq:0})}const lg="0.3.87";var Dc={};let Qt;const Y0=()=>typeof window<"u"&&typeof window.document<"u",Q0=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",eS=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),dg=()=>typeof Deno<"u",tS=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!dg(),fg=()=>Qt||(typeof Bun<"u"?Qt="bun":Y0()?Qt="browser":tS()?Qt="node":Q0()?Qt="webworker":eS()?Qt="jsdom":dg()?Qt="deno":Qt="other",Qt);let qo;function hg(){if(qo===void 0){const r=fg(),e=rS();qo={library:"langsmith",runtime:r,sdk:"langsmith-js",sdk_version:lg,...e}}return qo}function pg(){const r=nS(),e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[n,s]of Object.entries(r))typeof s=="string"&&!t.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[n]=s);return e}function nS(){const r={};try{if(typeof process<"u"&&Dc)for(const[e,t]of Object.entries(Dc))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&t!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof t=="string"?r[e]=t.slice(0,2)+"*".repeat(t.length-4)+t.slice(-2):r[e]=t)}catch{}return r}function un(r){try{return typeof process<"u"?Dc?.[r]:void 0}catch{return}}function ut(r){return un(`LANGSMITH_${r}`)||un(`LANGCHAIN_${r}`)}let Ho;function rS(){if(Ho!==void 0)return Ho;const r=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of r){const n=un(t);n!==void 0&&(e[t]=n)}return Ho=e,e}function mg(){return un("OTEL_ENABLED")==="true"||ut("OTEL_ENABLED")==="true"}class sS{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){!this.hasWarned&&mg()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let n;if(t.length===1&&typeof t[0]=="function"?n=t[0]:t.length===2&&typeof t[1]=="function"?n=t[1]:t.length===3&&typeof t[2]=="function"&&(n=t[2]),typeof n=="function")return n()}}class iS{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new sS})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class aS{active(){return{}}with(e,t){return t()}}const Vo=Symbol.for("ls:otel_trace"),Wo=Symbol.for("ls:otel_context"),Pf=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),oS=new iS,uS=new aS;class cS{getTraceInstance(){return globalThis[Vo]??oS}getContextInstance(){return globalThis[Wo]??uS}initializeGlobalInstances(e){globalThis[Vo]===void 0&&(globalThis[Vo]=e.trace),globalThis[Wo]===void 0&&(globalThis[Wo]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[Pf]=e}getDefaultOTLPTracerComponents(){return globalThis[Pf]??void 0}}const zl=new cS;function gg(){return zl.getTraceInstance()}function lS(){return zl.getContextInstance()}function dS(){return zl.getDefaultOTLPTracerComponents()}const fS={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function hS(r){return fS[r]||r}class pS{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(const n of e)try{if(!n.run)continue;if(n.operation==="post"){const s=this.createSpanForRun(n,n.run,t.get(n.id));s&&!n.run.end_time&&this.spans.set(n.id,s)}else this.updateSpanForRun(n,n.run)}catch(s){console.error(`Error processing operation ${n.id}:`,s)}}createSpanForRun(e,t,n){const s=n&&gg().getSpan(n);if(s)try{return this.finishSpanSetup(s,t,e)}catch(i){console.error(`Failed to create span for run ${e.id}:`,i);return}}finishSpanSetup(e,t,n){return this.setSpanAttributes(e,t,n),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{const n=this.spans.get(e.id);if(!n){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(n,t,e),t.error?(n.setStatus({code:2}),n.recordException(new Error(t.error))):n.setStatus({code:1});const s=t.end_time;s&&(n.end(new Date(s)),this.spans.delete(e.id))}catch(n){console.error(`Failed to update span for run ${e.id}:`,n)}}extractModelName(e){if(e.extra?.metadata){const t=e.extra.metadata;if(t.ls_model_name)return t.ls_model_name;if(t.invocation_params){const n=t.invocation_params;if(n.model)return n.model;if(n.model_name)return n.model_name}}}setSpanAttributes(e,t,n){if("run_type"in t&&t.run_type){e.setAttribute(z0,t.run_type);const o=hS(t.run_type||"chain");e.setAttribute(b0,o)}"name"in t&&t.name&&e.setAttribute(G0,t.name),"session_id"in t&&t.session_id&&e.setAttribute(F0,t.session_id),"session_name"in t&&t.session_name&&e.setAttribute(B0,t.session_name),this.setGenAiSystem(e,t);const s=this.extractModelName(t);s&&e.setAttribute(vf,s),"prompt_tokens"in t&&typeof t.prompt_tokens=="number"&&e.setAttribute(Sf,t.prompt_tokens),"completion_tokens"in t&&typeof t.completion_tokens=="number"&&e.setAttribute(Ef,t.completion_tokens),"total_tokens"in t&&typeof t.total_tokens=="number"&&e.setAttribute(xf,t.total_tokens),this.setInvocationParameters(e,t);const i=t.extra?.metadata||{};for(const[o,u]of Object.entries(i))u!=null&&e.setAttribute(`${q0}.${o}`,String(u));const a=t.tags;if(a&&Array.isArray(a)?e.setAttribute(Of,a.join(", ")):a&&e.setAttribute(Of,String(a)),"serialized"in t&&typeof t.serialized=="object"){const o=t.serialized;o.name&&e.setAttribute(C0,String(o.name)),o.signature&&e.setAttribute($0,String(o.signature)),o.doc&&e.setAttribute(N0,String(o.doc))}this.setIOAttributes(e,n)}setGenAiSystem(e,t){let n="langchain";const s=this.extractModelName(t);if(s){const i=s.toLowerCase();i.includes("anthropic")||i.startsWith("claude")?n="anthropic":i.includes("bedrock")?n="aws.bedrock":i.includes("azure")&&i.includes("openai")?n="az.ai.openai":i.includes("azure")&&i.includes("inference")?n="az.ai.inference":i.includes("cohere")?n="cohere":i.includes("deepseek")?n="deepseek":i.includes("gemini")?n="gemini":i.includes("groq")?n="groq":i.includes("watson")||i.includes("ibm")?n="ibm.watsonx.ai":i.includes("mistral")?n="mistral_ai":i.includes("gpt")||i.includes("openai")?n="openai":i.includes("perplexity")||i.includes("sonar")?n="perplexity":i.includes("vertex")?n="vertex_ai":(i.includes("xai")||i.includes("grok"))&&(n="xai")}e.setAttribute(w0,n)}setInvocationParameters(e,t){if(!t.extra?.metadata?.invocation_params)return;const n=t.extra.metadata.invocation_params;n.max_tokens!==void 0&&e.setAttribute(S0,n.max_tokens),n.temperature!==void 0&&e.setAttribute(E0,n.temperature),n.top_p!==void 0&&e.setAttribute(x0,n.top_p),n.frequency_penalty!==void 0&&e.setAttribute(O0,n.frequency_penalty),n.presence_penalty!==void 0&&e.setAttribute(k0,n.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{const n=t.run.inputs;typeof n=="object"&&n!==null&&(n.model&&Array.isArray(n.messages)&&e.setAttribute(vf,n.model),n.stream!==void 0&&e.setAttribute(H0,n.stream),n.extra_headers&&e.setAttribute(V0,JSON.stringify(n.extra_headers)),n.extra_query&&e.setAttribute(I0,JSON.stringify(n.extra_query)),n.extra_body&&e.setAttribute(R0,JSON.stringify(n.extra_body))),e.setAttribute(A0,JSON.stringify(n))}catch(n){console.debug(`Failed to process inputs for run ${t.id}`,n)}if(t.run.outputs)try{const n=t.run.outputs,s=this.getUnifiedRunTokens(n);if(s&&(e.setAttribute(Sf,s[0]),e.setAttribute(Ef,s[1]),e.setAttribute(xf,s[0]+s[1])),n&&typeof n=="object"){if(n.model&&e.setAttribute(v0,String(n.model)),n.id&&e.setAttribute(j0,n.id),n.choices&&Array.isArray(n.choices)){const i=n.choices.map(a=>a.finish_reason).filter(a=>a).map(String);i.length>0&&e.setAttribute(P0,i.join(", "))}if(n.service_tier&&e.setAttribute(L0,n.service_tier),n.system_fingerprint&&e.setAttribute(M0,n.system_fingerprint),n.usage_metadata&&typeof n.usage_metadata=="object"){const i=n.usage_metadata;i.input_token_details&&e.setAttribute(D0,JSON.stringify(i.input_token_details)),i.output_token_details&&e.setAttribute(U0,JSON.stringify(i.output_token_details))}}e.setAttribute(T0,JSON.stringify(n))}catch(n){console.debug(`Failed to process outputs for run ${t.id}`,n)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;const n=Object.keys(e);for(const a of n){const o=e[a];if(!(!o||typeof o!="object")&&(t=this.extractUnifiedRunTokens(o.usage_metadata),t||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(t=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),t)))return t}const s=e.generations||[];if(!Array.isArray(s))return null;const i=Array.isArray(s[0])?s.flat():s;for(const a of i)if(typeof a=="object"&&a.message&&typeof a.message=="object"&&a.message.kwargs&&typeof a.message.kwargs=="object"&&(t=this.extractUnifiedRunTokens(a.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}const mS=Object.prototype.toString,gS=r=>mS.call(r)==="[object Error]",yS=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function _S(r){if(!(r&&gS(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;const{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:yS.has(t)}function bS(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Ri(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be â‰¥ ${t}.`)}}class wS extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function vS(r,e){const t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1;let s=Math.round(n*e.minTimeout*e.factor**(t-1));return s=Math.min(s,e.maxTimeout),s}function Af(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function SS({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:s}){const i=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(i instanceof wS)throw i.originalError;const a=Number.isFinite(s.retries)?Math.max(0,s.retries-t):s.retries,o=s.maxRetryTime??Number.POSITIVE_INFINITY,u=Object.freeze({error:i,attemptNumber:e,retriesLeft:a,retriesConsumed:t});if(await s.onFailedAttempt(u),Af(n,o)<=0)throw i;const c=await s.shouldConsumeRetry(u),l=Af(n,o);if(l<=0||a<=0)throw i;if(i instanceof TypeError&&!_S(i)){if(c)throw i;return s.signal?.throwIfAborted(),!1}if(!await s.shouldRetry(u))throw i;if(!c)return s.signal?.throwIfAborted(),!1;const d=vS(t,s),f=Math.min(d,l);return f>0&&await new Promise((h,p)=>{const m=()=>{clearTimeout(g),s.signal?.removeEventListener("abort",m),p(s.signal.reason)},g=setTimeout(()=>{s.signal?.removeEventListener("abort",m),h()},f);s.unref&&g.unref?.(),s.signal?.addEventListener("abort",m,{once:!0})}),s.signal?.throwIfAborted(),!0}async function ES(r,e={}){if(e={...e},bS(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,Ri("factor",e.factor,{min:0,allowInfinity:!1}),Ri("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),Ri("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),Ri("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,n=0;const s=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{e.signal?.throwIfAborted();const i=await r(t);return e.signal?.throwIfAborted(),i}catch(i){await SS({error:i,attemptNumber:t,retriesConsumed:n,startTime:s,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}var Ci={},Zo={exports:{}},Tf;function xS(){return Tf||(Tf=1,(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(u,c,l){this.fn=u,this.context=c,this.once=l||!1}function i(u,c,l,d,f){if(typeof l!="function")throw new TypeError("The listener must be a function");var h=new s(l,d||u,f),p=t?t+c:c;return u._events[p]?u._events[p].fn?u._events[p]=[u._events[p],h]:u._events[p].push(h):(u._events[p]=h,u._eventsCount++),u}function a(u,c){--u._eventsCount===0?u._events=new n:delete u._events[c]}function o(){this._events=new n,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],l,d;if(this._eventsCount===0)return c;for(d in l=this._events)e.call(l,d)&&c.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},o.prototype.listeners=function(c){var l=t?t+c:c,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var f=0,h=d.length,p=new Array(h);f<h;f++)p[f]=d[f].fn;return p},o.prototype.listenerCount=function(c){var l=t?t+c:c,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,l,d,f,h,p){var m=t?t+c:c;if(!this._events[m])return!1;var g=this._events[m],y=arguments.length,_,b;if(g.fn){switch(g.once&&this.removeListener(c,g.fn,void 0,!0),y){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,l),!0;case 3:return g.fn.call(g.context,l,d),!0;case 4:return g.fn.call(g.context,l,d,f),!0;case 5:return g.fn.call(g.context,l,d,f,h),!0;case 6:return g.fn.call(g.context,l,d,f,h,p),!0}for(b=1,_=new Array(y-1);b<y;b++)_[b-1]=arguments[b];g.fn.apply(g.context,_)}else{var v=g.length,w;for(b=0;b<v;b++)switch(g[b].once&&this.removeListener(c,g[b].fn,void 0,!0),y){case 1:g[b].fn.call(g[b].context);break;case 2:g[b].fn.call(g[b].context,l);break;case 3:g[b].fn.call(g[b].context,l,d);break;case 4:g[b].fn.call(g[b].context,l,d,f);break;default:if(!_)for(w=1,_=new Array(y-1);w<y;w++)_[w-1]=arguments[w];g[b].fn.apply(g[b].context,_)}}return!0},o.prototype.on=function(c,l,d){return i(this,c,l,d,!1)},o.prototype.once=function(c,l,d){return i(this,c,l,d,!0)},o.prototype.removeListener=function(c,l,d,f){var h=t?t+c:c;if(!this._events[h])return this;if(!l)return a(this,h),this;var p=this._events[h];if(p.fn)p.fn===l&&(!f||p.once)&&(!d||p.context===d)&&a(this,h);else{for(var m=0,g=[],y=p.length;m<y;m++)(p[m].fn!==l||f&&!p[m].once||d&&p[m].context!==d)&&g.push(p[m]);g.length?this._events[h]=g.length===1?g[0]:g:a(this,h)}return this},o.prototype.removeAllListeners=function(c){var l;return c?(l=t?t+c:c,this._events[l]&&a(this,l)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,r.exports=o})(Zo)),Zo.exports}var ds={exports:{}},Jo,If;function OS(){return If||(If=1,Jo=(r,e)=>(e=e||(()=>{}),r.then(t=>new Promise(n=>{n(e())}).then(()=>t),t=>new Promise(n=>{n(e())}).then(()=>{throw t})))),Jo}var Rf;function kS(){if(Rf)return ds.exports;Rf=1;const r=OS();class e extends Error{constructor(s){super(s),this.name="TimeoutError"}}const t=(n,s,i)=>new Promise((a,o)=>{if(typeof s!="number"||s<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(s===1/0){a(n);return}const u=setTimeout(()=>{if(typeof i=="function"){try{a(i())}catch(d){o(d)}return}const c=typeof i=="string"?i:`Promise timed out after ${s} milliseconds`,l=i instanceof Error?i:new e(c);typeof n.cancel=="function"&&n.cancel(),o(l)},s);r(n.then(a,o),()=>{clearTimeout(u)})});return ds.exports=t,ds.exports.default=t,ds.exports.TimeoutError=e,ds.exports}var $i={},Ni={},Cf;function PS(){if(Cf)return Ni;Cf=1,Object.defineProperty(Ni,"__esModule",{value:!0});function r(e,t,n){let s=0,i=e.length;for(;i>0;){const a=i/2|0;let o=s+a;n(e[o],t)<=0?(s=++o,i-=a+1):i=a}return s}return Ni.default=r,Ni}var $f;function AS(){if($f)return $i;$f=1,Object.defineProperty($i,"__esModule",{value:!0});const r=PS();class e{constructor(){this._queue=[]}enqueue(n,s){s=Object.assign({priority:0},s);const i={priority:s.priority,run:n};if(this.size&&this._queue[this.size-1].priority>=s.priority){this._queue.push(i);return}const a=r.default(this._queue,i,(o,u)=>u.priority-o.priority);this._queue.splice(a,0,i)}dequeue(){const n=this._queue.shift();return n?.run}filter(n){return this._queue.filter(s=>s.priority===n.priority).map(s=>s.run)}get size(){return this._queue.length}}return $i.default=e,$i}var Nf;function TS(){if(Nf)return Ci;Nf=1,Object.defineProperty(Ci,"__esModule",{value:!0});const r=xS(),e=kS(),t=AS(),n=()=>{},s=new e.TimeoutError;class i extends r{constructor(o){var u,c,l,d;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=n,this._resolveIdle=n,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:t.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(c=(u=o.intervalCap)===null||u===void 0?void 0:u.toString())!==null&&c!==void 0?c:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(d=(l=o.interval)===null||l===void 0?void 0:l.toString())!==null&&d!==void 0?d:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=n,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=n,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const o=Date.now();if(this._intervalId===void 0){const u=this._intervalEnd-o;if(u<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},u)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const u=this._queue.dequeue();return u?(this.emit("active"),u(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,u={}){return new Promise((c,l)=>{const d=async()=>{this._pendingCount++,this._intervalCount++;try{const f=this._timeout===void 0&&u.timeout===void 0?o():e.default(Promise.resolve(o()),u.timeout===void 0?this._timeout:u.timeout,()=>{(u.throwOnTimeout===void 0?this._throwOnTimeout:u.throwOnTimeout)&&l(s)});c(await f)}catch(f){l(f)}this._next()};this._queue.enqueue(d,u),this._tryToStartAnother(),this.emit("add")})}async addAll(o,u){return Promise.all(o.map(async c=>this.add(c,u)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{const u=this._resolveEmpty;this._resolveEmpty=()=>{u(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{const u=this._resolveIdle;this._resolveIdle=()=>{u(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}}return Ci.default=i,Ci}var IS=TS();const gn=li(IS),RS=[408,425,429,500,502,503,504];let jf=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxQueueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.maxQueueSizeBytes=e.maxQueueSizeBytes,"default"in gn?this.queue=new gn.default({concurrency:this.maxConcurrency}):this.queue=new gn({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){return this.callWithOptions({},e,...t)}callWithOptions(e,t,...n){const s=e.sizeBytes??0;if(this.maxQueueSizeBytes!==void 0&&s>0&&this.queueSizeBytes+s>this.maxQueueSizeBytes)return Promise.reject(new Error(`Queue size limit (${this.maxQueueSizeBytes} bytes) exceeded. Current queue size: ${this.queueSizeBytes} bytes, attempted addition: ${s} bytes.`));s>0&&(this.queueSizeBytes+=s);const i=this.onFailedResponseHook;let a=this.queue.add(()=>ES(()=>t(...n).catch(o=>{throw o instanceof Error?o:new Error(o)}),{async onFailedAttempt({error:o}){if(o.message.startsWith("Cancel")||o.message.startsWith("TimeoutError")||o.name==="TimeoutError"||o.message.startsWith("AbortError")||o?.code==="ECONNABORTED")throw o;const u=o?.response;if(i&&await i(u))return;const c=u?.status??o?.status;if(c&&!RS.includes(+c))throw o},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0});return s>0&&(a=a.finally(()=>{this.queueSizeBytes-=s})),e.signal?Promise.race([a,new Promise((o,u)=>{e.signal?.addEventListener("abort",()=>{u(new Error("AbortError"))})})]):a}};function Lf(r){return typeof r?._getType=="function"}function Mf(r){const e={type:r._getType(),data:{content:r.content}};return r?.additional_kwargs&&Object.keys(r.additional_kwargs).length>0&&(e.data.additional_kwargs={...r.additional_kwargs}),e}var ji={exports:{}},Ko,Df;function ao(){if(Df)return Ko;Df=1;const r="2.0.0",e=256,t=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,s=e-6;return Ko={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:s,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:r,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},Ko}var Xo,Uf;function oo(){if(Uf)return Xo;Uf=1;var r={};return Xo=typeof process=="object"&&r&&r.NODE_DEBUG&&/\bsemver\b/i.test(r.NODE_DEBUG)?(...t)=>console.error("SEMVER",...t):()=>{},Xo}var Ff;function hi(){return Ff||(Ff=1,(function(r,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:s}=ao(),i=oo();e=r.exports={};const a=e.re=[],o=e.safeRe=[],u=e.src=[],c=e.safeSrc=[],l=e.t={};let d=0;const f="[a-zA-Z0-9-]",h=[["\\s",1],["\\d",s],[f,n]],p=g=>{for(const[y,_]of h)g=g.split(`${y}*`).join(`${y}{0,${_}}`).split(`${y}+`).join(`${y}{1,${_}}`);return g},m=(g,y,_)=>{const b=p(y),v=d++;i(g,v,y),l[g]=v,u[v]=y,c[v]=b,a[v]=new RegExp(y,_?"g":void 0),o[v]=new RegExp(b,_?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${f}*`),m("MAINVERSION",`(${u[l.NUMERICIDENTIFIER]})\\.(${u[l.NUMERICIDENTIFIER]})\\.(${u[l.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${u[l.NUMERICIDENTIFIERLOOSE]})\\.(${u[l.NUMERICIDENTIFIERLOOSE]})\\.(${u[l.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${u[l.NONNUMERICIDENTIFIER]}|${u[l.NUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${u[l.NONNUMERICIDENTIFIER]}|${u[l.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASE",`(?:-(${u[l.PRERELEASEIDENTIFIER]}(?:\\.${u[l.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${u[l.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${u[l.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${f}+`),m("BUILD",`(?:\\+(${u[l.BUILDIDENTIFIER]}(?:\\.${u[l.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${u[l.MAINVERSION]}${u[l.PRERELEASE]}?${u[l.BUILD]}?`),m("FULL",`^${u[l.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${u[l.MAINVERSIONLOOSE]}${u[l.PRERELEASELOOSE]}?${u[l.BUILD]}?`),m("LOOSE",`^${u[l.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${u[l.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${u[l.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${u[l.XRANGEIDENTIFIER]})(?:\\.(${u[l.XRANGEIDENTIFIER]})(?:\\.(${u[l.XRANGEIDENTIFIER]})(?:${u[l.PRERELEASE]})?${u[l.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${u[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[l.XRANGEIDENTIFIERLOOSE]})(?:${u[l.PRERELEASELOOSE]})?${u[l.BUILD]}?)?)?`),m("XRANGE",`^${u[l.GTLT]}\\s*${u[l.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${u[l.GTLT]}\\s*${u[l.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),m("COERCE",`${u[l.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",u[l.COERCEPLAIN]+`(?:${u[l.PRERELEASE]})?(?:${u[l.BUILD]})?(?:$|[^\\d])`),m("COERCERTL",u[l.COERCE],!0),m("COERCERTLFULL",u[l.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${u[l.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",m("TILDE",`^${u[l.LONETILDE]}${u[l.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${u[l.LONETILDE]}${u[l.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${u[l.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",m("CARET",`^${u[l.LONECARET]}${u[l.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${u[l.LONECARET]}${u[l.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${u[l.GTLT]}\\s*(${u[l.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${u[l.GTLT]}\\s*(${u[l.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${u[l.GTLT]}\\s*(${u[l.LOOSEPLAIN]}|${u[l.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${u[l.XRANGEPLAIN]})\\s+-\\s+(${u[l.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${u[l.XRANGEPLAINLOOSE]})\\s+-\\s+(${u[l.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(ji,ji.exports)),ji.exports}var Yo,Bf;function Gl(){if(Bf)return Yo;Bf=1;const r=Object.freeze({loose:!0}),e=Object.freeze({});return Yo=n=>n?typeof n!="object"?r:n:e,Yo}var Qo,zf;function yg(){if(zf)return Qo;zf=1;const r=/^[0-9]+$/,e=(n,s)=>{if(typeof n=="number"&&typeof s=="number")return n===s?0:n<s?-1:1;const i=r.test(n),a=r.test(s);return i&&a&&(n=+n,s=+s),n===s?0:i&&!a?-1:a&&!i?1:n<s?-1:1};return Qo={compareIdentifiers:e,rcompareIdentifiers:(n,s)=>e(s,n)},Qo}var eu,Gf;function nt(){if(Gf)return eu;Gf=1;const r=oo(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:t}=ao(),{safeRe:n,t:s}=hi(),i=Gl(),{compareIdentifiers:a}=yg();class o{constructor(c,l){if(l=i(l),c instanceof o){if(c.loose===!!l.loose&&c.includePrerelease===!!l.includePrerelease)return c;c=c.version}else if(typeof c!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof c}".`);if(c.length>e)throw new TypeError(`version is longer than ${e} characters`);r("SemVer",c,l),this.options=l,this.loose=!!l.loose,this.includePrerelease=!!l.includePrerelease;const d=c.trim().match(l.loose?n[s.LOOSE]:n[s.FULL]);if(!d)throw new TypeError(`Invalid Version: ${c}`);if(this.raw=c,this.major=+d[1],this.minor=+d[2],this.patch=+d[3],this.major>t||this.major<0)throw new TypeError("Invalid major version");if(this.minor>t||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>t||this.patch<0)throw new TypeError("Invalid patch version");d[4]?this.prerelease=d[4].split(".").map(f=>{if(/^[0-9]+$/.test(f)){const h=+f;if(h>=0&&h<t)return h}return f}):this.prerelease=[],this.build=d[5]?d[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(c){if(r("SemVer.compare",this.version,this.options,c),!(c instanceof o)){if(typeof c=="string"&&c===this.version)return 0;c=new o(c,this.options)}return c.version===this.version?0:this.compareMain(c)||this.comparePre(c)}compareMain(c){return c instanceof o||(c=new o(c,this.options)),this.major<c.major?-1:this.major>c.major?1:this.minor<c.minor?-1:this.minor>c.minor?1:this.patch<c.patch?-1:this.patch>c.patch?1:0}comparePre(c){if(c instanceof o||(c=new o(c,this.options)),this.prerelease.length&&!c.prerelease.length)return-1;if(!this.prerelease.length&&c.prerelease.length)return 1;if(!this.prerelease.length&&!c.prerelease.length)return 0;let l=0;do{const d=this.prerelease[l],f=c.prerelease[l];if(r("prerelease compare",l,d,f),d===void 0&&f===void 0)return 0;if(f===void 0)return 1;if(d===void 0)return-1;if(d===f)continue;return a(d,f)}while(++l)}compareBuild(c){c instanceof o||(c=new o(c,this.options));let l=0;do{const d=this.build[l],f=c.build[l];if(r("build compare",l,d,f),d===void 0&&f===void 0)return 0;if(f===void 0)return 1;if(d===void 0)return-1;if(d===f)continue;return a(d,f)}while(++l)}inc(c,l,d){if(c.startsWith("pre")){if(!l&&d===!1)throw new Error("invalid increment argument: identifier is empty");if(l){const f=`-${l}`.match(this.options.loose?n[s.PRERELEASELOOSE]:n[s.PRERELEASE]);if(!f||f[1]!==l)throw new Error(`invalid identifier: ${l}`)}}switch(c){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",l,d);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",l,d);break;case"prepatch":this.prerelease.length=0,this.inc("patch",l,d),this.inc("pre",l,d);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",l,d),this.inc("pre",l,d);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const f=Number(d)?1:0;if(this.prerelease.length===0)this.prerelease=[f];else{let h=this.prerelease.length;for(;--h>=0;)typeof this.prerelease[h]=="number"&&(this.prerelease[h]++,h=-2);if(h===-1){if(l===this.prerelease.join(".")&&d===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(f)}}if(l){let h=[l,f];d===!1&&(h=[l]),a(this.prerelease[0],l)===0?isNaN(this.prerelease[1])&&(this.prerelease=h):this.prerelease=h}break}default:throw new Error(`invalid increment argument: ${c}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return eu=o,eu}var tu,qf;function ns(){if(qf)return tu;qf=1;const r=nt();return tu=(t,n,s=!1)=>{if(t instanceof r)return t;try{return new r(t,n)}catch(i){if(!s)return null;throw i}},tu}var nu,Hf;function CS(){if(Hf)return nu;Hf=1;const r=ns();return nu=(t,n)=>{const s=r(t,n);return s?s.version:null},nu}var ru,Vf;function $S(){if(Vf)return ru;Vf=1;const r=ns();return ru=(t,n)=>{const s=r(t.trim().replace(/^[=v]+/,""),n);return s?s.version:null},ru}var su,Wf;function NS(){if(Wf)return su;Wf=1;const r=nt();return su=(t,n,s,i,a)=>{typeof s=="string"&&(a=i,i=s,s=void 0);try{return new r(t instanceof r?t.version:t,s).inc(n,i,a).version}catch{return null}},su}var iu,Zf;function jS(){if(Zf)return iu;Zf=1;const r=ns();return iu=(t,n)=>{const s=r(t,null,!0),i=r(n,null,!0),a=s.compare(i);if(a===0)return null;const o=a>0,u=o?s:i,c=o?i:s,l=!!u.prerelease.length;if(!!c.prerelease.length&&!l){if(!c.patch&&!c.minor)return"major";if(c.compareMain(u)===0)return c.minor&&!c.patch?"minor":"patch"}const f=l?"pre":"";return s.major!==i.major?f+"major":s.minor!==i.minor?f+"minor":s.patch!==i.patch?f+"patch":"prerelease"},iu}var au,Jf;function LS(){if(Jf)return au;Jf=1;const r=nt();return au=(t,n)=>new r(t,n).major,au}var ou,Kf;function MS(){if(Kf)return ou;Kf=1;const r=nt();return ou=(t,n)=>new r(t,n).minor,ou}var uu,Xf;function DS(){if(Xf)return uu;Xf=1;const r=nt();return uu=(t,n)=>new r(t,n).patch,uu}var cu,Yf;function US(){if(Yf)return cu;Yf=1;const r=ns();return cu=(t,n)=>{const s=r(t,n);return s&&s.prerelease.length?s.prerelease:null},cu}var lu,Qf;function Kt(){if(Qf)return lu;Qf=1;const r=nt();return lu=(t,n,s)=>new r(t,s).compare(new r(n,s)),lu}var du,eh;function FS(){if(eh)return du;eh=1;const r=Kt();return du=(t,n,s)=>r(n,t,s),du}var fu,th;function BS(){if(th)return fu;th=1;const r=Kt();return fu=(t,n)=>r(t,n,!0),fu}var hu,nh;function ql(){if(nh)return hu;nh=1;const r=nt();return hu=(t,n,s)=>{const i=new r(t,s),a=new r(n,s);return i.compare(a)||i.compareBuild(a)},hu}var pu,rh;function zS(){if(rh)return pu;rh=1;const r=ql();return pu=(t,n)=>t.sort((s,i)=>r(s,i,n)),pu}var mu,sh;function GS(){if(sh)return mu;sh=1;const r=ql();return mu=(t,n)=>t.sort((s,i)=>r(i,s,n)),mu}var gu,ih;function uo(){if(ih)return gu;ih=1;const r=Kt();return gu=(t,n,s)=>r(t,n,s)>0,gu}var yu,ah;function Hl(){if(ah)return yu;ah=1;const r=Kt();return yu=(t,n,s)=>r(t,n,s)<0,yu}var _u,oh;function _g(){if(oh)return _u;oh=1;const r=Kt();return _u=(t,n,s)=>r(t,n,s)===0,_u}var bu,uh;function bg(){if(uh)return bu;uh=1;const r=Kt();return bu=(t,n,s)=>r(t,n,s)!==0,bu}var wu,ch;function Vl(){if(ch)return wu;ch=1;const r=Kt();return wu=(t,n,s)=>r(t,n,s)>=0,wu}var vu,lh;function Wl(){if(lh)return vu;lh=1;const r=Kt();return vu=(t,n,s)=>r(t,n,s)<=0,vu}var Su,dh;function wg(){if(dh)return Su;dh=1;const r=_g(),e=bg(),t=uo(),n=Vl(),s=Hl(),i=Wl();return Su=(o,u,c,l)=>{switch(u){case"===":return typeof o=="object"&&(o=o.version),typeof c=="object"&&(c=c.version),o===c;case"!==":return typeof o=="object"&&(o=o.version),typeof c=="object"&&(c=c.version),o!==c;case"":case"=":case"==":return r(o,c,l);case"!=":return e(o,c,l);case">":return t(o,c,l);case">=":return n(o,c,l);case"<":return s(o,c,l);case"<=":return i(o,c,l);default:throw new TypeError(`Invalid operator: ${u}`)}},Su}var Eu,fh;function qS(){if(fh)return Eu;fh=1;const r=nt(),e=ns(),{safeRe:t,t:n}=hi();return Eu=(i,a)=>{if(i instanceof r)return i;if(typeof i=="number"&&(i=String(i)),typeof i!="string")return null;a=a||{};let o=null;if(!a.rtl)o=i.match(a.includePrerelease?t[n.COERCEFULL]:t[n.COERCE]);else{const h=a.includePrerelease?t[n.COERCERTLFULL]:t[n.COERCERTL];let p;for(;(p=h.exec(i))&&(!o||o.index+o[0].length!==i.length);)(!o||p.index+p[0].length!==o.index+o[0].length)&&(o=p),h.lastIndex=p.index+p[1].length+p[2].length;h.lastIndex=-1}if(o===null)return null;const u=o[2],c=o[3]||"0",l=o[4]||"0",d=a.includePrerelease&&o[5]?`-${o[5]}`:"",f=a.includePrerelease&&o[6]?`+${o[6]}`:"";return e(`${u}.${c}.${l}${d}${f}`,a)},Eu}var xu,hh;function HS(){if(hh)return xu;hh=1;class r{constructor(){this.max=1e3,this.map=new Map}get(t){const n=this.map.get(t);if(n!==void 0)return this.map.delete(t),this.map.set(t,n),n}delete(t){return this.map.delete(t)}set(t,n){if(!this.delete(t)&&n!==void 0){if(this.map.size>=this.max){const i=this.map.keys().next().value;this.delete(i)}this.map.set(t,n)}return this}}return xu=r,xu}var Ou,ph;function Xt(){if(ph)return Ou;ph=1;const r=/\s+/g;class e{constructor(R,V){if(V=s(V),R instanceof e)return R.loose===!!V.loose&&R.includePrerelease===!!V.includePrerelease?R:new e(R.raw,V);if(R instanceof i)return this.raw=R.value,this.set=[[R]],this.formatted=void 0,this;if(this.options=V,this.loose=!!V.loose,this.includePrerelease=!!V.includePrerelease,this.raw=R.trim().replace(r," "),this.set=this.raw.split("||").map(B=>this.parseRange(B.trim())).filter(B=>B.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const B=this.set[0];if(this.set=this.set.filter(W=>!m(W[0])),this.set.length===0)this.set=[B];else if(this.set.length>1){for(const W of this.set)if(W.length===1&&g(W[0])){this.set=[W];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let R=0;R<this.set.length;R++){R>0&&(this.formatted+="||");const V=this.set[R];for(let B=0;B<V.length;B++)B>0&&(this.formatted+=" "),this.formatted+=V[B].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(R){const B=((this.options.includePrerelease&&h)|(this.options.loose&&p))+":"+R,W=n.get(B);if(W)return W;const z=this.options.loose,X=z?u[c.HYPHENRANGELOOSE]:u[c.HYPHENRANGE];R=R.replace(X,J(this.options.includePrerelease)),a("hyphen replace",R),R=R.replace(u[c.COMPARATORTRIM],l),a("comparator trim",R),R=R.replace(u[c.TILDETRIM],d),a("tilde trim",R),R=R.replace(u[c.CARETTRIM],f),a("caret trim",R);let oe=R.split(" ").map(Ae=>_(Ae,this.options)).join(" ").split(/\s+/).map(Ae=>C(Ae,this.options));z&&(oe=oe.filter(Ae=>(a("loose invalid filter",Ae,this.options),!!Ae.match(u[c.COMPARATORLOOSE])))),a("range list",oe);const U=new Map,we=oe.map(Ae=>new i(Ae,this.options));for(const Ae of we){if(m(Ae))return[Ae];U.set(Ae.value,Ae)}U.size>1&&U.has("")&&U.delete("");const Xe=[...U.values()];return n.set(B,Xe),Xe}intersects(R,V){if(!(R instanceof e))throw new TypeError("a Range is required");return this.set.some(B=>y(B,V)&&R.set.some(W=>y(W,V)&&B.every(z=>W.every(X=>z.intersects(X,V)))))}test(R){if(!R)return!1;if(typeof R=="string")try{R=new o(R,this.options)}catch{return!1}for(let V=0;V<this.set.length;V++)if(pe(this.set[V],R,this.options))return!0;return!1}}Ou=e;const t=HS(),n=new t,s=Gl(),i=co(),a=oo(),o=nt(),{safeRe:u,t:c,comparatorTrimReplace:l,tildeTrimReplace:d,caretTrimReplace:f}=hi(),{FLAG_INCLUDE_PRERELEASE:h,FLAG_LOOSE:p}=ao(),m=$=>$.value==="<0.0.0-0",g=$=>$.value==="",y=($,R)=>{let V=!0;const B=$.slice();let W=B.pop();for(;V&&B.length;)V=B.every(z=>W.intersects(z,R)),W=B.pop();return V},_=($,R)=>($=$.replace(u[c.BUILD],""),a("comp",$,R),$=E($,R),a("caret",$),$=v($,R),a("tildes",$),$=O($,R),a("xrange",$),$=k($,R),a("stars",$),$),b=$=>!$||$.toLowerCase()==="x"||$==="*",v=($,R)=>$.trim().split(/\s+/).map(V=>w(V,R)).join(" "),w=($,R)=>{const V=R.loose?u[c.TILDELOOSE]:u[c.TILDE];return $.replace(V,(B,W,z,X,oe)=>{a("tilde",$,B,W,z,X,oe);let U;return b(W)?U="":b(z)?U=`>=${W}.0.0 <${+W+1}.0.0-0`:b(X)?U=`>=${W}.${z}.0 <${W}.${+z+1}.0-0`:oe?(a("replaceTilde pr",oe),U=`>=${W}.${z}.${X}-${oe} <${W}.${+z+1}.0-0`):U=`>=${W}.${z}.${X} <${W}.${+z+1}.0-0`,a("tilde return",U),U})},E=($,R)=>$.trim().split(/\s+/).map(V=>T(V,R)).join(" "),T=($,R)=>{a("caret",$,R);const V=R.loose?u[c.CARETLOOSE]:u[c.CARET],B=R.includePrerelease?"-0":"";return $.replace(V,(W,z,X,oe,U)=>{a("caret",$,W,z,X,oe,U);let we;return b(z)?we="":b(X)?we=`>=${z}.0.0${B} <${+z+1}.0.0-0`:b(oe)?z==="0"?we=`>=${z}.${X}.0${B} <${z}.${+X+1}.0-0`:we=`>=${z}.${X}.0${B} <${+z+1}.0.0-0`:U?(a("replaceCaret pr",U),z==="0"?X==="0"?we=`>=${z}.${X}.${oe}-${U} <${z}.${X}.${+oe+1}-0`:we=`>=${z}.${X}.${oe}-${U} <${z}.${+X+1}.0-0`:we=`>=${z}.${X}.${oe}-${U} <${+z+1}.0.0-0`):(a("no pr"),z==="0"?X==="0"?we=`>=${z}.${X}.${oe}${B} <${z}.${X}.${+oe+1}-0`:we=`>=${z}.${X}.${oe}${B} <${z}.${+X+1}.0-0`:we=`>=${z}.${X}.${oe} <${+z+1}.0.0-0`),a("caret return",we),we})},O=($,R)=>(a("replaceXRanges",$,R),$.split(/\s+/).map(V=>x(V,R)).join(" ")),x=($,R)=>{$=$.trim();const V=R.loose?u[c.XRANGELOOSE]:u[c.XRANGE];return $.replace(V,(B,W,z,X,oe,U)=>{a("xRange",$,B,W,z,X,oe,U);const we=b(z),Xe=we||b(X),Ae=Xe||b(oe),cs=Ae;return W==="="&&cs&&(W=""),U=R.includePrerelease?"-0":"",we?W===">"||W==="<"?B="<0.0.0-0":B="*":W&&cs?(Xe&&(X=0),oe=0,W===">"?(W=">=",Xe?(z=+z+1,X=0,oe=0):(X=+X+1,oe=0)):W==="<="&&(W="<",Xe?z=+z+1:X=+X+1),W==="<"&&(U="-0"),B=`${W+z}.${X}.${oe}${U}`):Xe?B=`>=${z}.0.0${U} <${+z+1}.0.0-0`:Ae&&(B=`>=${z}.${X}.0${U} <${z}.${+X+1}.0-0`),a("xRange return",B),B})},k=($,R)=>(a("replaceStars",$,R),$.trim().replace(u[c.STAR],"")),C=($,R)=>(a("replaceGTE0",$,R),$.trim().replace(u[R.includePrerelease?c.GTE0PRE:c.GTE0],"")),J=$=>(R,V,B,W,z,X,oe,U,we,Xe,Ae,cs)=>(b(B)?V="":b(W)?V=`>=${B}.0.0${$?"-0":""}`:b(z)?V=`>=${B}.${W}.0${$?"-0":""}`:X?V=`>=${V}`:V=`>=${V}${$?"-0":""}`,b(we)?U="":b(Xe)?U=`<${+we+1}.0.0-0`:b(Ae)?U=`<${we}.${+Xe+1}.0-0`:cs?U=`<=${we}.${Xe}.${Ae}-${cs}`:$?U=`<${we}.${Xe}.${+Ae+1}-0`:U=`<=${U}`,`${V} ${U}`.trim()),pe=($,R,V)=>{for(let B=0;B<$.length;B++)if(!$[B].test(R))return!1;if(R.prerelease.length&&!V.includePrerelease){for(let B=0;B<$.length;B++)if(a($[B].semver),$[B].semver!==i.ANY&&$[B].semver.prerelease.length>0){const W=$[B].semver;if(W.major===R.major&&W.minor===R.minor&&W.patch===R.patch)return!0}return!1}return!0};return Ou}var ku,mh;function co(){if(mh)return ku;mh=1;const r=Symbol("SemVer ANY");class e{static get ANY(){return r}constructor(l,d){if(d=t(d),l instanceof e){if(l.loose===!!d.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),a("comparator",l,d),this.options=d,this.loose=!!d.loose,this.parse(l),this.semver===r?this.value="":this.value=this.operator+this.semver.version,a("comp",this)}parse(l){const d=this.options.loose?n[s.COMPARATORLOOSE]:n[s.COMPARATOR],f=l.match(d);if(!f)throw new TypeError(`Invalid comparator: ${l}`);this.operator=f[1]!==void 0?f[1]:"",this.operator==="="&&(this.operator=""),f[2]?this.semver=new o(f[2],this.options.loose):this.semver=r}toString(){return this.value}test(l){if(a("Comparator.test",l,this.options.loose),this.semver===r||l===r)return!0;if(typeof l=="string")try{l=new o(l,this.options)}catch{return!1}return i(l,this.operator,this.semver,this.options)}intersects(l,d){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new u(l.value,d).test(this.value):l.operator===""?l.value===""?!0:new u(this.value,d).test(l.semver):(d=t(d),d.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||i(this.semver,"<",l.semver,d)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||i(this.semver,">",l.semver,d)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}ku=e;const t=Gl(),{safeRe:n,t:s}=hi(),i=wg(),a=oo(),o=nt(),u=Xt();return ku}var Pu,gh;function lo(){if(gh)return Pu;gh=1;const r=Xt();return Pu=(t,n,s)=>{try{n=new r(n,s)}catch{return!1}return n.test(t)},Pu}var Au,yh;function VS(){if(yh)return Au;yh=1;const r=Xt();return Au=(t,n)=>new r(t,n).set.map(s=>s.map(i=>i.value).join(" ").trim().split(" ")),Au}var Tu,_h;function WS(){if(_h)return Tu;_h=1;const r=nt(),e=Xt();return Tu=(n,s,i)=>{let a=null,o=null,u=null;try{u=new e(s,i)}catch{return null}return n.forEach(c=>{u.test(c)&&(!a||o.compare(c)===-1)&&(a=c,o=new r(a,i))}),a},Tu}var Iu,bh;function ZS(){if(bh)return Iu;bh=1;const r=nt(),e=Xt();return Iu=(n,s,i)=>{let a=null,o=null,u=null;try{u=new e(s,i)}catch{return null}return n.forEach(c=>{u.test(c)&&(!a||o.compare(c)===1)&&(a=c,o=new r(a,i))}),a},Iu}var Ru,wh;function JS(){if(wh)return Ru;wh=1;const r=nt(),e=Xt(),t=uo();return Ru=(s,i)=>{s=new e(s,i);let a=new r("0.0.0");if(s.test(a)||(a=new r("0.0.0-0"),s.test(a)))return a;a=null;for(let o=0;o<s.set.length;++o){const u=s.set[o];let c=null;u.forEach(l=>{const d=new r(l.semver.version);switch(l.operator){case">":d.prerelease.length===0?d.patch++:d.prerelease.push(0),d.raw=d.format();case"":case">=":(!c||t(d,c))&&(c=d);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${l.operator}`)}}),c&&(!a||t(a,c))&&(a=c)}return a&&s.test(a)?a:null},Ru}var Cu,vh;function KS(){if(vh)return Cu;vh=1;const r=Xt();return Cu=(t,n)=>{try{return new r(t,n).range||"*"}catch{return null}},Cu}var $u,Sh;function Zl(){if(Sh)return $u;Sh=1;const r=nt(),e=co(),{ANY:t}=e,n=Xt(),s=lo(),i=uo(),a=Hl(),o=Wl(),u=Vl();return $u=(l,d,f,h)=>{l=new r(l,h),d=new n(d,h);let p,m,g,y,_;switch(f){case">":p=i,m=o,g=a,y=">",_=">=";break;case"<":p=a,m=u,g=i,y="<",_="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(s(l,d,h))return!1;for(let b=0;b<d.set.length;++b){const v=d.set[b];let w=null,E=null;if(v.forEach(T=>{T.semver===t&&(T=new e(">=0.0.0")),w=w||T,E=E||T,p(T.semver,w.semver,h)?w=T:g(T.semver,E.semver,h)&&(E=T)}),w.operator===y||w.operator===_||(!E.operator||E.operator===y)&&m(l,E.semver))return!1;if(E.operator===_&&g(l,E.semver))return!1}return!0},$u}var Nu,Eh;function XS(){if(Eh)return Nu;Eh=1;const r=Zl();return Nu=(t,n,s)=>r(t,n,">",s),Nu}var ju,xh;function YS(){if(xh)return ju;xh=1;const r=Zl();return ju=(t,n,s)=>r(t,n,"<",s),ju}var Lu,Oh;function QS(){if(Oh)return Lu;Oh=1;const r=Xt();return Lu=(t,n,s)=>(t=new r(t,s),n=new r(n,s),t.intersects(n,s)),Lu}var Mu,kh;function eE(){if(kh)return Mu;kh=1;const r=lo(),e=Kt();return Mu=(t,n,s)=>{const i=[];let a=null,o=null;const u=t.sort((f,h)=>e(f,h,s));for(const f of u)r(f,n,s)?(o=f,a||(a=f)):(o&&i.push([a,o]),o=null,a=null);a&&i.push([a,null]);const c=[];for(const[f,h]of i)f===h?c.push(f):!h&&f===u[0]?c.push("*"):h?f===u[0]?c.push(`<=${h}`):c.push(`${f} - ${h}`):c.push(`>=${f}`);const l=c.join(" || "),d=typeof n.raw=="string"?n.raw:String(n);return l.length<d.length?l:n},Mu}var Du,Ph;function tE(){if(Ph)return Du;Ph=1;const r=Xt(),e=co(),{ANY:t}=e,n=lo(),s=Kt(),i=(d,f,h={})=>{if(d===f)return!0;d=new r(d,h),f=new r(f,h);let p=!1;e:for(const m of d.set){for(const g of f.set){const y=u(m,g,h);if(p=p||y!==null,y)continue e}if(p)return!1}return!0},a=[new e(">=0.0.0-0")],o=[new e(">=0.0.0")],u=(d,f,h)=>{if(d===f)return!0;if(d.length===1&&d[0].semver===t){if(f.length===1&&f[0].semver===t)return!0;h.includePrerelease?d=a:d=o}if(f.length===1&&f[0].semver===t){if(h.includePrerelease)return!0;f=o}const p=new Set;let m,g;for(const O of d)O.operator===">"||O.operator===">="?m=c(m,O,h):O.operator==="<"||O.operator==="<="?g=l(g,O,h):p.add(O.semver);if(p.size>1)return null;let y;if(m&&g){if(y=s(m.semver,g.semver,h),y>0)return null;if(y===0&&(m.operator!==">="||g.operator!=="<="))return null}for(const O of p){if(m&&!n(O,String(m),h)||g&&!n(O,String(g),h))return null;for(const x of f)if(!n(O,String(x),h))return!1;return!0}let _,b,v,w,E=g&&!h.includePrerelease&&g.semver.prerelease.length?g.semver:!1,T=m&&!h.includePrerelease&&m.semver.prerelease.length?m.semver:!1;E&&E.prerelease.length===1&&g.operator==="<"&&E.prerelease[0]===0&&(E=!1);for(const O of f){if(w=w||O.operator===">"||O.operator===">=",v=v||O.operator==="<"||O.operator==="<=",m){if(T&&O.semver.prerelease&&O.semver.prerelease.length&&O.semver.major===T.major&&O.semver.minor===T.minor&&O.semver.patch===T.patch&&(T=!1),O.operator===">"||O.operator===">="){if(_=c(m,O,h),_===O&&_!==m)return!1}else if(m.operator===">="&&!n(m.semver,String(O),h))return!1}if(g){if(E&&O.semver.prerelease&&O.semver.prerelease.length&&O.semver.major===E.major&&O.semver.minor===E.minor&&O.semver.patch===E.patch&&(E=!1),O.operator==="<"||O.operator==="<="){if(b=l(g,O,h),b===O&&b!==g)return!1}else if(g.operator==="<="&&!n(g.semver,String(O),h))return!1}if(!O.operator&&(g||m)&&y!==0)return!1}return!(m&&v&&!g&&y!==0||g&&w&&!m&&y!==0||T||E)},c=(d,f,h)=>{if(!d)return f;const p=s(d.semver,f.semver,h);return p>0?d:p<0||f.operator===">"&&d.operator===">="?f:d},l=(d,f,h)=>{if(!d)return f;const p=s(d.semver,f.semver,h);return p<0?d:p>0||f.operator==="<"&&d.operator==="<="?f:d};return Du=i,Du}var Uu,Ah;function nE(){if(Ah)return Uu;Ah=1;const r=hi(),e=ao(),t=nt(),n=yg(),s=ns(),i=CS(),a=$S(),o=NS(),u=jS(),c=LS(),l=MS(),d=DS(),f=US(),h=Kt(),p=FS(),m=BS(),g=ql(),y=zS(),_=GS(),b=uo(),v=Hl(),w=_g(),E=bg(),T=Vl(),O=Wl(),x=wg(),k=qS(),C=co(),J=Xt(),pe=lo(),$=VS(),R=WS(),V=ZS(),B=JS(),W=KS(),z=Zl(),X=XS(),oe=YS(),U=QS(),we=eE(),Xe=tE();return Uu={parse:s,valid:i,clean:a,inc:o,diff:u,major:c,minor:l,patch:d,prerelease:f,compare:h,rcompare:p,compareLoose:m,compareBuild:g,sort:y,rsort:_,gt:b,lt:v,eq:w,neq:E,gte:T,lte:O,cmp:x,coerce:k,Comparator:C,Range:J,satisfies:pe,toComparators:$,maxSatisfying:R,minSatisfying:V,minVersion:B,validRange:W,outside:z,gtr:X,ltr:oe,intersects:U,simplifyRange:we,subset:Xe,SemVer:t,re:r.re,src:r.src,tokens:r.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers},Uu}nE();function xn(r){if(!r||r.split("/").length>2||r.startsWith("/")||r.endsWith("/")||r.split(":").length>2)throw new Error(`Invalid identifier format: ${r}`);const[e,t]=r.split(":"),n=t||"latest";if(e.includes("/")){const[s,i]=e.split("/",2);if(!s||!i)throw new Error(`Invalid identifier format: ${r}`);return[s,i,n]}else{if(!e)throw new Error(`Invalid identifier format: ${r}`);return["-",e,n]}}class rE extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function F(r,e,t){let n;if(r.ok){t&&(n=await r.text());return}if(r.status===403)try{(await r.json())?.error==="org_scoped_key_requires_workspace"&&(n="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${r.status} ${r.statusText}`);throw o.status=r?.status,o}if(n===void 0)try{n=await r.text()}catch{n=""}const s=`Failed to ${e}. Received status [${r.status}]: ${r.statusText}. Message: ${n}`;if(r.status===409)throw new rE(s);const i=new Error(s);throw i.status=r.status,i}const vg="ERR_CONFLICTING_ENDPOINTS";class sE extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:vg}),this.name="ConflictingEndpointsError"}}function iE(r){return typeof r=="object"&&r!==null&&r.code===vg}var Th="[...]",aE={result:"[Circular]"},Sa=[],Rr=[];const oE=new TextEncoder;function uE(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Li(r){return oE.encode(r)}function Sg(r){if(r&&typeof r=="object"&&r!==null){if(r instanceof Map)return Object.fromEntries(r);if(r instanceof Set)return Array.from(r);if(r instanceof Date)return r.toISOString();if(r instanceof RegExp)return r.toString();if(r instanceof Error)return{name:r.name,message:r.message}}else if(typeof r=="bigint")return r.toString();return r}function cE(r){return function(e,t){return Sg(t)}}function mt(r,e,t,n,s){try{const i=JSON.stringify(r,cE(t),n);return Li(i)}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),Li("[Unserializable]");ut("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof s>"u"&&(s=uE()),Uc(r,"",0,[],void 0,0,s);let a;try{Rr.length===0?a=JSON.stringify(r,t,n):a=JSON.stringify(r,lE(t),n)}catch{return Li("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Sa.length!==0;){const o=Sa.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return Li(a)}}function Fu(r,e,t,n){var s=Object.getOwnPropertyDescriptor(n,t);s.get!==void 0?s.configurable?(Object.defineProperty(n,t,{value:r}),Sa.push([n,t,e,s])):Rr.push([e,t,r]):(n[t]=r,Sa.push([n,t,e]))}function Uc(r,e,t,n,s,i,a){i+=1;var o;if(typeof r=="object"&&r!==null){for(o=0;o<n.length;o++)if(n[o]===r){Fu(aE,r,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){Fu(Th,r,e,s);return}if(typeof a.edgesLimit<"u"&&t+1>a.edgesLimit){Fu(Th,r,e,s);return}if(n.push(r),Array.isArray(r))for(o=0;o<r.length;o++)Uc(r[o],o,o,n,r,i,a);else{r=Sg(r);var u=Object.keys(r);for(o=0;o<u.length;o++){var c=u[o];Uc(r[c],c,o,n,r,i,a)}}n.pop()}}function lE(r){return r=typeof r<"u"?r:function(e,t){return t},function(e,t){if(Rr.length>0)for(var n=0;n<Rr.length;n++){var s=Rr[n];if(s[1]===e&&s[0]===t){t=s[2],Rr.splice(n,1);break}}return r.call(this,e,t)}}function Ih(r,e,t){if(t)return r;const n=hg(),s=e??pg(),i=r.extra??{},a=i.metadata;return r.extra={...i,runtime:{...n,...i?.runtime},metadata:{...s,...s.revision_id||"revision_id"in r&&r.revision_id?{revision_id:("revision_id"in r?r.revision_id:void 0)??s.revision_id}:{},...a}},r}const dE=r=>{const e=r?.toString()??ut("TRACING_SAMPLING_RATE");if(e===void 0)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t},fE=r=>{const t=r.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function hE(r){const e=[];for await(const t of r)e.push(t);return e}function Mi(r){if(r!==void 0)return r.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const pE=async r=>{if(r?.status===429){const e=parseInt(r.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};function Rh(r){return typeof r=="number"?Number(r.toFixed(4)):r}const mE=24*1024*1024,Eg=1024*1024*1024,gE=1e4,yE=100,Ch="https://api.smith.langchain.com";class _E{constructor(e){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"maxSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSizeBytes=e??Eg}peek(){return this.items[0]}push(e){let t;const n=new Promise(i=>{t=i}),s=mt(e.item,`Serializing run with id: ${e.item.id}`).length;return this.sizeBytes+s>this.maxSizeBytes&&this.items.length>0?(console.warn(`AutoBatchQueue size limit (${this.maxSizeBytes} bytes) exceeded. Dropping run with id: ${e.item.id}. Current queue size: ${this.sizeBytes} bytes, attempted addition: ${s} bytes.`),t(),n):(this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:n,size:s}),this.sizeBytes+=s,n)}pop({upToSizeBytes:e,upToSize:t}){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let s=0;for(;s+(this.peek()?.size??0)<e&&this.items.length>0&&n.length<t;){const i=this.items.shift();i&&(n.push(i),s+=i.size,this.sizeBytes-=i.size)}if(n.length===0&&this.items.length>0){const i=this.items.shift();n.push(i),s+=i.size,this.sizeBytes-=i.size}return[n.map(i=>({action:i.action,item:i.payload,otelContext:i.otelContext,apiKey:i.apiKey,apiUrl:i.apiUrl,size:i.size})),()=>n.forEach(i=>i.itemPromiseResolve())]}}class Vs{get _fetch(){return this.fetchImplementation||J0(this.debug)}constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitTracedRuntimeInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:un("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:un("LANGSMITH_DEBUG")==="true"});const t=Vs.getDefaultClientConfig();if(this.tracingSampleRate=dE(e.tracingSamplingRate),this.apiUrl=Mi(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Mi(e.apiKey??t.apiKey),this.webUrl=Mi(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=Mi(e.workspaceId??ut("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new jf({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation;const n=e.maxIngestMemoryBytes??Eg;this.batchIngestCaller=new jf({maxRetries:4,maxConcurrency:this.traceBatchConcurrency,maxQueueSizeBytes:n,...e.callerOptions??{},onFailedResponseHook:pE,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.omitTracedRuntimeInfo=e.omitTracedRuntimeInfo??!1,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.autoBatchQueue=new _E(n),this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,mg()&&(this.langSmithToOTELTranslator=new pS),this.cachedLSEnvVarsForMetadata=pg()}static getDefaultClientConfig(){const e=ut("API_KEY"),t=ut("ENDPOINT")??Ch,n=ut("HIDE_INPUTS")==="true",s=ut("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:n,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:fE(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${lg}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=await this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",s=`${this.apiUrl}${e}?${n}`;return await this.caller.call(async()=>{const a=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,`fetch ${e}`),a})}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let s=Number(t.get("offset"))||0;const i=Number(t.get("limit"))||100;for(;;){t.set("offset",String(s)),t.set("limit",String(i));const a=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(async()=>{const c=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(c,`fetch ${e}`),c}),u=n?n(await o.json()):await o.json();if(u.length===0||(yield u,u.length<i))break;s+=u.length}}async*_getCursorPaginatedList(e,t=null,n="POST",s="runs"){const i=t?{...t}:{};for(;;){const a=JSON.stringify(i),u=await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await F(l,`fetch ${e}`),l})).json();if(!u||!u[s])break;yield u[s];const c=u.cursors;if(!c||!c.next)break;i.cursor=c.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const n=[];for(const s of e)this.filteredPostUuids.has(s.trace_id)?s.id===s.trace_id&&this.filteredPostUuids.delete(s.trace_id):n.push(s);return n}else{const n=[];for(const s of e){const i=s.trace_id??s.id;this.filteredPostUuids.has(i)||(s.id===i?this._shouldSample()?n.push(s):this.filteredPostUuids.add(i):n.push(s))}return n}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??mE}async _getBatchSizeLimit(){const e=await this._ensureServerInfo();return this.batchSizeLimit??e.batch_ingest_config?.size_limit??yE}async _getDatasetExamplesMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t}){const n=[];for(;this.autoBatchQueue.items.length>0;){const[s,i]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:t});if(!s.length){i();break}const a=s.reduce((c,l)=>{const d=l.apiUrl??this.apiUrl,f=l.apiKey??this.apiKey,p=l.apiKey===this.apiKey&&l.apiUrl===this.apiUrl?"default":`${d}|${f}`;return c[p]||(c[p]=[]),c[p].push(l),c},{}),o=[];for(const[c,l]of Object.entries(a)){const d=this._processBatch(l,{apiUrl:c==="default"?void 0:c.split("|")[0],apiKey:c==="default"?void 0:c.split("|")[1]});o.push(d)}const u=Promise.all(o).finally(i);n.push(u)}return Promise.all(n)}async _processBatch(e,t){if(!e.length)return;const n=e.reduce((s,i)=>s+(i.size??0),0);try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{const s={runCreates:e.filter(a=>a.action==="create").map(a=>a.item),runUpdates:e.filter(a=>a.action==="update").map(a=>a.item)},i=await this._ensureServerInfo();if(i?.batch_ingest_config?.use_multipart_endpoint){const a=i?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(s,{...t,useGzip:a,sizeBytes:n})}else await this.batchIngestRuns(s,{...t,sizeBytes:n})}}catch(s){console.error("Error exporting batch:",s)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){const t=new Map,n=[];for(const s of e)s.item.id&&s.otelContext&&(t.set(s.item.id,s.otelContext),s.action==="create"?n.push({operation:"post",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}):n.push({operation:"patch",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}));this.langSmithToOTELTranslator.exportBatch(n,t)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=Ih(e.item,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const n=await this._getBatchSizeLimitBytes(),s=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>n||this.autoBatchQueue.items.length>s)&&this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s})},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const t=await(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(gE),...this.fetchOptions});return await F(n,"get server info"),n})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(t,null,2)+`
`),t}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),t=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t})}_cloneCurrentOTELContext(){const e=gg(),t=lS();if(this.langSmithToOTELTranslator!==void 0){const n=e.getActiveSpan();if(n)return e.setSpan(t.active(),n)}}async createRun(e,t){if(!this._filterForSampling([e]).length)return;const n={...this.headers,"Content-Type":"application/json"},s=e.project_name;delete e.project_name;const i=await this.prepareRunCreateOrUpdateInputs({session_name:s,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){const u=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:i,otelContext:u,apiKey:t?.apiKey,apiUrl:t?.apiUrl}).catch(console.error);return}const a=Ih(i,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);t?.apiKey!==void 0&&(n["x-api-key"]=t.apiKey),t?.workspaceId!==void 0&&(n["x-tenant-id"]=t.workspaceId);const o=mt(a,`Creating run with id: ${a.id}`);await this.caller.call(async()=>{const u=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await F(u,"create run",!0),u})}async batchIngestRuns({runCreates:e,runUpdates:t},n){if(e===void 0&&t===void 0)return;let s=await Promise.all(e?.map(u=>this.prepareRunCreateOrUpdateInputs(u))??[]),i=await Promise.all(t?.map(u=>this.prepareRunCreateOrUpdateInputs(u))??[]);if(s.length>0&&i.length>0){const u=s.reduce((l,d)=>(d.id&&(l[d.id]=d),l),{}),c=[];for(const l of i)l.id!==void 0&&u[l.id]?u[l.id]={...u[l.id],...l}:c.push(l);s=Object.values(u),i=c}const a={post:s,patch:i};if(!a.post.length&&!a.patch.length)return;const o={post:[],patch:[]};for(const u of["post","patch"]){const c=u,l=a[c].reverse();let d=l.pop();for(;d!==void 0;)o[c].push(d),d=l.pop()}if(o.post.length>0||o.patch.length>0){const u=o.post.map(c=>c.id).concat(o.patch.map(c=>c.id)).join(",");await this._postBatchIngestRuns(mt(o,`Ingesting runs with ids: ${u}`),n)}}async _postBatchIngestRuns(e,t){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};t?.apiKey!==void 0&&(n["x-api-key"]=t.apiKey),await this.batchIngestCaller.callWithOptions({sizeBytes:t?.sizeBytes},async()=>{const s=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await F(s,"batch create run",!0),s})}async multipartIngestRuns({runCreates:e,runUpdates:t},n){if(e===void 0&&t===void 0)return;const s={};let i=[];for(const d of e??[]){const f=await this.prepareRunCreateOrUpdateInputs(d);f.id!==void 0&&f.attachments!==void 0&&(s[f.id]=f.attachments),delete f.attachments,i.push(f)}let a=[];for(const d of t??[])a.push(await this.prepareRunCreateOrUpdateInputs(d));if(i.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&a.length>0){const d=i.reduce((h,p)=>(p.id&&(h[p.id]=p),h),{}),f=[];for(const h of a)h.id!==void 0&&d[h.id]?d[h.id]={...d[h.id],...h}:f.push(h);i=Object.values(d),a=f}if(i.length===0&&a.length===0)return;const c=[],l=[];for(const[d,f]of[["post",i],["patch",a]])for(const h of f){const{inputs:p,outputs:m,events:g,extra:y,error:_,serialized:b,attachments:v,...w}=h,E={inputs:p,outputs:m,events:g,extra:y,error:_,serialized:b},T=mt(w,`Serializing for multipart ingestion of run with id: ${w.id}`);l.push({name:`${d}.${w.id}`,payload:new Blob([T],{type:`application/json; length=${T.length}`})});for(const[O,x]of Object.entries(E)){if(x===void 0)continue;const k=mt(x,`Serializing ${O} for multipart ingestion of run with id: ${w.id}`);l.push({name:`${d}.${w.id}.${O}`,payload:new Blob([k],{type:`application/json; length=${k.length}`})})}if(w.id!==void 0){const O=s[w.id];if(O){delete s[w.id];for(const[x,k]of Object.entries(O)){let C,J;if(Array.isArray(k)?[C,J]=k:(C=k.mimeType,J=k.data),x.includes(".")){console.warn(`Skipping attachment '${x}' for run ${w.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}l.push({name:`attachment.${w.id}.${x}`,payload:new Blob([J],{type:`${C}; length=${J.byteLength}`})})}}}c.push(`trace=${w.trace_id},id=${w.id}`)}await this._sendMultipartRequest(l,c.join("; "),n)}async _createNodeFetchBody(e,t){const n=[];for(const a of e)n.push(new Blob([`--${t}\r
`])),n.push(new Blob([`Content-Disposition: form-data; name="${a.name}"\r
`,`Content-Type: ${a.payload.type}\r
\r
`])),n.push(a.payload),n.push(new Blob([`\r
`]));return n.push(new Blob([`--${t}--\r
`])),await new Blob(n).arrayBuffer()}async _createMultipartStream(e,t){const n=new TextEncoder;return new ReadableStream({async start(i){const a=async o=>{typeof o=="string"?i.enqueue(n.encode(o)):i.enqueue(o)};for(const o of e){await a(`--${t}\r
`),await a(`Content-Disposition: form-data; name="${o.name}"\r
`),await a(`Content-Type: ${o.payload.type}\r
\r
`);const c=o.payload.stream().getReader();try{let l;for(;!(l=await c.read()).done;)i.enqueue(l.value)}finally{c.releaseLock()}await a(`\r
`)}await a(`--${t}--\r
`),i.close()}})}async _sendMultipartRequest(e,t,n){const s="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),i=Z0(),a=()=>this._createNodeFetchBody(e,s),o=()=>this._createMultipartStream(e,s),u=async c=>this.batchIngestCaller.callWithOptions({sizeBytes:n?.sizeBytes},async()=>{const l=await c(),d={...this.headers,"Content-Type":`multipart/form-data; boundary=${s}`};n?.apiKey!==void 0&&(d["x-api-key"]=n.apiKey);let f=l;n?.useGzip&&typeof l=="object"&&"pipeThrough"in l&&(f=l.pipeThrough(new CompressionStream("gzip")),d["Content-Encoding"]="gzip");const h=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:d,body:f,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(h,"Failed to send multipart request",!0),h});try{let c,l=!1;!i&&!this.multipartStreamingDisabled&&fg()!=="bun"?(l=!0,c=await u(o)):c=await u(a),(!this.multipartStreamingDisabled||l)&&c.status===422&&(n?.apiUrl??this.apiUrl)!==Ch&&(console.warn(`Streaming multipart upload to ${n?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${t}".`),this.multipartStreamingDisabled=!0,c=await u(a))}catch(c){console.warn(`${c.message.trim()}

Context: ${t}`)}}async updateRun(e,t,n){Y(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const s={...t,id:e};if(!this._filterForSampling([s],!0).length)return;if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(t.end_time!==void 0&&s.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}const i={...this.headers,"Content-Type":"application/json"};n?.apiKey!==void 0&&(i["x-api-key"]=n.apiKey),n?.workspaceId!==void 0&&(i["x-tenant-id"]=n.workspaceId);const a=mt(t,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const o=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await F(o,"update run",!0),o})}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Y(e);let n=await this._get(`/runs/${e}`);return t&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(t!==void 0){let s;t.session_id?s=t.session_id:n?.projectName?s=(await this.readProject({projectName:n?.projectName})).id:n?.projectId?s=n?.projectId:s=(await this.readProject({projectName:ut("PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${s}/r/${t.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await hE(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),n={},s={};t.sort((i,a)=>(i?.dotted_order??"").localeCompare(a?.dotted_order??""));for(const i of t){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);i.dotted_order?.startsWith(e.dotted_order??"")&&i.id!==e.id&&(i.parent_run_id in n||(n[i.parent_run_id]=[]),n[i.parent_run_id].push(i),s[i.id]=i)}e.child_runs=n[e.id]||[];for(const i in n)i!==e.id&&(s[i].child_runs=n[i]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:s,traceId:i,referenceExampleId:a,startTime:o,executionOrder:u,isRoot:c,runType:l,error:d,id:f,query:h,filter:p,traceFilter:m,treeFilter:g,limit:y,select:_,order:b}=e;let v=[];if(t&&(v=Array.isArray(t)?t:[t]),n){const O=Array.isArray(n)?n:[n],x=await Promise.all(O.map(k=>this.readProject({projectName:k}).then(C=>C.id)));v.push(...x)}const w=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],E={session:v.length?v:null,run_type:l,reference_example:a,query:h,filter:p,trace_filter:m,tree_filter:g,execution_order:u,parent_run:s,start_time:o?o.toISOString():null,error:d,id:f,limit:y,trace:i,select:_||w,is_root:c,order:b};E.select.includes("child_run_ids")&&Mc("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let T=0;for await(const O of this._getCursorPaginatedList("/runs/query",E))if(y){if(T>=y)break;if(O.length+T>y){yield*O.slice(0,y-T);break}T+=O.length,yield*O}else yield*O}async*listGroupRuns(e){const{projectId:t,projectName:n,groupBy:s,filter:i,startTime:a,endTime:o,limit:u,offset:c}=e,d={session_id:t||(await this.readProject({projectName:n})).id,group_by:s,filter:i,start_time:a?a.toISOString():null,end_time:o?o.toISOString():null,limit:Number(u)||100};let f=Number(c)||0;const h="/runs/group",p=`${this.apiUrl}${h}`;for(;;){const m={...d,offset:f},g=Object.fromEntries(Object.entries(m).filter(([E,T])=>T!==void 0)),y=JSON.stringify(g),b=await(await this.caller.call(async()=>{const E=await this._fetch(p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:y});return await F(E,`Failed to fetch ${h}`),E})).json(),{groups:v,total:w}=b;if(v.length===0)break;for(const E of v)yield E;if(f+=v.length,f>=w)break}}async getRunStats({id:e,trace:t,parentRun:n,runType:s,projectNames:i,projectIds:a,referenceExampleIds:o,startTime:u,endTime:c,error:l,query:d,filter:f,traceFilter:h,treeFilter:p,isRoot:m,dataSourceType:g}){let y=a||[];i&&(y=[...a||[],...await Promise.all(i.map(T=>this.readProject({projectName:T}).then(O=>O.id)))]);const b=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:n,run_type:s,session:y,reference_example:o,start_time:u,end_time:c,error:l,query:d,filter:f,trace_filter:h,tree_filter:p,is_root:m,data_source_type:g}).filter(([T,O])=>O!==void 0)),v=JSON.stringify(b);return await(await this.caller.call(async()=>{const T=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:v});return await F(T,"get run stats"),T})).json()}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||Ke()};Y(e);const s=JSON.stringify(n),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await F(o,"share run"),o})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){Y(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(t,"unshare run",!0),t})}async readRunSharedLink(e){Y(e);const n=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(s,"read run shared link"),s})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(t!==void 0)for(const a of t)n.append("id",a);return Y(e),await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,"list shared runs"),a})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),Y(e);const s=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(i,"read dataset shared schema"),i})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const n={dataset_id:e};Y(e);const s=JSON.stringify(n),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await F(o,"share dataset"),o})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){Y(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(t,"unshare dataset",!0),t})}async readSharedDataset(e){return Y(e),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(s,"read shared dataset"),s})).json()}async listSharedExamples(e,t){const n={};t?.exampleIds&&(n.id=t.exampleIds);const s=new URLSearchParams;Object.entries(n).forEach(([o,u])=>{Array.isArray(u)?u.forEach(c=>s.append(o,c)):s.append(o,u)});const i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(o,"list shared examples"),o}),a=await i.json();if(!i.ok)throw"detail"in a?new Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(a.detail)?a.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`);return a.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:s=!1,projectExtra:i=null,referenceDatasetId:a=null}){const o=s?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=i||{};n&&(c.metadata=n);const l={name:e,extra:c,description:t};a!==null&&(l.reference_dataset_id=a);const d=JSON.stringify(l);return await(await this.caller.call(async()=>{const p=await this._fetch(u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await F(p,"create project"),p})).json()}async updateProject(e,{name:t=null,description:n=null,metadata:s=null,projectExtra:i=null,endTime:a=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=i;s&&(u={...u||{},metadata:s});const c=JSON.stringify({name:t,extra:u,description:n,end_time:a?new Date(a).toISOString():null});return await(await this.caller.call(async()=>{const f=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await F(f,"update project"),f})).json()}async hasProject({projectId:e,projectName:t}){let n="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Y(e),n+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");const i=await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${n}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,"has project"),a});try{const a=await i.json();return i.ok?Array.isArray(a)?a.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let s="/sessions";const i=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Y(e),s+=`/${e}`;else if(t!==void 0)i.append("name",t);else throw new Error("Must provide projectName or projectId");n!==void 0&&i.append("include_stats",n.toString());const a=await this._get(s,i);let o;if(Array.isArray(a)){if(a.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=a[0]}else o=a;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${n.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:s,referenceDatasetName:i,includeStats:a,datasetVersion:o,referenceFree:u,metadata:c}={}){const l=new URLSearchParams;if(e!==void 0)for(const d of e)l.append("id",d);if(t!==void 0&&l.append("name",t),n!==void 0&&l.append("name_contains",n),s!==void 0)l.append("reference_dataset",s);else if(i!==void 0){const d=await this.readDataset({datasetName:i});l.append("reference_dataset",d.id)}a!==void 0&&l.append("include_stats",a.toString()),o!==void 0&&l.append("dataset_version",o),u!==void 0&&l.append("reference_free",u.toString()),c!==void 0&&l.append("metadata",JSON.stringify(c));for await(const d of this._getPaginated("/sessions",l))yield*d}async deleteProject({projectId:e,projectName:t}){let n;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?n=(await this.readProject({projectName:t})).id:n=e,Y(n),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(s,`delete session ${n} (${t})`,!0),s})}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:s,description:i,dataType:a,name:o}){const u=`${this.apiUrl}/datasets/upload`,c=new FormData;return c.append("file",e,t),n.forEach(f=>{c.append("input_keys",f)}),s.forEach(f=>{c.append("output_keys",f)}),i&&c.append("description",i),a&&c.append("data_type",a),o&&c.append("name",o),await(await this.caller.call(async()=>{const f=await this._fetch(u,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await F(f,"upload CSV"),f})).json()}async createDataset(e,{description:t,dataType:n,inputsSchema:s,outputsSchema:i,metadata:a}={}){const o={name:e,description:t,extra:a?{metadata:a}:void 0};n&&(o.data_type=n),s&&(o.inputs_schema_definition=s),i&&(o.outputs_schema_definition=i);const u=JSON.stringify(o);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await F(d,"create dataset"),d})).json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const s=new URLSearchParams({limit:"1"});if(e&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(e)Y(e),n+=`/${e}`;else if(t)s.append("name",t);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(n,s);let a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);a=i[0]}else a=i;return a}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(n){if(n instanceof Error&&n.message.toLocaleLowerCase().includes("not found"))return!1;throw n}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:s}){let i=e;if(i===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:t})).id);const a=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,a)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const n="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${n}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:s,datasetNameContains:i,metadata:a}={}){const o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(n!==void 0)for(const c of n)u.append("id",c);s!==void 0&&u.append("name",s),i!==void 0&&u.append("name_contains",i),a!==void 0&&u.append("metadata",JSON.stringify(a));for await(const c of this._getPaginated(o,u))yield*c}async updateDataset(e){const{datasetId:t,datasetName:n,...s}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const i=t??(await this.readDataset({datasetName:n})).id;Y(i);const a=JSON.stringify(s);return await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await F(u,"update dataset"),u})).json()}async updateDatasetTag(e){const{datasetId:t,datasetName:n,asOf:s,tag:i}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:n})).id;Y(a);const o=JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:i});await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${a}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await F(u,"update dataset tags",!0),u})}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",s=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(s=(await this.readDataset({datasetName:t})).id),s!==void 0)Y(s),n+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const i=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(i,`delete ${n}`,!0),i})}async indexDataset({datasetId:e,datasetName:t,tag:n}){let s=e;if(!s&&!t)throw new Error("Must provide either datasetName or datasetId");if(s&&t)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:t})).id),Y(s);const a=JSON.stringify({tag:n});await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await F(u,"index dataset"),u})).json()}async similarExamples(e,t,n,{filter:s}={}){const i={limit:n,inputs:e};s!==void 0&&(i.filter=s),Y(t);const a=JSON.stringify(i);return(await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${t}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:a});return await F(c,"fetch similar examples"),c})).json()).examples}async createExample(e,t,n){if($h(e)&&(t!==void 0||n!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=t?n?.datasetId:e.dataset_id;const i=t?n?.datasetName:e.dataset_name;if(s===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:i})).id);const a=(t?n?.createdAt:e.created_at)||new Date;let o;$h(e)?o=e:o={inputs:e,outputs:t,created_at:a?.toISOString(),id:n?.exampleId,metadata:n?.metadata,split:n?.split,source_run_id:n?.sourceRunId,use_source_run_io:n?.useSourceRunIO,use_source_run_attachments:n?.useSourceRunAttachments,attachments:n?.attachments};const u=await this._uploadExamplesMultipart(s,[o]);return await this.readExample(u.example_ids?.[0]??Ke())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const _=e;let b=_[0].dataset_id;const v=_[0].dataset_name;if(b===void 0&&v===void 0)throw new Error("Must provide either datasetName or datasetId");if(b!==void 0&&v!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");b===void 0&&(b=(await this.readDataset({datasetName:v})).id);const w=await this._uploadExamplesMultipart(b,_);return await Promise.all(w.example_ids.map(T=>this.readExample(T)))}const{inputs:t,outputs:n,metadata:s,splits:i,sourceRunIds:a,useSourceRunIOs:o,useSourceRunAttachments:u,attachments:c,exampleIds:l,datasetId:d,datasetName:f}=e;if(t===void 0)throw new Error("Must provide inputs when using legacy parameters");let h=d;const p=f;if(h===void 0&&p===void 0)throw new Error("Must provide either datasetName or datasetId");if(h!==void 0&&p!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");h===void 0&&(h=(await this.readDataset({datasetName:p})).id);const m=t.map((_,b)=>({dataset_id:h,inputs:_,outputs:n?.[b],metadata:s?.[b],split:i?.[b],id:l?.[b],attachments:c?.[b],source_run_id:a?.[b],use_source_run_io:o?.[b],use_source_run_attachments:u?.[b]})),g=await this._uploadExamplesMultipart(h,m);return await Promise.all(g.example_ids.map(_=>this.readExample(_)))}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const s=e.map(a=>Lf(a)?Mf(a):a),i=Lf(t)?Mf(t):t;return this.createExample({input:s},{output:i},n)}async readExample(e){Y(e);const t=`/examples/${e}`,n=await this._get(t),{attachment_urls:s,...i}=n,a=i;return s&&(a.attachments=Object.entries(s).reduce((o,[u,c])=>(o[u.slice(11)]={presigned_url:c.presigned_url,mime_type:c.mime_type},o),{})),a}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:s,splits:i,inlineS3Urls:a,metadata:o,limit:u,offset:c,filter:l,includeAttachments:d}={}){let f;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)f=e;else if(t!==void 0)f=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const h=new URLSearchParams({dataset:f}),p=s?typeof s=="string"?s:s?.toISOString():void 0;p&&h.append("as_of",p);const m=a??!0;if(h.append("inline_s3_urls",m.toString()),n!==void 0)for(const y of n)h.append("id",y);if(i!==void 0)for(const y of i)h.append("splits",y);if(o!==void 0){const y=JSON.stringify(o);h.append("metadata",y)}u!==void 0&&h.append("limit",u.toString()),c!==void 0&&h.append("offset",c.toString()),l!==void 0&&h.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(y=>h.append("select",y));let g=0;for await(const y of this._getPaginated("/examples",h)){for(const _ of y){const{attachment_urls:b,...v}=_,w=v;b&&(w.attachments=Object.entries(b).reduce((E,[T,O])=>(E[T.slice(11)]={presigned_url:O.presigned_url,mime_type:O.mime_type||void 0},E),{})),yield w,g++}if(u!==void 0&&g>=u)break}}async deleteExample(e){Y(e);const t=`/examples/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(n,`delete ${t}`,!0),n})}async deleteExamples(e,t){if(e.forEach(n=>Y(n)),t?.hardDelete){const n=this._getPlatformEndpointPath("datasets/examples/delete");await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}${n}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({example_ids:e,hard_delete:!0}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(s,"hard delete examples",!0),s})}else{const n=new URLSearchParams;e.forEach(s=>n.append("example_ids",s)),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/examples?${n.toString()}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(s,"delete examples",!0),s})}}async updateExample(e,t){let n;t?n=e:n=e.id,Y(n);let s;t?s={id:n,...t}:s=e;let i;return s.dataset_id!==void 0?i=s.dataset_id:i=(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(i,[s])}async updateExamples(e){let t;return e[0].dataset_id===void 0?t=(await this.readExample(e[0].id)).dataset_id:t=e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:n,tag:s}){let i;if(e?i=e:i=(await this.readDataset({datasetName:t})).id,Y(i),n&&s||!n&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const a=new URLSearchParams;return n!==void 0&&a.append("as_of",typeof n=="string"?n:n.toISOString()),s!==void 0&&a.append("tag",s),await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${i}/version?${a.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(u,"read dataset version"),u})).json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let s;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:t})).id:s=e,Y(s);const i=new URLSearchParams,a=n?typeof n=="string"?n:n?.toISOString():void 0;return a&&i.append("as_of",a),await this._get(`/datasets/${s}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:s,remove:i=!1}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,Y(a);const o={split_name:n,examples:s.map(c=>(Y(c),c)),remove:i},u=JSON.stringify(o);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await F(c,"update dataset splits",!0),c})}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:s,referenceExample:i}={loadChildRuns:!1}){Mc("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let a;if(typeof e=="string")a=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)a=e;else throw new Error(`Invalid run type: ${typeof e}`);a.reference_example_id!==null&&a.reference_example_id!==void 0&&(i=await this.readExample(a.reference_example_id));const o=await t.evaluateRun(a,i),[u,c]=await this._logEvaluationFeedback(o,a,n);return c[0]}async createFeedback(e,t,{score:n,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d,projectId:f,comparativeExperimentId:h}){if(!e&&!f)throw new Error("One of runId or projectId must be provided");if(e&&f)throw new Error("Only one of runId or projectId can be provided");const p={type:u??"api",metadata:o??{}};c!==void 0&&p?.metadata!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:c}),p?.metadata!==void 0&&p.metadata.__run?.run_id!==void 0&&Y(p.metadata.__run.run_id);const m={id:l??Ke(),run_id:e,key:t,score:Rh(n),value:s,correction:i,comment:a,feedback_source:p,comparative_experiment_id:h,feedbackConfig:d,session_id:f},g=JSON.stringify(m),y=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const _=await this._fetch(y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:g});return await F(_,"create feedback",!0),_}),m}async updateFeedback(e,{score:t,value:n,correction:s,comment:i}){const a={};t!=null&&(a.score=Rh(t)),n!=null&&(a.value=n),s!=null&&(a.correction=s),i!=null&&(a.comment=i),Y(e);const o=JSON.stringify(a);await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await F(u,"update feedback",!0),u})}async readFeedback(e){Y(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Y(e);const t=`/feedback/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(n,`delete ${t}`,!0),n})}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const s=new URLSearchParams;if(e)for(const i of e)Y(i),s.append("run",i);if(t)for(const i of t)s.append("key",i);if(n)for(const i of n)s.append("source",i);for await(const i of this._getPaginated("/feedback",s))yield*i}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:s}={}){const i={run_id:e,feedback_key:t,feedback_config:s};n?typeof n=="string"?i.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(i.expires_in=n):i.expires_in={hours:3};const a=JSON.stringify(i);return await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await F(u,"create presigned feedback token"),u})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:s,description:i,metadata:a,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),!n==null)throw new Error("A reference dataset is required");const u={id:o,name:e,experiment_ids:t,reference_dataset_id:n,description:i,created_at:(s??new Date)?.toISOString(),extra:{}};a&&(u.extra.metadata=a);const c=JSON.stringify(u);return(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await F(d,"create comparative experiment"),d})).json()}async*listPresignedFeedbackTokens(e){Y(e);const t=new URLSearchParams({run_id:e});for await(const n of this._getPaginated("/feedback/tokens",t))yield*n}_selectEvalResults(e){let t;return"results"in e?t=e.results:Array.isArray(e)?t=e:t=[e],t}async _logEvaluationFeedback(e,t,n){const s=this._selectEvalResults(e),i=[];for(const a of s){let o=n||{};a.evaluatorInfo&&(o={...a.evaluatorInfo,...o});let u=null;a.targetRunId?u=a.targetRunId:t&&(u=t.id),i.push(await this.createFeedback(u,a.key,{score:a.score,value:a.value,comment:a.comment,correction:a.correction,sourceInfo:o,sourceRunId:a.sourceRunId,feedbackConfig:a.feedbackConfig,feedbackSourceType:"model"}))}return[s,i]}async logEvaluationFeedback(e,t,n){const[s]=await this._logEvaluationFeedback(e,t,n);return s}async*listAnnotationQueues(e={}){const{queueIds:t,name:n,nameContains:s,limit:i}=e,a=new URLSearchParams;t&&t.forEach((u,c)=>{Y(u,`queueIds[${c}]`),a.append("ids",u)}),n&&a.append("name",n),s&&a.append("name_contains",s),a.append("limit",(i!==void 0?Math.min(i,100):100).toString());let o=0;for await(const u of this._getPaginated("/annotation-queues",a))if(yield*u,o++,i!==void 0&&o>=i)break}async createAnnotationQueue(e){const{name:t,description:n,queueId:s,rubricInstructions:i}=e,a={name:t,description:n,id:s||Ke(),rubric_instructions:i},o=JSON.stringify(Object.fromEntries(Object.entries(a).filter(([c,l])=>l!==void 0)));return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await F(c,"create annotation queue"),c})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(n,"read annotation queue"),n})).json()}async updateAnnotationQueue(e,t){const{name:n,description:s,rubricInstructions:i}=t,a=JSON.stringify({name:n,description:s,rubric_instructions:i});await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await F(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(t,"delete annotation queue",!0),t})}async addRunsToAnnotationQueue(e,t){const n=JSON.stringify(t.map((s,i)=>Y(s,`runIds[${i}]`).toString()));await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await F(s,"add runs to annotation queue",!0),s})}async getRunFromAnnotationQueue(e,t){const n=`/annotation-queues/${Y(e,"queueId")}/run`;return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(i,"get run from annotation queue"),i})).json()}async deleteRunFromAnnotationQueue(e,t){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}/runs/${Y(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(n,"get size from annotation queue"),n})).json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${n.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const n=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(s,"get latest commit hash"),s})).json();if(n.commits.length!==0)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[n,s,i]=xn(e),a=JSON.stringify({like:t});return(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/likes/${n}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await F(u,`${t?"like":"unlike"} prompt`),u})).json()}async _getPromptUrl(e){const[t,n,s]=xn(e);if(await this._currentTenantIsOwner(t)){const i=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${n}/${s.substring(0,8)}?organizationId=${i.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${i.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${t}/${n}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,n=>n.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),e?.isPublic!==void 0&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const n of this._getPaginated("/repos",t,s=>s.repos))yield*n}async getPrompt(e){const[t,n,s]=xn(e),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return o?.status===404?null:(await F(o,"get prompt"),o)}))?.json();return a?.repo?a.repo:null}async createPrompt(e,t){const n=await this._getSettings();if(t?.isPublic&&!n.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,i,a]=xn(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:i,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},u=JSON.stringify(o),c=await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await F(d,"create prompt"),d}),{repo:l}=await c.json();return l}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,i,a]=xn(e),o=n?.parentCommitHash==="latest"||!n?.parentCommitHash?await this._getLatestCommitHash(`${s}/${i}`):n?.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},c=JSON.stringify(u),d=await(await this.caller.call(async()=>{const f=await this._fetch(`${this.apiUrl}/commits/${s}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await F(f,"create commit"),f})).json();return this._getPromptUrl(`${s}/${i}${d.commit_hash?`:${d.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const a of t){const o=a.id,u={...a.metadata&&{metadata:a.metadata},...a.split&&{split:a.split}},c=mt(u,`Serializing body for example with id: ${o}`),l=new Blob([c],{type:"application/json"});if(n.append(o,l),a.inputs){const d=mt(a.inputs,`Serializing inputs for example with id: ${o}`),f=new Blob([d],{type:"application/json"});n.append(`${o}.inputs`,f)}if(a.outputs){const d=mt(a.outputs,`Serializing outputs whle updating example with id: ${o}`),f=new Blob([d],{type:"application/json"});n.append(`${o}.outputs`,f)}if(a.attachments)for(const[d,f]of Object.entries(a.attachments)){let h,p;Array.isArray(f)?[h,p]=f:(h=f.mimeType,p=f.data);const m=new Blob([p],{type:`${h}; length=${p.byteLength}`});n.append(`${o}.attachment.${d}`,m)}if(a.attachments_operations){const d=mt(a.attachments_operations,`Serializing attachments while updating example with id: ${o}`),f=new Blob([d],{type:"application/json"});n.append(`${o}.attachments_operations`,f)}}const s=e??t[0]?.dataset_id;return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${s}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await F(a,"update examples"),a})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const i of t){const a=(i.id??Ke()).toString(),o={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},u=mt(o,`Serializing body for uploaded example with id: ${a}`),c=new Blob([u],{type:"application/json"});if(n.append(a,c),i.inputs){const l=mt(i.inputs,`Serializing inputs for uploaded example with id: ${a}`),d=new Blob([l],{type:"application/json"});n.append(`${a}.inputs`,d)}if(i.outputs){const l=mt(i.outputs,`Serializing outputs for uploaded example with id: ${a}`),d=new Blob([l],{type:"application/json"});n.append(`${a}.outputs`,d)}if(i.attachments)for(const[l,d]of Object.entries(i.attachments)){let f,h;Array.isArray(d)?[f,h]=d:(f=d.mimeType,h=d.data);const p=new Blob([h],{type:`${f}; length=${h.byteLength}`});n.append(`${a}.attachment.${l}`,p)}}return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await F(i,"upload examples"),i})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,s]=xn(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const i={};if(t?.description!==void 0&&(i.description=t.description),t?.readme!==void 0&&(i.readme=t.readme),t?.tags!==void 0&&(i.tags=t.tags),t?.isPublic!==void 0&&(i.is_public=t.isPublic),t?.isArchived!==void 0&&(i.is_archived=t.isArchived),Object.keys(i).length===0)throw new Error("No valid update options provided");const a=JSON.stringify(i);return(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/repos/${n}/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await F(u,"update prompt"),u})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,n,s]=xn(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,"delete prompt"),a})).json()}async pullPromptCommit(e,t){const[n,s,i]=xn(e),o=await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/commits/${n}/${s}/${i}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(u,"pull prompt commit"),u})).json();return{owner:n,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const n=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(s=>s!=="object")&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:n=this.apiUrl,datasetName:s}=t,[i,a]=this.parseTokenOrUrl(e,n),o=new Vs({apiUrl:i,apiKey:"placeholder"}),u=await o.readSharedDataset(a),c=s||u.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch{}const l=await o.listSharedExamples(a),d=await this.createDataset(c,{description:u.description,dataType:u.data_type||"kv",inputsSchema:u.inputs_schema_definition??void 0,outputsSchema:u.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(f=>f.inputs),outputs:l.flatMap(f=>f.outputs?[f.outputs]:[]),datasetId:d.id})}catch(f){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),f}}parseTokenOrUrl(e,t,n=2,s="dataset"){try{return Y(e),[t,e]}catch{}try{const a=new URL(e).pathname.split("/").filter(o=>o!=="");if(a.length>=n){const o=a[a.length-n];return[t,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await dS()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush()}}function $h(r){return"dataset_id"in r||"dataset_name"in r}const bE=r=>!!["TRACING_V2","TRACING"].find(t=>ut(t)==="true"),Dn=Symbol.for("lc:context_variables"),Bu=Symbol.for("langsmith:replica_trace_roots");function Nh(r,e){if(Dn in r)return r[Dn][e]}function wE(r,e,t){const n=Dn in r?r[Dn]:{};n[e]=t,r[Dn]=n}const Os="6ba7b810-9dad-11d1-80b4-00c04fd430c8";function jh(r){const t=Object.keys(r).sort().map(n=>`${n}:${r[n]??""}`).join("|");return Tr(t,Os)}function vE(r){return r.replace(/[-:.]/g,"")}function xg(r,e=1){const t=e.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(r).toISOString().slice(0,-1)}${t}Z`}function Og(r,e,t=1){const n=xg(r,t);return{dottedOrder:vE(n)+e,microsecondPrecisionDatestring:n}}class Ea{constructor(e,t,n,s){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=n,this.replicas=s}static fromHeader(e){const t=e.split(",");let n={},s=[],i,a;for(const o of t){const[u,c]=o.split("="),l=decodeURIComponent(c);u==="langsmith-metadata"?n=JSON.parse(l):u==="langsmith-tags"?s=l.split(","):u==="langsmith-project"?i=l:u==="langsmith-replicas"&&(a=JSON.parse(l))}return new Ea(n,s,i,a)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class at{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"distributedParentId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),SE(e)){Object.assign(this,{...e});return}const t=at.getDefaultConfig(),{metadata:n,...s}=e,i=s.client??at.getSharedClient(),a={...n,...s?.extra?.metadata};if(s.extra={...s.extra,metadata:a},"id"in s&&s.id==null&&delete s.id,Object.assign(this,{...t,...s,client:i}),this.execution_order??=1,this.child_execution_order??=1,this.dotted_order||(this._serialized_start_time=xg(this.start_time,this.execution_order)),this.id||(this.id=X0(this._serialized_start_time??this.start_time)),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=kE(this.replicas),!this.dotted_order){const{dottedOrder:o}=Og(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o}}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){const e=Date.now();return{run_type:"chain",project_name:cg(),child_runs:[],api_url:un("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:un("LANGCHAIN_API_KEY"),caller_options:{},start_time:e,serialized:{},inputs:{},extra:{}}}static getSharedClient(){return at.sharedClient||(at.sharedClient=new Vs),at.sharedClient}createChild(e){const t=this.child_execution_order+1,n=this.replicas?.map(l=>{const{reroot:d,...f}=l;return f}),s=e.replicas??n,i=new at({...e,parent_run:this,project_name:this.project_name,replicas:s,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});Dn in this&&(i[Dn]=this[Dn]);const a=Symbol.for("lc:child_config"),o=e.extra?.[a]??this.extra[a];if(xE(o)){const l={...o},d=EE(l.callbacks)?l.callbacks.copy?.():void 0;d&&(Object.assign(d,{_parentRunId:i.id}),d.handlers?.find(kg)?.updateFromRunTree?.(i),l.callbacks=d),i.extra[a]=l}const u=new Set;let c=this;for(;c!=null&&!u.has(c.id);)u.add(c.id),c.child_execution_order=Math.max(c.child_execution_order,t),c=c.parent_run;return this.child_runs.push(i),i}async end(e,t,n=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??n,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,t,n=!0){const s=e.extra??{};if(s?.runtime?.library===void 0&&(s.runtime||(s.runtime={}),t))for(const[o,u]of Object.entries(t))s.runtime[o]||(s.runtime[o]=u);let i,a;return n?(a=e.parent_run?.id??e.parent_run_id,i=[]):(i=e.child_runs.map(o=>this._convertToCreate(o,t,n)),a=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:i,parent_run_id:a,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_sliceParentId(e,t){if(t.dotted_order){const n=t.dotted_order.split(".");let s=null;for(let i=0;i<n.length;i++)if(n[i].slice(-36)===e){s=i;break}if(s!==null){const i=n.slice(s+1);t.dotted_order=i.join("."),i.length>0?t.trace_id=i[0].slice(-36):t.trace_id=t.id}}t.parent_run_id===e&&(t.parent_run_id=void 0)}_setReplicaTraceRoot(e,t){const n=Nh(this,Bu)??{};n[e]=t,wE(this,Bu,n);for(const s of this.child_runs)s._setReplicaTraceRoot(e,t)}_remapForProject(e){const{projectName:t,runtimeEnv:n,excludeChildRuns:s=!0,reroot:i=!1,distributedParentId:a,apiUrl:o,apiKey:u,workspaceId:c}=e,l=this._convertToCreate(this,n,s);if(t===this.project_name)return{...l,session_name:t};if(i){if(a)this._sliceParentId(a,l);else if(l.parent_run_id=void 0,l.dotted_order){const _=l.dotted_order.split(".");_.length>0&&(l.dotted_order=_[_.length-1],l.trace_id=l.id)}const y=jh({projectName:t,apiUrl:o,apiKey:u,workspaceId:c});this._setReplicaTraceRoot(y,l.id)}let d;if(!i){const y=Nh(this,Bu)??{},_=jh({projectName:t,apiUrl:o,apiKey:u,workspaceId:c});if(d=y[_],d&&(l.trace_id=d,l.dotted_order)){const b=l.dotted_order.split(".");let v=null;for(let w=0;w<b.length;w++)if(b[w].slice(-36)===d){v=w;break}if(v!==null){const w=b.slice(v);l.dotted_order=w.join(".")}}}const f=l.id,h=Tr(`${f}:${t}`,Os);let p;l.trace_id?p=Tr(`${l.trace_id}:${t}`,Os):p=h;let m;l.parent_run_id&&(m=Tr(`${l.parent_run_id}:${t}`,Os));let g;return l.dotted_order&&(g=l.dotted_order.split(".").map(b=>{const v=b.slice(-36),w=Tr(`${v}:${t}`,Os);return b.slice(0,-36)+w}).join(".")),{...l,id:h,trace_id:p,parent_run_id:m,dotted_order:g,session_name:t}}async postRun(e=!0){try{const t=hg();if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:s,apiUrl:i,workspaceId:a,reroot:o}of this.replicas){const u=this._remapForProject({projectName:n??this.project_name,runtimeEnv:t,excludeChildRuns:!0,reroot:o,distributedParentId:this.distributedParentId,apiUrl:i,apiKey:s,workspaceId:a});await this.client.createRun(u,{apiKey:s,apiUrl:i,workspaceId:a})}else{const n=this._convertToCreate(this,t,e);await this.client.createRun(n)}if(!e){Mc("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const n of this.child_runs)await n.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(e){if(this.replicas&&this.replicas.length>0)for(const{projectName:t,apiKey:n,apiUrl:s,workspaceId:i,updates:a,reroot:o}of this.replicas){const u=this._remapForProject({projectName:t??this.project_name,runtimeEnv:void 0,excludeChildRuns:!0,reroot:o,distributedParentId:this.distributedParentId,apiUrl:s,apiKey:n,workspaceId:i}),c={id:u.id,name:u.name,run_type:u.run_type,start_time:u.start_time,outputs:u.outputs,error:u.error,parent_run_id:u.parent_run_id,session_name:u.session_name,reference_example_id:u.reference_example_id,end_time:u.end_time,dotted_order:u.dotted_order,trace_id:u.trace_id,events:u.events,tags:u.tags,extra:u.extra,attachments:this.attachments,...a};e?.excludeInputs||(c.inputs=u.inputs),await this.client.updateRun(u.id,c,{apiKey:n,apiUrl:s,workspaceId:i})}else try{const t={name:this.name,run_type:this.run_type,start_time:this._serialized_start_time??this.start_time,end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e?.excludeInputs||(t.inputs=this.inputs),await this.client.updateRun(this.id,t)}catch(t){console.error(`Error in patchRun for run ${this.id}`,t)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,t){const n=e?.callbacks;let s,i,a,o=bE();if(n){const c=n?.getParentRunId?.()??"",l=n?.handlers?.find(d=>d?.name=="langchain_tracer");s=l?.getRun?.(c),i=l?.projectName,a=l?.client,o=o||!!l}return s?new at({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:a,tracingEnabled:o,project_name:i,tags:[...new Set((s?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...s?.extra?.metadata,...e?.metadata}}}).createChild(t):new at({...t,client:a,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const n="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=n["langsmith-trace"];if(!s||typeof s!="string")return;const i=s.trim(),a=i.split(".").map(l=>{const[d,f]=l.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:f}}),o=a[0].uuid,u={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:a.at(-1)?.uuid,trace_id:o,dotted_order:i};if(n.baggage&&typeof n.baggage=="string"){const l=Ea.fromHeader(n.baggage);u.metadata=l.metadata,u.tags=l.tags,u.project_name=l.project_name,u.replicas=l.replicas}const c=new at(u);return c.distributedParentId=c.id,c}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new Ea(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[n,s]of Object.entries(t))e.set(n,s);return t}}Object.defineProperty(at,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function SE(r){return r!=null&&typeof r.createChild=="function"&&typeof r.postRun=="function"}function kg(r){return typeof r=="object"&&r!=null&&typeof r.name=="string"&&r.name==="langchain_tracer"}function Lh(r){return Array.isArray(r)&&r.some(e=>kg(e))}function EE(r){return typeof r=="object"&&r!=null&&Array.isArray(r.handlers)}function xE(r){const e=r?.callbacks;return r!=null&&typeof e=="object"&&(Lh(e?.handlers)||Lh(e))}function OE(){const r=un("LANGSMITH_RUNS_ENDPOINTS");if(!r)return[];try{const e=JSON.parse(r);if(Array.isArray(e)){const t=[];for(const n of e){if(typeof n!="object"||n===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof n}`);continue}if(typeof n.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_url}`);continue}if(typeof n.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_key}`);continue}t.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key})}return t}else if(typeof e=="object"&&e!==null){PE(e);const t=[];for(const[n,s]of Object.entries(e)){const i=n.replace(/\/$/,"");if(typeof s=="string")t.push({apiUrl:i,apiKey:s});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${n}: expected string, got ${typeof s}`);continue}}return t}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS â€“ must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(iE(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS â€“ must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function kE(r){return r?r.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):OE()}function PE(r){if(Object.keys(r).length>0&&ut("ENDPOINT"))throw new sE}var AE={};const TE=()=>typeof window<"u"&&typeof window.document<"u",IE=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",RE=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Jl=()=>typeof Deno<"u",CE=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Jl(),$E=()=>{let r;return TE()?r="browser":CE()?r="node":IE()?r="webworker":RE()?r="jsdom":Jl()?r="deno":r="other",r};let zu;function NE(){return zu===void 0&&(zu={library:"langchain-js",runtime:$E()}),zu}function Un(r){try{return typeof process<"u"?AE?.[r]:Jl()?Deno?.env.get(r):void 0}catch{return}}class jE{}function LE(r){return"lc_prefer_streaming"in r&&r.lc_prefer_streaming}class rs extends jE{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ng(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:Un("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return or.prototype.toJSON.call(this)}toJSONNotImplemented(){return or.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends rs{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ke()}),Object.assign(this,e)}}return new t}}const ME=r=>{const e=r;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"},DE=r=>{if(r)return r.events=r.events??[],r.child_runs=r.child_runs??[],r};function Fc(r,e){if(r)return new at({...r,start_time:r._serialized_start_time??r.start_time,parent_run:Fc(e),child_runs:r.child_runs.map(t=>Fc(t)).filter(t=>t!==void 0),extra:{...r.extra,runtime:NE()},tracingEnabled:!1})}function Gu(r,e){return r&&!Array.isArray(r)&&typeof r=="object"?r:{[e]:r}}function fs(r){return typeof r._addRunToRunMap=="function"}class pi extends rs{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"runTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!1})}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?DE(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const{dottedOrder:t,microsecondPrecisionDatestring:n}=Og(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},i=this.getRunById(s.parent_run_id);if(s.parent_run_id!==void 0?i&&(this._addChildRun(i,s),i.child_execution_order=Math.max(i.child_execution_order,s.child_execution_order),s.trace_id=i.trace_id,i.dotted_order!==void 0&&(s.dotted_order=[i.dotted_order,t].join("."),s._serialized_start_time=n)):(s.trace_id=s.id,s.dotted_order=t,s._serialized_start_time=n),this.usesRunTreeMap){const a=Fc(s,i);a!==void 0&&this.runTreeMap.set(s.id,a)}else this.runMap.set(s.id,s);return s}async _endTrace(e){const t=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await this.onRunUpdate?.(e),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=e!==void 0&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,n,s,i,a,o,u){const c=this._getExecutionOrder(s),l=Date.now(),d=o?{...i,metadata:o}:i,f={id:n,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(f)}async handleLLMStart(e,t,n,s,i,a,o,u){const c=this.getRunById(n)??this._createRunForLLMStart(e,t,n,s,i,a,o,u);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}_createRunForChatModelStart(e,t,n,s,i,a,o,u){const c=this._getExecutionOrder(s),l=Date.now(),d=o?{...i,metadata:o}:i,f={id:n,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(f)}async handleChatModelStart(e,t,n,s,i,a,o,u){const c=this.getRunById(n)??this._createRunForChatModelStart(e,t,n,s,i,a,o,u);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}async handleLLMEnd(e,t,n,s,i){const a=this.getRunById(t);if(!a||a?.run_type!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=e,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await this.onLLMEnd?.(a),await this._endTrace(a),a}async handleLLMError(e,t,n,s,i){const a=this.getRunById(t);if(!a||a?.run_type!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await this.onLLMError?.(a),await this._endTrace(a),a}_createRunForChainStart(e,t,n,s,i,a,o,u){const c=this._getExecutionOrder(s),l=Date.now(),d={id:n,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,n,s,i,a,o,u){const c=this.getRunById(n)??this._createRunForChainStart(e,t,n,s,i,a,o,u);return await this.onRunCreate?.(c),await this.onChainStart?.(c),c}async handleChainEnd(e,t,n,s,i){const a=this.getRunById(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=Gu(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),i?.inputs!==void 0&&(a.inputs=Gu(i.inputs,"input")),await this.onChainEnd?.(a),await this._endTrace(a),a}async handleChainError(e,t,n,s,i){const a=this.getRunById(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),i?.inputs!==void 0&&(a.inputs=Gu(i.inputs,"input")),await this.onChainError?.(a),await this._endTrace(a),a}_createRunForToolStart(e,t,n,s,i,a,o){const u=this._getExecutionOrder(s),c=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,n,s,i,a,o){const u=this.getRunById(n)??this._createRunForToolStart(e,t,n,s,i,a,o);return await this.onRunCreate?.(u),await this.onToolStart?.(u),u}async handleToolEnd(e,t){const n=this.getRunById(t);if(!n||n?.run_type!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onToolEnd?.(n),await this._endTrace(n),n}async handleToolError(e,t){const n=this.getRunById(t);if(!n||n?.run_type!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onToolError?.(n),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.getRunById(t);if(!n||n?.run_type!=="chain")return;const s=n;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(n)}async handleAgentEnd(e,t){const n=this.getRunById(t);!n||n?.run_type!=="chain"||(n.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(n))}_createRunForRetrieverStart(e,t,n,s,i,a,o){const u=this._getExecutionOrder(s),c=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,n,s,i,a,o){const u=this.getRunById(n)??this._createRunForRetrieverStart(e,t,n,s,i,a,o);return await this.onRunCreate?.(u),await this.onRetrieverStart?.(u),u}async handleRetrieverEnd(e,t){const n=this.getRunById(t);if(!n||n?.run_type!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onRetrieverEnd?.(n),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.getRunById(t);if(!n||n?.run_type!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onRetrieverError?.(n),await this._endTrace(n),n}async handleText(e,t){const n=this.getRunById(t);!n||n?.run_type!=="chain"||(n.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(n))}async handleLLMNewToken(e,t,n,s,i,a){const o=this.getRunById(n);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:a?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:a?.chunk}),o}}var na={exports:{}};na.exports;var Mh;function UE(){return Mh||(Mh=1,(function(r){const t=(i=0)=>a=>`\x1B[${38+i};5;${a}m`,n=(i=0)=>(a,o,u)=>`\x1B[${38+i};2;${a};${o};${u}m`;function s(){const i=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[o,u]of Object.entries(a)){for(const[c,l]of Object.entries(u))a[c]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},u[c]=a[c],i.set(l[0],l[1]);Object.defineProperty(a,o,{value:u,enumerable:!1})}return Object.defineProperty(a,"codes",{value:i,enumerable:!1}),a.color.close="\x1B[39m",a.bgColor.close="\x1B[49m",a.color.ansi256=t(),a.color.ansi16m=n(),a.bgColor.ansi256=t(10),a.bgColor.ansi16m=n(10),Object.defineProperties(a,{rgbToAnsi256:{value:(o,u,c)=>o===u&&u===c?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:c}=u.groups;c.length===3&&(c=c.split("").map(d=>d+d).join(""));const l=Number.parseInt(c,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>a.rgbToAnsi256(...a.hexToRgb(o)),enumerable:!1}}),a}Object.defineProperty(r,"exports",{enumerable:!0,get:s})})(na)),na.exports}var FE=UE();const Pg=li(FE);function Ye(r,e){return`${r.open}${e}${r.close}`}function kt(r,e){try{return JSON.stringify(r,null,2)}catch{return e}}function Dh(r){return typeof r=="string"?r.trim():r==null?r:kt(r,r.toString())}function On(r){if(!r.end_time)return"";const e=r.end_time-r.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:st}=Pg;class Uh extends pi{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const s=this.runMap.get(n.parent_run_id);if(s)t.push(s),n=s;else break}return t}getBreadcrumbs(e){const n=[...this.getParents(e).reverse(),e].map((s,i,a)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return i===a.length-1?Ye(Pg.bold,o):o}).join(" > ");return Ye(st.grey,n)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.green,"[chain/start]")} [${t}] Entering Chain run with input: ${kt(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.cyan,"[chain/end]")} [${t}] [${On(e)}] Exiting Chain run with output: ${kt(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.red,"[chain/error]")} [${t}] [${On(e)}] Chain run errored with error: ${kt(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${Ye(st.green,"[llm/start]")} [${t}] Entering LLM run with input: ${kt(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.cyan,"[llm/end]")} [${t}] [${On(e)}] Exiting LLM run with output: ${kt(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.red,"[llm/error]")} [${t}] [${On(e)}] LLM run errored with error: ${kt(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.green,"[tool/start]")} [${t}] Entering Tool run with input: "${Dh(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.cyan,"[tool/end]")} [${t}] [${On(e)}] Exiting Tool run with output: "${Dh(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.red,"[tool/error]")} [${t}] [${On(e)}] Tool run errored with error: ${kt(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${kt(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.cyan,"[retriever/end]")} [${t}] [${On(e)}] Exiting Retriever run with output: ${kt(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${Ye(st.red,"[retriever/error]")} [${t}] [${On(e)}] Retriever run errored with error: ${kt(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${Ye(st.blue,"[agent/action]")} [${n}] Agent selected action: ${kt(t.actions[t.actions.length-1],"[action]")}`)}}let qu;const BE=()=>{if(qu===void 0){const r=Un("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};qu=new Vs(r)}return qu};class Cs extends pi{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!0});const{exampleId:t,projectName:n,client:s,replicas:i}=e;this.projectName=n??cg(),this.replicas=i,this.exampleId=t,this.client=s??BE();const a=Cs.getTraceableRunTree();a&&this.updateFromRunTree(a)}async persistRun(e){}async onRunCreate(e){await this.getRunTreeWithTracingConfig(e.id)?.postRun()}async onRunUpdate(e){await this.getRunTreeWithTracingConfig(e.id)?.patchRun()}getRun(e){return this.runTreeMap.get(e)}updateFromRunTree(e){this.runTreeMap.set(e.id,e);let t=e;const n=new Set;for(;t.parent_run&&!(n.has(t.id)||(n.add(t.id),!t.parent_run));)t=t.parent_run;n.clear();const s=[t];for(;s.length>0;){const i=s.shift();!i||n.has(i.id)||(n.add(i.id),this.runTreeMap.set(i.id,i),i.child_runs&&s.push(...i.child_runs))}this.client=e.client??this.client,this.replicas=e.replicas??this.replicas,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(e){const t=this.runTreeMap.get(e);if(t)return new at({...t,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return f0(!0)}catch{return}}}const Ag=Symbol.for("ls:tracing_async_local_storage"),ra=Symbol.for("lc:context_variables"),zE=r=>{globalThis[Ag]=r},Ws=()=>globalThis[Ag];let $s;function GE(){const r="default"in gn?gn.default:gn;return new r({autoStart:!0,concurrency:1})}function qE(){return typeof $s>"u"&&($s=GE()),$s}async function Me(r,e){if(e===!0){const t=Ws();t!==void 0?await t.run(void 0,async()=>r()):await r()}else $s=qE(),$s.add(async()=>{const t=Ws();t!==void 0?await t.run(void 0,async()=>r()):await r()})}const HE=r=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>Un(t)==="true");function Tg(r){const e=Ws();return e===void 0?void 0:e.getStore()?.[ra]?.[r]}const VE=Symbol("lc:configure_hooks"),WE=()=>Tg(VE)||[];class ZE{setHandler(e){return this.setHandlers([e])}}class fo{constructor(e,t,n,s,i,a,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>Me(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleCustomEvent(e,t,n,s,i){await Promise.all(this.handlers.map(a=>Me(async()=>{try{await a.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}}class JE extends fo{getChild(e){const t=new lt(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>Me(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw n}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>Me(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${n}`),t.raiseError)throw e}},t.awaitHandlers)))}}class Fh extends fo{async handleLLMNewToken(e,t,n,s,i,a){await Promise.all(this.handlers.map(o=>Me(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a)}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e,t,n,s,i){await Promise.all(this.handlers.map(a=>Me(async()=>{if(!a.ignoreLLM)try{await a.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMError: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleLLMEnd(e,t,n,s,i){await Promise.all(this.handlers.map(a=>Me(async()=>{if(!a.ignoreLLM)try{await a.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMEnd: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}}class KE extends fo{getChild(e){const t=new lt(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,s,i){await Promise.all(this.handlers.map(a=>Me(async()=>{if(!a.ignoreChain)try{await a.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainError: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleChainEnd(e,t,n,s,i){await Promise.all(this.handlers.map(a=>Me(async()=>{if(!a.ignoreChain)try{await a.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainEnd: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>Me(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>Me(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}}class XE extends fo{getChild(e){const t=new lt(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>Me(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>Me(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}}class lt extends ZE{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,s=void 0,i=void 0,a=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{const d=l===0&&n?n:Ke();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return fs(f)&&f._createRunForLLMStart(e,[c],d,this._parentRunId,i,this.tags,this.metadata,u),Me(async()=>{try{await f.handleLLMStart?.(e,[c],d,this._parentRunId,i,this.tags,this.metadata,u)}catch(h){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${h}`),f.raiseError)throw h}},f.awaitHandlers)})),new Fh(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,n=void 0,s=void 0,i=void 0,a=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{const d=l===0&&n?n:Ke();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return fs(f)&&f._createRunForChatModelStart(e,[c],d,this._parentRunId,i,this.tags,this.metadata,u),Me(async()=>{try{if(f.handleChatModelStart)await f.handleChatModelStart?.(e,[c],d,this._parentRunId,i,this.tags,this.metadata,u);else if(f.handleLLMStart){const h=ig(c);await f.handleLLMStart?.(e,[h],d,this._parentRunId,i,this.tags,this.metadata,u)}}catch(h){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${h}`),f.raiseError)throw h}},f.awaitHandlers)})),new Fh(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,n=Ke(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return fs(u)&&u._createRunForChainStart(e,t,n,this._parentRunId,this.tags,this.metadata,s,o),Me(async()=>{try{await u.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,s,o)}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${c}`),u.raiseError)throw c}},u.awaitHandlers)})),new KE(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=Ke(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return fs(u)&&u._createRunForToolStart(e,t,n,this._parentRunId,this.tags,this.metadata,o),Me(async()=>{try{await u.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,o)}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${c}`),u.raiseError)throw c}},u.awaitHandlers)})),new XE(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=Ke(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return fs(u)&&u._createRunForRetrieverStart(e,t,n,this._parentRunId,this.tags,this.metadata,o),Me(async()=>{try{await u.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,o)}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${c}`),u.raiseError)throw c}},u.awaitHandlers)})),new JE(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,n,s,i){await Promise.all(this.handlers.map(a=>Me(async()=>{if(!a.ignoreCustomEvent)try{await a.handleCustomEvent?.(e,t,n,this.tags,this.metadata)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new lt(this._parentRunId);for(const s of this.handlers){const i=this.inheritableHandlers.includes(s);n.addHandler(s,i)}for(const s of this.tags){const i=this.inheritableTags.includes(s);n.addTags([s],i)}for(const s of Object.keys(this.metadata)){const i=Object.keys(this.inheritableMetadata).includes(s);n.addMetadata({[s]:this.metadata[s]},i)}for(const s of e)n.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===s.name)||n.addHandler(s,t);return n}static fromHandlers(e){class t extends rs{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ke()}),Object.assign(this,e)}}const n=new this;return n.addHandler(new t),n}static configure(e,t,n,s,i,a,o){return this._configureSync(e,t,n,s,i,a,o)}static _configureSync(e,t,n,s,i,a,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new lt,u.setHandlers(e?.map(xa)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(xa):t?.handlers,!1));const c=Un("LANGCHAIN_VERBOSE")==="true"||o?.verbose,l=Cs.getTraceableRunTree()?.tracingEnabled||HE(),d=l||(Un("LANGCHAIN_TRACING")??!1);if(c||d){if(u||(u=new lt),c&&!u.handlers.some(f=>f.name===Uh.prototype.name)){const f=new Uh;u.addHandler(f,!0)}if(d&&!u.handlers.some(f=>f.name==="langchain_tracer")&&l){const f=new Cs;u.addHandler(f,!0)}if(l){const f=Cs.getTraceableRunTree();f&&u._parentRunId===void 0&&(u._parentRunId=f.id,u.handlers.find(p=>p.name==="langchain_tracer")?.updateFromRunTree(f))}}for(const{contextVar:f,inheritable:h=!0,handlerClass:p,envVar:m}of WE()){const g=m&&Un(m)==="true"&&p;let y;const _=f!==void 0?Tg(f):void 0;_&&ME(_)?y=_:g&&(y=new p({})),y!==void 0&&(u||(u=new lt),u.handlers.some(b=>b.name===y.name)||u.addHandler(y,h))}return(n||s)&&u&&(u.addTags(n??[]),u.addTags(s??[],!1)),(i||a)&&u&&(u.addMetadata(i??{}),u.addMetadata(a??{},!1)),u}}function xa(r){return"name"in r?r:rs.fromMethods(r)}class YE{getStore(){}run(e,t){return t()}enterWith(e){}}const QE=new YE,Bh=Symbol.for("lc:child_config");class ex{getInstance(){return Ws()??QE}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[Bh]}runWithConfig(e,t,n){const s=lt._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),i=this.getInstance(),a=i.getStore(),o=s?.getParentRunId(),u=s?.handlers?.find(l=>l?.name==="langchain_tracer");let c;return u&&o?c=u.getRunTreeWithTracingConfig(o):n||(c=new at({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[Bh]:e}),a!==void 0&&a[ra]!==void 0&&(c===void 0&&(c={}),c[ra]=a[ra]),i.run(c,t)}initializeGlobalInstance(e){Ws()===void 0&&zE(e)}}const Ct=new ex,Hu=25;async function $t(r){return lt._configureSync(r?.callbacks,void 0,r?.tags,void 0,r?.metadata)}function sn(...r){const e={};for(const t of r.filter(n=>!!n))for(const n of Object.keys(t))if(n==="metadata")e[n]={...e[n],...t[n]};else if(n==="tags"){const s=e[n]??[];e[n]=[...new Set(s.concat(t[n]??[]))]}else if(n==="configurable")e[n]={...e[n],...t[n]};else if(n==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(n==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(n==="callbacks"){const s=e.callbacks,i=t.callbacks;if(Array.isArray(i))if(!s)e.callbacks=i;else if(Array.isArray(s))e.callbacks=s.concat(i);else{const a=s.copy();for(const o of i)a.addHandler(xa(o),!0);e.callbacks=a}else if(i)if(!s)e.callbacks=i;else if(Array.isArray(s)){const a=i.copy();for(const o of s)a.addHandler(xa(o),!0);e.callbacks=a}else e.callbacks=new lt(i._parentRunId,{handlers:s.handlers.concat(i.handlers),inheritableHandlers:s.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(i.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(i.inheritableTags))),metadata:{...s.metadata,...i.metadata}})}else{const s=n;e[s]=t[s]??e[s]}return e}const tx=new Set(["string","number","boolean"]);function fe(r){const e=Ct.getRunnableConfig();let t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:n,runName:s,...i}=e;t=Object.entries(i).reduce((a,[o,u])=>(u!==void 0&&(a[o]=u),a),t)}if(r&&(t=Object.entries(r).reduce((n,[s,i])=>(i!==void 0&&(n[s]=i),n),t)),t?.configurable)for(const n of Object.keys(t.configurable))tx.has(typeof t.configurable[n])&&!t.metadata?.[n]&&(t.metadata||(t.metadata={}),t.metadata[n]=t.configurable[n]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");const n=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,n])):t.signal=n,delete t.timeout}return t}function ke(r={},{callbacks:e,maxConcurrency:t,recursionLimit:n,runName:s,configurable:i,runId:a}={}){const o=fe(r);return e!==void 0&&(delete o.runName,o.callbacks=e),n!==void 0&&(o.recursionLimit=n),t!==void 0&&(o.maxConcurrency=t),s!==void 0&&(o.runName=s),i!==void 0&&(o.configurable={...o.configurable,...i}),a!==void 0&&delete o.runId,o}function Br(r){return r?{configurable:r.configurable,recursionLimit:r.recursionLimit,callbacks:r.callbacks,tags:r.tags,metadata:r.metadata,maxConcurrency:r.maxConcurrency,timeout:r.timeout,signal:r.signal}:void 0}async function Gn(r,e){if(e===void 0)return r;let t;return Promise.race([r.catch(n=>{if(!e?.aborted)throw n}),new Promise((n,s)=>{t=()=>{s(new Error("Aborted"))},e.addEventListener("abort",t),e.aborted&&s(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",t))}class tt extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new tt({start(n){return s();function s(){return t.read().then(({done:i,value:a})=>{if(i){n.close();return}return n.enqueue(a),s()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new tt({async pull(t){const{value:n,done:s}=await e.next();s&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function Ig(r,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(s){for(;;)if(s.length===0){const i=await r.next();for(const a of t)a.push(i)}else{if(s[0].done)return;yield s.shift().value}})}function ho(r,e){if(Array.isArray(r)&&Array.isArray(e))return r.concat(e);if(typeof r=="string"&&typeof e=="string")return r+e;if(typeof r=="number"&&typeof e=="number")return r+e;if("concat"in r&&typeof r.concat=="function")return r.concat(e);if(typeof r=="object"&&typeof e=="object"){const t={...r};for(const[n,s]of Object.entries(e))n in t&&!Array.isArray(t[n])?t[n]=ho(t[n],s):t[n]=s;return t}else throw new Error(`Cannot concat ${typeof r} and ${typeof e}`)}class ss{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,n)=>{Ct.runWithConfig(Br(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,n):this.firstResult.then(s=>t(void 0),n)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?Ct.runWithConfig(Br(this.config),this.signal?async()=>Gn(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function nx(r,e,t,n,...s){const i=new ss({generator:e,startSetup:t,signal:n}),a=await i.setup;return{output:r(i,a,...s),setup:a}}class An{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=wa({},t);return new Zs({ops:t,state:n[n.length-1].newDocument})}}class Zs extends An{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=wa(this.state,e.ops);return new Zs({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const t=wa({},e.ops);return new Zs({ops:e.ops,state:t[t.length-1].newDocument})}}const rx=r=>r.name==="log_stream_tracer";async function zh(r,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=r;if(["retriever","llm","prompt"].includes(r.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function Gh(r,e){const{outputs:t}=r;return e==="original"||["retriever","llm","prompt"].includes(r.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function sx(r){return r!==void 0&&r.message!==void 0}class qh extends pi{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=tt.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(n=n||t.find(s=>this.includeTags?.includes(s))!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(n=n&&t.every(s=>!this.excludeTags?.includes(s))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new An({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new An({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(n.inputs=await zh(e,this._schemaFormat)),await this.writer.write(new An({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const n=[];this._schemaFormat==="streaming_events"&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await zh(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await Gh(e,this._schemaFormat)}),e.end_time!==void 0&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const s=new An({ops:n});await this.writer.write(s)}finally{if(e.id===this.rootId){const t=new An({ops:[{op:"replace",path:"/final_output",value:await Gh(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const i=e.inputs.messages!==void 0;let a;i?sx(n?.chunk)?a=n?.chunk:a=new bn({id:`run-${e.id}`,content:t}):a=t;const o=new An({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${s}/streamed_output/-`,value:a}]});await this.writer.write(o)}}const Hh="__run";class zr{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new zr({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class ur extends zr{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new ur({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function Di({name:r,serialized:e}){return r!==void 0?r:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}const ix=r=>r.name==="event_stream_tracer";class ax extends pi{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=tt.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(n=n||t.find(s=>this.includeTags?.includes(s))!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(n=n&&t.every(s=>!this.excludeTags?.includes(s))),n}async*tapOutputIterable(e,t){const n=await t.next();if(n.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield n.value;return}function i(o,u){return o==="llm"&&typeof u=="string"?new zr({text:u}):u}let a=this.tappedPromises.get(e);if(a===void 0){let o;a=new Promise(u=>{o=u}),this.tappedPromises.set(e,a);try{const u={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...u,data:{chunk:i(s.runType,n.value)}},s),yield n.value;for await(const c of t)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...u,data:{chunk:i(s.runType,c)}},s),yield c}finally{o()}}else{yield n.value;for await(const o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const n=this.tappedPromises.get(e.run_id);n!==void 0?n.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){const t=Di(e),n=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,s);const i=`on_${n}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},s)}async onLLMNewToken(e,t,n){const s=this.runInfoMap.get(e.id);let i,a;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")a="on_chat_model_stream",n?.chunk===void 0?i=new bn({content:t,id:`run-${e.id}`}):i=n.chunk.message;else if(s.runType==="llm")a="on_llm_stream",n?.chunk===void 0?i=new zr({text:t}):i=n.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:a,data:{chunk:i},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let n;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=e.outputs?.generations;let i;if(t.runType==="chat_model"){for(const a of s??[]){if(i!==void 0)break;i=a[0]?.message}n="on_chat_model_end"}else if(t.runType==="llm")i={generations:s?.map(a=>a.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},n="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:n,data:{output:i,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=Di(e),n=e.run_type??"chain",s={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},s.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,s.inputs=e.inputs.input):(i.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${n}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},s)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,s=e.inputs??t.inputs??{},a={output:e.outputs?.output??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(a.input=s.input,t.inputs=s.input),await this.sendEndEvent({event:n,data:a,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=Di(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},n)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=Di(e),s={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},s)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){const s=this.runInfoMap.get(n);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:s.tags,metadata:s.metadata,data:t},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}const ox=[400,401,402,403,404,405,406,407,409],ux=r=>{if(r.message.startsWith("Cancel")||r.message.startsWith("AbortError")||r.name==="AbortError"||r?.code==="ECONNABORTED")throw r;const e=r?.response?.status??r?.status;if(e&&ox.includes(+e))throw r;if(r?.error?.code==="insufficient_quota"){const t=new Error(r?.message);throw t.name="InsufficientQuotaError",t}};class Kl{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??ux;const t="default"in gn?gn.default:gn;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Ic(()=>e(...t).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise((s,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...n)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}class Rg extends pi{constructor({config:e,onStart:t,onEnd:n,onError:s}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function Xl(r){return r?r.lc_runnable:!1}class cx{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const s=e.tags??[];return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(t)),this.includeTags!==void 0&&(n=n||s.some(i=>this.includeTags?.includes(i))),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(n=n&&s.every(i=>!this.excludeTags?.includes(i))),n}}function Vu(r){return r.replace(/[^a-zA-Z-_0-9]/g,"_")}const lx=["*","_","`"];function dx(r){let e="";for(const[t,n]of Object.entries(r))e+=`	classDef ${t} ${n};
`;return e}function fx(r,e,t){const{firstNode:n,lastNode:s,nodeColors:i,withStyles:a=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t??{};let c=a?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(a){const h="default",p={[h]:"{0}({1})"};n!==void 0&&(p[n]="{0}([{1}]):::first"),s!==void 0&&(p[s]="{0}([{1}]):::last");for(const[m,g]of Object.entries(r)){const y=g.name.split(":").pop()??"";let b=lx.some(w=>y.startsWith(w)&&y.endsWith(w))?`<p>${y}</p>`:y;Object.keys(g.metadata??{}).length&&(b+=`<hr/><small><em>${Object.entries(g.metadata??{}).map(([w,E])=>`${w} = ${E}`).join(`
`)}</em></small>`);const v=(p[m]??p[h]).replace("{0}",Vu(m)).replace("{1}",b);c+=`	${v}
`}}const l={};for(const h of e){const p=h.source.split(":"),m=h.target.split(":"),g=p.filter((y,_)=>y===m[_]).join(":");l[g]||(l[g]=[]),l[g].push(h)}const d=new Set;function f(h,p){const m=h.length===1&&h[0].source===h[0].target;if(p&&!m){const g=p.split(":").pop();if(d.has(g))throw new Error(`Found duplicate subgraph '${g}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(g),c+=`	subgraph ${g}
`}for(const g of h){const{source:y,target:_,data:b,conditional:v}=g;let w="";if(b!==void 0){let E=b;const T=E.split(" ");T.length>u&&(E=Array.from({length:Math.ceil(T.length/u)},(O,x)=>T.slice(x*u,(x+1)*u).join(" ")).join("&nbsp;<br>&nbsp;")),w=v?` -. &nbsp;${E}&nbsp; .-> `:` -- &nbsp;${E}&nbsp; --> `}else w=v?" -.-> ":" --> ";c+=`	${Vu(y)}${w}${Vu(_)};
`}for(const g in l)g.startsWith(`${p}:`)&&g!==p&&f(l[g],g);p&&!m&&(c+=`	end
`)}f(l[""]??[],"");for(const h in l)!h.includes(":")&&h!==""&&f(l[h],h);return a&&(c+=dx(i??{})),c}async function hx(r,e){return px(r,{...e,imageType:"png"})}async function px(r,e){let t=e?.backgroundColor??"white";const n=e?.imageType,s=btoa(r);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));const i=`https://mermaid.ink/img/${s}?bgColor=${t}&type=${n}`,a=await fetch(i);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join(`
`));return await a.blob()}function po(r,e,t){function n(o,u){var c;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(c=o._zod).traits??(c.traits=new Set),o._zod.traits.add(r),e(o,u);for(const l in a.prototype)l in o||Object.defineProperty(o,l,{value:a.prototype[l].bind(o)});o._zod.constr=a,o._zod.def=u}const s=t?.Parent??Object;class i extends s{}Object.defineProperty(i,"name",{value:r});function a(o){var u;const c=t?.Parent?new i:this;n(c,o),(u=c._zod).deferred??(u.deferred=[]);for(const l of c._zod.deferred)l();return c}return Object.defineProperty(a,"init",{value:n}),Object.defineProperty(a,Symbol.hasInstance,{value:o=>t?.Parent&&o instanceof t.Parent?!0:o?._zod?.traits?.has(r)}),Object.defineProperty(a,"name",{value:r}),a}class Oa extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const mx={};function mo(r){return mx}function gx(r){const e=Object.values(r).filter(n=>typeof n=="number");return Object.entries(r).filter(([n,s])=>e.indexOf(+n)===-1).map(([n,s])=>s)}function yx(r,e){return typeof e=="bigint"?e.toString():e}const Cg=Error.captureStackTrace?Error.captureStackTrace:(...r)=>{};function ka(r,e,t){const n=new r._zod.constr(e??r._zod.def);return(!e||t?.parent)&&(n._zod.parent=r),n}function _x(r){return{}}function Wu(r,e=0){for(let t=e;t<r.issues.length;t++)if(r.issues[t]?.continue!==!0)return!0;return!1}function Ui(r){return typeof r=="string"?r:r?.message}function go(r,e,t){const n={...r,path:r.path??[]};if(!r.message){const s=Ui(r.inst?._zod.def?.error?.(r))??Ui(e?.error?.(r))??Ui(t.customError?.(r))??Ui(t.localeError?.(r))??"Invalid input";n.message=s}return delete n.inst,delete n.continue,e?.reportInput||delete n.input,n}const $g=(r,e)=>{r.name="$ZodError",Object.defineProperty(r,"_zod",{value:r._zod,enumerable:!1}),Object.defineProperty(r,"issues",{value:e,enumerable:!1}),Object.defineProperty(r,"message",{get(){return JSON.stringify(e,yx,2)},enumerable:!0}),Object.defineProperty(r,"toString",{value:()=>r.message,enumerable:!1})},bx=po("$ZodError",$g),yo=po("$ZodError",$g,{Parent:Error}),wx=r=>(e,t,n,s)=>{const i=n?Object.assign(n,{async:!1}):{async:!1},a=e._zod.run({value:t,issues:[]},i);if(a instanceof Promise)throw new Oa;if(a.issues.length){const o=new(s?.Err??r)(a.issues.map(u=>go(u,i,mo())));throw Cg(o,s?.callee),o}return a.value},vx=wx(yo),Sx=r=>async(e,t,n,s)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let a=e._zod.run({value:t,issues:[]},i);if(a instanceof Promise&&(a=await a),a.issues.length){const o=new(s?.Err??r)(a.issues.map(u=>go(u,i,mo())));throw Cg(o,s?.callee),o}return a.value},Ex=Sx(yo),xx=r=>(e,t,n)=>{const s=n?{...n,async:!1}:{async:!1},i=e._zod.run({value:t,issues:[]},s);if(i instanceof Promise)throw new Oa;return i.issues.length?{success:!1,error:new(r??bx)(i.issues.map(a=>go(a,s,mo())))}:{success:!0,data:i.value}},Ox=xx(yo),kx=r=>async(e,t,n)=>{const s=n?Object.assign(n,{async:!0}):{async:!0};let i=e._zod.run({value:t,issues:[]},s);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new r(i.issues.map(a=>go(a,s,mo())))}:{success:!0,data:i.value}},Px=kx(yo),Ax={major:4,minor:0,patch:0},Tx=po("$ZodType",(r,e)=>{var t;r??(r={}),r._zod.def=e,r._zod.bag=r._zod.bag||{},r._zod.version=Ax;const n=[...r._zod.def.checks??[]];r._zod.traits.has("$ZodCheck")&&n.unshift(r);for(const s of n)for(const i of s._zod.onattach)i(r);if(n.length===0)(t=r._zod).deferred??(t.deferred=[]),r._zod.deferred?.push(()=>{r._zod.run=r._zod.parse});else{const s=(i,a,o)=>{let u=Wu(i),c;for(const l of a){if(l._zod.def.when){if(!l._zod.def.when(i))continue}else if(u)continue;const d=i.issues.length,f=l._zod.check(i);if(f instanceof Promise&&o?.async===!1)throw new Oa;if(c||f instanceof Promise)c=(c??Promise.resolve()).then(async()=>{await f,i.issues.length!==d&&(u||(u=Wu(i,d)))});else{if(i.issues.length===d)continue;u||(u=Wu(i,d))}}return c?c.then(()=>i):i};r._zod.run=(i,a)=>{const o=r._zod.parse(i,a);if(o instanceof Promise){if(a.async===!1)throw new Oa;return o.then(u=>s(u,n,a))}return s(o,n,a)}}r["~standard"]={validate:s=>{try{const i=Ox(r,s);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return Px(r,s).then(a=>a.success?{value:a.data}:{issues:a.error?.issues})}},vendor:"zod",version:1}}),Ix=po("$ZodNever",(r,e)=>{Tx.init(r,e),r._zod.parse=(t,n)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:r}),t)});class Ng{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){const n=t[0];if(this._map.set(e,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&typeof t=="object"&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const n={...this.get(t)??{}};return delete n.id,{...n,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function Rx(){return new Ng}const $n=Rx();function Cx(r,e){return new r({type:"never",..._x()})}class Vh{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??$n,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var n;const s=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},a=this.seen.get(e);if(a)return a.count++,t.schemaPath.includes(e)&&(a.cycle=t.path),a.schema;const o={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,o);const u=e._zod.toJSONSchema?.();if(u)o.schema=u;else{const d={...t,schemaPath:[...t.schemaPath,e],path:t.path},f=e._zod.parent;if(f)o.ref=f,this.process(f,d),this.seen.get(f).isParent=!0;else{const h=o.schema;switch(s.type){case"string":{const p=h;p.type="string";const{minimum:m,maximum:g,format:y,patterns:_,contentEncoding:b}=e._zod.bag;if(typeof m=="number"&&(p.minLength=m),typeof g=="number"&&(p.maxLength=g),y&&(p.format=i[y]??y,p.format===""&&delete p.format),b&&(p.contentEncoding=b),_&&_.size>0){const v=[..._];v.length===1?p.pattern=v[0].source:v.length>1&&(o.schema.allOf=[...v.map(w=>({...this.target==="draft-7"?{type:"string"}:{},pattern:w.source}))])}break}case"number":{const p=h,{minimum:m,maximum:g,format:y,multipleOf:_,exclusiveMaximum:b,exclusiveMinimum:v}=e._zod.bag;typeof y=="string"&&y.includes("int")?p.type="integer":p.type="number",typeof v=="number"&&(p.exclusiveMinimum=v),typeof m=="number"&&(p.minimum=m,typeof v=="number"&&(v>=m?delete p.minimum:delete p.exclusiveMinimum)),typeof b=="number"&&(p.exclusiveMaximum=b),typeof g=="number"&&(p.maximum=g,typeof b=="number"&&(b<=g?delete p.maximum:delete p.exclusiveMaximum)),typeof _=="number"&&(p.multipleOf=_);break}case"boolean":{const p=h;p.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{h.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{h.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const p=h,{minimum:m,maximum:g}=e._zod.bag;typeof m=="number"&&(p.minItems=m),typeof g=="number"&&(p.maxItems=g),p.type="array",p.items=this.process(s.element,{...d,path:[...d.path,"items"]});break}case"object":{const p=h;p.type="object",p.properties={};const m=s.shape;for(const _ in m)p.properties[_]=this.process(m[_],{...d,path:[...d.path,"properties",_]});const g=new Set(Object.keys(m)),y=new Set([...g].filter(_=>{const b=s.shape[_]._zod;return this.io==="input"?b.optin===void 0:b.optout===void 0}));y.size>0&&(p.required=Array.from(y)),s.catchall?._zod.def.type==="never"?p.additionalProperties=!1:s.catchall?s.catchall&&(p.additionalProperties=this.process(s.catchall,{...d,path:[...d.path,"additionalProperties"]})):this.io==="output"&&(p.additionalProperties=!1);break}case"union":{const p=h;p.anyOf=s.options.map((m,g)=>this.process(m,{...d,path:[...d.path,"anyOf",g]}));break}case"intersection":{const p=h,m=this.process(s.left,{...d,path:[...d.path,"allOf",0]}),g=this.process(s.right,{...d,path:[...d.path,"allOf",1]}),y=b=>"allOf"in b&&Object.keys(b).length===1,_=[...y(m)?m.allOf:[m],...y(g)?g.allOf:[g]];p.allOf=_;break}case"tuple":{const p=h;p.type="array";const m=s.items.map((_,b)=>this.process(_,{...d,path:[...d.path,"prefixItems",b]}));if(this.target==="draft-2020-12"?p.prefixItems=m:p.items=m,s.rest){const _=this.process(s.rest,{...d,path:[...d.path,"items"]});this.target==="draft-2020-12"?p.items=_:p.additionalItems=_}s.rest&&(p.items=this.process(s.rest,{...d,path:[...d.path,"items"]}));const{minimum:g,maximum:y}=e._zod.bag;typeof g=="number"&&(p.minItems=g),typeof y=="number"&&(p.maxItems=y);break}case"record":{const p=h;p.type="object",p.propertyNames=this.process(s.keyType,{...d,path:[...d.path,"propertyNames"]}),p.additionalProperties=this.process(s.valueType,{...d,path:[...d.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const p=h,m=gx(s.entries);m.every(g=>typeof g=="number")&&(p.type="number"),m.every(g=>typeof g=="string")&&(p.type="string"),p.enum=m;break}case"literal":{const p=h,m=[];for(const g of s.values)if(g===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof g=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");m.push(Number(g))}else m.push(g);if(m.length!==0)if(m.length===1){const g=m[0];p.type=g===null?"null":typeof g,p.const=g}else m.every(g=>typeof g=="number")&&(p.type="number"),m.every(g=>typeof g=="string")&&(p.type="string"),m.every(g=>typeof g=="boolean")&&(p.type="string"),m.every(g=>g===null)&&(p.type="null"),p.enum=m;break}case"file":{const p=h,m={type:"string",format:"binary",contentEncoding:"binary"},{minimum:g,maximum:y,mime:_}=e._zod.bag;g!==void 0&&(m.minLength=g),y!==void 0&&(m.maxLength=y),_?_.length===1?(m.contentMediaType=_[0],Object.assign(p,m)):p.anyOf=_.map(b=>({...m,contentMediaType:b})):Object.assign(p,m);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const p=this.process(s.innerType,d);h.anyOf=[p,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,d),o.ref=s.innerType;break}case"success":{const p=h;p.type="boolean";break}case"default":{this.process(s.innerType,d),o.ref=s.innerType,h.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,d),o.ref=s.innerType,this.io==="input"&&(h._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,d),o.ref=s.innerType;let p;try{p=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}h.default=p;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const p=h,m=e._zod.pattern;if(!m)throw new Error("Pattern not found in template literal");p.type="string",p.pattern=m.source;break}case"pipe":{const p=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(p,d),o.ref=p;break}case"readonly":{this.process(s.innerType,d),o.ref=s.innerType,h.readOnly=!0;break}case"promise":{this.process(s.innerType,d),o.ref=s.innerType;break}case"optional":{this.process(s.innerType,d),o.ref=s.innerType;break}case"lazy":{const p=e._zod.innerType;this.process(p,d),o.ref=p;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const c=this.metadataRegistry.get(e);return c&&Object.assign(o.schema,c),this.io==="input"&&$e(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((n=o.schema).default??(n.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,t){const n={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");const i=l=>{const d=this.target==="draft-2020-12"?"$defs":"definitions";if(n.external){const m=n.external.registry.get(l[0])?.id,g=n.external.uri??(_=>_);if(m)return{ref:g(m)};const y=l[1].defId??l[1].schema.id??`schema${this.counter++}`;return l[1].defId=y,{defId:y,ref:`${g("__shared")}#/${d}/${y}`}}if(l[1]===s)return{ref:"#"};const h=`#/${d}/`,p=l[1].schema.id??`__schema${this.counter++}`;return{defId:p,ref:h+p}},a=l=>{if(l[1].schema.$ref)return;const d=l[1],{ref:f,defId:h}=i(l);d.def={...d.schema},h&&(d.defId=h);const p=d.schema;for(const m in p)delete p[m];p.$ref=f};if(n.cycles==="throw")for(const l of this.seen.entries()){const d=l[1];if(d.cycle)throw new Error(`Cycle detected: #/${d.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const l of this.seen.entries()){const d=l[1];if(e===l[0]){a(l);continue}if(n.external){const h=n.external.registry.get(l[0])?.id;if(e!==l[0]&&h){a(l);continue}}if(this.metadataRegistry.get(l[0])?.id){a(l);continue}if(d.cycle){a(l);continue}if(d.count>1&&n.reused==="ref"){a(l);continue}}const o=(l,d)=>{const f=this.seen.get(l),h=f.def??f.schema,p={...h};if(f.ref===null)return;const m=f.ref;if(f.ref=null,m){o(m,d);const g=this.seen.get(m).schema;g.$ref&&d.target==="draft-7"?(h.allOf=h.allOf??[],h.allOf.push(g)):(Object.assign(h,g),Object.assign(h,p))}f.isParent||this.override({zodSchema:l,jsonSchema:h,path:f.path??[]})};for(const l of[...this.seen.entries()].reverse())o(l[0],{target:this.target});const u={};if(this.target==="draft-2020-12"?u.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?u.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),n.external?.uri){const l=n.external.registry.get(e)?.id;if(!l)throw new Error("Schema is missing an `id` property");u.$id=n.external.uri(l)}Object.assign(u,s.def);const c=n.external?.defs??{};for(const l of this.seen.entries()){const d=l[1];d.def&&d.defId&&(c[d.defId]=d.def)}n.external||Object.keys(c).length>0&&(this.target==="draft-2020-12"?u.$defs=c:u.definitions=c);try{return JSON.parse(JSON.stringify(u))}catch{throw new Error("Error converting schema to JSON.")}}}function Wh(r,e){if(r instanceof Ng){const n=new Vh(e),s={};for(const o of r._idmap.entries()){const[u,c]=o;n.process(c)}const i={},a={registry:r,uri:e?.uri,defs:s};for(const o of r._idmap.entries()){const[u,c]=o;i[u]=n.emit(c,{...e,external:a})}if(Object.keys(s).length>0){const o=n.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[o]:s}}return{schemas:i}}const t=new Vh(e);return t.process(r),t.emit(r,e)}function $e(r,e){const t=e??{seen:new Set};if(t.seen.has(r))return!1;t.seen.add(r);const s=r._zod.def;switch(s.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return $e(s.element,t);case"object":{for(const i in s.shape)if($e(s.shape[i],t))return!0;return!1}case"union":{for(const i of s.options)if($e(i,t))return!0;return!1}case"intersection":return $e(s.left,t)||$e(s.right,t);case"tuple":{for(const i of s.items)if($e(i,t))return!0;return!!(s.rest&&$e(s.rest,t))}case"record":return $e(s.keyType,t)||$e(s.valueType,t);case"map":return $e(s.keyType,t)||$e(s.valueType,t);case"set":return $e(s.valueType,t);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return $e(s.innerType,t);case"lazy":return $e(s.getter(),t);case"default":return $e(s.innerType,t);case"prefault":return $e(s.innerType,t);case"custom":return!1;case"transform":return!0;case"pipe":return $e(s.in,t)||$e(s.out,t);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${s.type}`)}const $x=Symbol("Let zodToJsonSchema decide on which parser to use"),Nx={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},jx=r=>({...Nx,...r}),Lx=r=>{const e=jx(r),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}};function jg(r,e,t,n){n?.errorMessages&&t&&(r.errorMessage={...r.errorMessage,[e]:t})}function me(r,e,t,n,s){r[e]=t,jg(r,e,n,s)}const Lg=(r,e)=>{let t=0;for(;t<r.length&&t<e.length&&r[t]===e[t];t++);return[(r.length-t).toString(),...e.slice(t)].join("/")};function xt(r){if(r.target!=="openAi")return{};const e=[...r.basePath,r.definitionPath,r.openAiAnyTypeName];return r.flags.hasReferencedOpenAiAnyType=!0,{$ref:r.$refStrategy==="relative"?Lg(e,r.currentPath):e.join("/")}}function Mx(r,e){const t={type:"array"};return r.type?._def&&r.type?._def?.typeName!==S.ZodAny&&(t.items=he(r.type._def,{...e,currentPath:[...e.currentPath,"items"]})),r.minLength&&me(t,"minItems",r.minLength.value,r.minLength.message,e),r.maxLength&&me(t,"maxItems",r.maxLength.value,r.maxLength.message,e),r.exactLength&&(me(t,"minItems",r.exactLength.value,r.exactLength.message,e),me(t,"maxItems",r.exactLength.value,r.exactLength.message,e)),t}function Dx(r,e){const t={type:"integer",format:"int64"};if(!r.checks)return t;for(const n of r.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?me(t,"minimum",n.value,n.message,e):me(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),me(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?me(t,"maximum",n.value,n.message,e):me(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),me(t,"maximum",n.value,n.message,e));break;case"multipleOf":me(t,"multipleOf",n.value,n.message,e);break}return t}function Ux(){return{type:"boolean"}}function Mg(r,e){return he(r.type._def,e)}const Fx=(r,e)=>he(r.innerType._def,e);function Dg(r,e,t){const n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((s,i)=>Dg(r,e,s))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Bx(r,e)}}const Bx=(r,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const n of r.checks)switch(n.kind){case"min":me(t,"minimum",n.value,n.message,e);break;case"max":me(t,"maximum",n.value,n.message,e);break}return t};function zx(r,e){return{...he(r.innerType._def,e),default:r.defaultValue()}}function Gx(r,e){return e.effectStrategy==="input"?he(r.schema._def,e):xt(e)}function qx(r){return{type:"string",enum:Array.from(r.values)}}const Hx=r=>"type"in r&&r.type==="string"?!1:"allOf"in r;function Vx(r,e){const t=[he(r.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),he(r.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return t.forEach(i=>{if(Hx(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(n=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...u}=i;a=u}else n=void 0;s.push(a)}}),s.length?{allOf:s,...n}:void 0}function Wx(r,e){const t=typeof r.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(r.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[r.value]}:{type:t==="bigint"?"integer":t,const:r.value}}let Zu;const Dt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Zu===void 0&&(Zu=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Zu),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function Ug(r,e){const t={type:"string"};if(r.checks)for(const n of r.checks)switch(n.kind){case"min":me(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,n.value):n.value,n.message,e);break;case"max":me(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,n.value):n.value,n.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Ut(t,"email",n.message,e);break;case"format:idn-email":Ut(t,"idn-email",n.message,e);break;case"pattern:zod":Qe(t,Dt.email,n.message,e);break}break;case"url":Ut(t,"uri",n.message,e);break;case"uuid":Ut(t,"uuid",n.message,e);break;case"regex":Qe(t,n.regex,n.message,e);break;case"cuid":Qe(t,Dt.cuid,n.message,e);break;case"cuid2":Qe(t,Dt.cuid2,n.message,e);break;case"startsWith":Qe(t,RegExp(`^${Ju(n.value,e)}`),n.message,e);break;case"endsWith":Qe(t,RegExp(`${Ju(n.value,e)}$`),n.message,e);break;case"datetime":Ut(t,"date-time",n.message,e);break;case"date":Ut(t,"date",n.message,e);break;case"time":Ut(t,"time",n.message,e);break;case"duration":Ut(t,"duration",n.message,e);break;case"length":me(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,n.value):n.value,n.message,e),me(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,n.value):n.value,n.message,e);break;case"includes":{Qe(t,RegExp(Ju(n.value,e)),n.message,e);break}case"ip":{n.version!=="v6"&&Ut(t,"ipv4",n.message,e),n.version!=="v4"&&Ut(t,"ipv6",n.message,e);break}case"base64url":Qe(t,Dt.base64url,n.message,e);break;case"jwt":Qe(t,Dt.jwt,n.message,e);break;case"cidr":{n.version!=="v6"&&Qe(t,Dt.ipv4Cidr,n.message,e),n.version!=="v4"&&Qe(t,Dt.ipv6Cidr,n.message,e);break}case"emoji":Qe(t,Dt.emoji(),n.message,e);break;case"ulid":{Qe(t,Dt.ulid,n.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Ut(t,"binary",n.message,e);break}case"contentEncoding:base64":{me(t,"contentEncoding","base64",n.message,e);break}case"pattern:zod":{Qe(t,Dt.base64,n.message,e);break}}break}case"nanoid":Qe(t,Dt.nanoid,n.message,e)}return t}function Ju(r,e){return e.patternStrategy==="escape"?Jx(r):r}const Zx=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function Jx(r){let e="";for(let t=0;t<r.length;t++)Zx.has(r[t])||(e+="\\"),e+=r[t];return e}function Ut(r,e,t,n){r.format||r.anyOf?.some(s=>s.format)?(r.anyOf||(r.anyOf=[]),r.format&&(r.anyOf.push({format:r.format,...r.errorMessage&&n.errorMessages&&{errorMessage:{format:r.errorMessage.format}}}),delete r.format,r.errorMessage&&(delete r.errorMessage.format,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):me(r,"format",e,t,n)}function Qe(r,e,t,n){r.pattern||r.allOf?.some(s=>s.pattern)?(r.allOf||(r.allOf=[]),r.pattern&&(r.allOf.push({pattern:r.pattern,...r.errorMessage&&n.errorMessages&&{errorMessage:{pattern:r.errorMessage.pattern}}}),delete r.pattern,r.errorMessage&&(delete r.errorMessage.pattern,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.allOf.push({pattern:Zh(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):me(r,"pattern",Zh(e,n),t,n)}function Zh(r,e){if(!e.applyRegexFlags||!r.flags)return r.source;const t={i:r.flags.includes("i"),m:r.flags.includes("m"),s:r.flags.includes("s")},n=t.i?r.source.toLowerCase():r.source;let s="",i=!1,a=!1,o=!1;for(let u=0;u<n.length;u++){if(i){s+=n[u],i=!1;continue}if(t.i){if(a){if(n[u].match(/[a-z]/)){o?(s+=n[u],s+=`${n[u-2]}-${n[u]}`.toUpperCase(),o=!1):n[u+1]==="-"&&n[u+2]?.match(/[a-z]/)?(s+=n[u],o=!0):s+=`${n[u]}${n[u].toUpperCase()}`;continue}}else if(n[u].match(/[a-z]/)){s+=`[${n[u]}${n[u].toUpperCase()}]`;continue}}if(t.m){if(n[u]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(n[u]==="$"){s+=`($|(?=[\r
]))`;continue}}if(t.s&&n[u]==="."){s+=a?`${n[u]}\r
`:`[${n[u]}\r
]`;continue}s+=n[u],n[u]==="\\"?i=!0:a&&n[u]==="]"?a=!1:!a&&n[u]==="["&&(a=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return s}function Fg(r,e){if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&r.keyType?._def.typeName===S.ZodEnum)return{type:"object",required:r.keyType._def.values,properties:r.keyType._def.values.reduce((n,s)=>({...n,[s]:he(r.valueType._def,{...e,currentPath:[...e.currentPath,"properties",s]})??xt(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};const t={type:"object",additionalProperties:he(r.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return t;if(r.keyType?._def.typeName===S.ZodString&&r.keyType._def.checks?.length){const{type:n,...s}=Ug(r.keyType._def,e);return{...t,propertyNames:s}}else{if(r.keyType?._def.typeName===S.ZodEnum)return{...t,propertyNames:{enum:r.keyType._def.values}};if(r.keyType?._def.typeName===S.ZodBranded&&r.keyType._def.type._def.typeName===S.ZodString&&r.keyType._def.type._def.checks?.length){const{type:n,...s}=Mg(r.keyType._def,e);return{...t,propertyNames:s}}}return t}function Kx(r,e){if(e.mapStrategy==="record")return Fg(r,e);const t=he(r.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||xt(e),n=he(r.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||xt(e);return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}function Xx(r){const e=r.values,n=Object.keys(r.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(n.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:n}}function Yx(r){return r.target==="openAi"?void 0:{not:xt({...r,currentPath:[...r.currentPath,"not"]})}}function Qx(r){return r.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Pa={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function eO(r,e){if(e.target==="openApi3")return Jh(r,e);const t=r.options instanceof Map?Array.from(r.options.values()):r.options;if(t.every(n=>n._def.typeName in Pa&&(!n._def.checks||!n._def.checks.length))){const n=t.reduce((s,i)=>{const a=Pa[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=t.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":if(i._def.value===null)return[...s,"null"];default:return s}},[]);if(n.length===t.length){const s=n.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:t.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,s)=>[...n,...s._def.values.filter(i=>!n.includes(i))],[])};return Jh(r,e)}const Jh=(r,e)=>{const t=(r.options instanceof Map?Array.from(r.options.values()):r.options).map((n,s)=>he(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0};function tO(r,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return e.target==="openApi3"?{type:Pa[r.innerType._def.typeName],nullable:!0}:{type:[Pa[r.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=he(r.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const t=he(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function nO(r,e){const t={type:"number"};if(!r.checks)return t;for(const n of r.checks)switch(n.kind){case"int":t.type="integer",jg(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?me(t,"minimum",n.value,n.message,e):me(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),me(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?me(t,"maximum",n.value,n.message,e):me(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),me(t,"maximum",n.value,n.message,e));break;case"multipleOf":me(t,"multipleOf",n.value,n.message,e);break}return t}function rO(r,e){const t=e.target==="openAi",n={type:"object",properties:{}},s=[],i=r.shape();for(const o in i){let u=i[o];if(u===void 0||u._def===void 0)continue;let c=iO(u);c&&t&&(u._def.typeName==="ZodOptional"&&(u=u._def.innerType),u.isNullable()||(u=u.nullable()),c=!1);const l=he(u._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});l!==void 0&&(n.properties[o]=l,c||s.push(o))}s.length&&(n.required=s);const a=sO(r,e);return a!==void 0&&(n.additionalProperties=a),n}function sO(r,e){if(r.catchall._def.typeName!=="ZodNever")return he(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(r.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function iO(r){try{return r.isOptional()}catch{return!0}}const aO=(r,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return he(r.innerType._def,e);const t=he(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:xt(e)},t]}:xt(e)},oO=(r,e)=>{if(e.pipeStrategy==="input")return he(r.in._def,e);if(e.pipeStrategy==="output")return he(r.out._def,e);const t=he(r.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=he(r.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(s=>s!==void 0)}};function uO(r,e){return he(r.type._def,e)}function cO(r,e){const n={type:"array",uniqueItems:!0,items:he(r.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return r.minSize&&me(n,"minItems",r.minSize.value,r.minSize.message,e),r.maxSize&&me(n,"maxItems",r.maxSize.value,r.maxSize.message,e),n}function lO(r,e){return r.rest?{type:"array",minItems:r.items.length,items:r.items.map((t,n)=>he(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:he(r.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:r.items.length,maxItems:r.items.length,items:r.items.map((t,n)=>he(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}function dO(r){return{not:xt(r)}}function fO(r){return xt(r)}const hO=(r,e)=>he(r.innerType._def,e),pO=(r,e,t)=>{switch(e){case S.ZodString:return Ug(r,t);case S.ZodNumber:return nO(r,t);case S.ZodObject:return rO(r,t);case S.ZodBigInt:return Dx(r,t);case S.ZodBoolean:return Ux();case S.ZodDate:return Dg(r,t);case S.ZodUndefined:return dO(t);case S.ZodNull:return Qx(t);case S.ZodArray:return Mx(r,t);case S.ZodUnion:case S.ZodDiscriminatedUnion:return eO(r,t);case S.ZodIntersection:return Vx(r,t);case S.ZodTuple:return lO(r,t);case S.ZodRecord:return Fg(r,t);case S.ZodLiteral:return Wx(r,t);case S.ZodEnum:return qx(r);case S.ZodNativeEnum:return Xx(r);case S.ZodNullable:return tO(r,t);case S.ZodOptional:return aO(r,t);case S.ZodMap:return Kx(r,t);case S.ZodSet:return cO(r,t);case S.ZodLazy:return()=>r.getter()._def;case S.ZodPromise:return uO(r,t);case S.ZodNaN:case S.ZodNever:return Yx(t);case S.ZodEffects:return Gx(r,t);case S.ZodAny:return xt(t);case S.ZodUnknown:return fO(t);case S.ZodDefault:return zx(r,t);case S.ZodBranded:return Mg(r,t);case S.ZodReadonly:return hO(r,t);case S.ZodCatch:return Fx(r,t);case S.ZodPipeline:return oO(r,t);case S.ZodFunction:case S.ZodVoid:case S.ZodSymbol:return;default:return(n=>{})()}};function he(r,e,t=!1){const n=e.seen.get(r);if(e.override){const o=e.override?.(r,e,n,t);if(o!==$x)return o}if(n&&!t){const o=mO(n,e);if(o!==void 0)return o}const s={def:r,path:e.currentPath,jsonSchema:void 0};e.seen.set(r,s);const i=pO(r,r.typeName,e),a=typeof i=="function"?he(i(),e):i;if(a&&gO(r,e,a),e.postProcess){const o=e.postProcess(a,r,e);return s.jsonSchema=a,o}return s.jsonSchema=a,a}const mO=(r,e)=>{switch(e.$refStrategy){case"root":return{$ref:r.path.join("/")};case"relative":return{$ref:Lg(e.currentPath,r.path)};case"none":case"seen":return r.path.length<e.currentPath.length&&r.path.every((t,n)=>e.currentPath[n]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),xt(e)):e.$refStrategy==="seen"?xt(e):void 0}},gO=(r,e,t)=>(r.description&&(t.description=r.description,e.markdownDescription&&(t.markdownDescription=r.description)),t),Bg=(r,e)=>{const t=Lx(e);let n;const s=he(r._def,t,!1)??xt(t);t.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[t.openAiAnyTypeName]||(n[t.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:t.$refStrategy==="relative"?"1":[...t.basePath,t.definitionPath,t.openAiAnyTypeName].join("/")}}));const i=n?{...s,[t.definitionPath]:n}:s;return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function Bc(r,e){const t=typeof r;if(t!==typeof e)return!1;if(Array.isArray(r)){if(!Array.isArray(e))return!1;const n=r.length;if(n!==e.length)return!1;for(let s=0;s<n;s++)if(!Bc(r[s],e[s]))return!1;return!0}if(t==="object"){if(!r||!e)return r===e;const n=Object.keys(r),s=Object.keys(e);if(n.length!==s.length)return!1;for(const a of n)if(!Bc(r[a],e[a]))return!1;return!0}return r===e}function ln(r){if(typeof r!="object"||r===null)return!1;const e=r;if(!("_zod"in e))return!1;const t=e._zod;return typeof t=="object"&&t!==null&&"def"in t}function wn(r){if(typeof r!="object"||r===null)return!1;const e=r;if(!("_def"in e)||"_zod"in e)return!1;const t=e._def;return typeof t=="object"&&t!=null&&"typeName"in t}function Yl(r){return!r||typeof r!="object"||Array.isArray(r)?!1:!!(ln(r)||wn(r))}async function yO(r,e){if(ln(r))try{return{success:!0,data:await Ex(r,e)}}catch(t){return{success:!1,error:t}}if(wn(r))return r.safeParse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function zg(r,e){if(ln(r))return vx(r,e);if(wn(r))return r.parse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Gg(r){if(ln(r))return $n.get(r)?.description;if(wn(r)||"description"in r&&typeof r.description=="string")return r.description}function _O(r){return Yl(r)?wn(r)?r._def.typeName==="ZodString":ln(r)?r._zod.def.type==="string":!1:!1}function Ns(r){return ln(r)?typeof r=="object"&&r!==null&&"_zod"in r&&typeof r._zod=="object"&&r._zod!==null&&"def"in r._zod&&typeof r._zod.def=="object"&&r._zod.def!==null&&"type"in r._zod.def&&r._zod.def.type==="object":!1}function qg(r){return ln(r)?typeof r=="object"&&r!==null&&"_zod"in r&&typeof r._zod=="object"&&r._zod!==null&&"def"in r._zod&&typeof r._zod.def=="object"&&r._zod.def!==null&&"type"in r._zod.def&&r._zod.def.type==="array":!1}function zc(r,e=!1){if(wn(r))return r.strict();if(Ns(r)){const t=r._zod.def.shape;if(e)for(const[i,a]of Object.entries(r._zod.def.shape)){if(Ns(a)){const u=zc(a,e);t[i]=u}else if(qg(a)){let u=a._zod.def.element;Ns(u)&&(u=zc(u,e)),t[i]=ka(a,{...a._zod.def,element:u})}else t[i]=a;const o=$n.get(a);o&&$n.add(t[i],o)}const n=ka(r,{...r._zod.def,shape:t,catchall:Cx(Ix)}),s=$n.get(r);return s&&$n.add(n,s),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function bO(r){return wn(r)&&"typeName"in r._def&&r._def.typeName==="ZodEffects"}function wO(r){return ln(r)&&r._zod.def.type==="pipe"}function ks(r,e=!1){if(wn(r))return bO(r)?ks(r._def.schema,e):r;if(ln(r)){let t=r;if(wO(r)&&(t=ks(r._zod.def.in,e)),e){if(Ns(t)){const s=t._zod.def.shape;for(const[i,a]of Object.entries(t._zod.def.shape))s[i]=ks(a,e);t=ka(t,{...t._zod.def,shape:s})}else if(qg(t)){const s=ks(t._zod.def.element,e);t=ka(t,{...t._zod.def,element:s})}}const n=$n.get(r);return n&&$n.add(t,n),t}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function _o(r){if(ln(r)){const e=ks(r,!0);if(Ns(e)){const t=zc(e,!0);return Wh(t)}else return Wh(r)}return wn(r)?Bg(r):r}function vO(r,e){if(r!==void 0&&!Mn(r))return r;if(Xl(e))try{let t=e.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t}catch{return e.getName()}else return e.name??"UnknownSchema"}function SO(r){return Xl(r.data)?{type:"runnable",data:{id:r.data.lc_id,name:r.data.getName()}}:{type:"schema",data:{..._o(r.data.schema),title:r.data.name}}}let Aa=class Hg{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,n)=>{e[t.id]=Mn(t.id)?n:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...SO(t)})),edges:this.edges.map(t=>{const n={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(n.data=t.data),typeof t.conditional<"u"&&(n.conditional=t.conditional),n})}}addNode(e,t,n){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);const s=t??Ke(),i={id:s,data:e,name:vO(t,e),metadata:n};return this.nodes[s]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,n,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);const i={source:e.id,target:t.id,data:n,conditional:s};return this.edges.push(i),i}firstNode(){return Kh(this)}lastNode(){return Xh(this)}extend(e,t=""){let n=t;Object.values(e.nodes).map(c=>c.id).every(Mn)&&(n="");const i=c=>n?`${n}:${c}`:c;Object.entries(e.nodes).forEach(([c,l])=>{this.nodes[i(c)]={...l,id:i(c)}});const a=e.edges.map(c=>({...c,source:i(c.source),target:i(c.target)}));this.edges=[...this.edges,...a];const o=e.firstNode(),u=e.lastNode();return[o?{id:i(o.id),data:o.data}:void 0,u?{id:i(u.id),data:u.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&Kh(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&Xh(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),t=new Map;Object.values(e).forEach(s=>{t.set(s,(t.get(s)||0)+1)});const n=s=>{const i=e[s];return Mn(s)&&t.get(i)===1?i:s};return new Hg({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,i])=>[n(s),{...i,id:n(s)}])),edges:this.edges.map(s=>({...s,source:n(s.source),target:n(s.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:n,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},a=this.reid(),o=a.firstNode(),u=a.lastNode();return fx(a.nodes,a.edges,{firstNode:o?.id,lastNode:u?.id,withStyles:t,curveStyle:n,nodeColors:s,wrapLabelNWords:i})}async drawMermaidPng(e){const t=this.drawMermaid(e);return hx(t,{backgroundColor:e?.backgroundColor})}};function Kh(r,e=[]){const t=new Set(r.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),n=[];for(const s of Object.values(r.nodes))!e.includes(s.id)&&!t.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}function Xh(r,e=[]){const t=new Set(r.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),n=[];for(const s of Object.values(r.nodes))!e.includes(s.id)&&!t.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}function EO(r){const e=new TextEncoder,t=new ReadableStream({async start(n){for await(const s of r)n.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));n.enqueue(e.encode(`event: end

`)),n.close()}});return tt.fromReadableStream(t)}function Yh(r){return typeof r=="object"&&r!==null&&typeof r[Symbol.iterator]=="function"&&typeof r.next=="function"}const xO=r=>r!=null&&typeof r=="object"&&"next"in r&&typeof r.next=="function";function Gc(r){return typeof r=="object"&&r!==null&&typeof r[Symbol.asyncIterator]=="function"}function*Qh(r,e){for(;;){const{value:t,done:n}=Ct.runWithConfig(Br(r),e.next.bind(e),!0);if(n)break;yield t}}async function*qc(r,e){const t=e[Symbol.asyncIterator]();for(;;){const{value:n,done:s}=await Ct.runWithConfig(Br(r),t.next.bind(e),!0);if(s)break;yield n}}function ze(r,e){return r&&!Array.isArray(r)&&!(r instanceof Date)&&typeof r=="object"?r:{[e]:r}}class be extends or{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Fn({bound:this,kwargs:e,config:{}})}map(){return new Ta({bound:this})}withRetry(e){return new Vg({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Fn({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new kO({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(fe);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:t},(s,i)=>fe(i===0?e:n))}return Array.from({length:t},()=>fe(e))}async batch(e,t,n){const s=this._getOptionsList(t??{},e.length),i=s[0]?.maxConcurrency??n?.maxConcurrency,a=new Kl({maxConcurrency:i,onFailedAttempt:u=>{throw u}}),o=e.map((u,c)=>a.call(async()=>{try{return await this.invoke(u,s[c])}catch(l){if(n?.returnExceptions)return l;throw l}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=fe(t),s=new ss({generator:this._streamIterator(e,n),config:n});return await s.setup,tt.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=fe(e):t=fe({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[t,n]}async _callWithConfig(e,t,n){const s=fe(n),a=await(await $t(s))?.handleChainStart(this.toJSON(),ze(t,"input"),s.runId,s?.runType,void 0,void 0,s?.runName??this.getName());delete s.runId;let o;try{const u=e.call(this,t,s,a);o=await Gn(u,n?.signal)}catch(u){throw await a?.handleChainError(u),u}return await a?.handleChainEnd(ze(o,"output")),o}async _batchWithConfig(e,t,n,s){const i=this._getOptionsList(n??{},t.length),a=await Promise.all(i.map($t)),o=await Promise.all(a.map(async(c,l)=>{const d=await c?.handleChainStart(this.toJSON(),ze(t[l],"input"),i[l].runId,i[l].runType,void 0,void 0,i[l].runName??this.getName());return delete i[l].runId,d}));let u;try{const c=e.call(this,t,i,o,s);u=await Gn(c,i?.[0]?.signal)}catch(c){throw await Promise.all(o.map(l=>l?.handleChainError(c))),c}return await Promise.all(o.map(c=>c?.handleChainEnd(ze(u,"output")))),u}_concatOutputChunks(e,t){return ho(e,t)}async*_transformStreamWithConfig(e,t,n){let s,i=!0,a,o=!0;const u=fe(n),c=await $t(u),l=this;async function*d(){for await(const h of e){if(i)if(s===void 0)s=h;else try{s=l._concatOutputChunks(s,h)}catch{s=void 0,i=!1}yield h}}let f;try{const h=await nx(t.bind(this),d(),async()=>c?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),n?.signal,u);delete u.runId,f=h.setup;const p=f?.handlers.find(ix);let m=h.output;p!==void 0&&f!==void 0&&(m=p.tapOutputIterable(f.runId,m));const g=f?.handlers.find(rx);g!==void 0&&f!==void 0&&(m=g.tapOutputIterable(f.runId,m));for await(const y of m)if(yield y,o)if(a===void 0)a=y;else try{a=this._concatOutputChunks(a,y)}catch{a=void 0,o=!1}}catch(h){throw await f?.handleChainError(h,void 0,void 0,void 0,{inputs:ze(s,"input")}),h}await f?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:ze(s,"input")})}getGraph(e){const t=new Aa,n=t.addNode({name:`${this.getName()}Input`,schema:Pr()}),s=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:Pr()});return t.addEdge(n,s),t.addEdge(s,i),t}pipe(e){return new wt({first:this,last:vt(e)})}pick(e){return this.pipe(new PO(e))}assign(e){return this.pipe(new Wg(new is({steps:e})))}async*transform(e,t){let n;for await(const s of e)n===void 0?n=s:n=this._concatOutputChunks(n,s);yield*this._streamIterator(n,fe(t))}async*streamLog(e,t,n){const s=new qh({...n,autoClose:!1,_schemaFormat:"original"}),i=fe(t);yield*this._streamLog(e,s,i)}async*_streamLog(e,t,n){const{callbacks:s}=n;if(s===void 0)n.callbacks=[t];else if(Array.isArray(s))n.callbacks=s.concat([t]);else{const u=s.copy();u.addHandler(t,!0),n.callbacks=u}const i=this.stream(e,n);async function a(){try{const u=await i;for await(const c of u){const l=new An({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}const o=a();try{for await(const u of t)yield u}finally{await o}}streamEvents(e,t,n){let s;if(t.version==="v1")s=this._streamEventsV1(e,t,n);else if(t.version==="v2")s=this._streamEventsV2(e,t,n);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?EO(s):tt.fromAsyncGenerator(s)}async*_streamEventsV2(e,t,n){const s=new ax({...n,autoClose:!1}),i=fe(t),a=i.runId??Ke();i.runId=a;const o=i.callbacks;if(o===void 0)i.callbacks=[s];else if(Array.isArray(o))i.callbacks=o.concat(s);else{const p=o.copy();p.addHandler(s,!0),i.callbacks=p}const u=new AbortController,c=this;async function l(){let p,m=null;try{t?.signal?"any"in AbortSignal?p=AbortSignal.any([u.signal,t.signal]):(p=t.signal,m=()=>{u.abort()},t.signal.addEventListener("abort",m,{once:!0})):p=u.signal;const g=await c.stream(e,{...i,signal:p}),y=s.tapOutputIterable(a,g);for await(const _ of y)if(u.signal.aborted)break}finally{await s.finish(),p&&m&&p.removeEventListener("abort",m)}}const d=l();let f=!1,h;try{for await(const p of s){if(!f){p.data.input=e,f=!0,h=p.run_id,yield p;continue}p.run_id===h&&p.event.endsWith("_end")&&p.data?.input&&delete p.data.input,yield p}}finally{u.abort(),await d}}async*_streamEventsV1(e,t,n){let s,i=!1;const a=fe(t),o=a.tags??[],u=a.metadata??{},c=a.runName??this.getName(),l=new qh({...n,autoClose:!1,_schemaFormat:"streaming_events"}),d=new cx({...n}),f=this._streamLog(e,l,a);for await(const p of f){if(s?s=s.concat(p):s=Zs.fromRunLogPatch(p),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const _={...s.state},b={run_id:_.id,event:`on_${_.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(b,_.type)&&(yield b)}const m=p.ops.filter(_=>_.path.startsWith("/logs/")).map(_=>_.path.split("/")[2]),g=[...new Set(m)];for(const _ of g){let b,v={};const w=s.state.logs[_];if(w.end_time===void 0?w.streamed_output.length>0?b="stream":b="start":b="end",b==="start")w.inputs!==void 0&&(v.input=w.inputs);else if(b==="end")w.inputs!==void 0&&(v.input=w.inputs),v.output=w.final_output;else if(b==="stream"){const E=w.streamed_output.length;if(E!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${E} instead. Encountered in: "${w.name}"`);v={chunk:w.streamed_output[0]},w.streamed_output=[]}yield{event:`on_${w.type}_${b}`,name:w.name,run_id:w.id,tags:w.tags,metadata:w.metadata,data:v}}const{state:y}=s;if(y.streamed_output.length>0){const _=y.streamed_output.length;if(_!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${_} instead. Encountered in: "${y.name}"`);const b={chunk:y.streamed_output[0]};y.streamed_output=[];const v={event:`on_${y.type}_stream`,run_id:y.id,tags:o,metadata:u,name:c,data:b};d.includeEvent(v,y.type)&&(yield v)}}const h=s?.state;if(h!==void 0){const p={event:`on_${h.type}_end`,name:c,run_id:h.id,tags:o,metadata:u,data:{output:h.final_output}};d.includeEvent(p,h.type)&&(yield p)}}static isRunnable(e){return Xl(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new Fn({bound:this,config:{},configFactories:[s=>({callbacks:[new Rg({config:s,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return AO(this,e)}}class Fn extends be{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=sn(this.config,...e);return sn(t,...this.configFactories?await Promise.all(this.configFactories.map(async n=>await n(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new Vg({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(fe(t),this.kwargs))}async batch(e,t,n){const s=Array.isArray(t)?await Promise.all(t.map(async i=>this._mergeConfig(fe(i),this.kwargs))):await this._mergeConfig(fe(t),this.kwargs);return this.bound.batch(e,s,n)}_concatOutputChunks(e,t){return this.bound._concatOutputChunks(e,t)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(fe(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(fe(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(fe(t),this.kwargs))}streamEvents(e,t,n){const s=this,i=async function*(){yield*s.bound.streamEvents(e,{...await s._mergeConfig(fe(t),s.kwargs),version:t.version},n)};return tt.fromAsyncGenerator(i())}static isRunnableBinding(e){return e.bound&&be.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new Fn({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[s=>({callbacks:[new Rg({config:s,onStart:e,onEnd:t,onError:n})]})]})}}class Ta extends be{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Ta({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,n){return this.bound.batch(e,ke(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new Ta({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class Vg extends Fn{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const s=e>1?`retry:attempt:${e}`:void 0;return ke(t,{callbacks:n?.getChild(s)})}async _invoke(e,t,n){return Ic(s=>super.invoke(e,this._patchConfigForRetry(s,t,n)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,n,s){const i={};try{await Ic(async a=>{const o=e.map((f,h)=>h).filter(f=>i[f.toString()]===void 0||i[f.toString()]instanceof Error),u=o.map(f=>e[f]),c=o.map(f=>this._patchConfigForRetry(a,t?.[f],n?.[f])),l=await super.batch(u,c,{...s,returnExceptions:!0});let d;for(let f=0;f<l.length;f+=1){const h=l[f],p=o[f];h instanceof Error&&d===void 0&&(d=h,d.input=u[f]),i[p.toString()]=h}if(d)throw d;return l},{onFailedAttempt:a=>this.onFailedAttempt(a,a.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if(s?.returnExceptions!==!0)throw a}return Object.keys(i).sort((a,o)=>parseInt(a,10)-parseInt(o,10)).map(a=>i[parseInt(a,10)])}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class wt extends be{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=fe(t),i=await(await $t(n))?.handleChainStart(this.toJSON(),ze(e,"input"),n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;let a=e,o;try{const u=[this.first,...this.middle];for(let c=0;c<u.length;c+=1){const d=u[c].invoke(a,ke(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`)}));a=await Gn(d,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");o=await this.last.invoke(a,ke(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd(ze(o,"output")),o}async batch(e,t,n){const s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map($t)),a=await Promise.all(i.map(async(u,c)=>{const l=await u?.handleChainStart(this.toJSON(),ze(e[c],"input"),s[c].runId,void 0,void 0,void 0,s[c].runName);return delete s[c].runId,l}));let o=e;try{for(let u=0;u<this.steps.length;u+=1){const l=this.steps[u].batch(o,a.map((d,f)=>{const h=d?.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`);return ke(s[f],{callbacks:h})}),n);o=await Gn(l,s[0]?.signal)}}catch(u){throw await Promise.all(a.map(c=>c?.handleChainError(u))),u}return await Promise.all(a.map(u=>u?.handleChainEnd(ze(o,"output")))),o}_concatOutputChunks(e,t){return this.last._concatOutputChunks(e,t)}async*_streamIterator(e,t){const n=await $t(t),{runId:s,...i}=t??{},a=await n?.handleChainStart(this.toJSON(),ze(e,"input"),s,void 0,void 0,void 0,i?.runName),o=[this.first,...this.middle,this.last];let u=!0,c;async function*l(){yield e}try{let d=o[0].transform(l(),ke(i,{callbacks:a?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let f=1;f<o.length;f+=1)d=await o[f].transform(d,ke(i,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${f+1}`)}));for await(const f of d)if(t?.signal?.throwIfAborted(),yield f,u)if(c===void 0)c=f;else try{c=this._concatOutputChunks(c,f)}catch{c=void 0,u=!1}}catch(d){throw await a?.handleChainError(d),d}await a?.handleChainEnd(ze(c,"output"))}getGraph(e){const t=new Aa;let n=null;return this.steps.forEach((s,i)=>{const a=s.getGraph(e);i!==0&&a.trimFirstNode(),i!==this.steps.length-1&&a.trimLastNode(),t.extend(a);const o=a.firstNode();if(!o)throw new Error(`Runnable ${s} has no first node`);n&&t.addEdge(n,o),n=a.lastNode()}),t}pipe(e){return wt.isRunnableSequence(e)?new wt({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new wt({first:this.first,middle:[...this.middle,this.last],last:vt(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&be.isRunnable(e)}static from([e,...t],n){let s={};return typeof n=="string"?s.name=n:n!==void 0&&(s=n),new wt({...s,first:vt(e),middle:t.slice(0,-1).map(vt),last:vt(t[t.length-1])})}}class is extends be{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=vt(n)}static from(e){return new is({steps:e})}async invoke(e,t){const n=fe(t),i=await(await $t(n))?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;const a={};try{const o=Object.entries(this.steps).map(async([u,c])=>{a[u]=await c.invoke(e,ke(n,{callbacks:i?.getChild(`map:key:${u}`)}))});await Gn(Promise.all(o),t?.signal)}catch(o){throw await i?.handleChainError(o),o}return await i?.handleChainEnd(a),a}async*_transform(e,t,n){const s={...this.steps},i=Ig(e,Object.keys(s).length),a=new Map(Object.entries(s).map(([o,u],c)=>{const l=u.transform(i[c],ke(n,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;a.size;){const o=Promise.race(a.values()),{key:u,result:c,gen:l}=await Gn(o,n?.signal);a.delete(u),c.done||(yield{[u]:c.value},a.set(u,l.next().then(d=>({key:u,gen:l,result:d}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const s=fe(t),i=new ss({generator:this.transform(n(),s),config:s});return await i.setup,tt.fromAsyncGenerator(i)}}class Ql extends be{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Bl(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[n]=this._getOptionsList(t??{},1),s=await $t(n),i=this.func(ke(n,{callbacks:s}),e);return Gn(i,n?.signal)}async*_streamIterator(e,t){const[n]=this._getOptionsList(t??{},1),s=await this.invoke(e,t);if(Gc(s)){for await(const i of s)n?.signal?.throwIfAborted(),yield i;return}if(xO(s)){for(;;){n?.signal?.throwIfAborted();const i=s.next();if(i.done)break;yield i.value}return}yield s}static from(e){return new Ql({func:e})}}function OO(r){if(Bl(r))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}class as extends be{static lc_name(){return"RunnableLambda"}constructor(e){if(Bl(e.func))return Ql.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),OO(e.func),this.func=e.func}static from(e){return new as({func:e})}async _invoke(e,t,n){return new Promise((s,i)=>{const a=ke(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??Hu)-1});Ct.runWithConfig(Br(a),async()=>{try{let o=await this.func(e,{...a});if(o&&be.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...a,recursionLimit:(a.recursionLimit??Hu)-1})}else if(Gc(o)){let u;for await(const c of qc(a,o))if(t?.signal?.throwIfAborted(),u===void 0)u=c;else try{u=this._concatOutputChunks(u,c)}catch{u=c}o=u}else if(Yh(o)){let u;for(const c of Qh(a,o))if(t?.signal?.throwIfAborted(),u===void 0)u=c;else try{u=this._concatOutputChunks(u,c)}catch{u=c}o=u}s(o)}catch(o){i(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,n){let s;for await(const o of e)if(s===void 0)s=o;else try{s=this._concatOutputChunks(s,o)}catch{s=o}const i=ke(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??Hu)-1}),a=await new Promise((o,u)=>{Ct.runWithConfig(Br(i),async()=>{try{const c=await this.func(s,{...i,config:i});o(c)}catch(c){u(c)}})});if(a&&be.isRunnable(a)){if(n?.recursionLimit===0)throw new Error("Recursion limit reached.");const o=await a.stream(s,i);for await(const u of o)yield u}else if(Gc(a))for await(const o of qc(i,a))n?.signal?.throwIfAborted(),yield o;else if(Yh(a))for(const o of Qh(i,a))n?.signal?.throwIfAborted(),yield o;else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const s=fe(t),i=new ss({generator:this.transform(n(),s),config:s});return await i.setup,tt.fromAsyncGenerator(i)}}class kO extends be{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=fe(t),s=await $t(n),{runId:i,...a}=n,o=await s?.handleChainStart(this.toJSON(),ze(e,"input"),i,void 0,void 0,void 0,a?.runName),u=ke(a,{callbacks:o?.getChild()});return await Ct.runWithConfig(u,async()=>{let l;for(const d of this.runnables()){n?.signal?.throwIfAborted();try{const f=await d.invoke(e,u);return await o?.handleChainEnd(ze(f,"output")),f}catch(f){l===void 0&&(l=f)}}throw l===void 0?new Error("No error stored at end of fallback."):(await o?.handleChainError(l),l)})}async*_streamIterator(e,t){const n=fe(t),s=await $t(n),{runId:i,...a}=n,o=await s?.handleChainStart(this.toJSON(),ze(e,"input"),i,void 0,void 0,void 0,a?.runName);let u,c;for(const d of this.runnables()){n?.signal?.throwIfAborted();const f=ke(a,{callbacks:o?.getChild()});try{const h=await d.stream(e,f);c=qc(f,h);break}catch(h){u===void 0&&(u=h)}}if(c===void 0){const d=u??new Error("No error stored at end of fallback.");throw await o?.handleChainError(d),d}let l;try{for await(const d of c){yield d;try{l=l===void 0?l:this._concatOutputChunks(l,d)}catch{l=void 0}}}catch(d){throw await o?.handleChainError(d),d}await o?.handleChainEnd(ze(l,"output"))}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map(u=>$t(u))),a=await Promise.all(i.map(async(u,c)=>{const l=await u?.handleChainStart(this.toJSON(),ze(e[c],"input"),s[c].runId,void 0,void 0,void 0,s[c].runName);return delete s[c].runId,l}));let o;for(const u of this.runnables()){s[0].signal?.throwIfAborted();try{const c=await u.batch(e,a.map((l,d)=>ke(s[d],{callbacks:l?.getChild()})),n);return await Promise.all(a.map((l,d)=>l?.handleChainEnd(ze(c[d],"output")))),c}catch(c){o===void 0&&(o=c)}}throw o?(await Promise.all(a.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function vt(r){if(typeof r=="function")return new as({func:r});if(be.isRunnable(r))return r;if(!Array.isArray(r)&&typeof r=="object"){const e={};for(const[t,n]of Object.entries(r))e[t]=vt(n);return new is({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class Wg extends be{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof is&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const s=this.mapper.getStepsKeys(),[i,a]=Ig(e),o=this.mapper.transform(a,ke(n,{callbacks:t?.getChild()})),u=o.next();for await(const c of i){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const l=Object.fromEntries(Object.entries(c).filter(([d])=>!s.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(const c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const s=fe(t),i=new ss({generator:this.transform(n(),s),config:s});return await i.setup,tt.fromAsyncGenerator(i)}}class PO extends be{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(n=>[n,e[n]]).filter(n=>n[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const n=await this._pick(t);n!==void 0&&(yield n)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const s=fe(t),i=new ss({generator:this.transform(n(),s),config:s});return await i.setup,tt.fromAsyncGenerator(i)}}class ep extends Fn{constructor(e){const t=wt.from([as.from(async n=>{let s;if(sg(n))try{s=await zg(this.schema,n.args)}catch{throw new jv("Received tool input did not match expected schema",JSON.stringify(n.args))}else s=n;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}function AO(r,e){const t=e.name??r.getName(),n=e.description??Gg(e.schema);return _O(e.schema)?new ep({name:t,description:n,schema:Hn({input:jt()}).transform(s=>s.input),bound:r}):new ep({name:t,description:n,schema:e.schema,bound:r})}var TO=typeof window=="object"?window:{},te="0123456789abcdef".split(""),IO=[-2147483648,8388608,32768,128],Ft=[24,16,8,0],Ue=[];function Zt(r){r?(Ue[0]=Ue[16]=Ue[1]=Ue[2]=Ue[3]=Ue[4]=Ue[5]=Ue[6]=Ue[7]=Ue[8]=Ue[9]=Ue[10]=Ue[11]=Ue[12]=Ue[13]=Ue[14]=Ue[15]=0,this.blocks=Ue):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Zt.prototype.update=function(r){if(!this.finalized){var e=typeof r!="string";e&&r.constructor===TO.ArrayBuffer&&(r=new Uint8Array(r));for(var t,n=0,s,i=r.length||0,a=this.blocks;n<i;){if(this.hashed&&(this.hashed=!1,a[0]=this.block,a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),e)for(s=this.start;n<i&&s<64;++n)a[s>>2]|=r[n]<<Ft[s++&3];else for(s=this.start;n<i&&s<64;++n)t=r.charCodeAt(n),t<128?a[s>>2]|=t<<Ft[s++&3]:t<2048?(a[s>>2]|=(192|t>>6)<<Ft[s++&3],a[s>>2]|=(128|t&63)<<Ft[s++&3]):t<55296||t>=57344?(a[s>>2]|=(224|t>>12)<<Ft[s++&3],a[s>>2]|=(128|t>>6&63)<<Ft[s++&3],a[s>>2]|=(128|t&63)<<Ft[s++&3]):(t=65536+((t&1023)<<10|r.charCodeAt(++n)&1023),a[s>>2]|=(240|t>>18)<<Ft[s++&3],a[s>>2]|=(128|t>>12&63)<<Ft[s++&3],a[s>>2]|=(128|t>>6&63)<<Ft[s++&3],a[s>>2]|=(128|t&63)<<Ft[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=a[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Zt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var r=this.blocks,e=this.lastByteIndex;r[16]=this.block,r[e>>2]|=IO[e&3],this.block=r[16],e>=56&&(this.hashed||this.hash(),r[0]=this.block,r[16]=r[1]=r[2]=r[3]=r[4]=r[5]=r[6]=r[7]=r[8]=r[9]=r[10]=r[11]=r[12]=r[13]=r[14]=r[15]=0),r[14]=this.hBytes<<3|this.bytes>>>29,r[15]=this.bytes<<3,this.hash()}};Zt.prototype.hash=function(){var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4,i,a,o,u=this.blocks;for(a=16;a<80;++a)o=u[a-3]^u[a-8]^u[a-14]^u[a-16],u[a]=o<<1|o>>>31;for(a=0;a<20;a+=5)i=e&t|~e&n,o=r<<5|r>>>27,s=o+i+s+1518500249+u[a]<<0,e=e<<30|e>>>2,i=r&e|~r&t,o=s<<5|s>>>27,n=o+i+n+1518500249+u[a+1]<<0,r=r<<30|r>>>2,i=s&r|~s&e,o=n<<5|n>>>27,t=o+i+t+1518500249+u[a+2]<<0,s=s<<30|s>>>2,i=n&s|~n&r,o=t<<5|t>>>27,e=o+i+e+1518500249+u[a+3]<<0,n=n<<30|n>>>2,i=t&n|~t&s,o=e<<5|e>>>27,r=o+i+r+1518500249+u[a+4]<<0,t=t<<30|t>>>2;for(;a<40;a+=5)i=e^t^n,o=r<<5|r>>>27,s=o+i+s+1859775393+u[a]<<0,e=e<<30|e>>>2,i=r^e^t,o=s<<5|s>>>27,n=o+i+n+1859775393+u[a+1]<<0,r=r<<30|r>>>2,i=s^r^e,o=n<<5|n>>>27,t=o+i+t+1859775393+u[a+2]<<0,s=s<<30|s>>>2,i=n^s^r,o=t<<5|t>>>27,e=o+i+e+1859775393+u[a+3]<<0,n=n<<30|n>>>2,i=t^n^s,o=e<<5|e>>>27,r=o+i+r+1859775393+u[a+4]<<0,t=t<<30|t>>>2;for(;a<60;a+=5)i=e&t|e&n|t&n,o=r<<5|r>>>27,s=o+i+s-1894007588+u[a]<<0,e=e<<30|e>>>2,i=r&e|r&t|e&t,o=s<<5|s>>>27,n=o+i+n-1894007588+u[a+1]<<0,r=r<<30|r>>>2,i=s&r|s&e|r&e,o=n<<5|n>>>27,t=o+i+t-1894007588+u[a+2]<<0,s=s<<30|s>>>2,i=n&s|n&r|s&r,o=t<<5|t>>>27,e=o+i+e-1894007588+u[a+3]<<0,n=n<<30|n>>>2,i=t&n|t&s|n&s,o=e<<5|e>>>27,r=o+i+r-1894007588+u[a+4]<<0,t=t<<30|t>>>2;for(;a<80;a+=5)i=e^t^n,o=r<<5|r>>>27,s=o+i+s-899497514+u[a]<<0,e=e<<30|e>>>2,i=r^e^t,o=s<<5|s>>>27,n=o+i+n-899497514+u[a+1]<<0,r=r<<30|r>>>2,i=s^r^e,o=n<<5|n>>>27,t=o+i+t-899497514+u[a+2]<<0,s=s<<30|s>>>2,i=n^s^r,o=t<<5|t>>>27,e=o+i+e-899497514+u[a+3]<<0,n=n<<30|n>>>2,i=t^n^s,o=e<<5|e>>>27,r=o+i+r-899497514+u[a+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+r<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+n<<0,this.h4=this.h4+s<<0};Zt.prototype.hex=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4;return te[r>>28&15]+te[r>>24&15]+te[r>>20&15]+te[r>>16&15]+te[r>>12&15]+te[r>>8&15]+te[r>>4&15]+te[r&15]+te[e>>28&15]+te[e>>24&15]+te[e>>20&15]+te[e>>16&15]+te[e>>12&15]+te[e>>8&15]+te[e>>4&15]+te[e&15]+te[t>>28&15]+te[t>>24&15]+te[t>>20&15]+te[t>>16&15]+te[t>>12&15]+te[t>>8&15]+te[t>>4&15]+te[t&15]+te[n>>28&15]+te[n>>24&15]+te[n>>20&15]+te[n>>16&15]+te[n>>12&15]+te[n>>8&15]+te[n>>4&15]+te[n&15]+te[s>>28&15]+te[s>>24&15]+te[s>>20&15]+te[s>>16&15]+te[s>>12&15]+te[s>>8&15]+te[s>>4&15]+te[s&15]};Zt.prototype.toString=Zt.prototype.hex;Zt.prototype.digest=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4;return[r>>24&255,r>>16&255,r>>8&255,r&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,n>>24&255,n>>16&255,n>>8&255,n&255,s>>24&255,s>>16&255,s>>8&255,s&255]};Zt.prototype.array=Zt.prototype.digest;Zt.prototype.arrayBuffer=function(){this.finalize();var r=new ArrayBuffer(20),e=new DataView(r);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),r};let tp=!1;const RO=r=>(tp||(console.warn(["The default method for hashing keys is insecure and will be replaced in a future version,","but hasn't been replaced yet as to not break existing caches. It's recommended that you use","a more secure hashing algorithm to avoid cache poisoning.","","See this page for more information:","|","â””> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm"].join(`
`)),tp=!0),new Zt(!0).update(r).hex()),CO=(...r)=>RO(r.join("_"));class $O{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:CO})}makeDefaultKeyEncoder(e){this.keyEncoder=e}}const NO=new Map;class ed extends $O{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,n){this.cache.set(this.keyEncoder(e,t),n)}static global(){return new ed(NO)}}class Zg extends or{}class jO extends Zg{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new so(this.value)]}}class LO extends Zg{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return ig(this.messages)}toChatMessages(){return this.messages}}var hs={},np;function MO(){if(np)return hs;np=1,hs.byteLength=o,hs.toByteArray=c,hs.fromByteArray=f;for(var r=[],e=[],t=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,i=n.length;s<i;++s)r[s]=n[s],e[n.charCodeAt(s)]=s;e[45]=62,e[95]=63;function a(h){var p=h.length;if(p%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var m=h.indexOf("=");m===-1&&(m=p);var g=m===p?0:4-m%4;return[m,g]}function o(h){var p=a(h),m=p[0],g=p[1];return(m+g)*3/4-g}function u(h,p,m){return(p+m)*3/4-m}function c(h){var p,m=a(h),g=m[0],y=m[1],_=new t(u(h,g,y)),b=0,v=y>0?g-4:g,w;for(w=0;w<v;w+=4)p=e[h.charCodeAt(w)]<<18|e[h.charCodeAt(w+1)]<<12|e[h.charCodeAt(w+2)]<<6|e[h.charCodeAt(w+3)],_[b++]=p>>16&255,_[b++]=p>>8&255,_[b++]=p&255;return y===2&&(p=e[h.charCodeAt(w)]<<2|e[h.charCodeAt(w+1)]>>4,_[b++]=p&255),y===1&&(p=e[h.charCodeAt(w)]<<10|e[h.charCodeAt(w+1)]<<4|e[h.charCodeAt(w+2)]>>2,_[b++]=p>>8&255,_[b++]=p&255),_}function l(h){return r[h>>18&63]+r[h>>12&63]+r[h>>6&63]+r[h&63]}function d(h,p,m){for(var g,y=[],_=p;_<m;_+=3)g=(h[_]<<16&16711680)+(h[_+1]<<8&65280)+(h[_+2]&255),y.push(l(g));return y.join("")}function f(h){for(var p,m=h.length,g=m%3,y=[],_=16383,b=0,v=m-g;b<v;b+=_)y.push(d(h,b,b+_>v?v:b+_));return g===1?(p=h[m-1],y.push(r[p>>2]+r[p<<4&63]+"==")):g===2&&(p=(h[m-2]<<8)+h[m-1],y.push(r[p>>10]+r[p>>4&63]+r[p<<2&63]+"=")),y.join("")}return hs}var DO=MO();const UO=li(DO);var FO=Object.defineProperty,BO=(r,e,t)=>e in r?FO(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,zO=(r,e,t)=>(BO(r,e+"",t),t);function GO(r,e){let t=Array.from({length:r.length},(n,s)=>({start:s,end:s+1}));for(;t.length>1;){let n=null;for(let s=0;s<t.length-1;s++){const i=r.slice(t[s].start,t[s+1].end),a=e.get(i.join(","));a!=null&&(n==null||a<n[0])&&(n=[a,s])}if(n!=null){const s=n[1];t[s]={start:t[s].start,end:t[s+1].end},t.splice(s+1,1)}else break}return t}function qO(r,e){return r.length===1?[e.get(r.join(","))]:GO(r,e).map(t=>e.get(r.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function HO(r){return r.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Hc=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(r,e){this.patStr=r.pat_str;const t=r.bpe_ranks.split(`
`).filter(Boolean).reduce((n,s)=>{const[i,a,...o]=s.split(" "),u=Number.parseInt(a,10);return o.forEach((c,l)=>n[c]=u+l),n},{});for(const[n,s]of Object.entries(t)){const i=UO.toByteArray(n);this.rankMap.set(i.join(","),s),this.textMap.set(s,i)}this.specialTokens={...r.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[s,i])=>(n[i]=this.textEncoder.encode(s),n),{})}encode(r,e=[],t="all"){const n=new RegExp(this.patStr,"ug"),s=Hc.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(c=>!a.has(c)):t);if(o.size>0){const c=Hc.specialTokenRegex([...o]),l=r.match(c);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let u=0;for(;;){let c=null,l=u;for(;s.lastIndex=l,c=s.exec(r),!(c==null||a.has(c[0]));)l=c.index+1;const d=c?.index??r.length;for(const h of r.substring(u,d).matchAll(n)){const p=this.textEncoder.encode(h[0]),m=this.rankMap.get(p.join(","));if(m!=null){i.push(m);continue}i.push(...qO(p,this.rankMap))}if(c==null)break;let f=this.specialTokens[c[0]];i.push(f),u=c.index+c[0].length}return i}decode(r){const e=[];let t=0;for(let i=0;i<r.length;++i){const a=r[i],o=this.textMap.get(a)??this.inverseSpecialTokens[a];o!=null&&(e.push(o),t+=o.length)}const n=new Uint8Array(t);let s=0;for(const i of e)n.set(i,s),s+=i.length;return this.textDecoder.decode(n)}},Jg=Hc;zO(Jg,"specialTokenRegex",r=>new RegExp(r.map(e=>HO(e)).join("|"),"g"));function VO(r){switch(r){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}const Fi={},WO=new Kl({});async function ZO(r){return r in Fi||(Fi[r]=WO.fetch(`https://tiktoken.pages.dev/js/${r}.json`).then(e=>e.json()).then(e=>new Jg(e)).catch(e=>{throw delete Fi[r],e})),await Fi[r]}async function JO(r){return ZO(VO(r))}const KO=r=>r.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":r.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":r.startsWith("gpt-4-32k")?"gpt-4-32k":r.startsWith("gpt-4-")?"gpt-4":r.startsWith("gpt-4o")?"gpt-4o":r;function Kg(r){return typeof r!="object"||!r?!1:!!("type"in r&&r.type==="function"&&"function"in r&&typeof r.function=="object"&&r.function&&"name"in r.function&&"parameters"in r.function)}const XO=()=>!1;class YO extends be{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??XO(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class QO extends YO{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){const{cache:s,...i}=n;super({callbacks:e??t,...i}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof s=="object"?this.cache=s:s?this.cache=ed.global():this.cache=void 0,this.caller=new Kl(n??{})}async getNumTokens(e){let t;typeof e=="string"?t=e:t=e.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join("");let n=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await JO("modelName"in this?KO(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{n=this._encoding.encode(t).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return n}static _convertInputToPromptValue(e){return typeof e=="string"?new jO(e):Array.isArray(e)?new LO(e.map(Qn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(n).filter(([a,o])=>o!==void 0).map(([a,o])=>`${a}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class Js extends be{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=fe(t);return this.func&&await this.func(e,n),this._callWithConfig(s=>Promise.resolve(s),e,n)}async*transform(e,t){const n=fe(t);let s,i=!0;for await(const a of this._transformStreamWithConfig(e,o=>o,n))if(yield a,i)if(s===void 0)s=a;else try{s=ho(s,a)}catch{s=void 0,i=!1}this.func&&s!==void 0&&await this.func(s,n)}static assign(e){return new Wg(new is({steps:e}))}}function Ku(r){const e=[];for(const t of r){let n=t;if(Array.isArray(t.content))for(let s=0;s<t.content.length;s++){const i=t.content[s];(Ov(i)||kv(i))&&n===t&&(n=new t.constructor({...n,content:[...t.content.slice(0,s),Pv(i),...t.content.slice(s+1)]}))}e.push(n)}return e}class Tn extends QO{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async invoke(e,t){const n=Tn._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===Tn.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{const s=Tn._convertInputToPromptValue(e).toChatMessages(),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...i.metadata,...this.getLsParams(a)},u=await lt.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this?.invocationParams(a),batch_size:1},l=await u?.handleChatModelStart(this.toJSON(),[Ku(s)],i.runId,void 0,c,void 0,void 0,i.runName);let d,f;try{for await(const h of this._streamResponseChunks(s,a,l?.[0])){if(h.message.id==null){const p=l?.at(0)?.runId;p!=null&&h.message._updateId(`run-${p}`)}h.message.response_metadata={...h.generationInfo,...h.message.response_metadata},yield h.message,d?d=d.concat(h):d=h,cf(h.message)&&h.message.usage_metadata!==void 0&&(f={tokenUsage:{promptTokens:h.message.usage_metadata.input_tokens,completionTokens:h.message.usage_metadata.output_tokens,totalTokens:h.message.usage_metadata.total_tokens}})}}catch(h){throw await Promise.all((l??[]).map(p=>p?.handleLLMError(h))),h}await Promise.all((l??[]).map(h=>h?.handleLLMEnd({generations:[[d]],llmOutput:f})))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,n,s){const i=e.map(d=>d.map(Qn));let a;if(s!==void 0&&s.length===i.length)a=s;else{const d={...n.metadata,...this.getLsParams(t)},f=await lt.configure(n.callbacks,this.callbacks,n.tags,this.tags,d,this.metadata,{verbose:this.verbose}),h={options:t,invocation_params:this?.invocationParams(t),batch_size:1};a=await f?.handleChatModelStart(this.toJSON(),i.map(Ku),n.runId,void 0,h,void 0,void 0,n.runName)}const o=[],u=[];if(!!a?.[0].handlers.find(LE)&&!this.disableStreaming&&i.length===1&&this._streamResponseChunks!==Tn.prototype._streamResponseChunks)try{const d=await this._streamResponseChunks(i[0],t,a?.[0]);let f,h;for await(const p of d){if(p.message.id==null){const m=a?.at(0)?.runId;m!=null&&p.message._updateId(`run-${m}`)}f===void 0?f=p:f=ho(f,p),cf(p.message)&&p.message.usage_metadata!==void 0&&(h={tokenUsage:{promptTokens:p.message.usage_metadata.input_tokens,completionTokens:p.message.usage_metadata.output_tokens,totalTokens:p.message.usage_metadata.total_tokens}})}if(f===void 0)throw new Error("Received empty response from chat model call.");o.push([f]),await a?.[0].handleLLMEnd({generations:o,llmOutput:h})}catch(d){throw await a?.[0].handleLLMError(d),d}else{const d=await Promise.allSettled(i.map((f,h)=>this._generate(f,{...t,promptIndex:h},a?.[h])));await Promise.all(d.map(async(f,h)=>{if(f.status==="fulfilled"){const p=f.value;for(const m of p.generations){if(m.message.id==null){const g=a?.at(0)?.runId;g!=null&&m.message._updateId(`run-${g}`)}m.message.response_metadata={...m.generationInfo,...m.message.response_metadata}}return p.generations.length===1&&(p.generations[0].message.response_metadata={...p.llmOutput,...p.generations[0].message.response_metadata}),o[h]=p.generations,u[h]=p.llmOutput,a?.[h]?.handleLLMEnd({generations:[p.generations],llmOutput:p.llmOutput})}else return await a?.[h]?.handleLLMError(f.reason),Promise.reject(f.reason)}))}const l={generations:o,llmOutput:u.length?this._combineLLMOutput?.(...u):void 0};return Object.defineProperty(l,Hh,{value:a?{runIds:a?.map(d=>d.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:s,handledOptions:i}){const a=e.map(g=>g.map(Qn)),o={...i.metadata,...this.getLsParams(s)},u=await lt.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:s,invocation_params:this?.invocationParams(s),batch_size:1},l=await u?.handleChatModelStart(this.toJSON(),a.map(Ku),i.runId,void 0,c,void 0,void 0,i.runName),d=[],h=(await Promise.allSettled(a.map(async(g,y)=>{const _=Tn._convertInputToPromptValue(g).toString(),b=await t.lookup(_,n);return b==null&&d.push(y),b}))).map((g,y)=>({result:g,runManager:l?.[y]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),p=[];await Promise.all(h.map(async({result:g,runManager:y},_)=>{if(g.status==="fulfilled"){const b=g.value;return p[_]=b.map(v=>("message"in v&&Pt(v.message)&&di(v.message)&&(v.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),v.generationInfo={...v.generationInfo,tokenUsage:{}},v)),b.length&&await y?.handleLLMNewToken(b[0].text),y?.handleLLMEnd({generations:[b]},void 0,void 0,void 0,{cached:!0})}else return await y?.handleLLMError(g.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(g.reason)}));const m={generations:p,missingPromptIndices:d,startedRunManagers:l};return Object.defineProperty(m,Hh,{value:l?{runIds:l?.map(g=>g.runId)}:void 0,configurable:!0}),m}async generate(e,t,n){let s;Array.isArray(t)?s={stop:t}:s=t;const i=e.map(p=>p.map(Qn)),[a,o]=this._separateRunnableConfigFromCallOptionsCompat(s);if(a.callbacks=a.callbacks??n,!this.cache)return this._generateUncached(i,o,a);const{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d,startedRunManagers:f}=await this._generateCached({messages:i,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:a});let h={};if(d.length>0){const p=await this._generateUncached(d.map(m=>i[m]),o,a,f!==void 0?d.map(m=>f?.[m]):void 0);await Promise.all(p.generations.map(async(m,g)=>{const y=d[g];l[y]=m;const _=Tn._convertInputToPromptValue(i[y]).toString();return u.update(_,c,m)})),h=p.llmOutput??{}}return{generations:l,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const s=e.map(i=>i.toChatMessages());return this.generate(s,t,n)}async call(e,t,n){return(await this.generate([e.map(Qn)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const s=e.toChatMessages();return this.call(s,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const s=new so(e),i=await this.call([s],t,n);if(typeof i.content!="string")throw new Error("Cannot use predict when output is not a string.");return i.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw new Error('"strict" mode is not supported for this model by default.');const n=e,s=t?.name,i=Gg(n)??"A function available to call.",a=t?.method,o=t?.includeRaw;if(a==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=s??"extract",c;Yl(n)?c=[{type:"function",function:{name:u,description:i,parameters:_o(n)}}]:("name"in n&&(u=n.name),c=[{type:"function",function:{name:u,description:i,parameters:n}}]);const l=this.bindTools(c),d=as.from(m=>{if(!m.tool_calls||m.tool_calls.length===0)throw new Error("No tool calls found in the response.");const g=m.tool_calls.find(y=>y.name===u);if(!g)throw new Error(`No tool call found with name ${u}.`);return g.args});if(!o)return l.pipe(d).withConfig({runName:"StructuredOutput"});const f=Js.assign({parsed:(m,g)=>d.invoke(m.raw,g)}),h=Js.assign({parsed:()=>null}),p=f.withFallbacks({fallbacks:[h]});return wt.from([{raw:l},p]).withConfig({runName:"StructuredOutputRunnable"})}}class ek extends be{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(n,s)=>this.parseResult([{text:n}],s?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(n,s)=>this.parseResult([{message:n,text:this._baseMessageToString(n)}],s?.callbacks),e,{...t,runType:"parser"})}}class Xg extends ek{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class td extends Error{constructor(e,t,n,s=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=s,s&&(n===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");rg(this,"OUTPUT_PARSING_FAILURE")}}class tk extends Xg{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class Yg extends tk{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let i;if(Tc(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new ur({message:s,text:s.content})}else if(Pt(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new ur({message:Uv(s),text:s.content})}else i=new zr({text:s});n===void 0?n=i:n=n.concat(i);const a=await this.parsePartialResult([n]);a!=null&&!Bc(a,t)&&(this.diff?yield this._diff(t,a):yield a,t=a)}}getFormatInstructions(){return""}}class rp extends Xg{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const t=Hn(Object.fromEntries(Object.entries(e).map(([n,s])=>[n,jt().describe(s)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(_o(this.schema))}
\`\`\`
`}async parse(e){try{const t=e.trim(),s=(t.match(/^```(?:json)?\s*([\s\S]*?)```/)?.[1]||t.match(/```json\s*([\s\S]*?)```/)?.[1]||t).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(i,a)=>`"${a.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await zg(this.schema,JSON.parse(s))}catch(t){throw new td(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class sp extends Yg{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?_0(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return sf(e[0].text)}async parse(e){return sf(e,JSON.parse)}getFormatInstructions(){return""}}function nd(r,e){if(r.function===void 0)return;let t;if(e?.partial)try{t=Dl(r.function.arguments??"{}")}catch{return}else try{t=JSON.parse(r.function.arguments)}catch(s){throw new td([`Function "${r.function.name}" arguments:`,"",r.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}const n={name:r.function.name,args:t,type:"tool_call"};return e?.returnId&&(n.id=r.id),n}function nk(r){if(r.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:r.id,type:"function",function:{name:r.name,arguments:JSON.stringify(r.args)}}}function Qg(r,e){return{name:r.function?.name,args:r.function?.arguments,id:r.id,error:e,type:"invalid_tool_call"}}class rk extends Yg{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){const n=e[0].message;let s;if(di(n)&&n.tool_calls?.length?s=n.tool_calls.map(a=>{const{id:o,...u}=a;return this.returnId?{id:o,...u}:u}):n.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(o=>nd(o,{returnId:this.returnId,partial:t}))),!s)return[];const i=[];for(const a of s)if(a!==void 0){const o={type:a.name,args:a.args,id:a.id};i.push(o)}return i}}class ip extends rk{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const t=await yO(this.zodSchema,e);if(t.success)return t.data;throw new td(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const n=(await super.parsePartialResult(e)).filter(i=>i.type===this.keyName);let s=n;if(n.length)return this.returnId||(s=n.map(i=>i.args)),this.returnSingle?s[0]:s}async parseResult(e){const n=(await super.parsePartialResult(e,!1)).filter(a=>a.type===this.keyName);let s=n;return n.length?(this.returnId||(s=n.map(a=>a.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(a=>this._validateResult(a)))):void 0}}const sk=Symbol("Let zodToJsonSchema decide on which parser to use"),ap={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},ik=r=>typeof r=="string"?{...ap,basePath:["#"],definitions:{},name:r}:{...ap,basePath:["#"],definitions:{},...r},Vc=r=>"_def"in r?r._def:r;function ak(r){if(!r)return!0;for(const e in r)return!1;return!0}const ok=r=>{const e=ik(r),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([n,s])=>[Vc(s),{def:Vc(s),path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}};function ey(r,e,t,n){n?.errorMessages&&t&&(r.errorMessage={...r.errorMessage,[e]:t})}function ge(r,e,t,n,s){r[e]=t,ey(r,e,n,s)}function uk(){return{}}function ck(r,e){const t={type:"array"};return r.type?._def?.typeName!==S.ZodAny&&(t.items=ce(r.type._def,{...e,currentPath:[...e.currentPath,"items"]})),r.minLength&&ge(t,"minItems",r.minLength.value,r.minLength.message,e),r.maxLength&&ge(t,"maxItems",r.maxLength.value,r.maxLength.message,e),r.exactLength&&(ge(t,"minItems",r.exactLength.value,r.exactLength.message,e),ge(t,"maxItems",r.exactLength.value,r.exactLength.message,e)),t}function lk(r,e){const t={type:"integer",format:"int64"};if(!r.checks)return t;for(const n of r.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?ge(t,"minimum",n.value,n.message,e):ge(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),ge(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?ge(t,"maximum",n.value,n.message,e):ge(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),ge(t,"maximum",n.value,n.message,e));break;case"multipleOf":ge(t,"multipleOf",n.value,n.message,e);break}return t}function dk(){return{type:"boolean"}}function fk(r,e){return ce(r.type._def,e)}const hk=(r,e)=>ce(r.innerType._def,e);function ty(r,e,t){const n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((s,i)=>ty(r,e,s))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return pk(r,e)}}const pk=(r,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const n of r.checks)switch(n.kind){case"min":ge(t,"minimum",n.value,n.message,e);break;case"max":ge(t,"maximum",n.value,n.message,e);break}return t};function mk(r,e){return{...ce(r.innerType._def,e),default:r.defaultValue()}}function gk(r,e,t){return e.effectStrategy==="input"?ce(r.schema._def,e,t):{}}function yk(r){return{type:"string",enum:[...r.values]}}const _k=r=>"type"in r&&r.type==="string"?!1:"allOf"in r;function bk(r,e){const t=[ce(r.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),ce(r.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return t.forEach(i=>{if(_k(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(n=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...u}=i;a=u}else n=void 0;s.push(a)}}),s.length?{allOf:s,...n}:void 0}function wk(r,e){const t=typeof r.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(r.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[r.value]}:{type:t==="bigint"?"integer":t,const:r.value}}let Xu;const Jn={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Xu===void 0&&(Xu=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Xu),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function ny(r,e){const t={type:"string"};function n(s){return e.patternStrategy==="escape"?vk(s):s}if(r.checks)for(const s of r.checks)switch(s.kind){case"min":ge(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e);break;case"max":ge(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Bt(t,"email",s.message,e);break;case"format:idn-email":Bt(t,"idn-email",s.message,e);break;case"pattern:zod":zt(t,Jn.email,s.message,e);break}break;case"url":Bt(t,"uri",s.message,e);break;case"uuid":Bt(t,"uuid",s.message,e);break;case"regex":zt(t,s.regex,s.message,e);break;case"cuid":zt(t,Jn.cuid,s.message,e);break;case"cuid2":zt(t,Jn.cuid2,s.message,e);break;case"startsWith":zt(t,RegExp(`^${n(s.value)}`),s.message,e);break;case"endsWith":zt(t,RegExp(`${n(s.value)}$`),s.message,e);break;case"datetime":Bt(t,"date-time",s.message,e);break;case"date":Bt(t,"date",s.message,e);break;case"time":Bt(t,"time",s.message,e);break;case"duration":Bt(t,"duration",s.message,e);break;case"length":ge(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e),ge(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"includes":{zt(t,RegExp(n(s.value)),s.message,e);break}case"ip":{s.version!=="v6"&&Bt(t,"ipv4",s.message,e),s.version!=="v4"&&Bt(t,"ipv6",s.message,e);break}case"emoji":zt(t,Jn.emoji,s.message,e);break;case"ulid":{zt(t,Jn.ulid,s.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Bt(t,"binary",s.message,e);break}case"contentEncoding:base64":{ge(t,"contentEncoding","base64",s.message,e);break}case"pattern:zod":{zt(t,Jn.base64,s.message,e);break}}break}case"nanoid":zt(t,Jn.nanoid,s.message,e)}return t}const vk=r=>Array.from(r).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Bt=(r,e,t,n)=>{r.format||r.anyOf?.some(s=>s.format)?(r.anyOf||(r.anyOf=[]),r.format&&(r.anyOf.push({format:r.format,...r.errorMessage&&n.errorMessages&&{errorMessage:{format:r.errorMessage.format}}}),delete r.format,r.errorMessage&&(delete r.errorMessage.format,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):ge(r,"format",e,t,n)},zt=(r,e,t,n)=>{r.pattern||r.allOf?.some(s=>s.pattern)?(r.allOf||(r.allOf=[]),r.pattern&&(r.allOf.push({pattern:r.pattern,...r.errorMessage&&n.errorMessages&&{errorMessage:{pattern:r.errorMessage.pattern}}}),delete r.pattern,r.errorMessage&&(delete r.errorMessage.pattern,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.allOf.push({pattern:op(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):ge(r,"pattern",op(e,n),t,n)},op=(r,e)=>{const t=typeof r=="function"?r():r;if(!e.applyRegexFlags||!t.flags)return t.source;const n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},s=n.i?t.source.toLowerCase():t.source;let i="",a=!1,o=!1,u=!1;for(let c=0;c<s.length;c++){if(a){i+=s[c],a=!1;continue}if(n.i){if(o){if(s[c].match(/[a-z]/)){u?(i+=s[c],i+=`${s[c-2]}-${s[c]}`.toUpperCase(),u=!1):s[c+1]==="-"&&s[c+2]?.match(/[a-z]/)?(i+=s[c],u=!0):i+=`${s[c]}${s[c].toUpperCase()}`;continue}}else if(s[c].match(/[a-z]/)){i+=`[${s[c]}${s[c].toUpperCase()}]`;continue}}if(n.m){if(s[c]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(s[c]==="$"){i+=`($|(?=[\r
]))`;continue}}if(n.s&&s[c]==="."){i+=o?`${s[c]}\r
`:`[${s[c]}\r
]`;continue}i+=s[c],s[c]==="\\"?a=!0:o&&s[c]==="]"?o=!1:!o&&s[c]==="["&&(o=!0)}try{const c=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return i};function ry(r,e){if(e.target==="openApi3"&&r.keyType?._def.typeName===S.ZodEnum)return{type:"object",required:r.keyType._def.values,properties:r.keyType._def.values.reduce((n,s)=>({...n,[s]:ce(r.valueType._def,{...e,currentPath:[...e.currentPath,"properties",s]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:ce(r.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(r.keyType?._def.typeName===S.ZodString&&r.keyType._def.checks?.length){const n=Object.entries(ny(r.keyType._def,e)).reduce((s,[i,a])=>i==="type"?s:{...s,[i]:a},{});return{...t,propertyNames:n}}else if(r.keyType?._def.typeName===S.ZodEnum)return{...t,propertyNames:{enum:r.keyType._def.values}};return t}function Sk(r,e){if(e.mapStrategy==="record")return ry(r,e);const t=ce(r.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=ce(r.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}function Ek(r){const e=r.values,n=Object.keys(r.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(n.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:n}}function xk(){return{not:{}}}function Ok(r){return r.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Ia={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function kk(r,e){if(e.target==="openApi3")return up(r,e);const t=r.options instanceof Map?Array.from(r.options.values()):r.options;if(t.every(n=>n._def.typeName in Ia&&(!n._def.checks||!n._def.checks.length))){const n=t.reduce((s,i)=>{const a=Ia[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=t.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":if(i._def.value===null)return[...s,"null"];default:return s}},[]);if(n.length===t.length){const s=n.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:t.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,s)=>[...n,...s._def.values.filter(i=>!n.includes(i))],[])};return up(r,e)}const up=(r,e)=>{const t=(r.options instanceof Map?Array.from(r.options.values()):r.options).map((n,s)=>ce(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0};function Pk(r,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Ia[r.innerType._def.typeName],nullable:!0}:{type:[Ia[r.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=ce(r.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const t=ce(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Ak(r,e){const t={type:"number"};if(!r.checks)return t;for(const n of r.checks)switch(n.kind){case"int":t.type="integer",ey(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?ge(t,"minimum",n.value,n.message,e):ge(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),ge(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?ge(t,"maximum",n.value,n.message,e):ge(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),ge(t,"maximum",n.value,n.message,e));break;case"multipleOf":ge(t,"multipleOf",n.value,n.message,e);break}return t}function Tk(r,e){return e.removeAdditionalStrategy==="strict"?r.catchall._def.typeName==="ZodNever"?r.unknownKeys!=="strict":ce(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:r.catchall._def.typeName==="ZodNever"?r.unknownKeys==="passthrough":ce(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Ik(r,e){const t={type:"object",...Object.entries(r.shape()).reduce((n,[s,i])=>{if(i===void 0||i._def===void 0)return n;const a=[...e.currentPath,"properties",s],o=ce(i._def,{...e,currentPath:a,propertyPath:a});return o===void 0?n:(e.openaiStrictMode&&i.isOptional()&&!i.isNullable()&&console.warn(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required
This will become an error in a future version of the SDK.`),{properties:{...n.properties,[s]:o},required:i.isOptional()&&!e.openaiStrictMode?n.required:[...n.required,s]})},{properties:{},required:[]}),additionalProperties:Tk(r,e)};return t.required.length||delete t.required,t}const Rk=(r,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return ce(r.innerType._def,e);const t=ce(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Ck=(r,e)=>{if(e.pipeStrategy==="input")return ce(r.in._def,e);if(e.pipeStrategy==="output")return ce(r.out._def,e);const t=ce(r.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=ce(r.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(s=>s!==void 0)}};function $k(r,e){return ce(r.type._def,e)}function Nk(r,e){const n={type:"array",uniqueItems:!0,items:ce(r.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return r.minSize&&ge(n,"minItems",r.minSize.value,r.minSize.message,e),r.maxSize&&ge(n,"maxItems",r.maxSize.value,r.maxSize.message,e),n}function jk(r,e){return r.rest?{type:"array",minItems:r.items.length,items:r.items.map((t,n)=>ce(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:ce(r.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:r.items.length,maxItems:r.items.length,items:r.items.map((t,n)=>ce(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}function Lk(){return{not:{}}}function Mk(){return{}}const Dk=(r,e)=>ce(r.innerType._def,e);function ce(r,e,t=!1){const n=e.seen.get(r);if(e.override){const a=e.override?.(r,e,n,t);if(a!==sk)return a}if(n&&!t){const a=Uk(n,e);if(a!==void 0)return"$ref"in a&&e.seenRefs.add(a.$ref),a}const s={def:r,path:e.currentPath,jsonSchema:void 0};e.seen.set(r,s);const i=Bk(r,r.typeName,e,t);return i&&zk(r,e,i),s.jsonSchema=i,i}const Uk=(r,e)=>{switch(e.$refStrategy){case"root":return{$ref:r.path.join("/")};case"extract-to-root":const t=r.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=r.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:Fk(e.currentPath,r.path)};case"none":case"seen":return r.path.length<e.currentPath.length&&r.path.every((n,s)=>e.currentPath[s]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Fk=(r,e)=>{let t=0;for(;t<r.length&&t<e.length&&r[t]===e[t];t++);return[(r.length-t).toString(),...e.slice(t)].join("/")},Bk=(r,e,t,n)=>{switch(e){case S.ZodString:return ny(r,t);case S.ZodNumber:return Ak(r,t);case S.ZodObject:return Ik(r,t);case S.ZodBigInt:return lk(r,t);case S.ZodBoolean:return dk();case S.ZodDate:return ty(r,t);case S.ZodUndefined:return Lk();case S.ZodNull:return Ok(t);case S.ZodArray:return ck(r,t);case S.ZodUnion:case S.ZodDiscriminatedUnion:return kk(r,t);case S.ZodIntersection:return bk(r,t);case S.ZodTuple:return jk(r,t);case S.ZodRecord:return ry(r,t);case S.ZodLiteral:return wk(r,t);case S.ZodEnum:return yk(r);case S.ZodNativeEnum:return Ek(r);case S.ZodNullable:return Pk(r,t);case S.ZodOptional:return Rk(r,t);case S.ZodMap:return Sk(r,t);case S.ZodSet:return Nk(r,t);case S.ZodLazy:return ce(r.getter()._def,t);case S.ZodPromise:return $k(r,t);case S.ZodNaN:case S.ZodNever:return xk();case S.ZodEffects:return gk(r,t,n);case S.ZodAny:return uk();case S.ZodUnknown:return Mk();case S.ZodDefault:return mk(r,t);case S.ZodBranded:return fk(r,t);case S.ZodReadonly:return Dk(r,t);case S.ZodCatch:return hk(r,t);case S.ZodPipeline:return Ck(r,t);case S.ZodFunction:case S.ZodVoid:case S.ZodSymbol:return;default:return(s=>{})()}},zk=(r,e,t)=>(r.description&&(t.description=r.description,e.markdownDescription&&(t.markdownDescription=r.description)),t),Gk=(r,e)=>{const t=ok(e),n=typeof e=="string"?e:e?.nameStrategy==="title"?void 0:e?.name,s=ce(r._def,n===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,n]},!1)??{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);const a=(()=>{if(ak(t.definitions))return;const u={},c=new Set;for(let l=0;l<500;l++){const d=Object.entries(t.definitions).filter(([f])=>!c.has(f));if(d.length===0)break;for(const[f,h]of d)u[f]=ce(Vc(h),{...t,currentPath:[...t.basePath,t.definitionPath,f]},!0)??{},c.add(f)}return u})(),o=n===void 0?a?{...s,[t.definitionPath]:a}:s:t.nameStrategy==="duplicate-ref"?{...s,...a||t.seenRefs.size?{[t.definitionPath]:{...a,...t.seenRefs.size?{[n]:s}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,n].join("/"),[t.definitionPath]:{...a,[n]:s}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function sy(r,e){return Gk(r,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function qk(r,e,t){return Ww({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:sy(r,{name:e})}},n=>r.parse(JSON.parse(n)))}function Hk(r){return Zw({type:"function",function:{name:r.name,parameters:sy(r.parameters,{name:r.name}),strict:!0,...r.description?{description:r.description}:void 0}},{callback:r.function,parser:e=>r.parameters.parse(JSON.parse(e))})}function Vk(r){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:n,azureOpenAIBasePath:s,baseURL:i,azureADTokenProvider:a,azureOpenAIEndpoint:o}=r;if((n||a)&&s&&e)return`${s}/${e}`;if((n||a)&&o&&e)return`${o}/openai/deployments/${e}`;if(n||a){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return i}function Wk(r){return r!==void 0&&Array.isArray(r.lc_namespace)}function Zk(r){return r!==void 0&&be.isRunnable(r)&&"lc_name"in r.constructor&&typeof r.constructor.lc_name=="function"&&r.constructor.lc_name()==="RunnableToolLike"}function Jk(r){return!!r&&typeof r=="object"&&"name"in r&&"schema"in r&&(Yl(r.schema)||r.schema!=null&&typeof r.schema=="object"&&"type"in r.schema&&typeof r.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(r.schema.type))}function Kk(r){return Jk(r)||Zk(r)||Wk(r)}function Xk(r,e){const t=typeof e=="number"?void 0:e;return{name:r.name,description:r.description,parameters:_o(r.schema),...t?.strict!==void 0?{strict:t.strict}:{}}}function Bi(r,e){return r.lc_error_code=e,r.message=`${r.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,r}function Yu(r){let e;return r.constructor.name===za.name?(e=new Error(r.message),e.name="TimeoutError"):r.constructor.name===bt.name?(e=new Error(r.message),e.name="AbortError"):r.status===400&&r.message.includes("tool_calls")?e=Bi(r,"INVALID_TOOL_RESULTS"):r.status===401?e=Bi(r,"MODEL_AUTHENTICATION"):r.status===429?e=Bi(r,"MODEL_RATE_LIMIT"):r.status===404?e=Bi(r,"MODEL_NOT_FOUND"):e=r,e}function cp(r){if(r)return r==="any"||r==="required"?"required":r==="auto"?"auto":r==="none"?"none":typeof r=="string"?{type:"function",function:{name:r}}:r}function Yk(r){return r.anyOf!==void 0&&Array.isArray(r.anyOf)}function Qk(r){const e=["namespace functions {",""];for(const t of r)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(iy(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function iy(r,e){const t=[];for(const[n,s]of Object.entries(r.properties??{}))s.description&&e<2&&t.push(`// ${s.description}`),r.required?.includes(n)?t.push(`${n}: ${Ra(s,e)},`):t.push(`${n}?: ${Ra(s,e)},`);return t.map(n=>" ".repeat(e)+n).join(`
`)}function Ra(r,e){if(Yk(r))return r.anyOf.map(t=>Ra(t,e)).join(" | ");switch(r.type){case"string":return r.enum?r.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return r.enum?r.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return r.enum?r.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",iy(r,e+2),"}"].join(`
`);case"array":return r.items?`${Ra(r.items,e)}[]`:"any[]";default:return""}}function eP(r,e){let t;if(Kk(r)){const n=Hk({name:r.name,parameters:r.schema,description:r.description});n.function.parameters?t={type:n.type,function:{name:n.function.name,description:n.function.description,parameters:n.function.parameters,...e?.strict!==void 0?{strict:e.strict}:{}}}:t={type:"function",function:Xk(r,e)}}else t=r;return e?.strict!==void 0&&(t.function.strict=e.strict),t}function tP(r){return r.role!=="system"&&r.role!=="developer"&&r.role!=="assistant"&&r.role!=="user"&&r.role!=="function"&&r.role!=="tool"&&console.warn(`Unknown message role: ${r.role}`),r.role}function rd(r){const e=r._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!fi.isInstance(r))throw new Error("Invalid generic chat message");return tP(r)}default:throw new Error(`Unknown message type: ${e}`)}}function lp(r,e){return r.flatMap(t=>{let n=rd(t);n==="system"&&sd(e)&&(n="developer");const s={role:n,content:t.content};if(t.name!=null&&(s.name=t.name),t.additional_kwargs.function_call!=null&&(s.function_call=t.additional_kwargs.function_call,s.content=""),di(t)&&t.tool_calls?.length?(s.tool_calls=t.tool_calls.map(nk),s.content=""):(t.additional_kwargs.tool_calls!=null&&(s.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(s.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){const i={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[s,i]}return s})}const Ca="__openai_function_call_ids__";function dp(r,e){return r.flatMap(t=>{let n=rd(t);if(n==="system"&&sd(e)&&(n="developer"),n==="function")throw new Error("Function messages are not supported in Responses API");if(n==="tool"){const s=t;return s.additional_kwargs?.type==="computer_call_output"?{type:"computer_call_output",output:(()=>{if(typeof s.content=="string")return{type:"computer_screenshot",image_url:s.content};if(Array.isArray(s.content)){const a=s.content.find(u=>u.type==="computer_screenshot");if(a)return a;const o=s.content.find(u=>u.type==="image_url");if(o)return{type:"computer_screenshot",image_url:typeof o.image_url=="string"?o.image_url:o.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:s.tool_call_id}:{type:"function_call_output",call_id:s.tool_call_id,id:s.id,output:typeof s.content!="string"?JSON.stringify(s.content):s.content}}if(n==="assistant"){const s=[];t.additional_kwargs.reasoning!=null&&(u=>typeof u=="object"&&u!=null&&"type"in u&&u.type==="reasoning")(t.additional_kwargs.reasoning)&&s.push(t.additional_kwargs.reasoning);let{content:i}=t;t.additional_kwargs.refusal!=null&&(typeof i=="string"&&(i=[{type:"output_text",text:i,annotations:[]}]),i=[...i,{type:"refusal",refusal:t.additional_kwargs.refusal}]),s.push({type:"message",role:"assistant",content:typeof i=="string"?i:i.flatMap(o=>o.type==="text"?{type:"output_text",text:o.text,annotations:o.annotations??[]}:o.type==="output_text"||o.type==="refusal"?o:[])});const a=t.additional_kwargs[Ca];if(di(t)&&t.tool_calls?.length?s.push(...t.tool_calls.map(o=>({type:"function_call",name:o.name,arguments:JSON.stringify(o.args),call_id:o.id,id:a?.[o.id]}))):t.additional_kwargs.tool_calls!=null&&s.push(...t.additional_kwargs.tool_calls.map(o=>({type:"function_call",name:o.function.name,call_id:o.id,id:a?.[o.id],arguments:o.function.arguments}))),t.additional_kwargs.tool_outputs!=null){const u=t.additional_kwargs.tool_outputs?.filter(c=>c.type==="computer_call");u.length>0&&s.push(...u)}return s}return n==="user"?{type:"message",role:"user",content:typeof t.content=="string"?t.content:t.content.flatMap(s=>{if(s.type==="text")return{type:"input_text",text:s.text};if(s.type==="image_url"){const i=typeof s.image_url=="string"?s.image_url:s.image_url.url,a=typeof s.image_url=="string"?"auto":s.image_url.detail;return{type:"input_image",image_url:i,detail:a}}return s.type==="input_text"||s.type==="input_image"||s.type==="input_file"?s:[]})}:[]})}function ay(r){if(r.error){const a=new Error(r.error.message);throw a.name=r.error.code,a}const e=[],t=[],n=[],s={model:r.model,created_at:r.created_at,id:r.id,incomplete_details:r.incomplete_details,metadata:r.metadata,object:r.object,status:r.status,user:r.user,model_name:r.model},i={};for(const a of r.output)if(a.type==="message")e.push(...a.content.flatMap(o=>o.type==="output_text"?("parsed"in o&&o.parsed!=null&&(i.parsed=o.parsed),{type:"text",text:o.text,annotations:o.annotations}):o.type==="refusal"?(i.refusal=o.refusal,[]):o));else if(a.type==="function_call"){const o={function:{name:a.name,arguments:a.arguments},id:a.call_id};try{t.push(nd(o,{returnId:!0}))}catch(u){let c;typeof u=="object"&&u!=null&&"message"in u&&typeof u.message=="string"&&(c=u.message),n.push(Qg(o,c))}i[Ca]??={},i[Ca][a.call_id]=a.id}else a.type==="reasoning"?i.reasoning=a:(i.tool_outputs??=[],i.tool_outputs.push(a));return new qs({id:r.id,content:e,tool_calls:t,invalid_tool_calls:n,usage_metadata:r.usage,additional_kwargs:i,response_metadata:s})}function nP(r){const e=[];let t={},n;const s=[],i={},a={};let o;if(r.type==="response.output_text.delta")e.push({type:"text",text:r.delta,index:r.content_index});else if(r.type==="response.output_text.annotation.added")e.push({type:"text",text:"",annotations:[r.annotation],index:r.content_index});else if(r.type==="response.output_item.added"&&r.item.type==="message")o=r.item.id;else if(r.type==="response.output_item.added"&&r.item.type==="function_call")s.push({type:"tool_call_chunk",name:r.item.name,args:r.item.arguments,id:r.item.id,index:r.output_index}),a[Ca]={[r.item.call_id]:r.item.id};else if(r.type==="response.output_item.done"&&(r.item.type==="web_search_call"||r.item.type==="file_search_call"||r.item.type==="computer_call"))a.tool_outputs=[r.item];else if(r.type==="response.created")i.id=r.response.id,i.model_name=r.response.model,i.model=r.response.model;else if(r.type==="response.completed"){const u=ay(r.response);n=r.response.usage,r.response.text?.format?.type==="json_schema"&&(a.parsed??=JSON.parse(u.text));for(const[c,l]of Object.entries(r.response))c!=="id"&&(i[c]=l)}else if(r.type==="response.function_call_arguments.delta")s.push({type:"tool_call_chunk",args:r.delta,index:r.output_index});else if(r.type==="response.web_search_call.completed"||r.type==="response.file_search_call.completed")t={tool_outputs:{id:r.item_id,type:r.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(r.type==="response.refusal.done")a.refusal=r.refusal;else return null;return new ur({text:e.map(u=>u.text).join(""),message:new bn({id:o,content:e,tool_call_chunks:s,usage_metadata:n,additional_kwargs:a,response_metadata:i}),generationInfo:t})}function Qu(r){return"type"in r&&r.type!=="function"}function rP(r){return r!=null&&typeof r=="object"&&"type"in r&&r.type!=="function"}function fp(r,e){return Kg(r)?e?.strict!==void 0?{...r,function:{...r.function,strict:e.strict}}:r:eP(r,e)}function sd(r){return r?.startsWith("o1")||r?.startsWith("o3")}class sP extends Tn{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming"]}constructor(e){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??Un("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=e?.configuration?.organization??Un("OPENAI_ORGANIZATION"),this.model=e?.model??e?.modelName??this.model,this.modelName=this.model,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.maxTokens=e?.maxCompletionTokens??e?.maxTokens,this.useResponsesApi=e?.useResponsesApi??this.useResponsesApi,this.model==="o1"&&(this.disableStreaming=!0),this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let n;return t?.strict!==void 0?n=t.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this.bind({tools:e.map(s=>Qu(s)?s:fp(s,{strict:n})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&zi(e.json_schema.schema)?qk(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){let n;if(e?.strict!==void 0?n=e.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this._useResponseApi(e)){const o={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e?.previous_response_id,truncation:e?.truncation,include:e?.include,tools:e?.tools?.length?e.tools.map(c=>Qu(c)?c:Kg(c)?{type:"function",name:c.function.name,parameters:c.function.parameters,description:c.function.description,strict:n}:null).filter(c=>c!==null):void 0,tool_choice:rP(e?.tool_choice)?e?.tool_choice:(()=>{const c=cp(e?.tool_choice);if(typeof c=="object"&&"type"in c)return{type:"function",name:c.function.name}})(),text:(()=>{if(e?.text)return e.text;const c=this.createResponseFormat(e?.response_format);return c?.type==="json_schema"?c.json_schema.schema!=null?{format:{type:"json_schema",schema:c.json_schema.schema,description:c.json_schema.description,name:c.json_schema.name,strict:c.json_schema.strict}}:void 0:{format:c}})(),parallel_tool_calls:e?.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,...this.modelKwargs},u=e?.reasoning_effort??this.reasoningEffort;return u!==void 0&&(o.reasoning={effort:u}),o}let s={};e?.stream_options!==void 0?s={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(s={stream_options:{include_usage:!0}});const i={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(o=>fp(o,{strict:n})):void 0,tool_choice:cp(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...s,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};e?.prediction!==void 0&&(i.prediction=e.prediction);const a=e?.reasoning_effort??this.reasoningEffort;return a!==void 0&&(i.reasoning_effort=a),sd(i.model)?i.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:i.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,i}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const n=e.tool_calls;switch(e.role){case"assistant":{const s=[],i=[];for(const u of n??[])try{s.push(nd(u,{returnId:!0}))}catch(c){i.push(Qg(u,c.message))}const a={function_call:e.function_call,tool_calls:n};this.__includeRawResponse!==void 0&&(a.__raw_response=t);const o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(a.audio=e.audio),new qs({content:e.content||"",tool_calls:s,invalid_tool_calls:i,additional_kwargs:a,response_metadata:o,id:t.id})}default:return new fi(e.content||"",e.role??"unknown")}}_convertOpenAIDeltaToBaseMessageChunk(e,t,n){const s=e.role??n,i=e.content??"";let a;e.function_call?a={function_call:e.function_call}:e.tool_calls?a={tool_calls:e.tool_calls}:a={},this.__includeRawResponse&&(a.__raw_response=t),e.audio&&(a.audio={...e.audio,index:t.choices[0].index});const o={usage:{...t.usage}};if(s==="user")return new io({content:i,response_metadata:o});if(s==="assistant"){const u=[];if(Array.isArray(e.tool_calls))for(const c of e.tool_calls)u.push({name:c.function?.name,args:c.function?.arguments,id:c.id,index:c.index,type:"tool_call_chunk"});return new bn({content:i,tool_call_chunks:u,additional_kwargs:a,id:t.id,response_metadata:o})}else return s==="system"?new Hs({content:i,response_metadata:o}):s==="developer"?new Hs({content:i,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):s==="function"?new ro({content:i,additional_kwargs:a,name:e.name,response_metadata:o}):s==="tool"?new Ul({content:i,additional_kwargs:a,tool_call_id:e.tool_call_id,response_metadata:o}):new no({content:i,role:s,response_metadata:o})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){if(this._useResponseApi(t)){const c=await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:dp(e,this.model),stream:!0},t);for await(const l of c){const d=nP(l);d!=null&&(yield d)}return}const s=lp(e,this.model),i={...this.invocationParams(t,{streaming:!0}),messages:s,stream:!0};let a;const o=await this.completionWithRetry(i,t);let u;for await(const c of o){const l=c?.choices?.[0];if(c.usage&&(u=c.usage),!l)continue;const{delta:d}=l;if(!d)continue;const f=this._convertOpenAIDeltaToBaseMessageChunk(d,c,a);a=d.role??a;const h={prompt:t.promptIndex??0,completion:l.index??0};if(typeof f.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const p={...h};l.finish_reason!=null&&(p.finish_reason=l.finish_reason,p.system_fingerprint=c.system_fingerprint,p.model_name=c.model),this.logprobs&&(p.logprobs=l.logprobs);const m=new ur({message:f,text:f.content,generationInfo:p});yield m,await n?.handleLLMNewToken(m.text??"",h,void 0,void 0,void 0,{chunk:m})}if(u){const c={...u.prompt_tokens_details?.audio_tokens!==null&&{audio:u.prompt_tokens_details?.audio_tokens},...u.prompt_tokens_details?.cached_tokens!==null&&{cache_read:u.prompt_tokens_details?.cached_tokens}},l={...u.completion_tokens_details?.audio_tokens!==null&&{audio:u.completion_tokens_details?.audio_tokens},...u.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:u.completion_tokens_details?.reasoning_tokens}};yield new ur({message:new bn({content:"",response_metadata:{usage:{...u}},usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens,...Object.keys(c).length>0&&{input_token_details:c},...Object.keys(l).length>0&&{output_token_details:l}}}),text:""})}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,n){const s=this.invocationParams(t);if(s.stream){const o=this._streamResponseChunks(e,t,n);let u;for await(const c of o)c.message.response_metadata={...c.generationInfo,...c.message.response_metadata},u=u?.concat(c)??c;return{generations:u?[u]:[],llmOutput:{estimatedTokenUsage:u?.message?.usage_metadata}}}const i=dp(e,this.model),a=await this.responseApiWithRetry({input:i,...s},{signal:t?.signal,...t?.options});return{generations:[{text:a.output_text,message:ay(a)}],llmOutput:{id:a.id,estimatedTokenUsage:a.usage?{promptTokens:a.usage.input_tokens,completionTokens:a.usage.output_tokens,totalTokens:a.usage.total_tokens}:void 0}}}_useResponseApi(e){const t=e?.tools?.some(Qu),n=e?.previous_response_id!=null||e?.text!=null||e?.truncation!=null||e?.include!=null;return this.useResponsesApi||t||n}async _generate(e,t,n){if(this._useResponseApi(t))return this._responseApiGenerate(e,t,n);const s={},i=this.invocationParams(t),a=lp(e,this.model);if(i.stream){const o=this._streamResponseChunks(e,t,n),u={};for await(const p of o){p.message.response_metadata={...p.generationInfo,...p.message.response_metadata};const m=p.generationInfo?.completion??0;u[m]===void 0?u[m]=p:u[m]=u[m].concat(p)}const c=Object.entries(u).sort(([p],[m])=>parseInt(p,10)-parseInt(m,10)).map(([p,m])=>m),{functions:l,function_call:d}=this.invocationParams(t),f=await this.getEstimatedTokenCountFromPrompt(e,l,d),h=await this.getNumTokensFromGenerations(c);return s.input_tokens=f,s.output_tokens=h,s.total_tokens=f+h,{generations:c,llmOutput:{estimatedTokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}else{let o;t.response_format&&t.response_format.type==="json_schema"?o=await this.betaParsedCompletionWithRetry({...i,stream:!1,messages:a},{signal:t?.signal,...t?.options}):o=await this.completionWithRetry({...i,stream:!1,messages:a},{signal:t?.signal,...t?.options});const{completion_tokens:u,prompt_tokens:c,total_tokens:l,prompt_tokens_details:d,completion_tokens_details:f}=o?.usage??{};u&&(s.output_tokens=(s.output_tokens??0)+u),c&&(s.input_tokens=(s.input_tokens??0)+c),l&&(s.total_tokens=(s.total_tokens??0)+l),(d?.audio_tokens!==null||d?.cached_tokens!==null)&&(s.input_token_details={...d?.audio_tokens!==null&&{audio:d?.audio_tokens},...d?.cached_tokens!==null&&{cache_read:d?.cached_tokens}}),(f?.audio_tokens!==null||f?.reasoning_tokens!==null)&&(s.output_token_details={...f?.audio_tokens!==null&&{audio:f?.audio_tokens},...f?.reasoning_tokens!==null&&{reasoning:f?.reasoning_tokens}});const h=[];for(const p of o?.choices??[]){const g={text:p.message?.content??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(p.message??{role:"assistant"},o)};g.generationInfo={...p.finish_reason?{finish_reason:p.finish_reason}:{},...p.logprobs?{logprobs:p.logprobs}:{}},di(g.message)&&(g.message.usage_metadata=s),g.message=new qs(Object.fromEntries(Object.entries(g.message).filter(([y])=>!y.startsWith("lc_")))),h.push(g)}return{generations:h,llmOutput:{tokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&n!=="auto"){const i=Qk(t);s+=await this.getNumTokens(i),s+=9}return t&&e.find(i=>i._getType()==="system")&&(s-=4),n==="none"?s+=1:typeof n=="object"&&(s+=await this.getNumTokens(n.name)+4),s}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async n=>n.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([n.message])).countPerMessage[0]:await this.getNumTokens(n.message.content)))).reduce((n,s)=>n+s,0)}async getNumTokensFromMessages(e){let t=0,n=0,s=0;this.model==="gpt-3.5-turbo-0301"?(n=4,s=-1):(n=3,s=1);const i=await Promise.all(e.map(async a=>{const o=await this.getNumTokens(a.content),u=await this.getNumTokens(rd(a)),c=a.name!==void 0?s+await this.getNumTokens(a.name):0;let l=o+n+u+c;const d=a;if(d._getType()==="function"&&(l-=2),d.additional_kwargs?.function_call&&(l+=3),d?.additional_kwargs.function_call?.name&&(l+=await this.getNumTokens(d.additional_kwargs.function_call?.name)),d.additional_kwargs.function_call?.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse(d.additional_kwargs.function_call?.arguments)))}catch(f){console.error("Error parsing function arguments",f,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens(d.additional_kwargs.function_call?.arguments)}return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,n)}catch(s){throw Yu(s)}})}async responseApiWithRetry(e,t){return this.caller.call(async()=>{const n=this._getClientOptions(t);try{return e.text?.format?.type==="json_schema"&&!e.stream?await this.client.responses.parse(e,n):await this.client.responses.create(e,n)}catch(s){throw Yu(s)}})}async betaParsedCompletionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,n)}catch(s){throw Yu(s)}})}_getClientOptions(e){if(!this.client){const n={baseURL:this.clientConfig.baseURL},s=Vk(n),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new ee(i)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,n)=>(n&&n.tokenUsage&&(t.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,s,i,a;iP(e)?(n=e.schema,s=e.name,i=e.method,a=e.includeRaw):(n=e,s=t?.name,i=t?.method,a=t?.includeRaw);let o,u;if(t?.strict!==void 0&&i==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"?i===void 0&&(i="jsonSchema"):i==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`),i==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),zi(n)?u=rp.fromZodSchema(n):u=new sp;else if(i==="jsonSchema")if(o=this.bind({response_format:{type:"json_schema",json_schema:{name:s??"extract",description:n.description,schema:n,strict:t?.strict}}}),zi(n)){const f=rp.fromZodSchema(n);u=as.from(h=>"parsed"in h.additional_kwargs?h.additional_kwargs.parsed:f)}else u=new sp;else{let f=s??"extract";if(zi(n)){const h=Bg(n);o=this.bind({tools:[{type:"function",function:{name:f,description:h.description,parameters:h}}],tool_choice:{type:"function",function:{name:f}},...t?.strict!==void 0?{strict:t.strict}:{}}),u=new ip({returnSingle:!0,keyName:f,zodSchema:n})}else{let h;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(h=n,f=n.name):(f=n.title??f,h={name:f,description:n.description??"",parameters:n}),o=this.bind({tools:[{type:"function",function:h}],tool_choice:{type:"function",function:{name:f}},...t?.strict!==void 0?{strict:t.strict}:{}}),u=new ip({returnSingle:!0,keyName:f})}}if(!a)return o.pipe(u);const c=Js.assign({parsed:(f,h)=>u.invoke(f.raw,h)}),l=Js.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[l]});return wt.from([{raw:o},d])}}function zi(r){return typeof r?.parse=="function"}function iP(r){return r!==void 0&&typeof r.schema=="object"}let $a=null;function aP(r){return $a=new sP({openAIApiKey:r.apiKey,configuration:{baseURL:r.baseUrl},modelName:r.model,temperature:.7}),$a}function Gi(){if(!$a)throw new Error("LLM client not initialized. Call createLLMClient() first.");return $a}const qi=3,oP=1e3;async function ec(r,e){let t=null;for(let n=0;n<qi;n++)try{return await r()}catch(s){if(t=s instanceof Error?s:new Error(String(s)),console.warn(`[${e}] Attempt ${n+1}/${qi} failed:`,t.message),n<qi-1){const i=oP*(n+1);await new Promise(a=>setTimeout(a,i))}}throw new Error(`[${e}] All ${qi} attempts failed: ${t?.message}`)}const uP=Hn({targetId:jt().describe("è¦æ€æ­»çš„çŽ©å®¶IDï¼Œå¿…é¡»æ˜¯å­˜æ´»çŽ©å®¶åˆ—è¡¨ä¸­çš„æŸä¸€ä¸ª"),reasoning:jt().describe("é€‰æ‹©è¯¥ç›®æ ‡çš„å†…éƒ¨æŽ¨ç†ï¼Œä¸ä¼šå…¬å¼€")}),cP=Hn({targetId:jt().describe("è¦æŸ¥éªŒèº«ä»½çš„çŽ©å®¶ID"),reasoning:jt().describe("é€‰æ‹©è¯¥ç›®æ ‡çš„å†…éƒ¨æŽ¨ç†")}),lP=Hn({action:rw(["save","poison","skip"]).describe("save=ä½¿ç”¨è§£è¯, poison=ä½¿ç”¨æ¯’è¯, skip=ä¸è¡ŒåŠ¨"),poisonTarget:jt().optional().describe("è‹¥ action=poisonï¼Œå¡«å†™è¦æ¯’æ€çš„çŽ©å®¶ID"),reasoning:jt().describe("å†³ç­–çš„å†…éƒ¨æŽ¨ç†")}),dP=Hn({targetId:jt().describe("æŠ•ç¥¨æ”¾é€çš„çŽ©å®¶IDï¼Œå¿…é¡»æ˜¯å­˜æ´»çŽ©å®¶ä¹‹ä¸€"),reasoning:jt().describe("æŠ•ç¥¨çš„å†…éƒ¨æŽ¨ç†")}),fP=Hn({targetId:jt().describe("çŒŽäººå¼€æžªå¸¦èµ°çš„çŽ©å®¶ID"),reasoning:jt().describe("é€‰æ‹©è¯¥ç›®æ ‡çš„å†…éƒ¨æŽ¨ç†")});class hP{constructor(e){this.player=e}async nightAction(e){const t=this.player.role;if(t==="villager"||t==="hunter")return{type:"none"};const n={werewolf:uP,seer:cP,witch:lP},s={werewolf:mr.wolfKill,seer:mr.seerInspect,witch:mr.witchDecision},i=n[t],a=s[t];if(!i||!a)return{type:"none"};const o=Gi(),u=_i(this.player,e.gameLog),c=e.alivePlayers.filter(g=>g.id!==this.player.id).map(g=>`${g.id}(${g.name})`).join("ã€");let l=a.replace("{{aliveTargets}}",c);if(t==="witch"&&e.nightKillTarget){const g=e.alivePlayers.find(_=>_.id===e.nightKillTarget);l=l.replace("{{killedPlayer}}",g?`${g.id}(${g.name})`:e.nightKillTarget);const y=this.player.memory.witchPotions;l=l.replace("{{hasAntidote}}",y?.antidote?"æœ‰":"æ— ").replace("{{hasPoison}}",y?.poison?"æœ‰":"æ— ")}const f=[{role:"system",content:yi(this.player.systemPrompt,this.player,e.allPlayers)},...u.map(g=>({role:g.senderId==="system"?"system":"user",content:`[${g.senderId}] ${g.content}`})),{role:"user",content:l}],h=await ec(async()=>o.withStructuredOutput(i,{method:"functionCalling"}).invoke(f),`nightAction:${t}:${this.player.id}`),p=Ht(),m=Rt();return h.reasoning&&p.addMessage("reasoning",this.player.id,h.reasoning,m.phase,m.round),this.mapToNightResult(t,h)}async speak(e){const t=Gi(),n=_i(this.player,e.gameLog),s=yi(this.player.systemPrompt,this.player,e.allPlayers),i=mr.daySpeech.replace("{{aliveList}}",e.alivePlayers.map(d=>d.id).join("ã€")),a=[{role:"system",content:s},...n.map(d=>({role:d.senderId==="system"?"system":"user",content:`[${d.senderId}] ${d.content}`})),{role:"user",content:i}],o=Ht(),u=crypto.randomUUID();o.beginStreamMessage(u,this.player.id,"day",e.round);let c="";const l=await t.stream(a);for await(const d of l){const f=typeof d.content=="string"?d.content:"";c+=f,o.appendStreamChunk(u,f)}return o.finalizeStreamMessage(u),c}async vote(e){const t=Gi(),n=_i(this.player,e.gameLog),s=yi(this.player.systemPrompt,this.player,e.allPlayers),i=e.alivePlayers.filter(d=>d.id!==this.player.id).map(d=>d.id).join("ã€"),a=mr.vote.replace("{{aliveTargets}}",i),o=[{role:"system",content:s},...n.map(d=>({role:d.senderId==="system"?"system":"user",content:`[${d.senderId}] ${d.content}`})),{role:"user",content:a}],u=await ec(async()=>t.withStructuredOutput(dP,{method:"functionCalling"}).invoke(o),`vote:${this.player.id}`),c=Ht(),l=Rt();return u.reasoning&&c.addMessage("reasoning",this.player.id,u.reasoning,l.phase,l.round),u.targetId}async hunterShot(e){const t=Gi(),n=_i(this.player,e.gameLog),s=yi(this.player.systemPrompt,this.player,e.allPlayers),i=e.alivePlayers.filter(d=>d.id!==this.player.id).map(d=>`${d.id}(${d.name})`).join("ã€"),a=mr.hunterShot.replace("{{aliveTargets}}",i),o=[{role:"system",content:s},...n.map(d=>({role:d.senderId==="system"?"system":"user",content:`[${d.senderId}] ${d.content}`})),{role:"user",content:a}],u=await ec(async()=>t.withStructuredOutput(fP,{method:"functionCalling"}).invoke(o),`hunterShot:${this.player.id}`),c=Ht(),l=Rt();return u.reasoning&&c.addMessage("reasoning",this.player.id,u.reasoning,l.phase,l.round),u.targetId}mapToNightResult(e,t){switch(e){case"werewolf":return{type:"kill",targetId:t.targetId};case"seer":return{type:"inspect",targetId:t.targetId};case"witch":{const n=t.action;return{type:"witch",action:n,targetId:n==="poison"?t.poisonTarget:void 0}}default:return{type:"none"}}}}function os(r){return r.isHuman?new Ib(r):new hP(r)}async function hp(r,e){const t=r.players.find(i=>i.id===e&&i.role==="hunter");return t?{hunterShotTarget:await os(t).hunterShot({player:t,alivePlayers:r.alivePlayers,allPlayers:r.players,gameLog:{rounds:[]}})}:{hunterShotTarget:null}}class hr extends Error{constructor(e,t){let n=e??"";t?.lc_error_code&&(n=`${n}

Troubleshooting URL: https://langchain-ai.github.io/langgraphjs/troubleshooting/errors/${t.lc_error_code}/
`),super(n),Object.defineProperty(this,"lc_error_code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_error_code=t?.lc_error_code}}class oy extends hr{get is_bubble_up(){return!0}}class pP extends hr{constructor(e,t){super(e,t),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}}class pp extends hr{constructor(e,t){super(e,t),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}}class js extends oy{constructor(e,t){super(JSON.stringify(e,null,2),t),Object.defineProperty(this,"interrupts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}}class uy extends js{constructor(e,t){super([{value:e,when:"during"}],t),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}}class cy extends oy{constructor(e){super(),Object.defineProperty(this,"command",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="ParentCommand",this.command=e}static get unminifiable_name(){return"ParentCommand"}}function mP(r){return r!==void 0&&r.name===cy.unminifiable_name}function sa(r){return r!==void 0&&r.is_bubble_up===!0}function Ps(r){return r!==void 0&&[js.unminifiable_name,uy.unminifiable_name].includes(r.name)}class mp extends hr{constructor(e,t){super(e,t),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}}class ft extends hr{constructor(e,t){super(e,t),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}}class xe extends hr{constructor(e,t){super(e,t),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}}class gP extends hr{constructor(e,t){super(e,t),this.name="UnreachableNodeError"}static get unminifiable_name(){return"UnreachableNodeError"}}function ly(r){return a0({clockseq:r})}function Cr(r,e){const t=e.replace(/-/g,"").match(/.{2}/g).map(n=>parseInt(n,16));return Tr(r,new Uint8Array(t))}const yP="__error__",ia="__scheduled__",_P="__interrupt__",bP="__resume__";var wP=Object.prototype.toString,us=Array.isArray||function(e){return wP.call(e)==="[object Array]"};function id(r){return typeof r=="function"}function vP(r){return us(r)?"array":typeof r}function tc(r){return r.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function gp(r,e){return r!=null&&typeof r=="object"&&e in r}function SP(r,e){return r!=null&&typeof r!="object"&&r.hasOwnProperty&&r.hasOwnProperty(e)}var EP=RegExp.prototype.test;function xP(r,e){return EP.call(r,e)}var OP=/\S/;function kP(r){return!xP(OP,r)}var PP={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function AP(r){return String(r).replace(/[&<>"'`=\/]/g,function(t){return PP[t]})}var TP=/\s*/,IP=/\s+/,yp=/\s*=/,RP=/\s*\}/,CP=/#|\^|\/|>|\{|&|=|!/;function $P(r,e){if(!r)return[];var t=!1,n=[],s=[],i=[],a=!1,o=!1,u="",c=0;function l(){if(a&&!o)for(;i.length;)delete s[i.pop()];else i=[];a=!1,o=!1}var d,f,h;function p(O){if(typeof O=="string"&&(O=O.split(IP,2)),!us(O)||O.length!==2)throw new Error("Invalid tags: "+O);d=new RegExp(tc(O[0])+"\\s*"),f=new RegExp("\\s*"+tc(O[1])),h=new RegExp("\\s*"+tc("}"+O[1]))}p(e||Jt.tags);for(var m=new mi(r),g,y,_,b,v,w;!m.eos();){if(g=m.pos,_=m.scanUntil(d),_)for(var E=0,T=_.length;E<T;++E)b=_.charAt(E),kP(b)?(i.push(s.length),u+=b):(o=!0,t=!0,u+=" "),s.push(["text",b,g,g+1]),g+=1,b===`
`&&(l(),u="",c=0,t=!1);if(!m.scan(d))break;if(a=!0,y=m.scan(CP)||"name",m.scan(TP),y==="="?(_=m.scanUntil(yp),m.scan(yp),m.scanUntil(f)):y==="{"?(_=m.scanUntil(h),m.scan(RP),m.scanUntil(f),y="&"):_=m.scanUntil(f),!m.scan(f))throw new Error("Unclosed tag at "+m.pos);if(y==">"?v=[y,_,g,m.pos,u,c,t]:v=[y,_,g,m.pos],c++,s.push(v),y==="#"||y==="^")n.push(v);else if(y==="/"){if(w=n.pop(),!w)throw new Error('Unopened section "'+_+'" at '+g);if(w[1]!==_)throw new Error('Unclosed section "'+w[1]+'" at '+g)}else y==="name"||y==="{"||y==="&"?o=!0:y==="="&&p(_)}if(l(),w=n.pop(),w)throw new Error('Unclosed section "'+w[1]+'" at '+m.pos);return jP(NP(s))}function NP(r){for(var e=[],t,n,s=0,i=r.length;s<i;++s)t=r[s],t&&(t[0]==="text"&&n&&n[0]==="text"?(n[1]+=t[1],n[3]=t[3]):(e.push(t),n=t));return e}function jP(r){for(var e=[],t=e,n=[],s,i,a=0,o=r.length;a<o;++a)switch(s=r[a],s[0]){case"#":case"^":t.push(s),n.push(s),t=s[4]=[];break;case"/":i=n.pop(),i[5]=s[2],t=n.length>0?n[n.length-1][4]:e;break;default:t.push(s)}return e}function mi(r){this.string=r,this.tail=r,this.pos=0}mi.prototype.eos=function(){return this.tail===""};mi.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n};mi.prototype.scanUntil=function(e){var t=this.tail.search(e),n;switch(t){case-1:n=this.tail,this.tail="";break;case 0:n="";break;default:n=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=n.length,n};function Gr(r,e){this.view=r,this.cache={".":this.view},this.parent=e}Gr.prototype.push=function(e){return new Gr(e,this)};Gr.prototype.lookup=function(e){var t=this.cache,n;if(t.hasOwnProperty(e))n=t[e];else{for(var s=this,i,a,o,u=!1;s;){if(e.indexOf(".")>0)for(i=s.view,a=e.split("."),o=0;i!=null&&o<a.length;)o===a.length-1&&(u=gp(i,a[o])||SP(i,a[o])),i=i[a[o++]];else i=s.view[e],u=gp(s.view,e);if(u){n=i;break}s=s.parent}t[e]=n}return id(n)&&(n=n.call(this.view)),n};function rt(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}rt.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};rt.prototype.parse=function(e,t){var n=this.templateCache,s=e+":"+(t||Jt.tags).join(":"),i=typeof n<"u",a=i?n.get(s):void 0;return a==null&&(a=$P(e,t),i&&n.set(s,a)),a};rt.prototype.render=function(e,t,n,s){var i=this.getConfigTags(s),a=this.parse(e,i),o=t instanceof Gr?t:new Gr(t,void 0);return this.renderTokens(a,o,n,e,s)};rt.prototype.renderTokens=function(e,t,n,s,i){for(var a="",o,u,c,l=0,d=e.length;l<d;++l)c=void 0,o=e[l],u=o[0],u==="#"?c=this.renderSection(o,t,n,s,i):u==="^"?c=this.renderInverted(o,t,n,s,i):u===">"?c=this.renderPartial(o,t,n,i):u==="&"?c=this.unescapedValue(o,t):u==="name"?c=this.escapedValue(o,t,i):u==="text"&&(c=this.rawValue(o)),c!==void 0&&(a+=c);return a};rt.prototype.renderSection=function(e,t,n,s,i){var a=this,o="",u=t.lookup(e[1]);function c(f){return a.render(f,t,n,i)}if(u){if(us(u))for(var l=0,d=u.length;l<d;++l)o+=this.renderTokens(e[4],t.push(u[l]),n,s,i);else if(typeof u=="object"||typeof u=="string"||typeof u=="number")o+=this.renderTokens(e[4],t.push(u),n,s,i);else if(id(u)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");u=u.call(t.view,s.slice(e[3],e[5]),c),u!=null&&(o+=u)}else o+=this.renderTokens(e[4],t,n,s,i);return o}};rt.prototype.renderInverted=function(e,t,n,s,i){var a=t.lookup(e[1]);if(!a||us(a)&&a.length===0)return this.renderTokens(e[4],t,n,s,i)};rt.prototype.indentPartial=function(e,t,n){for(var s=t.replace(/[^ \t]/g,""),i=e.split(`
`),a=0;a<i.length;a++)i[a].length&&(a>0||!n)&&(i[a]=s+i[a]);return i.join(`
`)};rt.prototype.renderPartial=function(e,t,n,s){if(n){var i=this.getConfigTags(s),a=id(n)?n(e[1]):n[e[1]];if(a!=null){var o=e[6],u=e[5],c=e[4],l=a;u==0&&c&&(l=this.indentPartial(a,c,o));var d=this.parse(l,i);return this.renderTokens(d,t,n,l,s)}}};rt.prototype.unescapedValue=function(e,t){var n=t.lookup(e[1]);if(n!=null)return n};rt.prototype.escapedValue=function(e,t,n){var s=this.getConfigEscape(n)||Jt.escape,i=t.lookup(e[1]);if(i!=null)return typeof i=="number"&&s===Jt.escape?String(i):s(i)};rt.prototype.rawValue=function(e){return e[1]};rt.prototype.getConfigTags=function(e){return us(e)?e:e&&typeof e=="object"?e.tags:void 0};rt.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!us(e))return e.escape};var Jt={tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0},ad=new rt;Jt.clearCache=function(){return ad.clearCache()};Jt.parse=function(e,t){return ad.parse(e,t)};Jt.render=function(e,t,n,s){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+vP(e)+'" was given as the first argument for mustache#render(template, view, partials)');return ad.render(e,t,n,s)};Jt.escape=AP;Jt.Scanner=mi;Jt.Context=Gr;Jt.Writer=rt;function od(r){if(typeof r!="object"||r===null)return r;const e=Array.isArray(r)?[]:{};for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=od(r[t]));return e}function dy(){return{v:1,id:ly(-2),ts:new Date().toISOString(),channel_values:{},channel_versions:{},versions_seen:{},pending_sends:[]}}function Na(r){return{v:r.v,id:r.id,ts:r.ts,channel_values:{...r.channel_values},channel_versions:{...r.channel_versions},versions_seen:od(r.versions_seen),pending_sends:[...r.pending_sends]}}function fy(r,e){return typeof r=="number"&&typeof e=="number"?Math.sign(r-e):String(r).localeCompare(String(e))}function _p(...r){return r.reduce((e,t,n)=>n===0?t:fy(e,t)>=0?e:t)}const bp={[yP]:-1,[ia]:-2,[_P]:-3,[bP]:-4};class ps extends Error{constructor(e){super(e),this.name="InvalidNamespaceError"}}function LP(r){if(r.length===0)throw new ps("Namespace cannot be empty.");for(const e of r){if(typeof e!="string")throw new ps(`Invalid namespace label '${e}' found in ${r}. Namespace labels must be strings, but got ${typeof e}.`);if(e.includes("."))throw new ps(`Invalid namespace label '${e}' found in ${r}. Namespace labels cannot contain periods ('.').`);if(e==="")throw new ps(`Namespace labels cannot be empty strings. Got ${e} in ${r}`)}if(r[0]==="langgraph")throw new ps(`Root label for namespace cannot be "langgraph". Got: ${r}`)}class MP{async get(e,t){return(await this.batch([{namespace:e,key:t}]))[0]}async search(e,t={}){const{filter:n,limit:s=10,offset:i=0,query:a}=t;return(await this.batch([{namespacePrefix:e,filter:n,limit:s,offset:i,query:a}]))[0]}async put(e,t,n,s){LP(e),await this.batch([{namespace:e,key:t,value:n,index:s}])}async delete(e,t){await this.batch([{namespace:e,key:t,value:null}])}async listNamespaces(e={}){const{prefix:t,suffix:n,maxDepth:s,limit:i=100,offset:a=0}=e,o=[];return t&&o.push({matchType:"prefix",path:t}),n&&o.push({matchType:"suffix",path:n}),(await this.batch([{matchConditions:o.length?o:void 0,maxDepth:s,limit:i,offset:a}]))[0]}start(){}stop(){}}const DP=r=>"lg_name"in r&&r.lg_name==="AsyncBatchedStore"?r.store:r;class UP extends MP{constructor(e){super(),Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"AsyncBatchedStore"}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"nextKey",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"running",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"processingTask",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.store=DP(e)}get isRunning(){return this.running}async batch(e){throw new Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,t){return this.enqueueOperation({namespace:e,key:t})}async search(e,t){const{filter:n,limit:s=10,offset:i=0,query:a}=t||{};return this.enqueueOperation({namespacePrefix:e,filter:n,limit:s,offset:i,query:a})}async put(e,t,n){return this.enqueueOperation({namespace:e,key:t,value:n})}async delete(e,t){return this.enqueueOperation({namespace:e,key:t,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise((t,n)=>{const s=this.nextKey;this.nextKey+=1,this.queue.set(s,{operation:e,resolve:t,reject:n})})}async processBatchQueue(){for(;this.running;){if(await new Promise(t=>{setTimeout(t,0)}),this.queue.size===0)continue;const e=new Map(this.queue);this.queue.clear();try{const t=Array.from(e.values()).map(({operation:s})=>s),n=await this.store.batch(t);e.forEach(({resolve:s},i)=>{const a=Array.from(e.keys()).indexOf(i);s(n[a])})}catch(t){e.forEach(({reject:n})=>{n(t)})}}}toJSON(){return{queue:this.queue,nextKey:this.nextKey,running:this.running,store:"[LangGraphStore]"}}}function bo(r){return r!=null&&r.lg_is_channel===!0}class wo{constructor(){Object.defineProperty(this,"ValueType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"UpdateType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lg_is_channel",{enumerable:!0,configurable:!0,writable:!0,value:!0})}consume(){return!1}}function ja(r,e){const t=Object.fromEntries(Object.entries(r).filter(([,s])=>bo(s))),n={};for(const s in t)if(Object.prototype.hasOwnProperty.call(t,s)){const i=e.channel_values[s];n[s]=t[s].fromCheckpoint(i)}return n}function Xn(r,e,t){let n;if(e===void 0)n=r.channel_values;else{n={};for(const s of Object.keys(e))try{n[s]=e[s].checkpoint()}catch(i){if(i.name!==ft.unminifiable_name)throw i}}return{v:1,id:ly(t),ts:new Date().toISOString(),channel_values:n,channel_versions:{...r.channel_versions},versions_seen:od(r.versions_seen),pending_sends:r.pending_sends??[]}}class Ks extends wo{constructor(e,t){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"BinaryOperatorAggregate"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"operator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"initialValueFactory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.operator=e,this.initialValueFactory=t,this.value=t?.()}fromCheckpoint(e){const t=new Ks(this.operator,this.initialValueFactory);return typeof e<"u"&&(t.value=e),t}update(e){let t=e;if(!t.length)return!1;this.value===void 0&&([this.value]=t,t=t.slice(1));for(const n of t)this.value!==void 0&&(this.value=this.operator(this.value,n));return!0}get(){if(this.value===void 0)throw new ft;return this.value}checkpoint(){if(this.value===void 0)throw new ft;return this.value}}class gi extends wo{constructor(){super(...arguments),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"LastValue"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]})}fromCheckpoint(e){const t=new gi;return typeof e<"u"&&(t.value=[e]),t}update(e){if(e.length===0)return!1;if(e.length!==1)throw new xe("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=[e[e.length-1]],!0}get(){if(this.value.length===0)throw new ft;return this.value[0]}checkpoint(){if(this.value.length===0)throw new ft;return this.value[0]}}const Se="__start__",le="__end__",pn="__input__",FP="__copy__",St="__error__",Lr="__pregel_send",ud="__pregel_call",er="__pregel_read",je="__pregel_checkpointer",In="__pregel_resuming",Ls="__pregel_task_id",La="__pregel_stream",BP="__pregel_resume_value",tr="__pregel_scratchpad",aa="__pregel_previous",zP="checkpoint_id",Wc="checkpoint_ns",GP="__pregel_node_finished",At="checkpoint_map",wp="__pregel_abort_signals",Oe="__interrupt__",Nt="__resume__",cd="__no_writes__",Xs="__return__",nc="__previous__",vr="__pregel_runtime_placeholder__",Re="langsmith:hidden",qP="langsmith:nostream",vp="__self__",qr="__pregel_tasks",Tt="__pregel_push",oa="__pregel_pull",It="00000000-0000-0000-0000-000000000000",HP=[Re,pn,Oe,Nt,St,cd,qr,Lr,er,je,La,In,Ls,ud,BP,tr,aa,At,Wc,zP],dt="|",nr=":";function Zc(r){const e=r;return e!=null&&typeof e.node=="string"&&e.args!==void 0}class Ma{constructor(e,t){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Send"}),Object.defineProperty(this,"node",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"args",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.node=e,this.args=Ys(t)}toJSON(){return{lg_name:this.lg_name,node:this.node,args:this.args}}}function Ot(r){return r instanceof Ma}class Wt{constructor(e){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Command"}),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"graph",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"update",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resume",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"goto",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.resume=e.resume,this.graph=e.graph,this.update=e.update,e.goto&&(this.goto=Array.isArray(e.goto)?Ys(e.goto):[Ys(e.goto)])}_updateAsTuples(){return this.update&&typeof this.update=="object"&&!Array.isArray(this.update)?Object.entries(this.update):Array.isArray(this.update)&&this.update.every(e=>Array.isArray(e)&&e.length===2&&typeof e[0]=="string")?this.update:[["__root__",this.update]]}toJSON(){let e;return typeof this.goto=="string"?e=this.goto:Ot(this.goto)?e=this.goto.toJSON():e=this.goto?.map(t=>typeof t=="string"?t:t.toJSON()),{lg_name:this.lg_name,update:this.update,resume:this.resume,goto:e}}}Object.defineProperty(Wt,"PARENT",{enumerable:!0,configurable:!0,writable:!0,value:"__parent__"});function ot(r){return typeof r!="object"||r==null?!1:"lg_name"in r&&r.lg_name==="Command"}function Ys(r,e=new Map){if(r!=null&&typeof r=="object"){if(e.has(r))return e.get(r);let t;if(Array.isArray(r))t=[],e.set(r,t),r.forEach((n,s)=>{t[s]=Ys(n,e)});else if(ot(r)&&!(r instanceof Wt))t=new Wt(r),e.set(r,t);else if(Zc(r)&&!(r instanceof Ma))t=new Ma(r.node,r.args),e.set(r,t);else if(ot(r)||Ot(r))t=r,e.set(r,t);else if("lc_serializable"in r&&r.lc_serializable)t=r,e.set(r,t);else{t={},e.set(r,t);for(const[n,s]of Object.entries(r))t[n]=Ys(s,e)}return t}return r}class VP{constructor(e,t){Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_promises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"lg_is_managed_value",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.config=e}static async initialize(e,t){throw new Error("Not implemented")}async promises(){return Promise.all(this._promises)}addPromise(e){this._promises.push(e)}}const WP="__channel_key_placeholder__";class ZP extends Map{constructor(e){super(e?Array.from(e):void 0)}replaceRuntimeValues(e,t){if(!(this.size===0||!t)&&!Array.from(this.values()).every(n=>!n.runtime)){if(typeof t=="object"&&!Array.isArray(t))for(const[n,s]of Object.entries(t))for(const[i,a]of this.entries())a.runtime&&a.call(e)===s&&(t[n]={[vr]:i});else if(typeof t=="object"&&"constructor"in t)for(const n of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{const s=t[n];for(const[i,a]of this.entries())a.runtime&&a.call(e)===s&&(t[n]={[vr]:i})}catch(s){if(s.name!==TypeError.name)throw s}}}replaceRuntimePlaceholders(e,t){if(!(this.size===0||!t)&&!Array.from(this.values()).every(n=>!n.runtime)){if(typeof t=="object"&&!Array.isArray(t)){for(const[n,s]of Object.entries(t))if(typeof s=="object"&&s!==null&&vr in s){const i=s[vr];typeof i=="string"&&(t[n]=this.get(i)?.call(e))}}else if(typeof t=="object"&&"constructor"in t)for(const n of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{const s=t[n];if(typeof s=="object"&&s!==null&&vr in s){const i=this.get(s[vr]);i&&(t[n]=i.call(e))}}catch(s){if(s.name!==TypeError.name)throw s}}}}function vo(r){return!!(typeof r=="object"&&r&&"cls"in r&&"params"in r)}class ld extends VP{call(){}static async initialize(e,t){return Promise.resolve(new ld(e))}}class JP{constructor(e){Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"AnnotationRoot"}),Object.defineProperty(this,"spec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.spec=e}}const Be=function(r){return vo(r)?r:r?Jc(r):new gi};Be.Root=r=>new JP(r);function Jc(r){return typeof r=="object"&&r&&"reducer"in r&&r.reducer?new Ks(r.reducer,r.default):typeof r=="object"&&r&&"value"in r&&r.value?new Ks(r.value,r.default):new gi}const KP=["tags","metadata","callbacks","configurable"],XP=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer","interruptBefore","interruptAfter","signal"],YP=25;function hy(...r){const e={tags:[],metadata:{},callbacks:void 0,recursionLimit:YP,configurable:{}},t=Ct.getRunnableConfig();if(t!==void 0){for(const[n,s]of Object.entries(t))if(s!==void 0)if(KP.includes(n)){let i;Array.isArray(s)?i=[...s]:typeof s=="object"?n==="callbacks"&&"copy"in s&&typeof s.copy=="function"?i=s.copy():i={...s}:i=s,e[n]=i}else e[n]=s}for(const n of r)if(n!==void 0)for(const[s,i]of Object.entries(n))i!==void 0&&XP.includes(s)&&(e[s]=i);for(const[n,s]of Object.entries(e.configurable))e.metadata=e.metadata??{},!n.startsWith("__")&&(typeof s=="string"||typeof s=="number"||typeof s=="boolean")&&!(n in e.metadata)&&(e.metadata[n]=s);return e}function rc(r){return r.split(dt).filter(e=>!e.match(/^\d+$/)).map(e=>e.split(nr)[0]).join(dt)}function QP(r){const e=r.split(dt);for(;e.length>1&&e[e.length-1].match(/^\d+$/);)e.pop();return e.slice(0,-1).join(dt)}class pr extends be{constructor(e){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"recurse",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.trace=e.trace??this.trace,this.recurse=e.recurse??this.recurse}async _tracedInvoke(e,t,n){return new Promise((s,i)=>{const a=ke(t,{callbacks:n?.getChild()});Ct.runWithConfig(a,async()=>{try{const o=await this.func(e,a);s(o)}catch(o){i(o)}})})}async invoke(e,t){let n;const s=hy(t),i=sn(this.config,s);return this.trace?n=await this._callWithConfig(this._tracedInvoke,e,i):n=await Ct.runWithConfig(i,async()=>this.func(e,i)),be.isRunnable(n)&&this.recurse?await Ct.runWithConfig(i,async()=>n.invoke(e,i)):n}}function*kn(r,e){if(e===void 0)yield*r;else for(const t of r)yield[e,t]}async function Rn(r){const e=[];for await(const t of await r)e.push(t);return e}function As(r){const e=[];for(const t of r)e.push(t);return e}function ms(r,e){return r?"configurable"in r?{...r,configurable:{...r.configurable,...e}}:{...r,configurable:e}:{configurable:e}}function eA(r){return typeof r=="object"&&r?.[Symbol.for("LG_SKIP_WRITE")]!==void 0}const rr={[Symbol.for("LG_PASSTHROUGH")]:!0};function Hi(r){return typeof r=="object"&&r?.[Symbol.for("LG_PASSTHROUGH")]!==void 0}const sc=Symbol("IS_WRITER");class Ge extends pr{constructor(e,t){const n=`ChannelWrite<${e.map(s=>Ot(s)?s.node:"channel"in s?s.channel:"...").join(",")}>`;super({writes:e,name:n,tags:t,func:async(s,i)=>this._write(s,i??{})}),Object.defineProperty(this,"writes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.writes=e}async _write(e,t){const n=this.writes.map(s=>ic(s)&&Hi(s.value)?{mapper:s.mapper,value:e}:ua(s)&&Hi(s.value)?{channel:s.channel,value:e,skipNone:s.skipNone,mapper:s.mapper}:s);return await Ge.doWrite(t,n),e}static async doWrite(e,t){for(const i of t){if(ua(i)){if(i.channel===qr)throw new xe("Cannot write to the reserved channel TASKS");if(Hi(i.value))throw new xe("PASSTHROUGH value must be replaced")}if(ic(i)&&Hi(i.value))throw new xe("PASSTHROUGH value must be replaced")}const n=[];for(const i of t)if(Ot(i))n.push([qr,i]);else if(ic(i)){const a=await i.mapper.invoke(i.value,e);a!=null&&a.length>0&&n.push(...a)}else if(ua(i)){const a=i.mapper!==void 0?await i.mapper.invoke(i.value,e):i.value;if(eA(a)||i.skipNone&&a===void 0)continue;n.push([i.channel,a])}else throw new Error(`Invalid write entry: ${JSON.stringify(i)}`);const s=e.configurable?.[Lr];s(n)}static isWriter(e){return e instanceof Ge||sc in e&&!!e[sc]}static registerWriter(e){return Object.defineProperty(e,sc,{value:!0})}}function ua(r){return r!==void 0&&typeof r.channel=="string"}function ic(r){return r!==void 0&&!ua(r)&&be.isRunnable(r.mapper)}class dd extends pr{constructor(e,t,n=!1){super({func:(s,i)=>dd.doRead(i,this.channel,this.fresh,this.mapper)}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"ChannelRead"}),Object.defineProperty(this,"channel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fresh",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fresh=n,this.mapper=t,this.channel=e,this.name=Array.isArray(e)?`ChannelRead<${e.join(",")}>`:`ChannelRead<${e}>`}static doRead(e,t,n,s){const i=e.configurable?.[er];if(!i)throw new Error("Runnable is not configured with a read function. Make sure to call in the context of a Pregel process");return s?s(i(t,n)):i(t,n)}}const Sr=new Js;class an extends Fn{constructor(e){const{channels:t,triggers:n,mapper:s,writers:i,bound:a,kwargs:o,metadata:u,retryPolicy:c,tags:l,subgraphs:d,ends:f}=e,h=[...e.config?.tags?e.config.tags:[],...l??[]];super({...e,bound:e.bound??Sr,config:{...e.config?e.config:{},tags:h}}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"PregelNode"}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"triggers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:Sr}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"subgraphs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.channels=t,this.triggers=n,this.mapper=s,this.writers=i??this.writers,this.bound=a??this.bound,this.kwargs=o??this.kwargs,this.metadata=u??this.metadata,this.tags=h,this.retryPolicy=c,this.subgraphs=d,this.ends=f}getWriters(){const e=[...this.writers];for(;e.length>1&&e[e.length-1]instanceof Ge&&e[e.length-2]instanceof Ge;){const t=e.slice(-2),n=t[0].writes.concat(t[1].writes);e[e.length-2]=new Ge(n,t[0].config?.tags),e.pop()}return e}getNode(){const e=this.getWriters();if(!(this.bound===Sr&&e.length===0))return this.bound===Sr&&e.length===1?e[0]:this.bound===Sr?new wt({first:e[0],middle:e.slice(1,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):e.length>0?new wt({first:this.bound,middle:e.slice(0,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):this.bound}join(e){if(!Array.isArray(e))throw new Error("channels must be a list");if(typeof this.channels!="object")throw new Error("all channels must be named when using .join()");return new an({channels:{...this.channels,...Object.fromEntries(e.map(t=>[t,t]))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy})}pipe(e){return Ge.isWriter(e)?new an({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,e],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}):this.bound===Sr?new an({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:vt(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}):new an({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy})}}class fn extends Error{constructor(e){super(e),this.name="GraphValidationError"}}function tA({nodes:r,channels:e,inputChannels:t,outputChannels:n,streamChannels:s,interruptAfterNodes:i,interruptBeforeNodes:a}){if(!e)throw new fn("Channels not provided");const o=new Set,u=new Set;for(const[c,l]of Object.entries(r)){if(c===Oe)throw new fn(`"Node name ${Oe} is reserved"`);if(l.constructor===an)l.triggers.forEach(d=>o.add(d));else throw new fn(`Invalid node type ${typeof l}, expected PregelNode`)}for(const c of o)if(!(c in e))throw new fn(`Subcribed channel '${String(c)}' not in channels`);if(Array.isArray(t)){if(t.every(c=>!o.has(c)))throw new fn(`None of the input channels ${t} are subscribed to by any node`)}else if(!o.has(t))throw new fn(`Input channel ${String(t)} is not subscribed to by any node`);Array.isArray(n)?n.forEach(c=>u.add(c)):u.add(n),s&&!Array.isArray(s)?u.add(s):Array.isArray(s)&&s.forEach(c=>u.add(c));for(const c of u)if(!(c in e))throw new fn(`Output channel '${String(c)}' not in channels`);if(i&&i!=="*"){for(const c of i)if(!(c in r))throw new fn(`Node ${String(c)} not in nodes`)}if(a&&a!=="*"){for(const c of a)if(!(c in r))throw new fn(`Node ${String(c)} not in nodes`)}}function Sp(r,e){if(Array.isArray(r)){for(const t of r)if(!(t in e))throw new Error(`Key ${String(t)} not found in channels`)}else if(!(r in e))throw new Error(`Key ${String(r)} not found in channels`)}function sr(r,e,t=!0,n=!1){try{return r[e].get()}catch(s){if(s.name===ft.unminifiable_name){if(n)return s;if(t)return null}throw s}}function cr(r,e,t=!0){if(Array.isArray(e)){const n={};for(const s of e)try{n[s]=sr(r,s,!t)}catch(i){if(i.name===ft.unminifiable_name)continue}return n}else return sr(r,e)}function*nA(r,e){if(r.graph===Wt.PARENT)throw new xe("There is no parent graph.");if(r.goto){let t;Array.isArray(r.goto)?t=r.goto:t=[r.goto];for(const n of t)if(Ot(n))yield[It,qr,n];else if(typeof n=="string")yield[It,`branch:to:${n}`,"__start__"];else throw new Error(`In Command.send, expected Send or string, got ${typeof n}`)}if(r.resume)if(typeof r.resume=="object"&&Object.keys(r.resume).length&&Object.keys(r.resume).every(Mn))for(const[t,n]of Object.entries(r.resume)){const s=e.filter(i=>i[0]===t&&i[1]===Nt).map(i=>i[2]).slice(0,1)??[];s.push(n),yield[t,Nt,s]}else yield[It,Nt,r.resume];if(r.update){if(typeof r.update!="object"||!r.update)throw new Error("Expected cmd.update to be a dict mapping channel names to update values");if(Array.isArray(r.update))for(const[t,n]of r.update)yield[It,t,n];else for(const[t,n]of Object.entries(r.update))yield[It,t,n]}}function*py(r,e){if(e!=null)if(Array.isArray(r)&&typeof e=="object"&&!Array.isArray(e))for(const t in e)r.includes(t)&&(yield[t,e[t]]);else{if(Array.isArray(r))throw new Error('Input chunk must be an object when "inputChannels" is an array');yield[r,e]}}function*ac(r,e,t){Array.isArray(r)?(e===!0||e.find(([n,s])=>r.includes(n)))&&(yield cr(t,r)):(e===!0||e.some(([n,s])=>n===r))&&(yield sr(t,r))}function*Ep(r,e,t){const n=e.filter(([o,u])=>(o.config===void 0||!o.config.tags?.includes(Re))&&u[0][0]!==St&&u[0][0]!==Oe);if(!n.length)return;let s;n.some(([o])=>o.writes.some(([u,c])=>u===Xs))?s=n.flatMap(([o])=>o.writes.filter(([u,c])=>u===Xs).map(([u,c])=>[o.name,c])):Array.isArray(r)?s=n.flatMap(([o])=>{const{writes:u}=o,c={};for(const[l]of u)r.includes(l)&&(c[l]=(c[l]||0)+1);return Object.values(c).some(l=>l>1)?u.filter(([l])=>r.includes(l)).map(([l,d])=>[o.name,{[l]:d}]):[[o.name,Object.fromEntries(u.filter(([l])=>r.includes(l)))]]}):s=n.flatMap(([o])=>o.writes.filter(([u,c])=>u===r).map(([u,c])=>[o.name,c]));const i={};for(const[o,u]of s)o in i||(i[o]=[]),i[o].push(u);const a={};for(const o in i)if(i[o].length===1){const[u]=i[o];a[o]=u}else a[o]=i[o];t&&(a.__metadata__={cached:t}),yield a}function rA(r){return"steps"in r&&Array.isArray(r.steps)}function fd(r){return"lg_is_pregel"in r&&r.lg_is_pregel===!0}function my(r){const e=[r];for(const t of e){if(fd(t))return t;rA(t)&&e.push(...t.steps)}}const Qs={blue:{start:"\x1B[34m",end:"\x1B[0m"},green:{start:"\x1B[32m",end:"\x1B[0m"},yellow:{start:"\x1B[33;1m",end:"\x1B[0m"}},ei=(r,e)=>`${r.start}${e}${r.end}`;function*xp(r,e){const t=new Date().toISOString();for(const{id:n,name:s,input:i,config:a,triggers:o,writes:u}of e){if(a?.tags?.includes(Re))continue;const c=u.filter(([l,d])=>l===n&&d===Oe).map(([,l])=>l);yield{type:"task",timestamp:t,step:r,payload:{id:n,name:s,input:i,triggers:o,interrupts:c}}}}function*sA(r,e,t){const n=new Date().toISOString();for(const[{id:s,name:i,config:a},o]of e)a?.tags?.includes(Re)||(yield{type:"task_result",timestamp:n,step:r,payload:{id:s,name:i,result:o.filter(([u])=>Array.isArray(t)?t.includes(u):u===t),interrupts:o.filter(u=>u[0]===Oe).map(u=>u[1])}})}function*iA(r,e,t,n,s,i,a,o){function u(f){const h={};return f.callbacks!=null&&(h.callbacks=f.callbacks),f.configurable!=null&&(h.configurable=f.configurable),f.maxConcurrency!=null&&(h.max_concurrency=f.maxConcurrency),f.metadata!=null&&(h.metadata=f.metadata),f.recursionLimit!=null&&(h.recursion_limit=f.recursionLimit),f.runId!=null&&(h.run_id=f.runId),f.runName!=null&&(h.run_name=f.runName),f.tags!=null&&(h.tags=f.tags),h}const c=e.configurable?.checkpoint_ns,l={};for(const f of i){if(!(f.subgraphs?.length?f.subgraphs:[f.proc]).find(my))continue;let p=`${f.name}:${f.id}`;c&&(p=`${c}|${p}`),l[f.id]={configurable:{thread_id:e.configurable?.thread_id,checkpoint_ns:p}}}yield{type:"checkpoint",timestamp:new Date().toISOString(),step:r,payload:{config:u(e),values:cr(t,n),metadata:s,next:i.map(f=>f.name),tasks:gy(i,a,l),parentConfig:o?u(o):void 0}}}function gy(r,e,t){return r.map(n=>{const s=e.find(([o,u])=>o===n.id&&u===St)?.[2],i=e.filter(([o,u])=>o===n.id&&u===Oe).map(([,,o])=>o);if(s)return{id:n.id,name:n.name,path:n.path,error:s,interrupts:i};const a=t?.[n.id];return{id:n.id,name:n.name,path:n.path,interrupts:i,...a!==void 0?{state:a}:{}}})}function aA(r,e,t){console.log([`${ei(Qs.blue,`[${r}:checkpoint]`)}`,`\x1B[1m State at the end of step ${r}:\x1B[0m
`,JSON.stringify(cr(e,t),null,2)].join(""))}function yy(r,e){const t=e.length;console.log([`${ei(Qs.blue,`[${r}:tasks]`)}`,`\x1B[1m Starting step ${r} with ${t} task${t===1?"":"s"}:\x1B[0m
`,e.map(n=>`- ${ei(Qs.green,String(n.name))} -> ${JSON.stringify(n.input,null,2)}`).join(`
`)].join(""))}function oA(r,e,t){const n={};for(const[s,i]of e)t.includes(s)&&(n[s]||(n[s]=[]),n[s].push(i));console.log([`${ei(Qs.blue,`[${r}:writes]`)}`,`\x1B[1m Finished step ${r} with writes to ${Object.keys(n).length} channel${Object.keys(n).length!==1?"s":""}:\x1B[0m
`,Object.entries(n).map(([s,i])=>`- ${ei(Qs.yellow,s)} -> ${i.map(a=>JSON.stringify(a)).join(", ")}`).join(`
`)].join(""))}class uA{constructor({func:e,name:t,input:n,retry:s,callbacks:i}){Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__lg_type",{enumerable:!0,configurable:!0,writable:!0,value:"call"}),this.func=e,this.name=t,this.input=n,this.retry=s,this.callbacks=i}}function cA(r){return typeof r=="object"&&r!==null&&"__lg_type"in r&&r.__lg_type==="call"}function _y(r){const e=Object.values(r),t=e.length>0?typeof e[0]:void 0;let n;return t==="number"?n=0:t==="string"&&(n=""),n}function Kc(r,e){if(Object.keys(r).length>0){const t=_y(e);return Object.fromEntries(Object.entries(e).filter(([n,s])=>s>(r[n]??t)))}else return e}function lA(r,e){return r&&!Array.isArray(r)&&!(r instanceof Date)&&typeof r=="object"?r:{[e]:r}}function Nn(r,e){return r===null?{configurable:e}:r?.configurable===void 0?{...r,configurable:e}:{...r,configurable:{...r.configurable,...e}}}function Er(r,e){const t=e?.parents??{};return Object.keys(t).length>0?Nn(r,{[At]:{...t,[r.configurable?.checkpoint_ns??""]:r.configurable?.checkpoint_id}}):r}function $r(...r){if(r.length===1)return r[0];const e=new AbortController,t=()=>{e.abort(),r.forEach(n=>n.removeEventListener("abort",t))};return r.forEach(n=>n.addEventListener("abort",t)),r.some(n=>n.aborted)&&e.abort(),e.signal}function dA(r,e){const t=new pr({func:n=>e(...n),name:r,trace:!1,recurse:!1});return new wt({name:r,first:t,last:new Ge([{channel:Xs,value:rr}],[Re])})}const fA=r=>r!==void 0?r+1:1;function Vi(r,e,t){const n=Object.values(r.channel_versions),s=n.length>0?typeof n[0]:void 0;let i;s==="number"?i=0:s==="string"&&(i="");const a=r.versions_seen[Oe]??{},o=Object.entries(r.channel_versions).some(([c,l])=>l>(a[c]??i)),u=t.some(c=>e==="*"?!c.config?.tags?.includes(Re):e.includes(c.name));return o&&u}function ca(r,e,t,n,s,i,a=!1){let o=[],u=new Set;if(Array.isArray(i))o=i.filter(l=>n.get(l)),i=i.filter(l=>!n.get(l)),u=new Set(i.filter(l=>s.writes.some(([d,f])=>d===l)));else{for(const[l]of s.writes)if(l===i){u=new Set([l]);break}u=u||new Set}let c;if(a&&u.size>0){const l=Object.fromEntries(Object.entries(t).filter(([h,p])=>u.has(h))),d=Xn(e,l,-1),f=ja(l,d);yt(Na(d),f,[s]),c=cr({...t,...f},i)}else c=cr(t,i);if(o.length>0)for(const l of o){const d=n.get(l);if(d){const f=d.call(r);c[l]=f}}return c}function oc(r,e,t,n,s){for(const[i,a]of s)if([Tt,qr].includes(i)&&a!=null){if(!Ot(a))throw new xe(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(a)}`);if(!(a.node in t))throw new xe(`Invalid node name "${a.node}" in Send packet`);n.replaceRuntimeValues(r,a.args)}e(s)}const hA=new Set([cd,Tt,Nt,Oe,Xs,St]);function yt(r,e,t,n){t.sort((d,f)=>{const h=d.path?.slice(0,3)||[],p=f.path?.slice(0,3)||[];for(let m=0;m<Math.min(h.length,p.length);m+=1){if(h[m]<p[m])return-1;if(h[m]>p[m])return 1}return h.length-p.length});const s=t.some(d=>d.triggers.length>0),i=Object.fromEntries(Object.entries(e).filter(([d,f])=>bo(f)));for(const d of t){r.versions_seen[d.name]===void 0&&(r.versions_seen[d.name]={});for(const f of d.triggers)f in r.channel_versions&&(r.versions_seen[d.name][f]=r.channel_versions[f])}let a;Object.keys(r.channel_versions).length>0&&(a=_p(...Object.values(r.channel_versions)));const o=new Set(t.flatMap(d=>d.triggers).filter(d=>!HP.includes(d)));for(const d of o)d in i&&i[d].consume()&&n!==void 0&&(r.channel_versions[d]=n(a,i[d]));r.pending_sends?.length&&s&&(r.pending_sends=[]);const u={},c={};for(const d of t)for(const[f,h]of d.writes)hA.has(f)||(f===qr?r.pending_sends.push({node:h.node,args:h.args}):f in i?f in u?u[f].push(h):u[f]=[h]:f in c?c[f].push(h):c[f]=[h]);a=void 0,Object.keys(r.channel_versions).length>0&&(a=_p(...Object.values(r.channel_versions)));const l=new Set;for(const[d,f]of Object.entries(u))if(d in i){let h;try{h=i[d].update(f)}catch(p){if(p.name===xe.unminifiable_name){const m=new xe(`Invalid update for channel "${d}" with values ${JSON.stringify(f)}: ${p.message}`);throw m.lc_error_code=p.lc_error_code,m}else throw p}h&&n!==void 0&&(r.channel_versions[d]=n(a,i[d])),l.add(d)}if(s)for(const d of Object.keys(i))l.has(d)||i[d].update([])&&n!==void 0&&(r.channel_versions[d]=n(a,i[d]));return c}function Ms(r,e,t,n,s,i,a,o){const u={};for(let c=0;c<r.pending_sends.length;c+=1){const l=Xc([Tt,c],r,e,t,n,s,i,a,o);l!==void 0&&(u[l.id]=l)}for(const c of Object.keys(t)){const l=Xc([oa,c],r,e,t,n,s,i,a,o);l!==void 0&&(u[l.id]=l)}return u}function Xc(r,e,t,n,s,i,a,o,u){const{step:c,checkpointer:l,manager:d}=u,f=a.configurable??{},h=f.checkpoint_ns??"";if(r[0]===Tt&&cA(r[r.length-1])){const p=r[r.length-1],m=dA(p.name,p.func),g=[Tt],y=h===""?p.name:`${h}${dt}${p.name}`,_=Cr(JSON.stringify([y,c.toString(),p.name,Tt,r[1],r[2]]),e.id),b=`${y}${nr}${_}`,v={langgraph_step:c,langgraph_node:p.name,langgraph_triggers:g,langgraph_path:r.slice(0,3),langgraph_checkpoint_ns:b};{const w=[];return{name:p.name,input:p.input,proc:m,writes:w,config:ke(sn(a,{metadata:v,store:u.store??a.store}),{runName:p.name,callbacks:d?.getChild(`graph:step:${c}`),configurable:{[Ls]:_,[Lr]:T=>oc(c,O=>w.push(...O),n,i,T),[er]:(T,O=!1)=>ca(c,e,s,i,{name:p.name,writes:w,triggers:g,path:r.slice(0,3)},T,O),[je]:l??f[je],[At]:{...f[At],[h]:e.id},[tr]:uc({pendingWrites:t??[],taskId:_,currentTaskInput:p.input}),[aa]:e.channel_values[nc],checkpoint_id:void 0,checkpoint_ns:b}}),triggers:g,retry_policy:p.retry,id:_,path:r.slice(0,3),writers:[]}}}else if(r[0]===Tt){const p=typeof r[1]=="number"?r[1]:parseInt(r[1],10);if(p>=e.pending_sends.length)return;const m=Zc(e.pending_sends[p])&&!Ot(e.pending_sends[p])?new Ma(e.pending_sends[p].node,e.pending_sends[p].args):e.pending_sends[p];if(!Zc(m)){console.warn(`Ignoring invalid packet ${JSON.stringify(m)} in pending sends.`);return}if(!(m.node in n)){console.warn(`Ignoring unknown node name ${m.node} in pending sends.`);return}const g=[Tt],y=h===""?m.node:`${h}${dt}${m.node}`,_=Cr(JSON.stringify([y,c.toString(),m.node,Tt,p.toString()]),e.id),b=`${y}${nr}${_}`;let v={langgraph_step:c,langgraph_node:m.node,langgraph_triggers:g,langgraph_path:r.slice(0,3),langgraph_checkpoint_ns:b};{const w=n[m.node],E=w.getNode();if(E!==void 0){i.replaceRuntimePlaceholders(c,m.args),w.metadata!==void 0&&(v={...v,...w.metadata});const T=[];return{name:m.node,input:m.args,proc:E,subgraphs:w.subgraphs,writes:T,config:ke(sn(a,{metadata:v,tags:w.tags,store:u.store??a.store}),{runName:m.node,callbacks:d?.getChild(`graph:step:${c}`),configurable:{[Ls]:_,[Lr]:O=>oc(c,x=>T.push(...x),n,i,O),[er]:(O,x=!1)=>ca(c,e,s,i,{name:m.node,writes:T,triggers:g,path:r},O,x),[je]:l??f[je],[At]:{...f[At],[h]:e.id},[tr]:uc({pendingWrites:t??[],taskId:_,currentTaskInput:m.args}),[aa]:e.channel_values[nc],checkpoint_id:void 0,checkpoint_ns:b}}),triggers:g,retry_policy:w.retryPolicy,id:_,path:r,writers:w.getWriters()}}}}else if(r[0]===oa){const p=r[1].toString(),m=n[p];if(m===void 0)return;if(t?.length){const b=h===""?p:`${h}${dt}${p}`,v=Cr(JSON.stringify([b,c.toString(),p,oa,p]),e.id);if(t.some(E=>E[0]===v&&E[1]!==St))return}const g=_y(e.channel_versions);if(g===void 0)return;const y=e.versions_seen[p]??{},_=m.triggers.filter(b=>{const v=sr(s,b,!1,!0);return!(v instanceof Error&&v.name===ft.unminifiable_name)&&(e.channel_versions[b]??g)>(y[b]??g)}).sort();if(_.length>0){const b=pA(c,m,i,s);if(b===void 0)return;const v=h===""?p:`${h}${dt}${p}`,w=Cr(JSON.stringify([v,c.toString(),p,oa,_]),e.id),E=`${v}${nr}${w}`;let T={langgraph_step:c,langgraph_node:p,langgraph_triggers:_,langgraph_path:r,langgraph_checkpoint_ns:E};{const O=m.getNode();if(O!==void 0){m.metadata!==void 0&&(T={...T,...m.metadata});const x=[];return{name:p,input:b,proc:O,subgraphs:m.subgraphs,writes:x,config:ke(sn(a,{metadata:T,tags:m.tags,store:u.store??a.store}),{runName:p,callbacks:d?.getChild(`graph:step:${c}`),configurable:{[Ls]:w,[Lr]:k=>oc(c,C=>{x.push(...C)},n,i,k),[er]:(k,C=!1)=>ca(c,e,s,i,{name:p,writes:x,triggers:_,path:r},k,C),[je]:l??f[je],[At]:{...f[At],[h]:e.id},[tr]:uc({pendingWrites:t??[],taskId:w,currentTaskInput:b}),[aa]:e.channel_values[nc],checkpoint_id:void 0,checkpoint_ns:E}}),triggers:_,retry_policy:m.retryPolicy,id:w,path:r,writers:m.getWriters()}}}}}}function pA(r,e,t,n,s){let i;if(typeof e.channels=="object"&&!Array.isArray(e.channels)){i={};for(const[a,o]of Object.entries(e.channels))if(e.triggers.includes(o))try{i[a]=sr(n,o,!1)}catch(u){if(u.name===ft.unminifiable_name)return;throw u}else if(o in n)try{i[a]=sr(n,o,!1)}catch(u){if(u.name===ft.unminifiable_name)continue;throw u}else i[a]=t.get(a)?.call(r)}else if(Array.isArray(e.channels)){let a=!1;for(const o of e.channels)try{i=sr(n,o,!1),a=!0;break}catch(u){if(u.name===ft.unminifiable_name)continue;throw u}if(!a)return}else throw new Error(`Invalid channels type, expected list or dict, got ${e.channels}`);return e.mapper!==void 0&&(i=e.mapper(i)),i}function uc({pendingWrites:r,taskId:e,currentTaskInput:t}){const n=r.find(([i,a])=>i===It&&a===Nt)?.[2],s={callCounter:0,interruptCounter:-1,resume:r.filter(([i,a])=>i===e&&a===Nt).flatMap(([i,a,o])=>o),nullResume:n,subgraphCounter:0,currentTaskInput:t,consumeNullResume:()=>{if(s.nullResume)return delete s.nullResume,r.splice(r.findIndex(([i,a])=>i===It&&a===Nt),1),n}};return s}class Op extends tt{constructor(e,t){const n=e.getReader(),s=t??new AbortController;super({start(i){return a();function a(){return n.read().then(({done:o,value:u})=>{if(o){i.close();return}return i.enqueue(u),a()})}}}),Object.defineProperty(this,"_abortController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._abortController=s,this._reader=n}async cancel(e){this._abortController.abort(e),this._reader.releaseLock()}get signal(){return this._abortController.signal}}class by extends tt{get closed(){return this._closed}constructor(e){let t;const n=new Promise(s=>{t=s});super({start:s=>{t(s)}}),Object.defineProperty(this,"modes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"controller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passthroughFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),n.then(s=>{this.controller=s}),this.passthroughFn=e.passthroughFn,this.modes=e.modes}push(e){this.passthroughFn?.(e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch{}finally{this._closed=!0}}error(e){this.controller.error(e)}}const Wi=Symbol.for("INPUT_DONE"),cc=Symbol.for("INPUT_RESUMING"),mA=25;function gA(...r){return new by({passthroughFn:e=>{for(const t of r)t.modes.has(e[1])&&t.push(e)},modes:new Set(r.flatMap(e=>Array.from(e.modes)))})}class hd{get isResuming(){const e=Object.keys(this.checkpoint.channel_versions).length!==0,n=this.config.configurable?.[In]!==void 0&&this.config.configurable?.[In],s=this.input===null||this.input===void 0,i=ot(this.input)&&this.input.resume!=null,a=this.input===cc;return e&&(n||s||i||a)}constructor(e){Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerGetNextVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"managed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointNamespace",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointPendingWrites",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"checkpointPreviousVersions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"step",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"skipDoneTasks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"prevCheckpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:"pending"}),Object.defineProperty(this,"tasks",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerPromises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"isNested",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_checkpointerChainedPromise",{enumerable:!0,configurable:!0,writable:!0,value:Promise.resolve()}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"toInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.input=e.input,this.checkpointer=e.checkpointer,this.checkpointer!==void 0?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=fA,this.checkpoint=e.checkpoint,this.checkpointMetadata=e.checkpointMetadata,this.checkpointPreviousVersions=e.checkpointPreviousVersions,this.channels=e.channels,this.managed=e.managed,this.checkpointPendingWrites=e.checkpointPendingWrites,this.step=e.step,this.stop=e.stop,this.config=e.config,this.checkpointConfig=e.checkpointConfig,this.isNested=e.isNested,this.manager=e.manager,this.outputKeys=e.outputKeys,this.streamKeys=e.streamKeys,this.nodes=e.nodes,this.skipDoneTasks=e.skipDoneTasks,this.store=e.store,this.stream=e.stream,this.checkpointNamespace=e.checkpointNamespace,this.prevCheckpointConfig=e.prevCheckpointConfig,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.debug=e.debug}static async initialize(e){let{config:t,stream:n}=e;n!==void 0&&t.configurable?.[La]!==void 0&&(n=gA(n,t.configurable[La]));const s=t.configurable?!("checkpoint_id"in t.configurable):!0,i=t.configurable?.[tr];t.configurable&&i&&(i.subgraphCounter>0&&(t=Nn(t,{[Wc]:[t.configurable[Wc],i.subgraphCounter.toString()].join(dt)})),i.subgraphCounter+=1);const a=er in(t.configurable??{});!a&&t.configurable?.checkpoint_ns!==void 0&&t.configurable?.checkpoint_ns!==""&&(t=Nn(t,{checkpoint_ns:"",checkpoint_id:void 0}));let o=t;t.configurable?.[At]!==void 0&&t.configurable?.[At]?.[t.configurable?.checkpoint_ns]&&(o=Nn(t,{checkpoint_id:t.configurable[At][t.configurable?.checkpoint_ns]}));const u=t.configurable?.checkpoint_ns?.split(dt)??[],c=await e.checkpointer?.getTuple(o)??{config:t,checkpoint:dy(),metadata:{source:"input",step:-2,writes:null,parents:{}},pendingWrites:[]};o={...t,...c.config,configurable:{checkpoint_ns:"",...t.configurable,...c.config.configurable}};const l=c.parentConfig,d=Na(c.checkpoint),f={...c.metadata},h=c.pendingWrites??[],p=ja(e.channelSpecs,d),m=(f.step??0)+1,g=m+(t.recursionLimit??mA)+1,y={...d.channel_versions},_=e.store?new UP(e.store):void 0;return _&&_.start(),new hd({input:e.input,config:t,checkpointer:e.checkpointer,checkpoint:d,checkpointMetadata:f,checkpointConfig:o,prevCheckpointConfig:l,checkpointNamespace:u,channels:p,managed:e.managed,isNested:a,manager:e.manager,skipDoneTasks:s,step:m,stop:g,checkpointPreviousVersions:y,checkpointPendingWrites:h,outputKeys:e.outputKeys??[],streamKeys:e.streamKeys??[],nodes:e.nodes,stream:n,store:_,interruptAfter:e.interruptAfter,interruptBefore:e.interruptBefore,debug:e.debug})}_checkpointerPutAfterPrevious(e){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then(()=>this.checkpointer?.put(e.config,e.checkpoint,e.metadata,e.newVersions)),this.checkpointerPromises.push(this._checkpointerChainedPromise)}async updateManagedValues(e,t){const n=this.managed.get(e);n&&"update"in n&&typeof n.update=="function"&&await n.update(t)}putWrites(e,t){let n=t;if(n.length===0)return;n.every(([i])=>i in bp)&&(n=Array.from(new Map(n.map(i=>[i[0],i])).values()));for(const[i,a]of n){const o=this.checkpointPendingWrites.findIndex(u=>u[0]===e&&u[1]===i);i in bp&&o!==-1?this.checkpointPendingWrites[o]=[e,i,a]:this.checkpointPendingWrites.push([e,i,a])}const s=this.checkpointer?.putWrites({...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??"",checkpoint_id:this.checkpoint.id}},n,e);s!==void 0&&this.checkpointerPromises.push(s),this.tasks&&this._outputWrites(e,n)}_outputWrites(e,t,n=!1){const s=this.tasks[e];if(s!==void 0){if(s.config!==void 0&&(s.config.tags??[]).includes(Re))return;t.length>0&&t[0][0]!==St&&t[0][0]!==Oe&&this._emit(As(kn(Ep(this.outputKeys,[[s,t]],n),"updates"))),n||this._emit(As(kn(sA(this.step,[[s,t]],this.streamKeys),"debug")))}}async tick(e){this.store&&!this.store.isRunning&&this.store?.start();const{inputKeys:t=[]}=e;if(this.status!=="pending")throw new Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if(![Wi,cc].includes(this.input))await this._first(t);else{if(this.toInterrupt.length>0)throw this.status="interrupt_before",new js;if(Object.values(this.tasks).every(i=>i.writes.length>0)){const i=Object.values(this.tasks).flatMap(u=>u.writes),a=yt(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion);for(const[u,c]of Object.entries(a))await this.updateManagedValues(u,c);const o=await Rn(kn(ac(this.outputKeys,i,this.channels),"values"));if(this._emit(o),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop",writes:Ep(this.outputKeys,Object.values(this.tasks).map(u=>[u,u.writes])).next().value??null}),Vi(this.checkpoint,this.interruptAfter,Object.values(this.tasks)))throw this.status="interrupt_after",new js;this.config.configurable?.[In]!==void 0&&delete this.config.configurable?.[In]}else return!1}if(this.step>this.stop)return this.status="out_of_steps",!1;const n=Ms(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.isResuming,manager:this.manager,store:this.store,stream:this.stream});if(this.tasks=n,this.checkpointer&&this._emit(await Rn(kn(iA(this.step-1,this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig),"debug"))),Object.values(this.tasks).length===0)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(const[i,a,o]of this.checkpointPendingWrites){if(a===St||a===Oe||a===Nt)continue;const u=Object.values(this.tasks).find(c=>c.id===i);u&&u.writes.push([a,o])}for(const i of Object.values(this.tasks))i.writes.length>0&&this._outputWrites(i.id,i.writes,!0)}if(Object.values(this.tasks).every(i=>i.writes.length>0))return this.tick({inputKeys:t});if(Vi(this.checkpoint,this.interruptBefore,Object.values(this.tasks)))throw this.status="interrupt_before",new js;const s=await Rn(kn(xp(this.step,Object.values(this.tasks)),"debug"));return this._emit(s),!0}async finishAndHandleError(e){const t=this._suppressInterrupt(e);if((t||e===void 0)&&(this.output=cr(this.channels,this.outputKeys)),t){if(this.tasks!==void 0&&this.checkpointPendingWrites.length>0&&Object.values(this.tasks).some(n=>n.writes.length>0)){const n=yt(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion);for(const[s,i]of Object.entries(n))await this.updateManagedValues(s,i);this._emit(As(kn(ac(this.outputKeys,Object.values(this.tasks).flatMap(s=>s.writes),this.channels),"values")))}this._emit([["updates",{[Oe]:e.interrupts}]])}return t}acceptPush(e,t,n){if(this.interruptAfter?.length>0&&Vi(this.checkpoint,this.interruptAfter,[e])){this.toInterrupt.push(e);return}const s=Xc([Tt,e.path??[],t,e.id,n],this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,e.config??{},!0,{step:this.step,checkpointer:this.checkpointer,manager:this.manager,store:this.store,stream:this.stream});if(s){if(this.interruptBefore?.length>0&&Vi(this.checkpoint,this.interruptBefore,[s])){this.toInterrupt.push(s);return}return this._emit(As(kn(xp(this.step,[s]),"debug"))),this.debug&&yy(this.step,[s]),this.tasks[s.id]=s,this.skipDoneTasks&&this._matchWrites({[s.id]:s}),s}}_suppressInterrupt(e){return Ps(e)&&!this.isNested}async _first(e){const{configurable:t}=this.config,n=t?.[tr];if(n&&n.nullResume!==void 0&&this.putWrites(It,[[Nt,n.nullResume]]),ot(this.input)){if(this.input.resume!=null&&this.checkpointer==null)throw new Error("Cannot use Command(resume=...) without checkpointer");const o={};for(const[u,c,l]of nA(this.input,this.checkpointPendingWrites))o[u]===void 0&&(o[u]=[]),o[u].push([c,l]);if(Object.keys(o).length===0)throw new mp("Received empty Command input");for(const[u,c]of Object.entries(o))this.putWrites(u,c)}const s=(this.checkpointPendingWrites??[]).filter(a=>a[0]===It).map(a=>a.slice(1));s.length>0&&yt(this.checkpoint,this.channels,[{name:pn,writes:s,triggers:[]}],this.checkpointerGetNextVersion);const i=ot(this.input)&&s.length>0;if(this.isResuming||i){for(const o of Object.keys(this.channels))if(this.checkpoint.channel_versions[o]!==void 0){const u=this.checkpoint.channel_versions[o];this.checkpoint.versions_seen[Oe]={...this.checkpoint.versions_seen[Oe],[o]:u}}const a=await Rn(kn(ac(this.outputKeys,!0,this.channels),"values"));this._emit(a)}if(this.isResuming)this.input=cc;else if(i)await this._putCheckpoint({source:"input",writes:{}}),this.input=Wi;else{const a=await Rn(py(e,this.input));if(a.length>0){const o=Ms(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step});yt(this.checkpoint,this.channels,Object.values(o).concat([{name:pn,writes:a,triggers:[]}]),this.checkpointerGetNextVersion),await this._putCheckpoint({source:"input",writes:Object.fromEntries(a)}),this.input=Wi}else if(In in(this.config.configurable??{}))this.input=Wi;else throw new mp(`Received no input writes for ${JSON.stringify(e,null,2)}`)}this.isNested||(this.config=Nn(this.config,{[In]:this.isResuming}))}_emit(e){for(const t of e)this.stream.modes.has(t[0])&&this.stream.push([this.checkpointNamespace,...t])}async _putCheckpoint(e){const t={...e,step:this.step,parents:this.config.configurable?.[At]??{}};if(this.checkpointer!==void 0){this.prevCheckpointConfig=this.checkpointConfig?.configurable?.checkpoint_id?this.checkpointConfig:void 0,this.checkpointMetadata=t,this.checkpoint=Xn(this.checkpoint,this.channels,this.step),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??""}};const n={...this.checkpoint.channel_versions},s=Kc(this.checkpointPreviousVersions,n);this.checkpointPreviousVersions=n,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:Na(this.checkpoint),metadata:{...this.checkpointMetadata},newVersions:s}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}}this.step+=1}_matchWrites(e){for(const[t,n,s]of this.checkpointPendingWrites){if(n===St||n===Oe||n===Nt)continue;const i=Object.values(e).find(a=>a.id===t);i&&i.writes.push([n,s])}for(const t of Object.values(e))t.writes.length>0&&this._outputWrites(t.id,t.writes,!0)}}function yA(r){return Pt(r?.message)}class _A extends rs{constructor(e){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"StreamMessagesHandler"}),Object.defineProperty(this,"streamFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadatas",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"emittedChatModelRunIds",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stableMessageIdMap",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.streamFn=e}_emit(e,t,n,s=!1){if(s&&t.id!==void 0&&this.seen[t.id]!==void 0)return;let i=t.id;n!=null&&(Nv(t)?i??=`run-${n}-tool-${t.tool_call_id}`:((i==null||i===`run-${n}`)&&(i=this.stableMessageIdMap[n]??i??`run-${n}`),this.stableMessageIdMap[n]??=i)),i!==t.id&&(t.id=i,t.lc_kwargs.id=i),t.id!=null&&(this.seen[t.id]=t),this.streamFn([e[0],"messages",[t,e[1]]])}handleChatModelStart(e,t,n,s,i,a,o,u){o&&(!a||!a.includes(qP)&&!a.includes("nostream"))&&(this.metadatas[n]=[o.langgraph_checkpoint_ns.split("|"),{tags:a,name:u,...o}])}handleLLMNewToken(e,t,n,s,i,a){const o=a?.chunk;this.emittedChatModelRunIds[n]=!0,this.metadatas[n]!==void 0&&(yA(o)?this._emit(this.metadatas[n],o.message,n):this._emit(this.metadatas[n],new bn({content:e}),n))}handleLLMEnd(e,t){if(!this.emittedChatModelRunIds[t]){const n=e.generations?.[0]?.[0];Pt(n?.message)&&this._emit(this.metadatas[t],n?.message,t,!0),delete this.emittedChatModelRunIds[t]}delete this.metadatas[t],delete this.stableMessageIdMap[t]}handleLLMError(e,t){delete this.metadatas[t]}handleChainStart(e,t,n,s,i,a,o,u){if(a!==void 0&&u===a.langgraph_node&&(i===void 0||!i.includes(Re))&&(this.metadatas[n]=[a.langgraph_checkpoint_ns.split("|"),{tags:i,name:u,...a}],typeof t=="object")){for(const c of Object.values(t))if((Pt(c)||Tc(c))&&c.id!==void 0)this.seen[c.id]=c;else if(Array.isArray(c))for(const l of c)(Pt(l)||Tc(l))&&l.id!==void 0&&(this.seen[l.id]=l)}}handleChainEnd(e,t){const n=this.metadatas[t];if(delete this.metadatas[t],n!==void 0){if(Pt(e))this._emit(n,e,t,!0);else if(Array.isArray(e))for(const s of e)Pt(s)&&this._emit(n,s,t,!0);else if(e!=null&&typeof e=="object"){for(const s of Object.values(e))if(Pt(s))this._emit(n,s,t,!0);else if(Array.isArray(s))for(const i of s)Pt(i)&&this._emit(n,i,t,!0)}}}handleChainError(e,t){delete this.metadatas[t]}}const bA=500,wA=2,vA=128e3,SA=3,EA=[400,401,402,403,404,405,406,407,409],xA=r=>{if(r.message.startsWith("Cancel")||r.message.startsWith("AbortError")||r.name==="AbortError"||r?.code==="ECONNABORTED")return!1;const e=r?.response?.status??r?.status;return!(e&&EA.includes(+e)||r?.error?.code==="insufficient_quota")};async function wy(r,e,t,n){const s=r.retry_policy??e;let i=s!==void 0?s.initialInterval??bA:0,a=0,o,u,{config:c}=r;for(t&&(c=Nn(c,t)),c={...c,signal:n};!n?.aborted;){r.writes.splice(0,r.writes.length),o=void 0;try{u=await r.proc.invoke(r.input,c);break}catch(l){if(o=l,o.pregelTaskId=r.id,mP(o)){const p=c?.configurable?.checkpoint_ns,m=o.command;if(m.graph===p){for(const g of r.writers)await g.invoke(m,c);o=void 0;break}else if(m.graph===Wt.PARENT){const g=QP(p);o.command=new Wt({...o.command,graph:g})}}if(sa(o)||s===void 0||(a+=1,a>=(s.maxAttempts??SA))||!(s.retryOn??xA)(o))break;i=Math.min(s.maxInterval??vA,i*(s.backoffFactor??wA));const f=s.jitter?Math.floor(i+Math.random()*1e3):i;await new Promise(p=>setTimeout(p,f));const h=o.name??o.constructor.unminifiable_name??o.constructor.name;(s?.logWarning??!0)&&console.log(`Retrying task "${String(r.name)}" after ${i.toFixed(2)}ms (attempt ${a}) after ${h}: ${o}`),c=Nn(c,{[In]:!0})}}return{task:r,result:u,error:o,signalAborted:n?.aborted}}const Yc=Symbol.for("promiseAdded");function OA(){const r={next:()=>{},wait:Promise.resolve(Yc)};function e(t){r.next=()=>{r.wait=new Promise(e),t(Yc)}}return r.wait=new Promise(e),r}class kA{constructor({loop:e,nodeFinished:t}){Object.defineProperty(this,"nodeFinished",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.loop=e,this.nodeFinished=t}async tick(e={}){const{timeout:t,retryPolicy:n,onStepWrite:s,maxConcurrency:i}=e,a=new Set;let o;const u=new AbortController,c=Object.values(this.loop.tasks).filter(f=>f.writes.length===0),l=this._initializeAbortSignals({exceptionSignalController:u,timeout:t,signal:e.signal}),d=this._executeTasksWithRetry(c,{signals:l,retryPolicy:n,maxConcurrency:i});for await(const{task:f,error:h,signalAborted:p}of d)this._commit(f,h),Ps(h)||sa(h)&&!Ps(o)?o=h:h&&(a.size===0||!p)&&(u.abort(),a.add(h));if(s?.(this.loop.step,Object.values(this.loop.tasks).map(f=>f.writes).flat()),a.size===1)throw Array.from(a)[0];if(a.size>1)throw new AggregateError(Array.from(a),`Multiple errors occurred during superstep ${this.loop.step}. See the "errors" field of this exception for more details.`);if(Ps(o)||sa(o)&&this.loop.isNested)throw o}_initializeAbortSignals({exceptionSignalController:e,timeout:t,signal:n}){const s=this.loop.config.configurable?.[wp]??{},a=n&&s.composedAbortSignal&&n!==s.composedAbortSignal?$r(s.externalAbortSignal,n):s.externalAbortSignal??n,o=s.errorAbortSignal?$r(s.errorAbortSignal,e.signal):e.signal,u=t?AbortSignal.timeout(t):void 0,c=$r(...a?[a]:[],...u?[u]:[],o),l={externalAbortSignal:a,errorAbortSignal:o,timeoutAbortSignal:u,composedAbortSignal:c};return this.loop.config=Nn(this.loop.config,{[wp]:l}),l}async*_executeTasksWithRetry(e,t){const{retryPolicy:n,maxConcurrency:s,signals:i}=t??{},a=OA(),o={},u={executingTasksMap:o,barrier:a,retryPolicy:n,scheduleTask:async(h,p,m)=>this.loop.acceptPush(h,p,m)};if(i?.composedAbortSignal?.aborted)throw new Error("Abort");let c=0,l;const d=i?.externalAbortSignal||i?.timeoutAbortSignal?$r(...i.externalAbortSignal?[i.externalAbortSignal]:[],...i.timeoutAbortSignal?[i.timeoutAbortSignal]:[]):void 0,f=d?new Promise((h,p)=>{l=()=>p(new Error("Abort")),d.addEventListener("abort",l,{once:!0})}):void 0;for(;(c===0||Object.keys(o).length>0)&&e.length;){for(;Object.values(o).length<(s??e.length)&&c<e.length;c+=1){const p=e[c];o[p.id]=wy(p,n,{[ud]:vy?.bind(u,this,p)},i?.composedAbortSignal).catch(m=>({task:p,error:m,signalAborted:i?.composedAbortSignal?.aborted}))}const h=await Promise.race([...Object.values(o),...f?[f]:[],a.wait]);h!==Yc&&(yield h,delete o[h.task.id])}}_commit(e,t){if(t!==void 0)if(Ps(t)){if(t.interrupts.length){const n=t.interrupts.map(i=>[Oe,i]),s=e.writes.filter(i=>i[0]===Nt);s.length&&n.push(...s),this.loop.putWrites(e.id,n)}}else sa(t)&&e.writes.length?this.loop.putWrites(e.id,e.writes):this.loop.putWrites(e.id,[[St,{message:t.message,name:t.name}]]);else this.nodeFinished&&(e.config?.tags==null||!e.config.tags.includes(Re))&&this.nodeFinished(String(e.name)),e.writes.length===0&&e.writes.push([cd,null]),this.loop.putWrites(e.id,e.writes)}}async function vy(r,e,t,n,s,i={}){const a=e.config?.configurable?.[tr];if(!a)throw new Error(`BUG: No scratchpad found on task ${e.name}__${e.id}`);const o=a.callCounter;a.callCounter+=1;const u=new uA({func:t,name:n,input:s,retry:i.retry,callbacks:i.callbacks}),c=await this.scheduleTask(e,o,u);if(!c)return;const l=this.executingTasksMap[c.id];if(l!==void 0)return l;if(c.writes.length>0){const d=c.writes.filter(([h])=>h===Xs),f=c.writes.filter(([h])=>h===St);if(d.length>0){if(d.length===1)return Promise.resolve(d[0][1]);throw new Error(`BUG: multiple returns found for task ${c.name}__${c.id}`)}if(f.length>0){if(f.length===1){const h=f[0][1],p=h instanceof Error?h:new Error(String(h));return Promise.reject(p)}throw new Error(`BUG: multiple errors found for task ${c.name}__${c.id}`)}return}else{const d=wy(c,i.retry,{[ud]:vy.bind(this,r,c)});return this.executingTasksMap[c.id]=d,this.barrier.next(),d.then(({result:f,error:h})=>h?Promise.reject(h):f)}}function PA(r){return typeof r=="string"}class AA{static subscribeTo(e,t){const{key:n,tags:s}={key:void 0,tags:void 0,...t??{}};if(Array.isArray(e)&&n!==void 0)throw new Error("Can't specify a key when subscribing to multiple channels");let i;PA(e)?n?i={[n]:e}:i=[e]:i=Object.fromEntries(e.map(o=>[o,o]));const a=Array.isArray(e)?e:[e];return new an({channels:i,triggers:a,tags:s})}static writeTo(e,t){const n=[];for(const s of e)n.push({channel:s,value:rr,skipNone:!1});for(const[s,i]of Object.entries(t??{}))be.isRunnable(i)||typeof i=="function"?n.push({channel:s,value:rr,skipNone:!0,mapper:vt(i)}):n.push({channel:s,value:i,skipNone:!1});return new Ge(n)}}class TA extends be{static lc_name(){return"LangGraph"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph","pregel"]}),Object.defineProperty(this,"lg_is_pregel",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoValidate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"streamMode",{enumerable:!0,configurable:!0,writable:!0,value:["values"]}),Object.defineProperty(this,"streamChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stepTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{streamMode:t}=e;t!=null&&!Array.isArray(t)&&(t=[t]),this.nodes=e.nodes,this.channels=e.channels,this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=t??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.name=e.name,this.autoValidate&&this.validate()}withConfig(e){const t=sn(this.config,e);return new this.constructor({...this,config:t})}validate(){return tA({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore}),this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,t){for(const[n,s]of Object.entries(this.nodes)){if(e!==void 0&&!e.startsWith(n))continue;const i=s.subgraphs?.length?s.subgraphs:[s.bound];for(const a of i){const o=my(a);if(o!==void 0){if(n===e){yield[n,o];return}if(e===void 0&&(yield[n,o]),t){let u=e;e!==void 0&&(u=e.slice(n.length+1));for(const[c,l]of o.getSubgraphs(u,t))yield[`${n}${dt}${c}`,l]}}}}}async*getSubgraphsAsync(e,t){yield*this.getSubgraphs(e,t)}async _prepareStateSnapshot({config:e,saved:t,subgraphCheckpointer:n,applyPendingWrites:s=!1}){if(t===void 0)return{values:{},next:[],config:e,tasks:[]};const{managed:i}=await this.prepareSpecs(e,{skipManaged:!0}),a=ja(this.channels,t.checkpoint);if(t.pendingWrites?.length){const h=t.pendingWrites.filter(([p,m])=>p===It).map(([p,m,g])=>[String(m),g]);h.length>0&&yt(t.checkpoint,a,[{name:pn,writes:h,triggers:[]}])}const o=Object.values(Ms(t.checkpoint,t.pendingWrites,this.nodes,a,i,t.config,!0,{step:(t.metadata?.step??-1)+1,store:this.store})),u=await Rn(this.getSubgraphsAsync()),c=t.config.configurable?.checkpoint_ns??"",l={};for(const h of o){const p=u.find(([g])=>g===h.name);if(!p)continue;let m=`${String(h.name)}${nr}${h.id}`;if(c&&(m=`${c}${dt}${m}`),n===void 0){const g={configurable:{thread_id:t.config.configurable?.thread_id,checkpoint_ns:m}};l[h.id]=g}else{const g={configurable:{[je]:n,thread_id:t.config.configurable?.thread_id,checkpoint_ns:m}},y=p[1];l[h.id]=await y.getState(g,{subgraphs:!0})}}if(s&&t.pendingWrites?.length){const h=Object.fromEntries(o.map(m=>[m.id,m]));for(const[m,g,y]of t.pendingWrites)[St,Oe,ia].includes(g)||m in h&&h[m].writes.push([String(g),y]);const p=o.filter(m=>m.writes.length>0);p.length>0&&yt(t.checkpoint,a,p)}let d=t?.metadata;d&&t?.config?.configurable?.thread_id&&(d={...d,thread_id:t.config.configurable.thread_id});const f=o.filter(h=>h.writes.length===0).map(h=>h.name);return{values:cr(a,this.streamChannelsAsIs),next:f,tasks:gy(o,t?.pendingWrites??[],l),metadata:d,config:Er(t.config,t.metadata),createdAt:t.checkpoint.ts,parentConfig:t.parentConfig}}async getState(e,t){const n=e.configurable?.[je]??this.checkpointer;if(!n)throw new pp("No checkpointer set");const s=e.configurable?.checkpoint_ns??"";if(s!==""&&e.configurable?.[je]===void 0){const u=rc(s);for await(const[c,l]of this.getSubgraphsAsync(u,!0))if(c===u)return await l.getState(ms(e,{[je]:n}),{subgraphs:t?.subgraphs});throw new Error(`Subgraph with namespace "${u}" not found.`)}const i=sn(this.config,e),a=await n.getTuple(e);return await this._prepareStateSnapshot({config:i,saved:a,subgraphCheckpointer:t?.subgraphs?n:void 0,applyPendingWrites:!e.configurable?.checkpoint_id})}async*getStateHistory(e,t){const n=e.configurable?.[je]??this.checkpointer;if(!n)throw new Error("No checkpointer set");const s=e.configurable?.checkpoint_ns??"";if(s!==""&&e.configurable?.[je]===void 0){const a=rc(s);for await(const[o,u]of this.getSubgraphsAsync(a,!0))if(o===a){yield*u.getStateHistory(ms(e,{[je]:n}),t);return}throw new Error(`Subgraph with namespace "${a}" not found.`)}const i=sn(this.config,e,{configurable:{checkpoint_ns:s}});for await(const a of n.list(i,t))yield this._prepareStateSnapshot({config:a.config,saved:a})}async bulkUpdateState(e,t){const n=e.configurable?.[je]??this.checkpointer;if(!n)throw new pp("No checkpointer set");if(t.length===0)throw new Error("No supersteps provided");if(t.some(o=>o.updates.length===0))throw new Error("No updates provided");const s=e.configurable?.checkpoint_ns??"";if(s!==""&&e.configurable?.[je]===void 0){const o=rc(s);for await(const[,u]of this.getSubgraphsAsync(o,!0))return await u.bulkUpdateState(ms(e,{[je]:n}),t);throw new Error(`Subgraph "${o}" not found`)}const i=async(o,u)=>{const c=this.config?sn(this.config,o):o,l=await n.getTuple(c),d=l!==void 0?Na(l.checkpoint):dy(),f={...l?.checkpoint.channel_versions},h=l?.metadata?.step??-1;let p=ms(c,{checkpoint_ns:c.configurable?.checkpoint_ns??""}),m=c.metadata??{};l?.config.configurable&&(p=ms(c,l.config.configurable),m={...l.metadata,...m});const{values:g,asNode:y}=u[0];if(g==null&&y===void 0){if(u.length>1)throw new xe("Cannot create empty checkpoint with multiple updates");const x=await n.put(p,Xn(d,void 0,h),{source:"update",step:h+1,writes:{},parents:l?.metadata?.parents??{}},{});return Er(x,l?l.metadata:void 0)}const _=ja(this.channels,d),{managed:b}=await this.prepareSpecs(c,{skipManaged:!0});if(g===null&&y===le){if(u.length>1)throw new xe("Cannot apply multiple updates when clearing state");if(l){const k=Ms(d,l.pendingWrites||[],this.nodes,_,b,l.config,!0,{step:(l.metadata?.step??-1)+1,checkpointer:this.checkpointer||void 0,store:this.store}),C=(l.pendingWrites||[]).filter(J=>J[0]===It).map(J=>J.slice(1));C.length>0&&yt(l.checkpoint,_,[{name:pn,writes:C,triggers:[]}]);for(const[J,pe,$]of l.pendingWrites||[])[St,Oe,ia].includes(pe)||J in k&&k[J].writes.push([pe,$]);yt(d,_,Object.values(k))}const x=await n.put(p,Xn(d,void 0,h),{...m,source:"update",step:h+1,writes:{},parents:l?.metadata?.parents??{}},{});return Er(x,l?l.metadata:void 0)}if(g==null&&y===FP){if(u.length>1)throw new xe("Cannot copy checkpoint with multiple updates");const x=await n.put(l?.parentConfig??p,Xn(d,void 0,h),{source:"fork",step:h+1,writes:{},parents:l?.metadata?.parents??{}},{});return Er(x,l?l.metadata:void 0)}if(y===pn){if(u.length>1)throw new xe("Cannot apply multiple updates when updating as input");const x=await Rn(py(this.inputChannels,g));if(x.length===0)throw new xe(`Received no input writes for ${JSON.stringify(this.inputChannels,null,2)}`);yt(d,_,[{name:pn,writes:x,triggers:[]}],n.getNextVersion.bind(this.checkpointer));const k=l?.metadata?.step!=null?l.metadata.step+1:-1,C=await n.put(p,Xn(d,_,k),{source:"input",step:k,writes:Object.fromEntries(x),parents:l?.metadata?.parents??{}},Kc(f,d.channel_versions));return await n.putWrites(C,x,Cr(pn,d.id)),Er(C,l?l.metadata:void 0)}if(c.configurable?.checkpoint_id===void 0&&l?.pendingWrites!==void 0&&l.pendingWrites.length>0){const x=Ms(d,l.pendingWrites,this.nodes,_,b,l.config,!0,{store:this.store,checkpointer:this.checkpointer,step:(l.metadata?.step??-1)+1}),k=(l.pendingWrites??[]).filter(J=>J[0]===It).map(J=>J.slice(1));k.length>0&&yt(l.checkpoint,_,[{name:pn,writes:k,triggers:[]}]);for(const[J,pe,$]of l.pendingWrites)[St,Oe,ia].includes(pe)||x[J]===void 0||x[J].writes.push([pe,$]);const C=Object.values(x).filter(J=>J.writes.length>0);C.length>0&&yt(d,_,C)}const v=Object.values(d.versions_seen).map(x=>Object.values(x)).flat().find(x=>!!x),w=[];if(u.length===1){let{values:x,asNode:k}=u[0];if(k===void 0&&Object.keys(this.nodes).length===1)[k]=Object.keys(this.nodes);else if(k===void 0&&v===void 0)typeof this.inputChannels=="string"&&this.nodes[this.inputChannels]!==void 0&&(k=this.inputChannels);else if(k===void 0){const C=Object.entries(d.versions_seen).map(([J,pe])=>Object.values(pe).map($=>[$,J])).flat().sort(([J],[pe])=>fy(J,pe));C&&(C.length===1?k=C[0][1]:C[C.length-1][0]!==C[C.length-2][0]&&(k=C[C.length-1][1]))}if(k===void 0)throw new xe('Ambiguous update, specify "asNode"');w.push({values:x,asNode:k})}else for(const{asNode:x,values:k}of u){if(x==null)throw new xe('"asNode" is required when applying multiple updates');w.push({values:k,asNode:x})}const E=[];for(const{asNode:x,values:k}of w){if(this.nodes[x]===void 0)throw new xe(`Node "${x.toString()}" does not exist`);const C=this.nodes[x].getWriters();if(!C.length)throw new xe(`No writers found for node "${x.toString()}"`);E.push({name:x,input:k,proc:C.length>1?wt.from(C,{omitSequenceTags:!0}):C[0],writes:[],triggers:[Oe],id:Cr(Oe,d.id),writers:[]})}for(const x of E)await x.proc.invoke(x.input,ke({...c,store:c?.store??this.store},{runName:c.runName??`${this.getName()}UpdateState`,configurable:{[Lr]:k=>x.writes.push(...k),[er]:(k,C=!1)=>ca(h,d,_,b,x,k,C)}}));for(const x of E){const k=x.writes.filter(C=>C[0]!==Tt);l!==void 0&&k.length>0&&await n.putWrites(p,k,x.id)}yt(d,_,E,n.getNextVersion.bind(this.checkpointer));const T=Kc(f,d.channel_versions),O=await n.put(p,Xn(d,_,h+1),{source:"update",step:h+1,writes:Object.fromEntries(w.map(x=>[x.asNode,x.values])),parents:l?.metadata?.parents??{}},T);for(const x of E){const k=x.writes.filter(C=>C[0]===Tt);k.length>0&&await n.putWrites(O,k,x.id)}return Er(O,l?l.metadata:void 0)};let a=e;for(const{updates:o}of t)a=await i(a,o);return a}async updateState(e,t,n){return this.bulkUpdateState(e,[{updates:[{values:t,asNode:n}]}])}_defaults(e){const{debug:t,streamMode:n,inputKeys:s,outputKeys:i,interruptAfter:a,interruptBefore:o,...u}=e;let c=!0;const l=t!==void 0?t:this.debug;let d=i;d===void 0?d=this.streamChannelsAsIs:Sp(d,this.channels);let f=s;f===void 0?f=this.inputChannels:Sp(f,this.channels);const h=o??this.interruptBefore??[],p=a??this.interruptAfter??[];let m;n!==void 0?(m=Array.isArray(n)?n:[n],c=typeof n=="string"):(m=this.streamMode,c=!0),e.configurable?.[Ls]!==void 0&&(m=["values"]);let g;this.checkpointer===!1?g=void 0:e!==void 0&&e.configurable?.[je]!==void 0?g=e.configurable[je]:g=this.checkpointer;const y=e.store??this.store;return[l,m,f,d,u,h,p,g,y,c]}async stream(e,t){const n=new AbortController,s={recursionLimit:this.config?.recursionLimit,...t,signal:t?.signal?$r(t.signal,n.signal):n.signal};return new Op(await super.stream(e,s),n)}streamEvents(e,t,n){const s=new AbortController,i={recursionLimit:this.config?.recursionLimit,callbacks:this.config?.callbacks,...t,signal:t?.signal?$r(t.signal,s.signal):s.signal};return new Op(super.streamEvents(e,i,n),s)}async prepareSpecs(e,t){const n={...e,store:this.store},s={},i={};for(const[o,u]of Object.entries(this.channels))bo(u)?s[o]=u:t?.skipManaged?i[o]={cls:ld,params:{config:{}}}:i[o]=u;const a=new ZP(await Object.entries(i).reduce(async(o,[u,c])=>{const l=await o;let d;return vo(c)?("key"in c.params&&c.params.key===WP&&(c.params.key=u),d=await c.cls.initialize(n,c.params)):d=await c.initialize(n),d!==void 0&&l.push([u,d]),l},Promise.resolve([])));return{channelSpecs:s,managed:a}}async _validateInput(e){return e}async _validateConfigurable(e){return e}async*_streamIterator(e,t){const n=t?.subgraphs,s=hy(this.config,t);if(s.recursionLimit===void 0||s.recursionLimit<1)throw new Error('Passed "recursionLimit" must be at least 1.');if(this.checkpointer!==void 0&&this.checkpointer!==!1&&s.configurable===void 0)throw new Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');const i=await this._validateInput(e),{runId:a,...o}=s,[u,c,,l,d,f,h,p,m,g]=this._defaults(o);d.configurable=await this._validateConfigurable(d.configurable);const y=new by({modes:new Set(c)});if(c.includes("messages")){const k=new _A(J=>y.push(J)),{callbacks:C}=d;if(C===void 0)d.callbacks=[k];else if(Array.isArray(C))d.callbacks=C.concat(k);else{const J=C.copy();J.addHandler(k,!0),d.callbacks=J}}c.includes("custom")&&(d.writer=k=>y.push([[],"custom",k]));const b=await(await $t(d))?.handleChainStart(this.toJSON(),lA(e,"input"),a,void 0,void 0,void 0,d?.runName??this.getName()),{channelSpecs:v,managed:w}=await this.prepareSpecs(d);let E,T;const x=(async()=>{try{E=await hd.initialize({input:i,config:d,checkpointer:p,nodes:this.nodes,channelSpecs:v,managed:w,outputKeys:l,streamKeys:this.streamChannelsAsIs,store:m,stream:y,interruptAfter:h,interruptBefore:f,manager:b,debug:this.debug});const k=new kA({loop:E,nodeFinished:d.configurable?.[GP]});t?.subgraphs&&(E.config.configurable={...E.config.configurable,[La]:E.stream}),await this._runLoop({loop:E,runner:k,debug:u,config:d})}catch(k){T=k}finally{try{E&&await E.store?.stop(),await Promise.all([...E?.checkpointerPromises??[],...Array.from(w.values()).map(k=>k.promises())])}catch(k){T=T??k}T?y.error(T):y.close()}})();try{for await(const k of y){if(k===void 0)throw new Error("Data structure error.");const[C,J,pe]=k;c.includes(J)&&(n&&!g?yield[C,J,pe]:g?n?yield[C,pe]:yield pe:yield[J,pe])}}catch(k){throw await b?.handleChainError(T),k}finally{await x}await b?.handleChainEnd(E?.output??{},a,void 0,void 0,void 0)}async invoke(e,t){const n=t?.streamMode??"values",s={...t,outputKeys:t?.outputKeys??this.outputChannels,streamMode:n},i=[],a=await this.stream(e,s);for await(const o of a)i.push(o);return n==="values"?i[i.length-1]:i}async _runLoop(e){const{loop:t,runner:n,debug:s,config:i}=e;let a;try{for(;await t.tick({inputKeys:this.inputChannels});)s&&aA(t.checkpointMetadata.step,t.channels,this.streamChannelsList),s&&yy(t.step,Object.values(t.tasks)),await n.tick({timeout:this.stepTimeout,retryPolicy:this.retryPolicy,onStepWrite:(o,u)=>{s&&oA(o,u,this.streamChannelsList)},maxConcurrency:i.maxConcurrency,signal:i.signal});if(t.status==="out_of_steps")throw new pP([`Recursion limit of ${i.recursionLimit} reached`,"without hitting a stop condition. You can increase the",'limit by setting the "recursionLimit" config key.'].join(" "),{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(o){if(a=o,!await t.finishAndHandleError(a))throw o}finally{a===void 0&&await t.finishAndHandleError()}}}class qn extends wo{constructor(e=!0){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"EphemeralValue"}),Object.defineProperty(this,"guard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.guard=e}fromCheckpoint(e){const t=new qn(this.guard);return typeof e<"u"&&(t.value=[e]),t}update(e){if(e.length===0){const t=this.value.length>0;return this.value=[],t}if(e.length!==1&&this.guard)throw new xe("EphemeralValue can only receive one value per step.");return this.value=[e[e.length-1]],!0}get(){if(this.value.length===0)throw new ft;return this.value[0]}checkpoint(){if(this.value.length===0)throw new ft;return this.value[0]}}class Sy{constructor(e){Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),be.isRunnable(e.path)?this.path=e.path:this.path=vt(e.path).withConfig({runName:"Branch"}),this.ends=Array.isArray(e.pathMap)?e.pathMap.reduce((t,n)=>(t[n]=n,t),{}):e.pathMap}run(e,t){return Ge.registerWriter(new pr({name:"<branch_run>",trace:!1,func:async(n,s)=>{try{return await this._route(n,s,e,t)}catch(i){throw i.name===uy.unminifiable_name&&console.warn(`[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.
NodeInterrupt should only be thrown inside a node, not in edge conditions.`),i}}}))}async _route(e,t,n,s){let i=await this.path.invoke(s?s(t):e,t);Array.isArray(i)||(i=[i]);let a;if(this.ends?a=i.map(u=>Ot(u)?u:this.ends[u]):a=i,a.some(u=>!u))throw new Error("Branch condition returned unknown or null destination");if(a.filter(Ot).some(u=>u.node===le))throw new xe("Cannot send a packet to the END node");return await n(a,t)??e}}class IA{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"branches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"entryPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"compiled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(e){this.compiled&&console.warn(e)}get allEdges(){return this.edges}addNode(...e){function t(s){return s.length>=1&&typeof s[0]!="string"}const n=t(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(n.length===0)throw new Error("No nodes provided in `addNode`");for(const[s,i,a]of n){for(const u of[dt,nr])if(s.includes(u))throw new Error(`"${u}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),s in this.nodes)throw new Error(`Node \`${s}\` already present.`);if(s===le)throw new Error(`Node \`${s}\` is reserved.`);const o=vt(i);this.nodes[s]={runnable:o,metadata:a?.metadata,subgraphs:fd(o)?[o]:a?.subgraphs,ends:a?.ends}}return this}addEdge(e,t){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),e===le)throw new Error("END cannot be a start node");if(t===Se)throw new Error("START cannot be an end node");if(Array.from(this.edges).some(([n])=>n===e)&&!("channels"in this))throw new Error(`Already found path for ${e}. For multiple edges, use StateGraph.`);return this.edges.add([e,t]),this}addConditionalEdges(e,t,n){const s=typeof e=="object"?e:{source:e,path:t,pathMap:n};if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),!be.isRunnable(s.path)){const a=Array.isArray(s.pathMap)?s.pathMap.join(","):Object.keys(s.pathMap??{}).join(",");s.path=vt(s.path).withConfig({runName:`Branch<${s.source}${a!==""?`,${a}`:""}>`.slice(0,63)})}const i=s.path.getName()==="RunnableLambda"?"condition":s.path.getName();if(this.branches[s.source]&&this.branches[s.source][i])throw new Error(`Condition \`${i}\` already present for node \`${e}\``);return this.branches[s.source]??={},this.branches[s.source][i]=new Sy(s),this}setEntryPoint(e){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(Se,e)}setFinishPoint(e){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(e,le)}compile({checkpointer:e,interruptBefore:t,interruptAfter:n,name:s}={}){this.validate([...Array.isArray(t)?t:[],...Array.isArray(n)?n:[]]);const i=new Ey({builder:this,checkpointer:e,interruptAfter:n,interruptBefore:t,autoValidate:!1,nodes:{},channels:{[Se]:new qn,[le]:new qn},inputChannels:Se,outputChannels:le,streamChannels:[],streamMode:"values",name:s});for(const[a,o]of Object.entries(this.nodes))i.attachNode(a,o);for(const[a,o]of this.edges)i.attachEdge(a,o);for(const[a,o]of Object.entries(this.branches))for(const[u,c]of Object.entries(o))i.attachBranch(a,u,c);return i.validate()}validate(e){const t=new Set([...this.allEdges].map(([s,i])=>s));for(const[s]of Object.entries(this.branches))t.add(s);for(const s of t)if(s!==Se&&!(s in this.nodes))throw new Error(`Found edge starting at unknown node \`${s}\``);const n=new Set([...this.allEdges].map(([s,i])=>i));for(const[s,i]of Object.entries(this.branches))for(const a of Object.values(i))if(a.ends!=null)for(const o of Object.values(a.ends))n.add(o);else{n.add(le);for(const o of Object.keys(this.nodes))o!==s&&n.add(o)}for(const s of Object.values(this.nodes))for(const i of s.ends??[])n.add(i);for(const s of Object.keys(this.nodes))if(!n.has(s))throw new gP([`Node \`${s}\` is not reachable.`,"","If you are returning Command objects from your node,",'make sure you are passing names of potential destination nodes as an "ends" array','into ".addNode(..., { ends: ["node1", "node2"] })".'].join(`
`),{lc_error_code:"UNREACHABLE_NODE"});for(const s of n)if(s!==le&&!(s in this.nodes))throw new Error(`Found edge ending at unknown node \`${s}\``);if(e){for(const s of e)if(!(s in this.nodes))throw new Error(`Interrupt node \`${s}\` is not present`)}this.compiled=!0}}class Ey extends TA{constructor({builder:e,...t}){super(t),Object.defineProperty(this,"builder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.builder=e}attachNode(e,t){this.channels[e]=new qn,this.nodes[e]=new an({channels:[],triggers:[],metadata:t.metadata,subgraphs:t.subgraphs,ends:t.ends}).pipe(t.runnable).pipe(new Ge([{channel:e,value:rr}],[Re])),this.streamChannels.push(e)}attachEdge(e,t){if(t===le){if(e===Se)throw new Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new Ge([{channel:le,value:rr}],[Re]))}else this.nodes[t].triggers.push(e),this.nodes[t].channels.push(e)}attachBranch(e,t,n){e===Se&&!this.nodes[Se]&&(this.nodes[Se]=AA.subscribeTo(Se,{tags:[Re]})),this.nodes[e].pipe(n.run(i=>{const a=i.map(o=>Ot(o)?o:{channel:o===le?le:`branch:${e}:${t}:${o}`,value:rr});return new Ge(a,[Re])}));const s=n.ends?Object.values(n.ends):Object.keys(this.nodes);for(const i of s)if(i!==le){const a=`branch:${e}:${t}:${i}`;this.channels[a]=new qn,this.nodes[i].triggers.push(a),this.nodes[i].channels.push(a)}}async getGraphAsync(e){const t=e?.xray,n=new Aa,s={[Se]:n.addNode({schema:Pr()},Se)},i={};let a={};t&&(a=Object.fromEntries((await Rn(this.getSubgraphsAsync())).filter(c=>kp(c[1]))));function o(c,l,d,f=!1){if(l===le&&i[le]===void 0&&(i[le]=n.addNode({schema:Pr()},le)),s[c]!==void 0){if(i[l]===void 0)throw new Error(`End node ${l} not found!`);return n.addEdge(s[c],i[l],d!==l?d:void 0,f)}}for(const[c,l]of Object.entries(this.builder.nodes)){const d=Ze(c),f=l.runnable,h=l.metadata??{};if(this.interruptBefore?.includes(c)&&this.interruptAfter?.includes(c)?h.__interrupt="before,after":this.interruptBefore?.includes(c)?h.__interrupt="before":this.interruptAfter?.includes(c)&&(h.__interrupt="after"),t){const p=typeof t=="number"?t-1:t,m=a[c]!==void 0?await a[c].getGraphAsync({...e,xray:p}):f.getGraph(e);if(m.trimFirstNode(),m.trimLastNode(),Object.keys(m.nodes).length>1){let _=function(v){return v?v.lc_runnable:!1},b=function(v,w){if(v!==void 0&&!Mn(v))return v;if(_(w))try{let E=w.getName();return E=E.startsWith("Runnable")?E.slice(8):E,E}catch{return w.getName()}else return w.name??"UnknownSchema"};const[g,y]=n.extend(m,d);if(g===void 0)throw new Error(`Could not extend subgraph "${c}" due to missing entrypoint.`);y!==void 0&&(s[d]={name:b(y.id,y.data),...y}),i[d]={name:b(g.id,g.data),...g}}else{const g=n.addNode(f,d,h);s[d]=g,i[d]=g}}else{const p=n.addNode(f,d,h);s[d]=p,i[d]=p}}const u=[...this.builder.allEdges].sort(([c],[l])=>c<l?-1:l>c?1:0);for(const[c,l]of u)o(Ze(c),Ze(l));for(const[c,l]of Object.entries(this.builder.branches)){const d={...Object.fromEntries(Object.keys(this.builder.nodes).filter(f=>f!==c).map(f=>[Ze(f),Ze(f)])),[le]:le};for(const f of Object.values(l)){let h;f.ends!==void 0?h=f.ends:h=d;for(const[p,m]of Object.entries(h))o(Ze(c),Ze(m),p,!0)}}for(const[c,l]of Object.entries(this.builder.nodes))if(l.ends!==void 0)for(const d of l.ends)o(Ze(c),Ze(d),void 0,!0);return n}getGraph(e){const t=e?.xray,n=new Aa,s={[Se]:n.addNode({schema:Pr()},Se)},i={};let a={};t&&(a=Object.fromEntries(As(this.getSubgraphs()).filter(c=>kp(c[1]))));function o(c,l,d,f=!1){return l===le&&i[le]===void 0&&(i[le]=n.addNode({schema:Pr()},le)),n.addEdge(s[c],i[l],d!==l?d:void 0,f)}for(const[c,l]of Object.entries(this.builder.nodes)){const d=Ze(c),f=l.runnable,h=l.metadata??{};if(this.interruptBefore?.includes(c)&&this.interruptAfter?.includes(c)?h.__interrupt="before,after":this.interruptBefore?.includes(c)?h.__interrupt="before":this.interruptAfter?.includes(c)&&(h.__interrupt="after"),t){const p=typeof t=="number"?t-1:t,m=a[c]!==void 0?a[c].getGraph({...e,xray:p}):f.getGraph(e);if(m.trimFirstNode(),m.trimLastNode(),Object.keys(m.nodes).length>1){let _=function(v){return v?v.lc_runnable:!1},b=function(v,w){if(v!==void 0&&!Mn(v))return v;if(_(w))try{let E=w.getName();return E=E.startsWith("Runnable")?E.slice(8):E,E}catch{return w.getName()}else return w.name??"UnknownSchema"};const[g,y]=n.extend(m,d);if(g===void 0)throw new Error(`Could not extend subgraph "${c}" due to missing entrypoint.`);y!==void 0&&(s[d]={name:b(y.id,y.data),...y}),i[d]={name:b(g.id,g.data),...g}}else{const g=n.addNode(f,d,h);s[d]=g,i[d]=g}}else{const p=n.addNode(f,d,h);s[d]=p,i[d]=p}}const u=[...this.builder.allEdges].sort(([c],[l])=>c<l?-1:l>c?1:0);for(const[c,l]of u)o(Ze(c),Ze(l));for(const[c,l]of Object.entries(this.builder.branches)){const d={...Object.fromEntries(Object.keys(this.builder.nodes).filter(f=>f!==c).map(f=>[Ze(f),Ze(f)])),[le]:le};for(const f of Object.values(l)){let h;f.ends!==void 0?h=f.ends:h=d;for(const[p,m]of Object.entries(h))o(Ze(c),Ze(m),p,!0)}}return n}}function kp(r){return typeof r.attachNode=="function"&&typeof r.attachEdge=="function"}function Ze(r){return r==="subgraph"?`"${r}"`:r}const Pp=(r,e)=>r.size===e.size&&[...r].every(t=>e.has(t));class pd extends wo{constructor(e){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"NamedBarrierValue"}),Object.defineProperty(this,"names",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.names=e,this.seen=new Set}fromCheckpoint(e){const t=new pd(this.names);return typeof e<"u"&&(t.seen=new Set(e)),t}update(e){let t=!1;for(const n of e)if(this.names.has(n))this.seen.has(n)||(this.seen.add(n),t=!0);else throw new xe(`Value ${JSON.stringify(n)} not in names ${JSON.stringify(this.names)}`);return t}get(){if(!Pp(this.names,this.seen))throw new ft}checkpoint(){return[...this.seen]}consume(){return this.seen&&this.names&&Pp(this.seen,this.names)?(this.seen=new Set,!0):!1}}const xy=new WeakMap;function Oy(r){return typeof r=="object"&&r!=null&&"_parse"in r&&typeof r._parse=="function"}function RA(r){return Oy(r)&&"removeDefault"in r&&typeof r.removeDefault=="function"}function yn(r){return Oy(r)&&"partial"in r&&typeof r.partial=="function"}function CA(r,e){if(e.reducer&&!e.default){const t=RA(r)?r._def.defaultValue:void 0;t!=null&&(e.default=t)}return xy.set(r,e),r}function $A(r){return xy.get(r)}function gs(r){const e={};for(const t in r.shape)if(Object.prototype.hasOwnProperty.call(r.shape,t)){const n=r.shape[t],s=$A(n);s?.reducer?e[t]=new Ks(s.reducer.fn,s.default):e[t]=new gi}return e}const mn="__root__";class md extends IA{constructor(e,t){if(super(),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"waitingEdges",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"_schemaDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaDefinitions",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"_configSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_configRuntimeSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),FA(e)){const n=gs(e.state),s=e.input!=null?gs(e.input):n,i=e.output!=null?gs(e.output):n;this._schemaDefinition=n,this._schemaRuntimeDefinition=e.state,this._inputDefinition=s,this._inputRuntimeDefinition=e.input??e.state.partial(),this._outputDefinition=i,this._outputRuntimeDefinition=e.output??e.state}else if(yn(e)){const n=gs(e);this._schemaDefinition=n,this._schemaRuntimeDefinition=e,this._inputDefinition=n,this._inputRuntimeDefinition=e.partial(),this._outputDefinition=n,this._outputRuntimeDefinition=e}else if(UA(e))this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(DA(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=e.input?.spec??this._schemaDefinition,this._outputDefinition=e.output?.spec??this._schemaDefinition;else if(LA(e)||Ap(e)){const n=Ap(e)?e.spec:e;this._schemaDefinition=n}else if(MA(e)){const n=NA(e.channels);this._schemaDefinition=n}else throw new Error("Invalid StateGraph input.");this._inputDefinition??=this._schemaDefinition,this._outputDefinition??=this._schemaDefinition,this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition),yn(t)&&(this._configRuntimeSchema=t.passthrough())}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap(([e,t])=>e.map(n=>[n,t]))])}_addSchema(e){if(!this._schemaDefinitions.has(e)){this._schemaDefinitions.set(e,e);for(const[t,n]of Object.entries(e)){let s;if(typeof n=="function"?s=n():s=n,this.channels[t]!==void 0){if(this.channels[t]!==s&&!vo(s)&&s.lc_graph_name!=="LastValue")throw new Error(`Channel "${t}" already exists with a different type.`)}else this.channels[t]=s}}}addNode(...e){function t(s){return s.length>=1&&typeof s[0]!="string"}const n=t(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(n.length===0)throw new Error("No nodes provided in `addNode`");for(const[s,i,a]of n){if(s in this.channels)throw new Error(`${s} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(const l of[dt,nr])if(s.includes(l))throw new Error(`"${l}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),s in this.nodes)throw new Error(`Node \`${s}\` already present.`);if(s===le||s===Se)throw new Error(`Node \`${s}\` is reserved.`);let o=this._schemaDefinition;a?.input!==void 0&&(yn(a.input)?o=gs(a.input):a.input.spec!==void 0&&(o=a.input.spec)),o!==void 0&&this._addSchema(o);let u;be.isRunnable(i)?u=i:typeof i=="function"?u=new pr({func:i,name:s,trace:!1}):u=vt(i);const c={runnable:u,retryPolicy:a?.retryPolicy,metadata:a?.metadata,input:o??this._schemaDefinition,subgraphs:fd(u)?[u]:a?.subgraphs,ends:a?.ends};this.nodes[s]=c}return this}addEdge(e,t){if(typeof e=="string")return super.addEdge(e,t);this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph.");for(const n of e){if(n===le)throw new Error("END cannot be a start node");if(!Object.keys(this.nodes).some(s=>s===n))throw new Error(`Need to add a node named "${n}" first`)}if(t===le)throw new Error("END cannot be an end node");if(!Object.keys(this.nodes).some(n=>n===t))throw new Error(`Need to add a node named "${t}" first`);return this.waitingEdges.add([e,t]),this}addSequence(e){const t=Array.isArray(e)?e:Object.entries(e);if(t.length===0)throw new Error("Sequence requires at least one node.");let n;for(const[s,i,a]of t){if(s in this.nodes)throw new Error(`Node names must be unique: node with the name "${s}" already exists.`);const o=s;this.addNode(o,i,a),n!=null&&this.addEdge(n,o),n=o}return this}compile({checkpointer:e,store:t,interruptBefore:n,interruptAfter:s,name:i}={}){this.validate([...Array.isArray(n)?n:[],...Array.isArray(s)?s:[]]);const a=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),o=a.length===1&&a[0]===mn?mn:a,u=Object.keys(this.channels),c=u.length===1&&u[0]===mn?mn:u,l=new jA({builder:this,checkpointer:e,interruptAfter:s,interruptBefore:n,autoValidate:!1,nodes:{},channels:{...this.channels,[Se]:new qn},inputChannels:Se,outputChannels:o,streamChannels:c,streamMode:"updates",store:t,name:i});l.attachNode(Se);for(const[d,f]of Object.entries(this.nodes))l.attachNode(d,f);l.attachBranch(Se,vp,Tp(),{withReader:!1});for(const[d]of Object.entries(this.nodes))l.attachBranch(d,vp,Tp(),{withReader:!1});for(const[d,f]of this.edges)l.attachEdge(d,f);for(const[d,f]of this.waitingEdges)l.attachEdge(d,f);for(const[d,f]of Object.entries(this.branches))for(const[h,p]of Object.entries(f))l.attachBranch(d,h,p);return l.validate()}}function NA(r){const e={};for(const[t,n]of Object.entries(r))e[t]=Jc(n);return e}class jA extends Ey{attachNode(e,t){let n;e===Se?n=Object.entries(this.builder._schemaDefinitions.get(this.builder._inputDefinition)).filter(([u,c])=>!vo(c)).map(([u])=>u):n=Object.keys(this.builder.channels);function s(u){if(ot(u))return u.graph===Wt.PARENT?null:u._updateAsTuples();if(Array.isArray(u)&&u.length>0&&u.some(c=>ot(c))){const c=[];for(const l of u)if(ot(l)){if(l.graph===Wt.PARENT)continue;c.push(...l._updateAsTuples())}else c.push([mn,l]);return c}else if(u!=null)return[[mn,u]];return null}const i=e;function a(u){if(u){if(ot(u))return u.graph===Wt.PARENT?null:u._updateAsTuples().filter(([c])=>n.includes(c));if(Array.isArray(u)&&u.length>0&&u.some(ot)){const c=[];for(const l of u)if(ot(l)){if(l.graph===Wt.PARENT)continue;c.push(...l._updateAsTuples().filter(([d])=>n.includes(d)))}else{const d=a(l);d&&c.push(...d??[])}return c}else{if(typeof u=="object"&&!Array.isArray(u))return Object.entries(u).filter(([c])=>n.includes(c));{const c=Array.isArray(u)?"array":typeof u;throw new xe(`Expected node "${i.toString()}" to return an object or an array containing at least one Command object, received ${c}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}}}else return null}const o=[{value:rr,mapper:new pr({func:n.length&&n[0]===mn?s:a,trace:!1,recurse:!1})}];if(e===Se)this.nodes[e]=new an({tags:[Re],triggers:[Se],channels:[Se],writers:[new Ge(o,[Re])]});else{const u=t?.input??this.builder._schemaDefinition,c=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(u)).map(f=>[f,f])),l=Object.keys(c).length===1&&mn in c,d=`branch:to:${e}`;this.channels[d]=new qn(!1),this.nodes[e]=new an({triggers:[d],channels:l?Object.keys(c):c,writers:[new Ge(o,[Re])],mapper:l?void 0:f=>Object.fromEntries(Object.entries(f).filter(([h])=>h in c)),bound:t?.runnable,metadata:t?.metadata,retryPolicy:t?.retryPolicy,subgraphs:t?.subgraphs,ends:t?.ends})}}attachEdge(e,t){if(t!==le){if(typeof e=="string")this.nodes[e].writers.push(new Ge([{channel:`branch:to:${t}`,value:null}],[Re]));else if(Array.isArray(e)){const n=`join:${e.join("+")}:${t}`;this.channels[n]=new pd(new Set(e)),this.nodes[t].triggers.push(n);for(const s of e)this.nodes[s].writers.push(new Ge([{channel:n,value:s}],[Re]))}}}attachBranch(e,t,n,s={withReader:!0}){const i=async(a,o)=>{const u=a.filter(l=>l!==le);if(!u.length)return;const c=u.map(l=>Ot(l)?l:{channel:`branch:to:${l}`,value:e});await Ge.doWrite({...o,tags:(o.tags??[]).concat([Re])},c)};this.nodes[e].writers.push(n.run(i,s.withReader?a=>dd.doRead(a,this.streamChannels??this.outputChannels,!0):void 0))}async _validateInput(e){const t=this.builder._inputRuntimeDefinition;if(ot(e)){const n=e;return e.update&&yn(t)&&(n.update=t.parse(e.update)),n}return yn(t)?t.parse(e):e}async _validateConfigurable(e){const t=this.builder._configRuntimeSchema;return yn(t)&&t.parse(e),e}}function LA(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)&&Object.keys(r).length>0&&Object.values(r).every(e=>typeof e=="function"||bo(e))}function Ap(r){return typeof r=="object"&&r!==null&&"lc_graph_name"in r&&r.lc_graph_name==="AnnotationRoot"}function MA(r){return typeof r=="object"&&r!==null&&r.channels!==void 0}function DA(r){return typeof r=="object"&&r!==null&&r.stateSchema!==void 0}function UA(r){return typeof r=="object"&&r!==null&&r.stateSchema===void 0&&r.input!==void 0&&r.output!==void 0}function FA(r){return!(typeof r!="object"||r==null||!("state"in r)||!yn(r.state)||"input"in r&&!yn(r.input)||"output"in r&&!yn(r.output))}function BA(r){if(Ot(r))return[r];const e=[];ot(r)?e.push(r):Array.isArray(r)&&e.push(...r.filter(ot));const t=[];for(const n of e){if(n.graph===Wt.PARENT)throw new cy(n);Ot(n.goto)||typeof n.goto=="string"?t.push(n.goto):Array.isArray(n.goto)&&t.push(...n.goto)}return t}function Tp(){const r=new pr({func:BA,tags:[Re],trace:!1,recurse:!1,name:"<control_branch>"});return new Sy({path:r})}const zA="__remove_all__";function ky(r,e){const t=Array.isArray(r)?r:[r],n=Array.isArray(e)?e:[e],s=t.map(Qn),i=n.map(Qn);for(const l of s)(l.id===null||l.id===void 0)&&(l.id=Ke(),l.lc_kwargs.id=l.id);let a;for(let l=0;l<i.length;l+=1){const d=i[l];(d.id===null||d.id===void 0)&&(d.id=Ke(),d.lc_kwargs.id=d.id),d.getType()==="remove"&&d.id===zA&&(a=l)}if(a!=null)return i.slice(a+1);const o=[...s],u=new Map(o.map((l,d)=>[l.id,d])),c=new Set;for(const l of i){const d=u.get(l.id);if(d!==void 0)l.getType()==="remove"?c.add(l.id):(c.delete(l.id),o[d]=l);else{if(l.getType()==="remove")throw new Error(`Attempting to delete a message with an ID that doesn't exist ('${l.id}')`);u.set(l.id,o.length),o.push(l)}}return o.filter(l=>!c.has(l.id))}Be.Root({messages:Be({reducer:ky,default:()=>[]})});Hn({messages:CA(Nd(),{reducer:{schema:Nd(),fn:ky},default:()=>[]})});function GA(r){const e=r.nightDeaths||[];let t;return e.length===0?t="æ˜¨æ™šæ˜¯å¹³å®‰å¤œï¼Œæ²¡æœ‰äººæ­»äº¡ã€‚":t=`æ˜¨æ™š ${e.map(s=>{const i=r.players.find(a=>a.id===s);return i?`${i.name}(${i.id})`:s}).join("ã€")} æ­»äº¡äº†ã€‚`,{daySummary:t,phase:"day"}}function qA(r){return{daySummary:`æœ¬è½®å…±æœ‰ ${r.speeches?.length||0} åçŽ©å®¶å‘è¨€å®Œæ¯•ï¼Œè¿›å…¥æŠ•ç¥¨é˜¶æ®µã€‚`,phase:"vote"}}async function HA(r,e){const t=r.players.find(u=>u.id===e);if(!t||!t.isAlive)return{};const n=Rt(),i=await os(t).speak({player:t,previousSpeeches:r.speeches,gameLog:n.gameLog,alivePlayers:r.alivePlayers,allPlayers:r.players,round:r.round,nightDeaths:r.nightDeaths||[]}),a={id:crypto.randomUUID(),type:"speak",senderId:e,content:i,phase:"day",round:r.round,timestamp:Date.now()},o=n.getCurrentRound();return o&&o.speeches.push(a),{speeches:[a]}}const gd=Be.Root({phase:Be(),round:Be(),players:Be(),alivePlayers:Be(),nightKillTarget:Be(),witchSaved:Be(),witchPoisonTarget:Be(),nightDeaths:Be(),speeches:Be({reducer:(r,e)=>[...r,...e],default:()=>[]}),daySummary:Be(),votes:Be(),eliminatedByVote:Be(),hunterShotTarget:Be(),winner:Be()});function VA(r){const e=[...r].sort((n,s)=>n.seatIndex-s.seatIndex);if(e.length===0)return[];const t=Math.floor(Math.random()*e.length);return[...e.slice(t),...e.slice(0,t)]}function WA(r){const e=VA(r),t=new md(gd);t.addNode("announce",GA);for(const n of e){const s=`speak_${n.id}`;t.addNode(s,async i=>HA(i,n.id))}if(t.addNode("dayEnd",qA),t.addEdge("__start__","announce"),e.length>0){t.addEdge("announce",`speak_${e[0].id}`);for(let n=0;n<e.length-1;n++)t.addEdge(`speak_${e[n].id}`,`speak_${e[n+1].id}`);t.addEdge(`speak_${e[e.length-1].id}`,"dayEnd")}else t.addEdge("announce","dayEnd");return t.addEdge("dayEnd","__end__"),t.compile()}function ZA(r){const e=[];return r.nightKillTarget&&!r.witchSaved&&e.push(r.nightKillTarget),r.witchPoisonTarget&&e.push(r.witchPoisonTarget),{nightDeaths:e}}async function JA(r){const e=Ht(),t=Rt(),n=r.alivePlayers.find(a=>a.role==="seer");if(!n)return{};e.addSystemMessage("ðŸ”® é¢„è¨€å®¶æŸ¥éªŒçŽ¯èŠ‚",r.phase,r.round);const i=await os(n).nightAction({player:n,alivePlayers:r.alivePlayers,allPlayers:r.players,gameLog:t.gameLog});if(i.type==="inspect"){const a=r.players.find(o=>o.id===i.targetId);if(a){n.memory.seerResults||(n.memory.seerResults=[]),n.memory.seerResults.push({targetId:a.id,faction:a.faction});const o=a.faction==="werewolf"?"åäººï¼ˆç‹¼äººé˜µè¥ï¼‰":"å¥½äººï¼ˆå¥½äººé˜µè¥ï¼‰",u=`æŸ¥éªŒç»“æžœï¼š${a.name}ï¼ˆ${a.id}ï¼‰æ˜¯${o}`;e.addMessage("action",n.id,u,r.phase,r.round);const c=t.getCurrentRound();if(c){const l={id:crypto.randomUUID(),type:"system",senderId:"system",content:u,phase:r.phase,round:r.round,timestamp:Date.now()};c.nightEvents.seerActions.push(l)}}}return{}}async function KA(r){const e=Ht(),t=Rt(),n=r.alivePlayers.find(c=>c.role==="witch");if(!n)return{witchSaved:!1,witchPoisonTarget:null};const s=n.memory.witchPotions;if(!(s?.antidote||s?.poison))return{witchSaved:!1,witchPoisonTarget:null};e.addSystemMessage("ðŸ§ª å¥³å·«è¡ŒåŠ¨çŽ¯èŠ‚",r.phase,r.round);const a=t.getCurrentRound();if(r.nightKillTarget&&a){const l=`ä»Šæ™šè¢«ç‹¼äººè¢­å‡»çš„æ˜¯ ${r.players.find(d=>d.id===r.nightKillTarget)?.name||r.nightKillTarget}ï¼Œä½ æœ‰è§£è¯ï¼ˆ${s?.antidote?"å‰©ä½™":"å·²ç”¨"}ï¼‰å’Œæ¯’è¯ï¼ˆ${s?.poison?"å‰©ä½™":"å·²ç”¨"}ï¼‰`;a.nightEvents.witchNotification={id:crypto.randomUUID(),type:"system",senderId:"system",content:l,phase:r.phase,round:r.round,timestamp:Date.now()}}const u=await os(n).nightAction({player:n,alivePlayers:r.alivePlayers,allPlayers:r.players,nightKillTarget:r.nightKillTarget??void 0,gameLog:t.gameLog});if(u.type==="witch")switch(u.action){case"save":{if(!s?.antidote)break;n.memory.witchPotions.antidote=!1;const l=`ä½¿ç”¨è§£è¯ï¼Œæ•‘æ´»äº† ${r.players.find(d=>d.id===r.nightKillTarget)?.name||r.nightKillTarget}`;return e.addMessage("action",n.id,`ðŸ§ª ${l}`,r.phase,r.round),a&&(a.nightEvents.witchAction={id:crypto.randomUUID(),type:"action",senderId:n.id,content:l,phase:r.phase,round:r.round,timestamp:Date.now()}),{witchSaved:!0,witchPoisonTarget:null}}case"poison":{if(!s?.poison||!u.targetId)break;n.memory.witchPotions.poison=!1;const l=`ä½¿ç”¨æ¯’è¯ï¼Œæ¯’æ€äº† ${r.players.find(d=>d.id===u.targetId)?.name||u.targetId}`;return e.addMessage("action",n.id,`â˜ ï¸ ${l}`,r.phase,r.round),a&&(a.nightEvents.witchAction={id:crypto.randomUUID(),type:"action",senderId:n.id,content:l,phase:r.phase,round:r.round,timestamp:Date.now()}),{witchSaved:!1,witchPoisonTarget:u.targetId}}case"skip":{const c="é€‰æ‹©ä¸ä½¿ç”¨ä»»ä½•è¯ç‰©";e.addMessage("action",n.id,c,r.phase,r.round),a&&(a.nightEvents.witchAction={id:crypto.randomUUID(),type:"action",senderId:n.id,content:c,phase:r.phase,round:r.round,timestamp:Date.now()});break}}return{witchSaved:!1,witchPoisonTarget:null}}async function XA(r){const e=Ht(),t=Rt();e.addSystemMessage("ðŸº ç‹¼äººè¡ŒåŠ¨çŽ¯èŠ‚ï¼Œç‹¼äººå¼€å§‹é€‰æ‹©å‡»æ€ç›®æ ‡",r.phase,r.round);const n=r.alivePlayers.filter(a=>a.role==="werewolf"),s=[];for(const a of n){const u=await os(a).nightAction({player:a,alivePlayers:r.alivePlayers,allPlayers:r.players,gameLog:t.gameLog});u.type==="kill"&&s.push(u.targetId)}const i=s.length>0?Ky(s):null;if(i){const o=`ç‹¼äººå†³å®šä»Šæ™šå‡»æ€ ${r.players.find(c=>c.id===i)?.name||i}`;e.addMessage("action","system",`ðŸº ${o}`,r.phase,r.round);const u=t.getCurrentRound();u&&(u.nightEvents.killDecision={id:crypto.randomUUID(),type:"system",senderId:"system",content:o,phase:r.phase,round:r.round,timestamp:Date.now()})}return{nightKillTarget:i}}function YA(){return new md(gd).addNode("wolfGroup",XA).addNode("seer",JA).addNode("witch",KA).addNode("nightSummary",ZA).addEdge("__start__","wolfGroup").addEdge("wolfGroup","seer").addEdge("seer","witch").addEdge("witch","nightSummary").addEdge("nightSummary","__end__").compile()}async function QA(r,e){const t=r.players.find(u=>u.id===e);if(!t||!t.isAlive)return{};const n=Rt(),s=Ht(),a=await os(t).vote({player:t,speeches:r.speeches,gameLog:n.gameLog,alivePlayers:r.alivePlayers,allPlayers:r.players,round:r.round}),o=r.players.find(u=>u.id===a);return s.addMessage("action",e,`æŠ•ç¥¨æ”¾é€ ${o?.name||a}`,r.phase,r.round),{votes:{...r.votes,[e]:a}}}function eT(r){return{eliminatedByVote:Xy(r.votes||{})}}function tT(r){const e=new md(gd);e.addNode("initVotes",()=>({votes:{}}));for(const t of r){const n=`vote_${t.id}`;e.addNode(n,async s=>QA(s,t.id))}if(e.addNode("voteCount",eT),e.addEdge("__start__","initVotes"),r.length>0){e.addEdge("initVotes",`vote_${r[0].id}`);for(let t=0;t<r.length-1;t++)e.addEdge(`vote_${r[t].id}`,`vote_${r[t+1].id}`);e.addEdge(`vote_${r[r.length-1].id}`,"voteCount")}else e.addEdge("initVotes","voteCount");return e.addEdge("voteCount","__end__"),e.compile()}async function nT(r,e){let t={...r};for(;!t.winner;){t.phase="night",e.onPhaseChange("night",t.round);const s=await YA().invoke(t);t={...t,...s};const i=t.nightDeaths||[];for(const f of i)Zi(t.players,f);t.alivePlayers=t.players.filter(f=>f.isAlive),e.onNightDeaths(i);for(const f of i)if(t.players.find(p=>p.id===f)?.isHuman&&e.onPlayerDeath&&await e.onPlayerDeath(f)==="restart")return t;for(const f of i)if(t.players.find(p=>p.id===f)?.role==="hunter"&&f!==t.witchPoisonTarget){e.onHunterTrigger(f);const p=await hp(t,f);p.hunterShotTarget&&(Zi(t.players,p.hunterShotTarget),t.alivePlayers=t.players.filter(m=>m.isAlive),e.onPlayerEliminated(p.hunterShotTarget,"hunter"))}const a=_d(t.players);if(a){t.winner=a,t.phase="ended",e.onGameEnd(a);break}t.phase="day",t.speeches=[],e.onPhaseChange("day",t.round),await Ip(500);const u=await WA(t.alivePlayers).invoke(t);t={...t,...u},t.phase="vote",t.votes={},e.onPhaseChange("vote",t.round),await Ip(300);const l=await tT(t.alivePlayers).invoke(t);if(t={...t,...l},e.onVoteResults(t.votes||{},t.eliminatedByVote),t.eliminatedByVote){Zi(t.players,t.eliminatedByVote),t.alivePlayers=t.players.filter(h=>h.isAlive),e.onPlayerEliminated(t.eliminatedByVote,"vote");const f=t.players.find(h=>h.id===t.eliminatedByVote);if(f?.isHuman&&e.onPlayerDeath&&await e.onPlayerDeath(t.eliminatedByVote)==="restart")return t;if(f?.role==="hunter"){e.onHunterTrigger(f.id);const h=await hp(t,f.id);h.hunterShotTarget&&(Zi(t.players,h.hunterShotTarget),t.alivePlayers=t.players.filter(p=>p.isAlive),e.onPlayerEliminated(h.hunterShotTarget,"hunter"))}}const d=_d(t.players);if(d){t.winner=d,t.phase="ended",e.onGameEnd(d);break}t.round++,t.nightKillTarget=null,t.witchSaved=!1,t.witchPoisonTarget=null,t.nightDeaths=[],t.speeches=[],t.votes={},t.eliminatedByVote=null,t.hunterShotTarget=null}return t}function Zi(r,e){const t=r.find(n=>n.id===e);t&&(t.isAlive=!1)}function Ip(r){return new Promise(e=>setTimeout(e,r))}function rT(){const r=Rt(),e=cn(),t=Ht(),n=Rp(),s=Le(!1);function i(){for(const o of e.players)o.systemPrompt=iw[o.role]||""}async function a(){if(s.value)return;s.value=!0,aP({apiKey:n.apiKey,baseUrl:n.apiBaseUrl,model:n.modelId}),i();const o=e.humanPlayer;if(o&&(t.addSystemMessage(`æ¸¸æˆå¼€å§‹ï¼ä½ çš„èº«ä»½æ˜¯ã€${Qc(o.role)}ã€‘ï¼ˆ${o.faction==="werewolf"?"ç‹¼äººé˜µè¥":"å¥½äººé˜µè¥"}ï¼‰`,"init",0),o.role==="werewolf")){const c=e.players.filter(l=>l.role==="werewolf"&&!l.isHuman).map(l=>l.name);c.length>0&&t.addSystemMessage(`ä½ çš„ç‹¼äººé˜Ÿå‹æ˜¯ï¼š${c.join("ã€")}`,"init",0)}const u={phase:"night",round:1,players:e.players,alivePlayers:e.alivePlayers,nightKillTarget:null,witchSaved:!1,witchPoisonTarget:null,nightDeaths:[],speeches:[],daySummary:"",votes:{},eliminatedByVote:null,hunterShotTarget:null,winner:null};r.setPhase("night"),r.nextRound();try{await nT(u,{onPhaseChange(c,l){r.setPhase(c),r.isAiThinking=c!=="ended",c==="night"&&l>r.round&&r.nextRound();const d={night:"ðŸŒ™ å¤œæ™šé™ä¸´ï¼Œé—­ä¸Šçœ¼ç›...",day:"â˜€ï¸ å¤©äº®äº†",vote:"âš–ï¸ è¿›å…¥æŠ•ç¥¨é˜¶æ®µ"};d[c]&&t.addSystemMessage(d[c],c,l)},onNightDeaths(c){for(const f of c)e.killPlayer(f);const l=c.length===0?"æ˜¨æ™šæ˜¯å¹³å®‰å¤œï¼Œæ²¡æœ‰äººæ­»äº¡ã€‚":`æ˜¨æ™š ${c.map(f=>e.getPlayerById(f)?.name||f).join("ã€")} æ­»äº¡äº†ã€‚`;t.addSystemMessage(l,"day",r.round);const d=r.getCurrentRound();d&&(d.dayAnnouncement={id:crypto.randomUUID(),type:"system",senderId:"system",content:l,phase:"day",round:r.round,timestamp:Date.now()}),r.isAiThinking=!1},onPlayerEliminated(c,l){e.killPlayer(c);const f=e.getPlayerById(c)?.name||c;l==="vote"?t.addSystemMessage(`${f} è¢«æŠ•ç¥¨æ”¾é€å‡ºå±€ã€‚`,"vote",r.round):t.addSystemMessage(`ðŸŽ¯ çŒŽäººå¼€æžªå¸¦èµ°äº† ${f}ï¼`,r.phase,r.round)},onHunterTrigger(c){const l=e.getPlayerById(c);t.addSystemMessage(`${l?.name||c} æ˜¯çŒŽäººï¼Œè§¦å‘å¼€æžªæŠ€èƒ½ï¼`,r.phase,r.round)},onVoteResults(c,l){const d=new Map;for(const[m,g]of Object.entries(c))d.has(g)||d.set(g,[]),d.get(g).push(m);const h=[...d.entries()].sort((m,g)=>g[1].length-m[1].length).map(([m,g])=>{const y=e.getPlayerById(m)?.name||m,_=g.map(b=>e.getPlayerById(b)?.name||b).join("ã€");return`${y} èŽ· ${g.length} ç¥¨ï¼ˆ${_}ï¼‰`});t.addSystemMessage(`ðŸ“Š æŠ•ç¥¨ç»“æžœï¼š
${h.join(`
`)}`,"vote",r.round);const p=r.getCurrentRound();if(p){const m={id:crypto.randomUUID(),type:"system",senderId:"system",content:`æŠ•ç¥¨ç»“æžœï¼š
${h.join(`
`)}`,phase:"vote",round:r.round,timestamp:Date.now()};p.voteResults.push(m)}l||t.addSystemMessage("æœ¬è½®æ— äººå‡ºå±€ï¼ˆå¹³ç¥¨ï¼‰ã€‚","vote",r.round)},onGameEnd(c){r.setWinner(c),r.isAiThinking=!1,s.value=!1;const l=c==="werewolf"?"ðŸº ç‹¼äººé˜µè¥":"ðŸŽ‰ å¥½äººé˜µè¥";t.addSystemMessage(`æ¸¸æˆç»“æŸï¼${l}èŽ·å¾—èƒœåˆ©ï¼`,"ended",r.round)},async onPlayerDeath(c){const l=e.getPlayerById(c);r.isPlayerDead=!0,r.isAiThinking=!1,t.addSystemMessage("ðŸ’€ ä½ å·²æ­»äº¡ï¼è¯·é€‰æ‹©ï¼šç»§ç»­è§‚æˆ˜è¿˜æ˜¯é‡æ–°å¼€å§‹æ¸¸æˆï¼Ÿ",r.phase,r.round);const d=await Tb(l);return r.isPlayerDead=!1,d==="restart"&&(s.value=!1),d}})}catch(c){console.error("Game loop error:",c),r.isAiThinking=!1,s.value=!1;const l=c instanceof Error?c.message:"æœªçŸ¥é”™è¯¯";t.addSystemMessage(`âŒ æ¸¸æˆå‡ºé”™ï¼š${l}`,r.phase,r.round)}}return{isRunning:s,startGame:a}}const sT=globalThis.setInterval;function iT(){const r=Le(null),e=Le(null);let t=null;function n(){t||(t=sT(()=>{const a=Pb();a?(r.value=a.type,e.value=a):(r.value=null,e.value=null)},100))}function s(){t&&(clearInterval(t),t=null)}function i(a){r.value=null,e.value=null,Ab(a)}return Ua(n),Uy(s),{waitingFor:r,currentInterrupt:e,submit:i,startPolling:n,stopPolling:s}}const aT={class:"h-screen flex flex-col bg-background overflow-hidden"},oT={class:"shrink-0 px-4 pt-3 pb-2"},uT={key:0,class:"shrink-0 flex justify-center gap-2 px-4 pb-2"},cT={class:"flex-1 flex gap-2 px-4 min-h-0"},lT={key:0,class:"shrink-0 flex flex-col justify-center gap-2"},dT={class:"flex-1 flex flex-col gap-2 min-h-0 min-w-0"},fT={key:0,class:"shrink-0 flex items-center justify-between px-4 py-2.5 rounded-xl bg-blue-950/60 border border-blue-500/20"},hT={class:"text-sm text-blue-300"},pT={key:0,class:"flex items-center gap-1.5 text-xs text-blue-400"},mT={class:"flex-1 min-h-0"},gT={key:1,class:"shrink-0"},yT={key:4,class:"shrink-0"},_T={key:1,class:"shrink-0 flex flex-col justify-center gap-2"},bT={key:1,class:"shrink-0 px-4 py-3 border-t border-border/30"},wT={class:"flex items-center justify-center gap-4"},vT={class:"flex flex-col gap-1.5 text-xs"},ST={class:"flex items-center gap-2"},ET={class:"text-base"},xT={key:0,class:"flex gap-1 flex-wrap"},OT={key:1,class:"space-y-0.5"},kT={key:2,class:"flex gap-3"},PT=Pe({__name:"GameBoard",setup(r){const e=Rt(),t=cn(),n=Ht(),{isRunning:s,startGame:i}=rT(),{waitingFor:a,currentInterrupt:o,submit:u}=iT(),c=de(()=>[...t.players].filter(x=>!x.isHuman).sort((x,k)=>x.seatIndex-k.seatIndex)),l=de(()=>t.humanPlayer),d=de(()=>{const x=c.value,k=x.length;if(k===0)return{top:[],left:[],right:[]};const C=Math.min(k,5),J=k-C,pe=Math.ceil(J/2),$=J-pe;return{top:x.slice(0,C),left:x.slice(C,C+pe),right:x.slice(C+pe,C+pe+$)}}),f=de(()=>{if(!e.isNight)return"";if(a.value==="wolf_kill")return"ðŸº è½®åˆ°ä½ é€‰æ‹©å‡»æ€ç›®æ ‡";if(a.value==="seer_inspect")return"ðŸ”® è½®åˆ°ä½ é€‰æ‹©æŸ¥éªŒç›®æ ‡";if(a.value==="witch_action")return"ðŸ§ª è½®åˆ°ä½ å†³å®šç”¨è¯";if(e.isAiThinking)return"â³ æ­£åœ¨è¿›è¡Œå¤œæ™šè¡ŒåŠ¨...";const x=l.value?.role;return x==="villager"||x==="hunter"?"ðŸ˜´ å¤œæ™šé™ä¸´ï¼Œä½ é—­ä¸Šäº†çœ¼ç›...":"ðŸŒ™ å¤œæ™šè¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…..."}),h=de(()=>a.value==="speech"),p=de(()=>a.value==="vote"),m=de(()=>a.value==="hunter_shot"&&!e.isNight),g=de(()=>e.isNight&&(a.value==="wolf_kill"||a.value==="seer_inspect"||a.value==="witch_action")),y=de(()=>a.value==="player_death");function _(x){u(x)}function b(x){n.addMessage("speak",l.value.id,x,"day",e.round),u(x)}function v(x){const k=t.getPlayerById(x)?.name||x;n.addMessage("vote",l.value.id,`æŠ•ç¥¨ç»™ ${k}`,"vote",e.round),u(x)}function w(x){u(x)}function E(){u("continue")}function T(){u("restart"),e.resetGame(),t.resetPlayers(),n.resetMessages(),yd("/")}function O(){e.resetGame(),t.resetPlayers(),n.resetMessages(),yd("/")}return Ua(()=>{!s.value&&t.players.length>0&&i()}),(x,k)=>{const C=Zy,J=r_,pe=lr,$=o_,R=M_,V=db,B=pb,W=_b,z=$p,X=ti,oe=kb;return I(),L("div",aT,[N("div",oT,[q(C)]),P(d).top.length?(I(),L("div",uT,[(I(!0),L(ct,null,_t(P(d).top,U=>(I(),_e(J,{key:U.id,player:U,"show-role":P(e).isGameOver,class:"w-20"},null,8,["player","show-role"]))),128))])):se("",!0),N("div",cT,[P(d).left.length?(I(),L("div",lT,[(I(!0),L(ct,null,_t(P(d).left,U=>(I(),_e(J,{key:U.id,player:U,"show-role":P(e).isGameOver,class:"w-20"},null,8,["player","show-role"]))),128))])):se("",!0),N("div",dT,[P(e).isNight?(I(),L("div",fT,[N("span",hT,ne(P(f)),1),P(e).isAiThinking&&!P(a)?(I(),L("div",pT,[q(pe,{name:"lucide:loader",class:"size-3.5 animate-spin"}),k[0]||(k[0]=ie(" AI è¡ŒåŠ¨ä¸­ ",-1))])):se("",!0)])):se("",!0),N("div",mT,[q(R,null,Fy({_:2},[P(y)?{name:"footer",fn:H(()=>[q($,{onContinue:E,onRestart:T})]),key:"0"}:void 0]),1024)]),P(g)?(I(),L("div",gT,[q(V,{interrupt:P(o),"night-kill-target":null,onSubmit:_},null,8,["interrupt"])])):se("",!0),P(h)?(I(),_e(B,{key:2,onSubmit:b})):se("",!0),P(p)?(I(),_e(W,{key:3,onSubmit:v})):se("",!0),P(m)?(I(),L("div",yT,[q(z,{onSubmit:w})])):se("",!0)]),P(d).right.length?(I(),L("div",_T,[(I(!0),L(ct,null,_t(P(d).right,U=>(I(),_e(J,{key:U.id,player:U,"show-role":P(e).isGameOver,class:"w-20"},null,8,["player","show-role"]))),128))])):se("",!0)]),P(l)?(I(),L("div",bT,[N("div",wT,[q(J,{player:P(l),"show-role":!0,class:"w-24"},null,8,["player"]),N("div",vT,[N("div",ST,[N("span",ET,ne({werewolf:"ðŸº",seer:"ðŸ”®",witch:"ðŸ§ª",hunter:"ðŸŽ¯",villager:"ðŸ§‘â€ðŸŒ¾"}[P(l).role]),1),q(X,{variant:P(l).faction==="werewolf"?"destructive":"secondary",class:"text-[10px]"},{default:H(()=>[ie(ne(P(l).faction==="werewolf"?"ç‹¼äººé˜µè¥":"å¥½äººé˜µè¥"),1)]),_:1},8,["variant"])]),P(l).role==="werewolf"?(I(),L("div",xT,[k[1]||(k[1]=N("span",{class:"text-muted-foreground"},"é˜Ÿå‹ï¼š",-1)),(I(!0),L(ct,null,_t(P(t).players.filter(U=>U.role==="werewolf"&&!U.isHuman),U=>(I(),L("span",{key:U.id,class:"text-destructive"},"ðŸº "+ne(U.name),1))),128))])):se("",!0),P(l).role==="seer"&&P(l).memory.seerResults?.length?(I(),L("div",OT,[k[2]||(k[2]=N("span",{class:"text-muted-foreground"},"æŸ¥éªŒï¼š",-1)),(I(!0),L(ct,null,_t(P(l).memory.seerResults,U=>(I(),L("div",{key:U.targetId},[ie(ne(P(t).getPlayerById(U.targetId)?.name)+" ",1),N("span",{class:Ve(U.faction==="werewolf"?"text-destructive":"text-green-400")}," â†’ "+ne(U.faction==="werewolf"?"ç‹¼äºº":"å¥½äºº"),3)]))),128))])):se("",!0),P(l).role==="witch"?(I(),L("div",kT,[N("span",null,"ðŸ’š è§£è¯ "+ne(P(l).memory.witchPotions?.antidote?"å‰©ä½™":"å·²ç”¨"),1),N("span",null,"â˜ ï¸ æ¯’è¯ "+ne(P(l).memory.witchPotions?.poison?"å‰©ä½™":"å·²ç”¨"),1)])):se("",!0)])])])):se("",!0),P(e).isGameOver&&P(e).winner?(I(),_e(oe,{key:2,winner:P(e).winner,onRestart:O},null,8,["winner"])):se("",!0)])}}}),AT=Object.assign(PT,{__name:"GameBoard"}),TT={class:"min-h-screen flex items-center justify-center bg-background"},IT={class:"text-center space-y-3"},XT=Pe({__name:"game",setup(r){const e=cn(),t=Rp(),n=By();return Ua(()=>{(e.players.length===0||!t.isConfigured)&&n.push("/")}),(s,i)=>{const a=AT,o=lr,u=Gy;return I(),_e(u,null,{fallback:H(()=>[N("div",TT,[N("div",IT,[q(o,{name:"lucide:loader",class:"size-8 animate-spin text-primary mx-auto"}),i[0]||(i[0]=N("p",{class:"text-sm text-muted-foreground"}," æ­£åœ¨åŠ è½½æ¸¸æˆå¼•æ“Ž... ",-1))])])]),default:H(()=>[P(e).players.length>0?(I(),_e(a,{key:0})):se("",!0)]),_:1})}}});export{XT as default};
